<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>WC â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Cairo:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHITE CLOTHES â€” LUXURY MONOCHROME SYSTEM
   Aesthetic: Editorial luxury. Black ink on ivory.
   Like a fashion house's internal ops system.
   Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø£Ø¨ÙŠØ¶ Ø¹Ù„Ù‰ Ø£Ø³ÙˆØ¯ â€” Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹ÙƒØ³Ù‡ ØªÙ…Ø§Ù…Ø§Ù‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
  --ink:      #0a0a0a;
  --ink2:     #141414;
  --ink3:     #1e1e1e;
  --ink4:     #2a2a2a;
  --rule:     #2e2e2e;
  --rule2:    #3a3a3a;
  --mist:     #888;
  --silver:   #aaa;
  --pearl:    #ccc;
  --ivory:    #e8e4dc;
  --white:    #f5f2ed;

  --gold:     #c9a84c;
  --gold2:    #b8941e;
  --gold-faint: rgba(201,168,76,.12);
  --gold-glow:  rgba(201,168,76,.25);

  --red:      #c0392b;
  --red-faint: rgba(192,57,43,.12);
  --green:    #27ae60;
  --green-faint: rgba(39,174,96,.10);
  --amber:    #d4961a;
  --amber-faint: rgba(212,150,26,.12);

  --r1: 4px;
  --r2: 8px;
  --r3: 16px;
  --r4: 999px;

  --sh1: 0 2px 16px rgba(0,0,0,.40);
  --sh2: 0 8px 40px rgba(0,0,0,.55);
  --sh3: 0 20px 80px rgba(0,0,0,.70);
}

/* â”€â”€ Reset â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }

body {
  font-family: 'Cairo', sans-serif;
  background: var(--ink);
  color: var(--ivory);
  min-height: 100vh;
  padding: 12px;
  overflow-x: hidden;
  /* Subtle linen grain */
  background-image:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
}

/* â”€â”€ Typography â”€â”€ */
.display { font-family: 'Cormorant Garamond', serif; letter-spacing: .5px; }
.mono    { font-family: 'JetBrains Mono', monospace; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOPBAR â€” thin editorial header
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar {
  position: sticky;
  top: 8px;
  z-index: 200;
  background: rgba(10,10,10,.92);
  backdrop-filter: blur(20px) saturate(1.4);
  border: 1px solid var(--rule2);
  border-radius: var(--r3);
  padding: 10px 16px;
  box-shadow: var(--sh2);
}

/* Gold hairline on top */
.topbar::before {
  content: "";
  position: absolute;
  top: 0; left: 20%; right: 20%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: .7;
}

.topbar-row {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* Brand mark */
.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.brand-logo {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  border: 1px solid var(--rule2);
  background: var(--ink2);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
}

.brand-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.brand-logo-fallback {
  font-family: 'Cormorant Garamond', serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--ivory);
  letter-spacing: -1px;
}

.brand-text { line-height: 1.1; }
.brand-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 16px;
  font-weight: 600;
  color: var(--white);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.brand-tagline {
  font-size: 9px;
  color: var(--mist);
  letter-spacing: 2.5px;
  text-transform: uppercase;
  margin-top: 1px;
}

/* Vertical divider */
.vr {
  width: 1px;
  height: 28px;
  background: var(--rule);
  flex-shrink: 0;
}

/* â”€â”€ Metric chips â”€â”€ */
.metric {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
  padding: 6px 12px;
  border-radius: var(--r2);
  border: 1px solid var(--rule);
  background: rgba(255,255,255,.03);
  cursor: default;
  transition: border-color .2s;
  white-space: nowrap;
}
.metric:hover { border-color: var(--rule2); }

.metric-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 600;
  color: var(--white);
  line-height: 1;
}
.metric-lbl {
  font-size: 9px;
  color: var(--mist);
  text-transform: uppercase;
  letter-spacing: 1.5px;
}

/* Right side */
.topbar-actions {
  margin-inline-start: auto;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

/* â”€â”€ Topbar Buttons â”€â”€ */
.tb-btn {
  font-family: 'Cairo', sans-serif;
  font-size: 11px;
  font-weight: 700;
  color: var(--silver);
  background: rgba(255,255,255,.05);
  border: 1px solid var(--rule);
  border-radius: var(--r2);
  padding: 8px 14px;
  cursor: pointer;
  transition: all .18s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  position: relative;
  letter-spacing: .5px;
}
.tb-btn:hover { background: rgba(255,255,255,.08); border-color: var(--rule2); color: var(--white); }
.tb-btn:active { transform: scale(.97); }

/* Print pending button */
.tb-btn.pending-active {
  color: var(--gold);
  border-color: rgba(201,168,76,.35);
  background: var(--gold-faint);
}
@keyframes goldPulse {
  0%,100% { box-shadow: 0 0 0 rgba(201,168,76,0); }
  50%      { box-shadow: 0 0 20px var(--gold-glow); }
}
.tb-btn.pending-active { animation: goldPulse 2.5s ease-in-out infinite; }

.tb-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  padding: 1px 7px;
  border-radius: var(--r4);
  background: rgba(201,168,76,.2);
  border: 1px solid rgba(201,168,76,.3);
  color: var(--gold);
}

/* Ship button states */
.tb-btn.ship-normal { }
.tb-btn.ship-follow {
  color: var(--amber);
  border-color: rgba(212,150,26,.35);
  background: var(--amber-faint);
}
.tb-btn.ship-overdue {
  color: #e74c3c;
  border-color: rgba(192,57,43,.35);
  background: var(--red-faint);
}
@keyframes redPulse {
  0%,100% { box-shadow: 0 0 0 rgba(192,57,43,0); }
  50%      { box-shadow: 0 0 22px rgba(192,57,43,.3); }
}
.tb-btn.ship-overdue { animation: redPulse 2.2s ease-in-out infinite; }

.ship-dot {
  position: absolute;
  top: -5px;
  left: -5px;
  min-width: 17px;
  height: 17px;
  padding: 0 5px;
  border-radius: var(--r4);
  background: var(--red);
  color: #fff;
  font-size: 9px;
  font-weight: 800;
  display: none;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--ink);
  font-family: 'JetBrains Mono', monospace;
}

.clock {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--mist);
  letter-spacing: 1px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wrap { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }

.card {
  background: var(--ink2);
  border: 1px solid var(--rule);
  border-radius: var(--r3);
  padding: 16px;
  box-shadow: var(--sh1);
  animation: fadeUp .3s ease;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 14px;
}

.card-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 15px;
  font-weight: 600;
  color: var(--pearl);
  letter-spacing: .5px;
}

.card-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  padding: 2px 8px;
  border-radius: var(--r4);
  border: 1px solid var(--rule);
  color: var(--silver);
  background: rgba(255,255,255,.04);
  margin-inline-start: auto;
}

.section-rule {
  height: 1px;
  background: var(--rule);
  margin: 12px 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTROLS GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ctrl-grid {
  display: grid;
  grid-template-columns: 1.8fr 1fr 1fr;
  gap: 16px;
}
@media (max-width: 820px) { .ctrl-grid { grid-template-columns: 1fr; } }

.ctrl-group { display: flex; flex-direction: column; gap: 8px; }

.ctrl-label {
  font-size: 9px;
  color: var(--mist);
  text-transform: uppercase;
  letter-spacing: 2px;
  border-bottom: 1px solid var(--rule);
  padding-bottom: 6px;
  margin-bottom: 2px;
}

/* â”€â”€ Inputs â”€â”€ */
input, select {
  font-family: 'Cairo', sans-serif;
  font-size: 13px;
  color: var(--ivory);
  background: var(--ink3);
  border: 1px solid var(--rule);
  border-radius: var(--r2);
  padding: 9px 13px;
  outline: none;
  width: 100%;
  min-height: 38px;
  transition: border-color .18s, box-shadow .18s;
}
input::placeholder { color: var(--mist); }
input:focus, select:focus {
  border-color: var(--gold);
  box-shadow: 0 0 0 3px var(--gold-faint);
}
select option { background: var(--ink2); }

.input-row { display: flex; gap: 8px; align-items: center; }
.flex1 { flex: 1; min-width: 0; }

/* â”€â”€ Buttons â”€â”€ */
button {
  font-family: 'Cairo', sans-serif;
  font-size: 12px;
  font-weight: 700;
  color: var(--ivory);
  background: rgba(255,255,255,.06);
  border: 1px solid var(--rule);
  border-radius: var(--r2);
  padding: 9px 16px;
  cursor: pointer;
  transition: all .18s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  white-space: nowrap;
  min-height: 38px;
  letter-spacing: .3px;
}
button:hover { background: rgba(255,255,255,.10); border-color: var(--rule2); }
button:active { transform: scale(.97); }
button:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }

.btn-gold {
  background: linear-gradient(145deg, var(--gold), var(--gold2));
  border-color: rgba(201,168,76,.4);
  color: #0a0a0a;
  font-weight: 900;
  box-shadow: 0 4px 18px var(--gold-faint);
}
.btn-gold:hover { box-shadow: 0 6px 28px var(--gold-glow); transform: translateY(-1px); }

.btn-danger {
  background: rgba(192,57,43,.15);
  border-color: rgba(192,57,43,.35);
  color: #e74c3c;
}
.btn-danger:hover { background: rgba(192,57,43,.22); }

.btn-ghost {
  background: transparent;
  border-color: var(--rule);
  font-size: 11px;
  padding: 6px 12px;
  min-height: 32px;
}

.btn-w100 { width: 100%; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING OVERLAY (global spinner)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loadingOverlay {
  position: fixed;
  inset: 0;
  background: rgba(10,10,10,.75);
  backdrop-filter: blur(6px);
  z-index: 9000;
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
}
#loadingOverlay.active { display: flex; }

.spinner {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid var(--rule2);
  border-top-color: var(--gold);
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loading-txt {
  font-family: 'Cormorant Garamond', serif;
  font-size: 16px;
  color: var(--pearl);
  letter-spacing: 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATUS CHANGE TOAST (inline, not bottom)
   ÙŠØ¸Ù‡Ø± ØªØ­Øª Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ progress bar
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#statusToast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  opacity: 0;
  transition: all .3s cubic-bezier(.34,1.56,.64,1);
  z-index: 8000;
  pointer-events: none;
  min-width: 280px;
  max-width: 90vw;
}
#statusToast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.toast-box {
  background: var(--ink2);
  border: 1px solid var(--rule2);
  border-radius: var(--r3);
  padding: 14px 18px;
  box-shadow: var(--sh3);
  display: flex;
  align-items: center;
  gap: 12px;
  position: relative;
  overflow: hidden;
}

.toast-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.toast-body { flex: 1; min-width: 0; }
.toast-title { font-size: 13px; font-weight: 700; color: var(--white); }
.toast-sub   { font-size: 11px; color: var(--silver); margin-top: 2px; }

.toast-progress {
  position: absolute;
  bottom: 0; left: 0;
  height: 2px;
  border-radius: 0 0 var(--r3) var(--r3);
  background: var(--gold);
  width: 100%;
  transform-origin: left;
  animation: progressShrink 2.8s linear forwards;
}
@keyframes progressShrink {
  from { transform: scaleX(1); }
  to   { transform: scaleX(0); }
}

.toast-box.t-ok    .toast-progress { background: var(--green); }
.toast-box.t-warn  .toast-progress { background: var(--amber); }
.toast-box.t-err   .toast-progress { background: var(--red); }
.toast-box.t-ok    { border-color: rgba(39,174,96,.3); }
.toast-box.t-warn  { border-color: rgba(212,150,26,.3); }
.toast-box.t-err   { border-color: rgba(192,57,43,.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT MENU POPUP (ÙŠØ¸Ù‡Ø± ØªØ­Øª Ø§Ù„Ø²Ø±Ø§Ø±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#printMenu {
  position: fixed;
  z-index: 500;
  display: none;
  min-width: 260px;
}
#printMenu.open { display: block; animation: menuIn .18s ease; }
@keyframes menuIn {
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.print-menu-box {
  background: var(--ink2);
  border: 1px solid var(--rule2);
  border-radius: var(--r3);
  box-shadow: var(--sh3);
  overflow: hidden;
  padding: 6px;
}

.pm-header {
  padding: 10px 12px 8px;
  border-bottom: 1px solid var(--rule);
  margin-bottom: 6px;
}
.pm-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 14px;
  color: var(--pearl);
  letter-spacing: .5px;
}
.pm-sub { font-size: 10px; color: var(--mist); margin-top: 2px; }

.pm-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--r2);
  cursor: pointer;
  transition: background .15s;
  border: none;
  background: transparent;
  width: 100%;
  text-align: right;
  color: var(--ivory);
  font-family: 'Cairo', sans-serif;
  font-size: 12px;
  font-weight: 600;
  min-height: unset;
}
.pm-item:hover { background: rgba(255,255,255,.06); }

.pm-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: var(--r4);
  border: 1px solid var(--rule);
  background: rgba(255,255,255,.05);
  color: var(--silver);
  margin-inline-start: auto;
}

.pm-count.gold {
  border-color: rgba(201,168,76,.35);
  background: var(--gold-faint);
  color: var(--gold);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tbl-wrap {
  width: 100%;
  overflow-x: auto;
  border-radius: var(--r2);
  border: 1px solid var(--rule);
}

table { width: 100%; border-collapse: collapse; min-width: 820px; }

thead { position: sticky; top: 0; z-index: 10; }

thead th {
  background: var(--ink3);
  border-bottom: 1px solid var(--rule2);
  padding: 9px 14px;
  text-align: right;
  font-size: 9px;
  color: var(--mist);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 600;
  white-space: nowrap;
}

tbody tr {
  border-bottom: 1px solid var(--rule);
  transition: background .12s;
  break-inside: avoid;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(255,255,255,.025); }

tbody td {
  padding: 11px 14px;
  font-size: 12px;
  color: var(--silver);
  vertical-align: top;
}

.td-id {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 600;
  color: var(--gold) !important;
}
.td-name { color: var(--ivory) !important; font-weight: 600; }
.td-phone {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--pearl) !important;
}
.td-addr { font-size: 11px; line-height: 1.6; }
.td-amount {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  font-weight: 600;
  color: var(--white) !important;
}

/* â”€â”€ Badges â”€â”€ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 3px 9px;
  border-radius: var(--r4);
  font-size: 10px;
  font-weight: 700;
  border: 1px solid;
  white-space: nowrap;
  letter-spacing: .3px;
}
.badge-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }

.b-ok   { color: var(--green); border-color: rgba(39,174,96,.3); background: var(--green-faint); }
.b-ok .badge-dot { background: var(--green); box-shadow: 0 0 5px var(--green); }
.b-warn { color: var(--amber); border-color: rgba(212,150,26,.3); background: var(--amber-faint); }
.b-warn .badge-dot { background: var(--amber); }
.b-err  { color: var(--red); border-color: rgba(192,57,43,.3); background: var(--red-faint); }
.b-err .badge-dot { background: var(--red); }

/* Days badge */
.days-chip {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 9px;
  border-radius: var(--r4);
  border: 1px solid rgba(212,150,26,.3);
  background: var(--amber-faint);
  color: var(--amber);
}
.days-chip.danger { border-color: rgba(192,57,43,.3); background: var(--red-faint); color: var(--red); }
.days-chip.safe   { border-color: rgba(39,174,96,.25); background: var(--green-faint); color: var(--green); }

/* Courier chip */
.courier-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 3px 10px;
  border-radius: var(--r4);
  font-size: 10px;
  font-weight: 600;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
}
.courier-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

/* â”€â”€ Checkbox â”€â”€ */
input[type=checkbox] {
  width: 15px;
  height: 15px;
  min-height: unset;
  padding: 0;
  border-radius: 3px;
  background: var(--ink3);
  border: 1px solid var(--rule2);
  accent-color: var(--gold);
  cursor: pointer;
  flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR Scanner
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#qrWrap { display: none; margin-top: 12px; animation: fadeUp .3s ease; }

.qr-shell {
  position: relative;
  max-width: 460px;
  border-radius: var(--r2);
  overflow: hidden;
  border: 1px solid var(--rule2);
  background: #000;
}

#qr-reader { width: 100%; }

.qr-overlay {
  position: absolute; inset: 0;
  pointer-events: none;
  display: flex; align-items: center; justify-content: center;
}

.qr-frame {
  width: 200px; height: 200px;
  position: relative;
}

.qr-frame::before, .qr-frame::after,
.qr-br::before, .qr-br::after {
  content: "";
  position: absolute;
  width: 22px; height: 22px;
  border-color: var(--gold);
  border-style: solid;
}
.qr-frame::before { top:0; right:0; border-width: 2px 2px 0 0; }
.qr-frame::after  { top:0; left:0;  border-width: 2px 0 0 2px; }
.qr-br::before    { bottom:0; right:0; border-width: 0 2px 2px 0; }
.qr-br::after     { bottom:0; left:0;  border-width: 0 0 2px 2px; }

.qr-scan {
  position: absolute; left: 5%; right: 5%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  box-shadow: 0 0 8px var(--gold);
  animation: scan 2s ease-in-out infinite alternate;
}
@keyframes scan { from { top: 8%; } to { top: 92%; } }

.qr-mask {
  position: absolute; inset: 0;
  background: rgba(0,0,0,.4);
  mask-image: radial-gradient(ellipse 200px 200px at 50% 50%, transparent 50%, black 51%);
  -webkit-mask-image: radial-gradient(ellipse 200px 200px at 50% 50%, transparent 50%, black 51%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHIP MONITOR â€” tabs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ship-tabs {
  display: flex;
  gap: 4px;
  background: rgba(255,255,255,.03);
  border: 1px solid var(--rule);
  border-radius: var(--r2);
  padding: 3px;
  width: fit-content;
}

.ship-tab {
  padding: 7px 14px;
  border-radius: var(--r1);
  font-size: 11px;
  font-weight: 700;
  color: var(--mist);
  cursor: pointer;
  transition: all .18s;
  border: 1px solid transparent;
  background: transparent;
  min-height: unset;
  display: flex;
  align-items: center;
  gap: 6px;
  letter-spacing: .3px;
}
.ship-tab:hover { color: var(--silver); }

.ship-tab.tab-normal  { color: var(--green); background: var(--green-faint); border-color: rgba(39,174,96,.25); }
.ship-tab.tab-follow  { color: var(--amber); background: var(--amber-faint); border-color: rgba(212,150,26,.25); }
.ship-tab.tab-overdue { color: var(--red);   background: var(--red-faint);   border-color: rgba(192,57,43,.25); }

.tab-n {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  font-weight: 700;
  padding: 1px 6px;
  border-radius: var(--r4);
  background: rgba(255,255,255,.08);
}

/* Courier filter badges */
.c-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }

.c-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  border-radius: var(--r4);
  border: 1px solid var(--rule);
  background: rgba(255,255,255,.04);
  cursor: pointer;
  font-size: 11px;
  font-weight: 600;
  color: var(--silver);
  transition: all .15s;
  min-height: unset;
}
.c-badge:hover { border-color: var(--rule2); color: var(--ivory); }
.c-badge.active { border-color: var(--gold); background: var(--gold-faint); color: var(--gold); }
.c-badge.overdue-c { border-color: rgba(192,57,43,.3); background: var(--red-faint); color: #e74c3c; }
@keyframes redBadgePulse {
  0%,100% { box-shadow: 0 0 0 rgba(192,57,43,0); }
  50% { box-shadow: 0 0 14px rgba(192,57,43,.3); }
}
.c-badge.overdue-c { animation: redBadgePulse 2s ease-in-out infinite; }

.c-n {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  padding: 1px 6px;
  border-radius: var(--r4);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.08);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH CARD highlight
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#searchCard {
  border-color: rgba(201,168,76,.25);
  box-shadow: var(--sh1), 0 0 30px var(--gold-faint);
}
#searchCard::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  border-radius: var(--r3) var(--r3) 0 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 40px 20px;
  gap: 8px;
  color: var(--mist);
  text-align: center;
}
.empty-icon { font-size: 32px; opacity: .3; }
.empty-text { font-family: 'Cormorant Garamond', serif; font-size: 16px; }
.empty-sub  { font-size: 11px; opacity: .6; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT & PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.print-header, .print-summary { display: none; }

@page { margin: 9mm; size: A4 landscape; }

@media print {
  *, *::before, *::after {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  html, body {
    background: #fff !important; color: #000 !important;
    margin: 0 !important; padding: 0 !important;
    font-family: 'Cairo', Arial, sans-serif !important;
    font-size: 12px !important;
  }

  body::before, body::after { display: none !important; }

  .no-print, .topbar, #ctrlCard, #indexCard,
  #searchCard, #shipCard, button { display: none !important; }

  .wrap { max-width: none !important; gap: 0 !important; padding: 0 !important; }

  .card, #printArea {
    background: #fff !important; border: none !important;
    box-shadow: none !important; border-radius: 0 !important;
    padding: 0 !important; margin: 0 !important;
  }

  .print-header { display: block !important; margin-bottom: 10px !important; color: #000 !important; }
  .print-title { font-size: 16px !important; font-weight: 900 !important; color: #000 !important; }

  .print-summary {
    display: grid !important;
    grid-template-columns: 1fr 1fr 1fr !important;
    gap: 8px !important; margin: 8px 0 14px !important;
  }
  .print-box {
    border: 1px solid #bbb !important; border-radius: 6px !important;
    padding: 8px 12px !important; font-size: 12px !important;
    color: #000 !important; background: #fff !important; line-height: 1.8 !important;
  }

  .tbl-wrap { border: 1px solid #ccc !important; overflow: visible !important; box-shadow: none !important; }
  table { width: 100% !important; min-width: 0 !important; border-collapse: collapse !important; }

  thead th {
    position: static !important; background: #f2f2f2 !important;
    border: 1px solid #ccc !important; color: #000 !important;
    font-size: 10px !important; padding: 7px 10px !important;
    text-transform: uppercase !important; letter-spacing: .5px !important;
  }

  thead th:first-child, tbody td:first-child { display: none !important; }

  tbody td {
    border: 1px solid #ddd !important; padding: 8px 10px !important;
    font-size: 11px !important; color: #000 !important; background: #fff !important;
  }

  tbody td *, .td-id, .td-phone, .td-amount, .td-name, .td-addr, .mono {
    color: #000 !important; font-family: 'Cairo', Arial, sans-serif !important;
  }

  .badge {
    border: 1px solid #bbb !important; background: #f5f5f5 !important;
    color: #000 !important; font-size: 10px !important;
    padding: 2px 8px !important; border-radius: 999px !important;
    display: inline-block !important;
  }
  .badge-dot { display: none !important; }

  tr, td, th { page-break-inside: avoid !important; break-inside: avoid !important; }
  tbody tr   { break-inside: avoid !important; }
  .empty     { display: none !important; }
  .card-header { display: none !important; }
}

/* PDF Mode */
body.pdf-mode {
  background: #fff !important; color: #000 !important;
  padding: 0 !important; margin: 0 !important;
  font-family: 'Cairo', Arial, sans-serif !important;
}
body.pdf-mode::before, body.pdf-mode::after { display: none !important; }
body.pdf-mode .no-print,
body.pdf-mode .topbar,
body.pdf-mode #ctrlCard,
body.pdf-mode #indexCard,
body.pdf-mode #searchCard,
body.pdf-mode #shipCard { display: none !important; }
body.pdf-mode .wrap { max-width: none !important; gap: 0 !important; padding: 0 !important; }
body.pdf-mode .card, body.pdf-mode #printArea {
  background: #fff !important; border: none !important;
  box-shadow: none !important; border-radius: 0 !important;
  padding: 6mm !important; margin: 0 !important;
}
body.pdf-mode .card-header { display: none !important; }
body.pdf-mode .print-header { display: block !important; margin-bottom: 10px !important; }
body.pdf-mode .print-summary {
  display: grid !important; grid-template-columns: 1fr 1fr 1fr !important;
  gap: 8px !important; margin: 8px 0 12px !important;
}
body.pdf-mode .print-box {
  border: 1px solid #bbb !important; border-radius: 6px !important;
  padding: 8px 12px !important; color: #000 !important;
  background: #fff !important; font-size: 11px !important; line-height: 1.8 !important;
}
body.pdf-mode .tbl-wrap {
  border: 1px solid #ccc !important; overflow: visible !important;
  box-shadow: none !important; background: #fff !important;
}
body.pdf-mode table { width: 100% !important; min-width: 0 !important; border-collapse: collapse !important; }
body.pdf-mode thead th {
  position: static !important; background: #f2f2f2 !important;
  border: 1px solid #ccc !important; color: #000 !important;
  font-size: 10px !important; padding: 7px 10px !important;
  backdrop-filter: none !important; letter-spacing: .5px !important;
  text-transform: uppercase !important;
}
body.pdf-mode thead th:first-child,
body.pdf-mode tbody td:first-child { display: none !important; }
body.pdf-mode tbody td {
  border: 1px solid #ddd !important; padding: 8px 10px !important;
  font-size: 11px !important; color: #000 !important; background: #fff !important;
}
body.pdf-mode tbody td *, body.pdf-mode .td-id, body.pdf-mode .td-phone,
body.pdf-mode .td-amount, body.pdf-mode .td-name, body.pdf-mode .mono {
  color: #000 !important; font-family: 'Cairo', Arial, sans-serif !important;
}
body.pdf-mode .badge {
  border: 1px solid #bbb !important; background: #f5f5f5 !important;
  color: #000 !important; font-size: 10px !important; padding: 2px 8px !important;
  border-radius: 999px !important; display: inline-block !important;
}
body.pdf-mode .badge-dot { display: none !important; }
body.pdf-mode tr, body.pdf-mode tbody tr {
  break-inside: avoid !important; page-break-inside: avoid !important;
}
body.pdf-mode .empty, body.pdf-mode button { display: none !important; }
body.pdf-mode #selectionInfo, body.pdf-mode #toggleAllBtn { display: none !important; }

/* â”€â”€ Shake â”€â”€ */
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20% { transform: translateX(-7px); }
  40% { transform: translateX(7px); }
  60% { transform: translateX(-4px); }
  80% { transform: translateX(4px); }
}
.shake { animation: shake .5s ease; }

/* â”€â”€ Mobile â”€â”€ */
@media (max-width: 640px) {
  body { padding: 8px; }
  .topbar { border-radius: 12px; padding: 8px 12px; top: 6px; }
  .brand-name { font-size: 13px; }
  .metric-val { font-size: 15px; }
  .metric { padding: 5px 8px; }
  .tb-btn { padding: 7px 10px; font-size: 10px; }
  .clock { display: none; }
}
</style>
</head>

<body>

<!-- â•â• LOADING OVERLAY â•â• -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-txt" id="loadingTxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦</div>
</div>

<!-- â•â• STATUS TOAST â•â• -->
<div id="statusToast">
  <div class="toast-box" id="toastBox">
    <div class="toast-icon" id="toastIcon">âœ…</div>
    <div class="toast-body">
      <div class="toast-title" id="toastTitle">ØªÙ…</div>
      <div class="toast-sub" id="toastSub"></div>
    </div>
    <div class="toast-progress" id="toastProgress"></div>
  </div>
</div>

<!-- â•â• PRINT MENU â•â• -->
<div id="printMenu">
  <div class="print-menu-box">
    <div class="pm-header">
      <div class="pm-title">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
      <div class="pm-sub">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ·Ø¨Ø¹Ù‡Ø§</div>
    </div>
    <button class="pm-item" onclick="doPrintBatch('new')">
      <span>ğŸ†•</span>
      <span>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (new)</span>
      <span class="pm-count gold" id="pmNewCount">0</span>
    </button>
    <button class="pm-item" onclick="doPrintBatch('pending')">
      <span>ğŸ–¨ï¸</span>
      <span>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</span>
      <span class="pm-count gold" id="pmPendingCount">0</span>
    </button>
    <button class="pm-item" onclick="doPrintBatch('both')">
      <span>ğŸ“‹</span>
      <span>Ø§Ù„ÙƒÙ„ (Ø¬Ø¯ÙŠØ¯ + ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)</span>
      <span class="pm-count gold" id="pmBothCount">0</span>
    </button>
  </div>
</div>

<div class="wrap">

  <!-- â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â• -->
  <div class="topbar no-print">
    <div class="topbar-row">

      <div class="brand">
        <div class="brand-logo">
          <img src="/mnt/user-data/uploads/1752347012924190719.png" alt="WC" onerror="this.parentElement.innerHTML='<span class=\'brand-logo-fallback\'>WC</span>'">
        </div>
        <div class="brand-text">
          <div class="brand-name">White Clothes</div>
          <div class="brand-tagline">Delivery System</div>
        </div>
      </div>

      <div class="vr"></div>

      <div class="metric">
        <div class="metric-val" id="metricOrders">0</div>
        <div class="metric-lbl">Ø·Ù„Ø¨Ø§Øª</div>
      </div>

      <div class="metric">
        <div class="metric-val" id="metricSubtotal">0</div>
        <div class="metric-lbl">ØªØ­ØµÙŠÙ„</div>
      </div>

      <div class="metric">
        <div class="metric-val" id="metricShipping">0</div>
        <div class="metric-lbl">Ø´Ø­Ù†</div>
      </div>

      <div class="topbar-actions">

        <!-- Print Pending -->
        <button class="tb-btn" id="printPendingBtn" onclick="togglePrintMenu(event)">
          ğŸ–¨ï¸ ÙÙˆØ§ØªÙŠØ±
          <span class="tb-badge" id="pendingTotal">0</span>
        </button>

        <div class="vr"></div>

        <!-- Ship Monitor -->
        <button class="tb-btn ship-normal" id="shipBtn" onclick="toggleShipCard()">
          ğŸšš Ø´Ø­Ù†
          <span class="tb-badge" id="shipCountBadge">0</span>
          <span class="ship-dot" id="shipDot"></span>
        </button>

        <div class="vr"></div>

        <span class="clock" id="clock"></span>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• CONTROLS â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print" id="ctrlCard">
    <div class="ctrl-grid">

      <div class="ctrl-group">
        <div class="ctrl-label">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø±</div>
        <div class="input-row">
          <input id="orderIdInput" placeholder="Order ID â€” Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù…Ø³Ø­ QR" class="flex1"/>
          <button class="btn-gold" onclick="addOne()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="input-row">
          <button style="flex:1" onclick="startScan()">ğŸ“· ØªØ´ØºÙŠÙ„ QR</button>
          <button style="flex:1" onclick="stopScan()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
      </div>

      <div class="ctrl-group">
        <div class="ctrl-label">ØªØ­ÙƒÙ…</div>
        <button class="btn-w100" onclick="showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦'); refreshMine().finally(hideLoading)">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button>
        <button class="btn-danger btn-w100" onclick="clearMine()">ğŸ§¹ Ù…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button>
      </div>

      <div class="ctrl-group">
        <div class="ctrl-label">ØªØµØ¯ÙŠØ±</div>
        <button class="btn-w100" onclick="printA4()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        <button class="btn-w100" onclick="downloadSelectedPDF()">â¬‡ï¸ PDF Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        <button class="btn-w100" onclick="downloadAllXLSX()">â¬‡ï¸ Excel Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      </div>

    </div>

    <div class="section-rule"></div>

    <div class="input-row" style="flex-wrap:wrap; gap:8px;">
      <select id="statusSelect" style="flex:1; min-width:200px;">
        <option value="">â€” ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯ â€”</option>
        <option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
        <option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
        <option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
        <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
        <option>Ù…Ø±ØªØ¬Ø¹</option>
        <option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option>
        <option>Ø§Ù„ØºØ§Ø¡</option>
      </select>
      <button class="btn-gold" onclick="bulkUpdate()">âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯</button>
      <span style="font-size:10px; color:var(--mist); align-self:center">(ØªÙ… Ø§Ù„Ø´Ø­Ù†) ÙŠØ·Ù„Ø¨ Ù…Ù†Ø¯ÙˆØ¨ + ØªØ§Ø±ÙŠØ®</span>
    </div>

    <!-- QR -->
    <div id="qrWrap">
      <div style="margin-top:10px; padding:10px; background:var(--ink3); border-radius:var(--r2); border:1px solid var(--rule); font-size:11px; color:var(--silver)">
        ğŸ“Œ Ø¶Ø¹ Ø§Ù„Ù€ QR Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” ÙŠÙØ¶Ø§Ù Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙˆØ± Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
      </div>
      <div style="margin-top:10px;">
        <div class="qr-shell">
          <div id="qr-reader"></div>
          <div class="qr-overlay">
            <div class="qr-frame">
              <div class="qr-br"></div>
              <div class="qr-scan"></div>
              <div class="qr-mask"></div>
            </div>
          </div>
        </div>
        <div style="font-size:10px; color:var(--mist); margin-top:6px;">âš ï¸ ÙŠØ³ØªÙ„Ø²Ù… HTTPS + ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print" id="indexCard">
    <div class="card-header">
      <div class="card-title">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div>
      <span class="card-badge" id="indexStats">â³</span>
    </div>
    <div class="input-row" style="flex-wrap:wrap;">
      <input id="idx_q" placeholder="Ù…ÙˆØ¨Ø§ÙŠÙ„ / Order ID / Ø§Ø³Ù… / Ù…Ø­Ø§ÙØ¸Ø©â€¦" class="flex1"/>
      <button onclick="searchIndex()">Ø¨Ø­Ø«</button>
      <button onclick="closeSearch()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• SEARCH RESULTS â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print" id="searchCard" style="display:none; position:relative;">
    <div class="card-header">
      <div class="card-title">ğŸ“Œ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
      <span class="card-badge" id="srCount"></span>
    </div>
    <div class="input-row" style="margin-bottom:10px;">
      <button class="btn-ghost" onclick="srToggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
      <button class="btn-gold" onclick="srAddToMine()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      <button onclick="closeSearch()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th style="width:36px"></th>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody id="srTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• SHIP MONITOR â•â•â•â•â•â•â•â•â•â• -->
  <div class="card no-print" id="shipCard" style="display:none;">
    <div class="card-header">
      <div class="card-title">ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª</div>
      <span class="card-badge" id="shipStats"></span>
    </div>

    <div class="input-row" style="flex-wrap:wrap; gap:8px; margin-bottom:10px;">
      <div class="ship-tabs">
        <button class="ship-tab" id="tabNormal"  onclick="setShipTab('normal')">ğŸŸ¢ Ø·Ø¨ÙŠØ¹ÙŠ <span class="tab-n" id="bNormal">0</span></button>
        <button class="ship-tab" id="tabFollow"  onclick="setShipTab('follow')">ğŸŸ¡ Ù…ØªØ§Ø¨Ø¹Ø© <span class="tab-n" id="bFollow">0</span></button>
        <button class="ship-tab" id="tabOverdue" onclick="setShipTab('overdue')">ğŸ”´ Ù…ØªØ£Ø®Ø± <span class="tab-n" id="bOverdue">0</span></button>
      </div>
      <select id="shipCourierFilter" style="min-width:180px; flex:1;" onchange="renderShipTable();renderCourierBadges();">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>
      </select>
      <button onclick="printShipCurrent()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button onclick="toggleShipCard()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="c-badges" id="courierBadges"></div>

    <div style="margin-top:8px; padding:8px 12px; background:var(--ink3); border-radius:var(--r2); border:1px solid var(--rule); font-size:10px; color:var(--mist);">
      Ù…ØªØ£Ø®Ø± = Ø£ÙƒØ«Ø± Ù…Ù† <b style="color:var(--silver)">10</b> Ø£ÙŠØ§Ù… Â· Ù…ØªØ§Ø¨Ø¹Ø© = <b style="color:var(--silver)">6â€“9</b> Ø£ÙŠØ§Ù…
    </div>

    <div class="tbl-wrap" style="margin-top:10px;">
      <table>
        <thead><tr>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody id="shipTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• PRINT AREA â•â•â•â•â•â•â•â•â•â• -->
  <div class="card" id="printArea">

    <div class="print-header">
      <div class="print-title">ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… â€” White Clothes</div>
      <div id="printDate" style="font-size:12px; color:#333; margin-top:3px;"></div>
    </div>

    <div class="print-summary">
      <div class="print-box">
        <div><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</b> <span id="pCount">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†):</b> <span id="pSubtotal">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†:</b> <span id="pShipping">0</span></div>
      </div>
      <div class="print-box">
        <div><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø´Ø­Ù†):</b> <span id="pTotal">0</span></div>
        <div><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</b> ________________________</div>
        <div><b>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</b> ________________________</div>
      </div>
      <div class="print-box">
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ù…Ø·Ø¨ÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­</div>
        <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> <span id="pDate2"></span></div>
      </div>
    </div>

    <div class="card-header no-print" style="justify-content:space-between; margin-bottom:10px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="card-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</span>
        <span class="card-badge" id="selectionInfo">0 Ù…Ø­Ø¯Ø¯</span>
      </div>
      <button class="btn-ghost no-print" id="toggleAllBtn" onclick="toggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
    </div>

    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th class="no-print" style="width:36px;"></th>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody id="tbody">
          <tr><td colspan="7"><div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div>
            <div class="empty-sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ù…Ø³Ø­ QR</div>
          </div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div><!-- /wrap -->

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WEB_APP_URL       = "https://script.google.com/macros/s/AKfycbwsMr7euLyvoHz0Sr_k26N_HJYG_O_W5mb061-ljwm-G6I2n0W_Wjb2aiXCk0hg0HkN/exec";
const WEB_APP_PRINT_URL = "https://script.google.com/macros/s/AKfycbwZ68iM4-HzCpfX3tRrVWzzZQIONDuDO2VKXyKxhRY/exec";
const API_KEY           = "123";
const FOLLOW_MIN        = 6;
const FOLLOW_MAX        = 9;
const OVERDUE_MIN       = 10;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let rows = [], selected = new Set(), mineIds = new Set();
let qr = null, lastScan = { id:"", t:0 }, scanLockUntil = 0;
let allCache = [], srSelected = new Set(), lastResults = [];
let shipAll = [], shipTab = "overdue", courierStats = {};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function tickClock(){ const e=document.getElementById("clock"); if(e) e.textContent=new Date().toLocaleTimeString("ar-EG"); }
tickClock(); setInterval(tickClock, 1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERSISTENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LS_KEY     = "wc_mine_ids_v2";
const ODIDS_KEY  = "wc_overdue_ids";
const COLORS_KEY = "wc_courier_colors";

function loadMine(){ try{ mineIds=new Set((JSON.parse(localStorage.getItem(LS_KEY)||"[]")).map(String)); }catch(e){ mineIds=new Set(); } }
function saveMine(){ localStorage.setItem(LS_KEY, JSON.stringify([...mineIds])); }
function getOldOverdueIds(){ try{ return JSON.parse(localStorage.getItem(ODIDS_KEY)||"[]"); }catch(e){ return []; } }
function setOldOverdueIds(a){ localStorage.setItem(ODIDS_KEY, JSON.stringify(a||[])); }
function loadColors(){ try{ return JSON.parse(localStorage.getItem(COLORS_KEY)||"{}"); }catch(e){ return {}; } }
function saveColors(m){ localStorage.setItem(COLORS_KEY, JSON.stringify(m||{})); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoading(txt="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"){
  document.getElementById("loadingTxt").textContent = txt;
  document.getElementById("loadingOverlay").classList.add("active");
}
function hideLoading(){ document.getElementById("loadingOverlay").classList.remove("active"); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST (animated, typed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer = null;
function toast(title, sub="", type="default", dur=2800){
  const el   = document.getElementById("statusToast");
  const box  = document.getElementById("toastBox");
  const icon = document.getElementById("toastIcon");
  const tEl  = document.getElementById("toastTitle");
  const sEl  = document.getElementById("toastSub");
  const prog = document.getElementById("toastProgress");

  const icons = { ok:"âœ…", warn:"âš ï¸", err:"âŒ", default:"â„¹ï¸" };
  icon.textContent = icons[type] || "â„¹ï¸";
  tEl.textContent  = title;
  sEl.textContent  = sub;
  box.className    = "toast-box" + (type!=="default" ? " t-"+type : "");

  // Reset progress animation
  prog.style.animation = "none";
  prog.offsetHeight;
  prog.style.animation = `progressShrink ${dur}ms linear forwards`;

  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove("show"), dur + 300);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BEEP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let audioCtx = null;
function beep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="sine"; o.frequency.value=880; g.gain.value=0.07;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), 110);
  }catch(e){}
  try{ navigator.vibrate?.([40]); }catch(e){}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API (JSONP)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function jsonp(url){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{ cleanup(); res(data); };
    function cleanup(){ try{delete window[cb];}catch(e){window[cb]=undefined;} script.remove(); }
    const script=document.createElement("script");
    script.src=url+(url.includes("?")?"&":"?")+`callback=${cb}`;
    script.onerror=()=>{ cleanup(); rej(new Error("JSONP fail")); };
    document.body.appendChild(script);
  });
}
async function api(action, params={}){
  const qs=new URLSearchParams({ action, key:API_KEY, _t:Date.now(), ...params }).toString();
  return jsonp(WEB_APP_URL+"?"+qs);
}
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function nextFrame(){ return new Promise(r=>requestAnimationFrame(r)); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function n(v){ const x=Number(v); return isNaN(x)?0:x; }
function norm(s){ return String(s??"").trim().toLowerCase(); }
function fmt(v){ return n(v).toLocaleString("ar-EG"); }
function fmtYMD(dt){ return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`; }

function colorFor(name){
  const m=loadColors(); const k=String(name||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  if(!m[k]){ let h=0; for(let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))>>>0; m[k]=`hsl(${h%360} 60% 55%)`; saveColors(m); }
  return m[k];
}

function courierChip(name){
  const n2=String(name||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯", c=colorFor(n2);
  return `<span class="courier-chip"><span class="courier-dot" style="background:${c};box-shadow:0 0 5px ${c}80"></span>${esc(n2)}</span>`;
}

function statusBadge(status){
  const s=(status||"").trim();
  if(s==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"||s==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") return `<span class="badge b-ok"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`;
  if(s==="Ù…Ø±ØªØ¬Ø¹"||s==="Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"||s==="Ø§Ù„ØºØ§Ø¡") return `<span class="badge b-err"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`;
  return `<span class="badge b-warn"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER (Main Table)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
  updateToggleBtn();
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const subtotalSum = rows.reduce((a,r)=>a+n(r.subtotal), 0);
  const shippingSum = rows.reduce((a,r)=>a+n(r.shipping), 0);

  document.getElementById("metricOrders").textContent   = rows.length;
  document.getElementById("metricSubtotal").textContent = fmt(subtotalSum);
  document.getElementById("metricShipping").textContent = fmt(shippingSum);

  const si = document.getElementById("selectionInfo");
  if(si) si.textContent = selected.size+" Ù…Ø­Ø¯Ø¯";

  if(!rows.length){
    tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div><div class="empty-sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ù…Ø³Ø­ QR</div></div></td></tr>`;
    return;
  }

  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const checked=selected.has(String(r.orderId));
    const p1=esc((r.phone||"").trim()), p2=esc((r.altPhone||"").trim());
    const phones=p2?`${p1} â€” ${p2}`:p1;

    tr.innerHTML=`
      <td class="no-print" style="text-align:center"><input type="checkbox" ${checked?"checked":""}></td>
      <td class="td-id"><b>${esc(r.orderId)}</b></td>
      <td class="td-name">${esc(r.name||"")}</td>
      <td class="td-addr">
        <span class="td-phone">${phones}</span><br>
        <span style="font-size:10px;color:var(--mist)">${esc(r.city||"")}${r.address?" / "+esc(r.address):""}</span>
      </td>
      <td class="td-amount">${fmt(r.subtotal)}</td>
      <td class="mono" style="font-size:11px;color:var(--silver)">${fmt(r.shipping)}</td>
      <td>${statusBadge(r.status)}</td>
    `;
    tr.querySelector("input").addEventListener("change",e=>{
      const id=String(r.orderId);
      e.target.checked?selected.add(id):selected.delete(id);
      if(si) si.textContent=selected.size+" Ù…Ø­Ø¯Ø¯";
      updateToggleBtn();
    });
    tbody.appendChild(tr);
  });
}

function toggleAll(){
  const allIds=rows.map(r=>String(r.orderId));
  const allSel=allIds.length&&allIds.every(id=>selected.has(id));
  if(allSel) selected.clear(); else allIds.forEach(id=>selected.add(id));
  updateToggleBtn(); render();
}
function updateToggleBtn(){
  const btn=document.getElementById("toggleAllBtn");
  if(!btn) return;
  const allIds=rows.map(r=>String(r.orderId));
  btn.textContent=(allIds.length&&allIds.every(id=>selected.has(id)))?"Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„":"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH MINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function refreshMine(){
  if(!mineIds.size){ rows=[]; selected=new Set(); render(); return; }
  const res=await api("scanList");
  if(!res?.ok){ toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„", res?.error||"", "err"); return; }
  const mine=(res.rows||[]).filter(r=>mineIds.has(String(r.orderId)));
  const order=[...mineIds];
  mine.sort((a,b)=>order.indexOf(String(b.orderId))-order.indexOf(String(a.orderId)));
  rows=mine; selected=new Set(rows.map(r=>String(r.orderId))); render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function addOne(){
  const id=document.getElementById("orderIdInput").value.trim();
  if(!id) return;
  if(mineIds.has(String(id))){ toast("Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„","","warn"); return; }
  mineIds.add(String(id)); saveMine(); beep();
  toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±", id, "ok");
  const res=await api("scanAdd",{orderId:id});
  if(!res?.ok){ toast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©", res?.error||"", "err"); return; }
  document.getElementById("orderIdInput").value="";
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦");
  await refreshMine();
  hideLoading();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BULK UPDATE â€” with animated loading
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function bulkUpdate(){
  const status=document.getElementById("statusSelect").value.trim();
  if(!status){ toast("Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  const ids=[...selected];
  if(!ids.length){ toast("Ù„Ù… ØªØ­Ø¯Ø¯ Ø£ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª","","warn"); return; }

  let courier="", shipDate="", deliveryDate="", partialAmount="";

  if(status==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"){
    courier=prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ","")||"";
    shipDate=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† (YYYY-MM-DD)ØŸ",new Date().toISOString().slice(0,10))||"";
    if(!courier){ toast("Ù„Ø§Ø²Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨","","err"); return; }
  }
  if(status==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"){
    deliveryDate=prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD)ØŸ",new Date().toISOString().slice(0,10))||"";
  }
  if(status==="Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"){
    partialAmount=prompt("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ","")||"";
    if(!partialAmount){ toast("Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº","","err"); return; }
  }

  // âœ… Show loading while updating
  showLoading(`Ø¬Ø§Ø±ÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ ${ids.length} Ø£ÙˆØ±Ø¯Ø±â€¦`);

  try {
    const res=await api("bulkUpdate",{ ids:ids.join(","), status, courier, shipDate, deliveryDate, partialAmount });
    hideLoading();
    if(!res?.ok){ toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", res?.error||"", "err"); return; }
    toast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©`, `${res.updated??ids.length} Ø£ÙˆØ±Ø¯Ø± â€” ${status}`, "ok", 3500);
    await refreshMine();
    refreshShipMonitor();
  } catch(e){
    hideLoading();
    toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err");
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startScan(){
  document.getElementById("qrWrap").style.display="block";
  if(!qr) qr=new Html5Qrcode("qr-reader");
  const cfg={fps:15, qrbox:{width:200,height:200}, aspectRatio:1.0};
  let camId=null;
  try{
    const cams=await Html5Qrcode.getCameras();
    if(cams?.length){ const bk=cams.find(c=>/back|rear|environment/i.test(c.label)); camId=(bk||cams[0]).id; }
  }catch(e){}
  try{ await qr.start(camId||{facingMode:"environment"},cfg,onQrSuccess,()=>{}); toast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø©","","ok"); }
  catch(e){ toast("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§",String(e),"err"); }
}
async function stopScan(){
  document.getElementById("qrWrap").style.display="none";
  if(qr){ try{await qr.stop();}catch(e){} }
  toast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
}
async function onQrSuccess(txt){
  const now=Date.now();
  if(now<scanLockUntil) return;
  const raw=String(txt||"").trim();
  const clean=raw.match(/\d+/)?raw.match(/\d+/)[0]:raw;
  if(!clean) return;
  if(lastScan.id===clean&&(now-lastScan.t)<2500) return;
  lastScan={id:clean,t:now};
  if(mineIds.has(String(clean))){ toast("Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„","","warn"); scanLockUntil=now+1200; return; }
  scanLockUntil=now+1500;
  beep(); toast("ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·", clean, "ok");
  mineIds.add(String(clean)); saveMine();
  const res=await api("scanAdd",{orderId:clean});
  if(!res?.ok){ toast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©",res?.error||"","err"); return; }
  await refreshMine();
}
function clearMine(){
  if(!confirm("Ù‡ØªÙ…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø© (Ù…Ø´ Ù…Ù† Ø§Ù„Ø´ÙŠØª). Ù…ØªØ£ÙƒØ¯ØŸ")) return;
  mineIds=new Set(); saveMine(); rows=[]; selected=new Set(); render();
  toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª","","warn");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT / PDF
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updatePrintSummary(){
  const sub=rows.reduce((a,r)=>a+n(r.subtotal),0);
  const shp=rows.reduce((a,r)=>a+n(r.shipping),0);
  const now=new Date().toLocaleString("ar-EG");
  document.getElementById("printDate").textContent="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…: "+now;
  document.getElementById("pDate2").textContent=now;
  document.getElementById("pCount").textContent=rows.length;
  document.getElementById("pSubtotal").textContent=sub;
  document.getElementById("pShipping").textContent=shp;
  document.getElementById("pTotal").textContent=sub+shp;
}
function printA4(){ updatePrintSummary(); window.print(); }

async function downloadSelectedPDF(){
  const ids=[...selected];
  if(!ids.length){ toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  const prevRows=rows.slice(), prevSel=new Set(selected);
  rows=rows.filter(r=>ids.includes(String(r.orderId)));
  selected=new Set(ids);
  updatePrintSummary(); render();
  document.body.classList.add("pdf-mode");
  const area=document.getElementById("printArea");
  await nextFrame(); await nextFrame(); await sleep(200);
  area.offsetHeight; await nextFrame();

  const opt={
    margin:[6,6,6,6],
    filename:`wc-delivery-${new Date().toISOString().slice(0,10)}.pdf`,
    image:{type:"jpeg",quality:1.0},
    html2canvas:{
      scale:2, useCORS:true, backgroundColor:"#ffffff",
      scrollX:0, scrollY:0, logging:false,
      onclone(doc){
        const s=doc.createElement("style");
        s.textContent=`
          *{color:#000!important;background:transparent!important;font-family:'Cairo',Arial,sans-serif!important}
          body,#printArea,.card,.tbl-wrap,table{background:#fff!important}
          thead th{background:#f2f2f2!important;border:1px solid #ccc!important;color:#000!important;font-size:10px!important;padding:7px 10px!important}
          tbody td{border:1px solid #ddd!important;background:#fff!important;color:#000!important;padding:8px 10px!important;font-size:11px!important}
          .badge{border:1px solid #bbb!important;background:#f5f5f5!important;color:#000!important;display:inline-block!important;padding:2px 8px!important;border-radius:999px!important}
          .badge-dot{display:none!important}
          .no-print,button,.card-header{display:none!important}
          .print-header{display:block!important}
          .print-summary{display:grid!important;grid-template-columns:1fr 1fr 1fr!important;gap:8px!important;margin:8px 0 12px!important}
          .print-box{border:1px solid #bbb!important;border-radius:6px!important;padding:8px 12px!important;background:#fff!important;color:#000!important}
          thead th:first-child,tbody td:first-child{display:none!important}
          .tbl-wrap{border:1px solid #ccc!important;overflow:visible!important}
          #printArea{padding:6mm!important;background:#fff!important}
          .empty,.card-header{display:none!important}
        `;
        doc.head.appendChild(s);
      }
    },
    jsPDF:{unit:"mm",format:"a4",orientation:"landscape"},
    pagebreak:{mode:["css","legacy"],avoid:["tr","td"]}
  };

  try{
    await html2pdf().set(opt).from(area).save();
    toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ PDF","","ok");
  }catch(e){ toast("Ø®Ø·Ø£ ÙÙŠ PDF","","err"); }
  finally{
    document.body.classList.remove("pdf-mode");
    rows=prevRows; selected=prevSel; render();
  }
}

function downloadAllXLSX(){
  const ids=[...selected];
  if(!ids.length){ toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  const exp=rows.filter(r=>ids.includes(String(r.orderId)));
  const sub=exp.reduce((a,r)=>a+(Number(r.subtotal)||0),0);
  const shp=exp.reduce((a,r)=>a+(Number(r.shipping)||0),0);
  const now=new Date().toLocaleString("ar-EG");
  const header=["Order ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‡Ø§ØªÙ","Ù‡Ø§ØªÙ Ø¥Ø¶Ø§ÙÙŠ","Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©","Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","Ø§Ù„ØªØ­ØµÙŠÙ„","Ø§Ù„Ø´Ø­Ù†","Ø§Ù„Ø­Ø§Ù„Ø©"];
  const aoa=[];
  aoa.push(["ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… â€” White Clothes"]);
  aoa.push([`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now}`]);
  aoa.push([""]);
  aoa.push(["Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:",exp.length,"","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø´Ø­Ù†):",sub+shp,"","Ù…Ù„Ø§Ø­Ø¸Ø©:","Ù…Ø·Ø¨ÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­",""]);
  aoa.push(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„:",sub,"","Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:","___________","","Ø§Ù„ØªØ§Ø±ÙŠØ®:",now,""]);
  aoa.push(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†:",shp,"","Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:","___________","","",""]);
  aoa.push([""]);
  const hRow=aoa.length;
  aoa.push(header);
  exp.forEach(r=>aoa.push([String(r.orderId??""),String(r.name??""),String(r.phone??""),String(r.altPhone??""),String(r.city??""),String(r.address??""),Number(r.subtotal||0),Number(r.shipping||0),String(r.status??"")] ));
  const wb=XLSX.utils.book_new();
  wb.Workbook={Views:[{RTL:true}]};
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  ws["!rows"]=[{hpt:36},{hpt:22}];
  ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:8}},{s:{r:1,c:0},e:{r:1,c:8}}];
  ws["!cols"]=[{wch:12},{wch:20},{wch:14},{wch:14},{wch:12},{wch:55},{wch:16},{wch:10},{wch:14}];
  ws["!freeze"]={xSplit:0,ySplit:hRow+1};
  ws["!pageSetup"]={orientation:"landscape",fitToWidth:1,fitToHeight:0};
  const bdr=(s="thin")=>{ const b={style:s,color:{rgb:"000000"}}; return{top:b,bottom:b,left:b,right:b}; };
  const range=XLSX.utils.decode_range(ws["!ref"]);
  for(let R=range.s.r;R<=range.e.r;R++){
    for(let C=range.s.c;C<=range.e.c;C++){
      const a=XLSX.utils.encode_cell({r:R,c:C});
      if(!ws[a]) continue;
      ws[a].s={alignment:{wrapText:true,vertical:"top",horizontal:"right"}};
      if(R===0){ ws[a].s.font={bold:true,sz:16}; ws[a].s.alignment.horizontal="center"; ws[a].s.alignment.vertical="center"; }
      if(R===1){ ws[a].s.font={bold:true,sz:11}; }
      if(R>=3&&R<=5){ ws[a].s.border=bdr(); }
      if(R===hRow){ ws[a].s.font={bold:true}; ws[a].s.fill={patternType:"solid",fgColor:{rgb:"EFEFEF"}}; ws[a].s.border=bdr("medium"); }
      if(R>hRow){ ws[a].s.border=bdr(); }
      if(R>=hRow&&R<=range.e.r){
        if(R===hRow) ws[a].s.border.top={style:"medium",color:{rgb:"000000"}};
        if(R===range.e.r) ws[a].s.border.bottom={style:"medium",color:{rgb:"000000"}};
        if(C===0) ws[a].s.border.right={style:"medium",color:{rgb:"000000"}};
        if(C===8) ws[a].s.border.left={style:"medium",color:{rgb:"000000"}};
      }
    }
  }
  XLSX.utils.book_append_sheet(wb,ws,"Delivery Sheet");
  XLSX.writeFile(wb,`wc-${new Date().toISOString().slice(0,10)}.xlsx`);
  toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Excel","","ok");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT MENU (ÙÙˆØ§ØªÙŠØ± Ø²Ø±Ø§Ø±)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let printMenuOpen = false;
let pendingCache  = { newOrders:[], pending:[] };

function togglePrintMenu(e){
  e.stopPropagation();
  const menu=document.getElementById("printMenu");
  const btn=document.getElementById("printPendingBtn");
  if(printMenuOpen){ closePrintMenu(); return; }
  const rect=btn.getBoundingClientRect();
  menu.style.top  = (rect.bottom+6+window.scrollY)+"px";
  menu.style.left = rect.left+"px";
  menu.classList.add("open");
  printMenuOpen=true;
}

function closePrintMenu(){
  document.getElementById("printMenu").classList.remove("open");
  printMenuOpen=false;
}

document.addEventListener("click", ()=>closePrintMenu());

async function refreshPendingCount(){
  try{
    const res=await api("scanList");
    if(!res?.ok) return;
    const all=res.rows||[];
    pendingCache.newOrders = all.filter(r=>{ const s=String(r.status||"").trim(); return s===""||s.toLowerCase()==="new"||s==="Ø¬Ø¯ÙŠØ¯"; });
    pendingCache.pending   = all.filter(r=>String(r.status||"").trim()==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
    const total=pendingCache.newOrders.length+pendingCache.pending.length;
    document.getElementById("pmNewCount").textContent  = pendingCache.newOrders.length;
    document.getElementById("pmPendingCount").textContent = pendingCache.pending.length;
    document.getElementById("pmBothCount").textContent = total;
    document.getElementById("pendingTotal").textContent = total;
    const btn=document.getElementById("printPendingBtn");
    if(total>0) btn.classList.add("pending-active");
    else btn.classList.remove("pending-active");
  }catch(e){}
}

async function doPrintBatch(which){
  closePrintMenu();
  let ids=[];
  if(which==="new")     ids=pendingCache.newOrders.map(r=>r.orderId).filter(Boolean);
  if(which==="pending") ids=pendingCache.pending.map(r=>r.orderId).filter(Boolean);
  if(which==="both")    ids=[...pendingCache.newOrders,...pendingCache.pending].map(r=>r.orderId).filter(Boolean);

  if(!ids.length){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©","","warn"); return; }

  const btn=document.getElementById("printPendingBtn");
  btn.disabled=true;
  showLoading(`Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² ${ids.length} ÙØ§ØªÙˆØ±Ø©â€¦`);

  try{
    const url=WEB_APP_PRINT_URL+"?action=printBatch&ids="+encodeURIComponent(ids.join(","))+"&v="+Date.now();
    const w=window.open(url,"_blank");
    hideLoading();
    if(!w){ toast("Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°","Ø§Ø³Ù…Ø­ Ø¨Ù€ Pop-up ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©","err"); return; }
    toast(`Ø¬Ø§Ø±ÙŠ Ø·Ø¨Ø§Ø¹Ø© ${ids.length} ÙØ§ØªÙˆØ±Ø©â€¦`,"","ok",3500);
    setTimeout(refreshPendingCount, 5000);
  }catch(e){
    hideLoading();
    toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©","","err");
  }finally{
    btn.disabled=false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH INDEX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadAllForIndex(){
  const el=document.getElementById("indexStats");
  el.textContent="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦";
  try{
    const res=await api("scanList");
    if(!res?.ok){ el.textContent="âŒ ÙØ´Ù„"; return; }
    allCache=res.rows||[];
    el.textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`;
  }catch(e){ el.textContent="âŒ Ø®Ø·Ø£"; }
}

function searchIndex(){
  const q=norm(document.getElementById("idx_q").value);
  if(!q){ closeSearch(); return; }
  if(!allCache.length){ toast("Ø§Ù„Ø¯Ø§ØªØ§ Ù„Ø³Ù‡ Ø¨ØªØªØ­Ù…Ù‘Ù„","","warn"); return; }
  const digits=q.replace(/\D/g,""), isD=digits.length>=4;
  lastResults=allCache.filter(r=>{
    const h=norm([r.orderId,r.name,r.phone,r.altPhone,r.city,r.address,r.status].join("|"));
    if(isD) return String(r.orderId??"").includes(digits)||String(r.phone??"").includes(digits)||String(r.altPhone??"").includes(digits)||h.includes(q);
    return h.includes(q);
  });
  srSelected.clear();
  renderSearchResults();
  document.getElementById("searchCard")?.scrollIntoView({behavior:"smooth",block:"start"});
}

function renderSearchResults(){
  const card=document.getElementById("searchCard");
  const tbody=document.getElementById("srTbody");
  const cnt=document.getElementById("srCount");
  if(!lastResults?.length){ card.style.display="none"; tbody.innerHTML=""; return; }
  card.style.display="block";
  cnt.textContent=lastResults.length+" Ù†ØªÙŠØ¬Ø©";
  tbody.innerHTML="";
  lastResults.forEach(r=>{
    const id=String(r.orderId??""), tr=document.createElement("tr");
    const p1=esc((r.phone||"").trim()), p2=esc((r.altPhone||"").trim());
    const phones=p2?`${p1} â€” ${p2}`:p1;
    tr.innerHTML=`
      <td style="text-align:center"><input type="checkbox" ${srSelected.has(id)?"checked":""}></td>
      <td class="td-id"><b>${esc(id)}</b></td>
      <td class="td-name">${esc(r.name||"")}</td>
      <td class="td-addr"><span class="td-phone">${phones}</span><br><span style="font-size:10px;color:var(--mist)">${esc(r.city||"")}${r.address?" / "+esc(r.address):""}</span></td>
      <td class="td-amount">${fmt(r.subtotal)}</td>
      <td class="mono" style="font-size:11px">${fmt(r.shipping)}</td>
      <td>${statusBadge(r.status)}</td>
    `;
    tr.querySelector("input").addEventListener("change",e=>{ e.target.checked?srSelected.add(id):srSelected.delete(id); });
    tbody.appendChild(tr);
  });
}

function srToggleAll(){
  if(!lastResults?.length) return;
  const allIds=lastResults.map(r=>String(r.orderId));
  const allSel=allIds.every(id=>srSelected.has(id));
  if(allSel) srSelected.clear(); else allIds.forEach(id=>srSelected.add(id));
  renderSearchResults();
}

function closeSearch(){
  lastResults=[]; srSelected.clear();
  document.getElementById("searchCard").style.display="none";
  document.getElementById("srTbody").innerHTML="";
  document.getElementById("idx_q").value="";
  document.getElementById("indexStats").textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`;
}

async function srAddToMine(){
  const ids=[...srSelected];
  if(!ids.length){ toast("Ø­Ø¯Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  let added=0;
  ids.forEach(id=>{ if(!mineIds.has(String(id))){ mineIds.add(String(id)); added++; } });
  saveMine();
  toast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${added} Ø£ÙˆØ±Ø¯Ø±`,"","ok");
  closeSearch();
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦");
  await refreshMine();
  hideLoading();
}

document.getElementById("idx_q").addEventListener("input",()=>{
  const q=document.getElementById("idx_q").value.trim().toLowerCase();
  const el=document.getElementById("indexStats");
  if(!q){ el.textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`; return; }
  const cnt=allCache.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))).length;
  el.textContent=`ğŸ” ${cnt.toLocaleString("ar-EG")} Ù…ØªÙˆÙ‚Ø¹`;
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHIP MONITOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseShipDate(r){
  const raw=String(r.shipDate??r.ship_date??r.shippedDate??r.shipped_date??r.shipDateText??"").trim();
  if(!raw) return null;
  const m=raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m){ const dt=new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`); return isNaN(dt.getTime())?null:dt; }
  const dt=new Date(raw); return isNaN(dt.getTime())?null:dt;
}
function daysSince(dt){ if(!dt) return null; return Math.floor((Date.now()-dt.getTime())/86400000); }

function setShipBtn({ total=0, follow=0, overdue=0 }){
  const btn=document.getElementById("shipBtn");
  const dot=document.getElementById("shipDot");
  document.getElementById("shipCountBadge").textContent=total;
  btn.className="tb-btn "+(overdue>0?"ship-overdue":follow>0?"ship-follow":"ship-normal");
  if(overdue>0){ dot.textContent=overdue; dot.style.display="inline-flex"; }
  else { dot.style.display="none"; }
}

async function refreshShipMonitor(){
  try{
    const res=await api("scanList");
    if(!res?.ok) return;
    const all=res.rows||[];
    shipAll=all.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†");
    let ov=0,fw=0,nm=0;
    shipAll.forEach(r=>{ const d=daysSince(parseShipDate(r)); if(d===null){nm++;return;} if(d>=OVERDUE_MIN)ov++; else if(d>=FOLLOW_MIN)fw++; else nm++; });

    // Smart overdue alert
    const ovIds=shipAll.filter(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=OVERDUE_MIN;}).map(r=>String(r.orderId));
    const lastIds=getOldOverdueIds();
    const newOv=ovIds.filter(id=>!lastIds.includes(id));
    if(newOv.length){
      const names=new Set(shipAll.filter(r=>newOv.includes(String(r.orderId))).map(r=>String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")));
      toast("Ù…ØªØ£Ø®Ø± Ø¬Ø¯ÙŠØ¯ ğŸš¨",[...names].join(" ØŒ "),"err",5000);
      document.body.classList.add("shake");
      setTimeout(()=>document.body.classList.remove("shake"),600);
    }
    setOldOverdueIds(ovIds);

    courierStats={};
    shipAll.forEach(r=>{
      const nm2=String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      const d=daysSince(parseShipDate(r));
      if(!courierStats[nm2]) courierStats[nm2]={total:0,overdue:0};
      courierStats[nm2].total++;
      if(d!==null&&d>=OVERDUE_MIN) courierStats[nm2].overdue++;
    });

    setShipBtn({total:shipAll.length,follow:fw,overdue:ov});
    document.getElementById("bNormal").textContent=nm;
    document.getElementById("bFollow").textContent=fw;
    document.getElementById("bOverdue").textContent=ov;

    buildCourierFilter(shipAll);
    renderCourierBadges();
    const card=document.getElementById("shipCard");
    if(card?.style.display!=="none") renderShipTable();
  }catch(e){}
}

function toggleShipCard(){
  const card=document.getElementById("shipCard");
  if(!card) return;
  if(card.style.display!=="none"){ card.style.display="none"; return; }
  card.style.display="block";
  const hasOv=shipAll.some(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=OVERDUE_MIN;});
  const hasFw=shipAll.some(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=FOLLOW_MIN&&d<=FOLLOW_MAX;});
  shipTab=hasOv?"overdue":hasFw?"follow":"normal";
  setShipTab(shipTab);
  card.scrollIntoView({behavior:"smooth",block:"start"});
}

function setShipTab(tab){
  shipTab=tab;
  ["normal","follow","overdue"].forEach(t=>{
    const btn=document.getElementById("tab"+t.charAt(0).toUpperCase()+t.slice(1));
    if(btn) btn.className="ship-tab"+(t===tab?" tab-"+t:"");
  });
  renderShipTable();
}

function renderShipTable(){
  const tbody=document.getElementById("shipTbody"); if(!tbody) return;
  tbody.innerHTML="";
  const cf=(document.getElementById("shipCourierFilter")?.value||"").trim();
  let list=shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}));
  list=list.filter(x=>{ if(x.days===null) return shipTab==="normal"; if(shipTab==="overdue") return x.days>=OVERDUE_MIN; if(shipTab==="follow") return x.days>=FOLLOW_MIN&&x.days<=FOLLOW_MAX; return x.days<FOLLOW_MIN; });
  if(cf) list=list.filter(x=>(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list.sort((a,b)=>{ const da=a.days??-1,db=b.days??-1; return shipTab==="normal"?da-db:db-da; });
  if(!list.length){ tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</div></div></td></tr>`; return; }
  list.forEach(x=>{
    const r=x.r; const isOv=x.days!==null&&x.days>=OVERDUE_MIN; const isWrn=!isOv&&x.days!==null&&x.days>=FOLLOW_MIN;
    const dc=isOv?"danger":isWrn?"":"safe";
    const p1=esc((r.phone||"").trim()), p2=esc((r.altPhone||"").trim());
    const phones=p2?`${p1} â€” ${p2}`:p1;
    const tr=document.createElement("tr");
    if(isOv) tr.style.background="rgba(192,57,43,.04)";
    tr.innerHTML=`
      <td class="td-id"><b>${esc(r.orderId)}</b></td>
      <td class="td-name">${esc(r.name||"")}</td>
      <td class="td-addr"><span class="td-phone">${phones}</span><br><span style="font-size:10px;color:var(--mist)">${esc(r.city||"")}${r.address?" / "+esc(r.address):""}</span></td>
      <td>${courierChip(r.courier)}</td>
      <td class="mono" style="font-size:11px;color:var(--silver)">${x.dt?fmtYMD(x.dt):"â€”"}</td>
      <td><span class="days-chip ${dc}">${x.days??"â€”"} ÙŠÙˆÙ…</span></td>
      <td>${statusBadge(r.status)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function buildCourierFilter(list){
  const sel=document.getElementById("shipCourierFilter"); if(!sel) return;
  const prev=(sel.value||"").trim();
  const arr=[...new Set(list.map(r=>String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"))].sort((a,b)=>a.localeCompare(b,"ar"));
  sel.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>`+arr.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");
  if(prev&&arr.includes(prev)) sel.value=prev; else sel.value="";
}

function renderCourierBadges(){
  const wrap=document.getElementById("courierBadges"); if(!wrap) return;
  const cur=(document.getElementById("shipCourierFilter")?.value||"").trim();
  const names=Object.keys(courierStats).sort((a,b)=>a.localeCompare(b,"ar"));
  let html=`<button class="c-badge${cur===""?" active":""}" onclick="setCourierFilter('')">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† <span class="c-n">${names.reduce((s,n2)=>s+(courierStats[n2]?.total||0),0)}</span></button>`;
  names.forEach(nm=>{
    const st=courierStats[nm]||{total:0,overdue:0};
    const cls=["c-badge",st.overdue>0?"overdue-c":"",cur===nm?"active":""].filter(Boolean).join(" ");
    html+=`<button class="${cls}" onclick='setCourierFilter(${JSON.stringify(nm)})'>${esc(nm)} <span class="c-n">${st.total}</span></button>`;
  });
  wrap.innerHTML=html;
}

function setCourierFilter(name){
  const sel=document.getElementById("shipCourierFilter");
  if(sel) sel.value=(name||"").trim();
  renderCourierBadges(); renderShipTable();
}

function printShipCurrent(){
  const cf=(document.getElementById("shipCourierFilter")?.value||"").trim();
  let list=shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}));
  if(cf) list=list.filter(x=>(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list=list.filter(x=>{ if(x.days===null) return shipTab==="normal"; if(shipTab==="overdue") return x.days>=OVERDUE_MIN; if(shipTab==="follow") return x.days>=FOLLOW_MIN&&x.days<=FOLLOW_MAX; return x.days<FOLLOW_MIN; });
  list.sort((a,b)=>{ const da=a.days??-1,db=b.days??-1; return shipTab==="normal"?da-db:db-da; });
  if(!list.length){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª","","warn"); return; }

  const rowsHtml=list.map(x=>{
    const r=x.r; const isOv=x.days!==null&&x.days>=OVERDUE_MIN;
    const p1=(r.phone||"").trim(), p2=(r.altPhone||"").trim();
    return `<tr style="${isOv?"background:#fff8f8":""}">
      <td><b>${esc(r.orderId??"")}</b></td>
      <td>${esc(r.name||"")}</td>
      <td>${p2?esc(p1)+" - "+esc(p2):esc(p1)} / ${esc(r.city||"")} / ${esc(r.address||"")}</td>
      <td>${esc(String(r.courier||""))}</td>
      <td>${x.dt?fmtYMD(x.dt):"â€”"}</td>
      <td style="${isOv?"color:#c0392b;font-weight:800":""}">${x.days??"â€”"} ÙŠÙˆÙ…</td>
      <td>${esc(r.status||"")}</td>
    </tr>`;
  }).join("");

  const now=new Date().toLocaleString("ar-EG");
  const tabLabel={overdue:"Ù…ØªØ£Ø®Ø±",follow:"Ù…ØªØ§Ø¨Ø¹Ø©",normal:"Ø·Ø¨ÙŠØ¹ÙŠ"}[shipTab]||"";
  const w=window.open("","_blank");
  if(!w){ toast("Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°","","err"); return; }
  w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8">
<title>Ø´Ø­Ù†Ø§Øª â€” ${tabLabel}</title>
<style>
body{font-family:Cairo,Arial,sans-serif;margin:0;padding:12px;background:#fff;color:#000}
h1{font-size:15px;margin:0 0 6px}
.meta{font-size:11px;color:#555;margin-bottom:10px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:7px 10px;font-size:11px;text-align:right;vertical-align:top}
th{background:#f5f5f5;font-weight:700}
@media print{body{padding:0}tr,td,th{page-break-inside:avoid}tbody tr{break-inside:avoid}}
</style></head>
<body onload="window.print()">
<h1>ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª â€” ${esc(tabLabel)}</h1>
<div class="meta">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${esc(now)} Â· Ø§Ù„ÙÙ„ØªØ±: ${cf?"Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+esc(cf):"ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†"} Â· Ø¹Ø¯Ø¯: <b>${list.length}</b></div>
<table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ/Ù…Ø­Ø§ÙØ¸Ø©/Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
<tbody>${rowsHtml}</tbody></table></body></html>`);
  w.document.close();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById("orderIdInput").addEventListener("keydown", e=>{ if(e.key==="Enter") addOne(); });
document.getElementById("idx_q").addEventListener("keydown", e=>{ if(e.key==="Enter") searchIndex(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadMine();
render();
showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦");
Promise.all([refreshMine(), loadAllForIndex(), refreshShipMonitor(), refreshPendingCount()])
  .finally(hideLoading);

setInterval(refreshShipMonitor, 60000);
setInterval(refreshPendingCount, 90000);
</script>
</body>
</html>
