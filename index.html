<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>WC â€” Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Cairo:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
:root {
  --ink:      #0a0a0a;
  --ink2:     #141414;
  --ink3:     #1e1e1e;
  --ink4:     #2a2a2a;
  --rule:     #2e2e2e;
  --rule2:    #3a3a3a;
  --mist:     #888;
  --silver:   #aaa;
  --pearl:    #ccc;
  --ivory:    #e8e4dc;
  --white:    #f5f2ed;
  --gold:     #c9a84c;
  --gold2:    #b8941e;
  --gold-faint: rgba(201,168,76,.12);
  --gold-glow:  rgba(201,168,76,.25);
  --red:      #c0392b;
  --red-faint: rgba(192,57,43,.12);
  --green:    #27ae60;
  --green-faint: rgba(39,174,96,.10);
  --amber:    #d4961a;
  --amber-faint: rgba(212,150,26,.12);
  --blue:     #3498db;
  --blue-faint: rgba(52,152,219,.10);
  --r1: 4px; --r2: 8px; --r3: 16px; --r4: 999px;
  --sh1: 0 2px 16px rgba(0,0,0,.40);
  --sh2: 0 8px 40px rgba(0,0,0,.55);
  --sh3: 0 20px 80px rgba(0,0,0,.70);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { height: 100%; }

body {
  font-family: 'Cairo', sans-serif;
  background: var(--ink);
  color: var(--ivory);
  min-height: 100vh;
  padding: 12px;
  overflow-x: hidden;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
}

.display { font-family: 'Cormorant Garamond', serif; letter-spacing: .5px; }
.mono    { font-family: 'JetBrains Mono', monospace; }

/* â•â• DASHBOARD â•â• */
.dash-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
  margin-bottom: 4px;
}
.dash-tile {
  background: var(--ink2);
  border: 1px solid var(--rule);
  border-radius: var(--r3);
  padding: 14px 16px;
  position: relative;
  overflow: hidden;
  cursor: default;
  transition: border-color .2s, transform .15s;
}
.dash-tile:hover { border-color: var(--rule2); transform: translateY(-1px); }
.dash-tile::after {
  content: "";
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 2px;
  border-radius: 0 0 var(--r3) var(--r3);
}
.dt-gold::after  { background: linear-gradient(90deg, var(--gold2), var(--gold)); }
.dt-green::after { background: linear-gradient(90deg, #1e8449, var(--green)); }
.dt-red::after   { background: linear-gradient(90deg, #922b21, var(--red)); }
.dt-amber::after { background: linear-gradient(90deg, #b7770d, var(--amber)); }
.dt-blue::after  { background: linear-gradient(90deg, #1a5276, var(--blue)); }
.dt-pearl::after { background: linear-gradient(90deg, #666, var(--pearl)); }

.dt-icon { font-size: 20px; margin-bottom: 6px; }
.dt-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 22px; font-weight: 600; color: var(--white);
  line-height: 1; margin-bottom: 4px;
}
.dt-val.dt-gold  { color: var(--gold); }
.dt-val.dt-green { color: var(--green); }
.dt-val.dt-red   { color: #e74c3c; }
.dt-val.dt-amber { color: var(--amber); }
.dt-val.dt-blue  { color: var(--blue); }
.dt-lbl { font-size: 10px; color: var(--mist); text-transform: uppercase; letter-spacing: 1.5px; }
.dt-sub { font-size: 10px; color: var(--mist); margin-top: 3px; }

/* â•â• TOPBAR â•â• */
.topbar {
  position: sticky; top: 8px; z-index: 200;
  background: rgba(10,10,10,.95);
  backdrop-filter: blur(20px) saturate(1.4);
  border: 1px solid var(--rule2);
  border-radius: var(--r3);
  padding: 10px 14px;
  box-shadow: var(--sh2);
  /* FIX: overflow visible so print menu not clipped */
  overflow: visible;
}
.topbar::before {
  content: "";
  position: absolute; top: 0; left: 20%; right: 20%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  opacity: .7; border-radius: var(--r3);
}
/* FIX: Two-row topbar - row1: brand+metrics, row2: action buttons centered */
.topbar-row { display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; margin-bottom: 8px; }
.topbar-btn-row { display: flex; align-items: center; gap: 6px; justify-content: center; flex-wrap: wrap; }

/* Bell button */
.bell-btn { position: relative; font-size: 16px; padding: 7px 11px; }
.bell-dot {
  position: absolute; top: -4px; right: -4px; width: 10px; height: 10px;
  border-radius: 50%; background: var(--red); border: 2px solid var(--ink);
  display: none;
}
.bell-dot.active { display: block; animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.3)} }

/* Notification drawer */
#notifDrawer {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  z-index: 9200; pointer-events: none;
}
#notifDrawer.open { pointer-events: all; }
.nd-backdrop {
  position: absolute; inset: 0; background: rgba(0,0,0,.5);
  opacity: 0; transition: opacity .2s;
}
#notifDrawer.open .nd-backdrop { opacity: 1; }
.nd-panel {
  position: absolute; top: 72px; left: 50%; transform: translateX(-50%) translateY(-10px);
  width: min(420px, 92vw); background: var(--ink2);
  border: 1px solid var(--rule2); border-radius: var(--r3);
  box-shadow: var(--sh3); overflow: hidden;
  max-height: 60vh; display: flex; flex-direction: column;
  opacity: 0; transition: all .25s cubic-bezier(.34,1.2,.64,1);
}
#notifDrawer.open .nd-panel { opacity: 1; transform: translateX(-50%) translateY(0); }
.nd-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--rule); flex-shrink:0; }
.nd-title { font-family:'Cormorant Garamond',serif; font-size:15px; color:var(--pearl); font-weight:600; }
.nd-clear { font-size:10px; color:var(--mist); background:none; border:none; cursor:pointer; min-height:unset; padding:3px 8px; border-radius:var(--r1); }
.nd-clear:hover { color:var(--silver); background:rgba(255,255,255,.05); }
.nd-list { overflow-y: auto; flex:1; }
.nd-item { display:flex; align-items:flex-start; gap:10px; padding:11px 16px; border-bottom:1px solid var(--rule); }
.nd-item:last-child { border-bottom:none; }
.nd-icon { font-size:18px; flex-shrink:0; margin-top:1px; }
.nd-body { flex:1; min-width:0; }
.nd-txt { font-size:12px; color:var(--ivory); font-weight:600; }
.nd-sub { font-size:10px; color:var(--mist); margin-top:2px; }
.nd-empty { padding:28px; text-align:center; color:var(--mist); font-size:12px; }

.brand { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.brand-logo {
  width: 38px; height: 38px; border-radius: 50%;
  border: 1px solid var(--rule2); background: var(--ink2);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0;
}
.brand-logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.brand-logo-fallback {
  font-family: 'Cormorant Garamond', serif;
  font-size: 16px; font-weight: 700; color: var(--ivory); letter-spacing: -1px;
}
.brand-text { line-height: 1.1; }
.brand-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 16px; font-weight: 600; color: var(--white);
  letter-spacing: 2px; text-transform: uppercase;
}
.brand-tagline { font-size: 9px; color: var(--mist); letter-spacing: 2.5px; text-transform: uppercase; margin-top: 1px; }

.vr { width: 1px; height: 28px; background: var(--rule); flex-shrink: 0; }

.metric {
  display: inline-flex; flex-direction: column; align-items: center; gap: 1px;
  padding: 6px 12px; border-radius: var(--r2);
  border: 1px solid var(--rule); background: rgba(255,255,255,.03);
  cursor: default; transition: border-color .2s; white-space: nowrap;
}
.metric:hover { border-color: var(--rule2); }
.metric-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; color: var(--white); line-height: 1; }
.metric-lbl { font-size: 9px; color: var(--mist); text-transform: uppercase; letter-spacing: 1.5px; }

.topbar-actions { margin-inline-start: auto; display: flex; align-items: center; gap: 6px; flex-wrap: nowrap; }

.tb-btn {
  font-family: 'Cairo', sans-serif; font-size: 11px; font-weight: 700;
  color: var(--silver); background: rgba(255,255,255,.05);
  border: 1px solid var(--rule); border-radius: var(--r2);
  padding: 8px 14px; cursor: pointer; transition: all .18s;
  display: inline-flex; align-items: center; gap: 6px;
  white-space: nowrap; position: relative; letter-spacing: .5px;
}
.tb-btn:hover { background: rgba(255,255,255,.08); border-color: var(--rule2); color: var(--white); }
.tb-btn:active { transform: scale(.97); }

.tb-btn.pending-active { color: var(--gold); border-color: rgba(201,168,76,.35); background: var(--gold-faint); }
@keyframes goldPulse { 0%,100% { box-shadow: 0 0 0 rgba(201,168,76,0); } 50% { box-shadow: 0 0 20px var(--gold-glow); } }
.tb-btn.pending-active { animation: goldPulse 2.5s ease-in-out infinite; }

.tb-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700;
  padding: 1px 7px; border-radius: var(--r4);
  background: rgba(201,168,76,.2); border: 1px solid rgba(201,168,76,.3); color: var(--gold);
}

.tb-btn.ship-follow { color: var(--amber); border-color: rgba(212,150,26,.35); background: var(--amber-faint); }
.tb-btn.ship-overdue { color: #e74c3c; border-color: rgba(192,57,43,.35); background: var(--red-faint); }
@keyframes redPulse { 0%,100% { box-shadow: 0 0 0 rgba(192,57,43,0); } 50% { box-shadow: 0 0 22px rgba(192,57,43,.3); } }
.tb-btn.ship-overdue { animation: redPulse 2.2s ease-in-out infinite; }

.ship-dot {
  position: absolute; top: -5px; left: -5px;
  min-width: 17px; height: 17px; padding: 0 5px;
  border-radius: var(--r4); background: var(--red); color: #fff;
  font-size: 9px; font-weight: 800; display: none;
  align-items: center; justify-content: center;
  border: 2px solid var(--ink); font-family: 'JetBrains Mono', monospace;
}

.clock { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--mist); letter-spacing: 1px; }

/* â•â• CARDS â•â• */
.wrap { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }

.card {
  background: var(--ink2); border: 1px solid var(--rule);
  border-radius: var(--r3); padding: 16px; box-shadow: var(--sh1);
  animation: fadeUp .3s ease;
}
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
.card-title { font-family: 'Cormorant Garamond', serif; font-size: 15px; font-weight: 600; color: var(--pearl); letter-spacing: .5px; }
.card-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  padding: 2px 8px; border-radius: var(--r4);
  border: 1px solid var(--rule); color: var(--silver);
  background: rgba(255,255,255,.04); margin-inline-start: auto;
}
.section-rule { height: 1px; background: var(--rule); margin: 12px 0; }

/* â•â• CONTROLS â•â• */
.ctrl-grid { display: grid; grid-template-columns: 1.8fr 1fr 1fr; gap: 16px; }
@media (max-width: 820px) { .ctrl-grid { grid-template-columns: 1fr; } }
.ctrl-group { display: flex; flex-direction: column; gap: 8px; }
.ctrl-label {
  font-size: 9px; color: var(--mist); text-transform: uppercase;
  letter-spacing: 2px; border-bottom: 1px solid var(--rule);
  padding-bottom: 6px; margin-bottom: 2px;
}

/* â•â• INPUTS â•â• */
input, select {
  font-family: 'Cairo', sans-serif; font-size: 13px; color: var(--ivory);
  background: var(--ink3); border: 1px solid var(--rule);
  border-radius: var(--r2); padding: 9px 13px;
  outline: none; width: 100%; min-height: 38px;
  transition: border-color .18s, box-shadow .18s;
}
input::placeholder { color: var(--mist); }
input:focus, select:focus { border-color: var(--gold); box-shadow: 0 0 0 3px var(--gold-faint); }
select option { background: var(--ink2); }
.input-row { display: flex; gap: 8px; align-items: center; }
.flex1 { flex: 1; min-width: 0; }

/* â•â• BUTTONS â•â• */
button {
  font-family: 'Cairo', sans-serif; font-size: 12px; font-weight: 700;
  color: var(--ivory); background: rgba(255,255,255,.06);
  border: 1px solid var(--rule); border-radius: var(--r2);
  padding: 9px 16px; cursor: pointer; transition: all .18s;
  display: inline-flex; align-items: center; justify-content: center;
  gap: 6px; white-space: nowrap; min-height: 38px; letter-spacing: .3px;
}
button:hover { background: rgba(255,255,255,.10); border-color: var(--rule2); }
button:active { transform: scale(.97); }
button:disabled { opacity: .4; cursor: not-allowed; transform: none !important; }

.btn-gold {
  background: linear-gradient(145deg, var(--gold), var(--gold2));
  border-color: rgba(201,168,76,.4); color: #0a0a0a;
  font-weight: 900; box-shadow: 0 4px 18px var(--gold-faint);
}
.btn-gold:hover { box-shadow: 0 6px 28px var(--gold-glow); transform: translateY(-1px); }
.btn-danger { background: rgba(192,57,43,.15); border-color: rgba(192,57,43,.35); color: #e74c3c; }
.btn-danger:hover { background: rgba(192,57,43,.22); }
.btn-ghost { background: transparent; border-color: var(--rule); font-size: 11px; padding: 6px 12px; min-height: 32px; }
.btn-w100 { width: 100%; }

/* â•â• LOADING OVERLAY â•â• */
#loadingOverlay {
  position: fixed; inset: 0; background: rgba(10,10,10,.75);
  backdrop-filter: blur(6px); z-index: 9000;
  display: none; align-items: center; justify-content: center;
  flex-direction: column; gap: 16px;
}
#loadingOverlay.active { display: flex; }
.spinner { width: 44px; height: 44px; border-radius: 50%; border: 2px solid var(--rule2); border-top-color: var(--gold); animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-txt { font-family: 'Cormorant Garamond', serif; font-size: 16px; color: var(--pearl); letter-spacing: 2px; }

/* â•â• TOAST â•â• */
#statusToast {
  position: fixed; bottom: 20px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  opacity: 0; transition: all .3s cubic-bezier(.34,1.56,.64,1);
  z-index: 8000; pointer-events: none; min-width: 280px; max-width: 90vw;
}
#statusToast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.toast-box {
  background: var(--ink2); border: 1px solid var(--rule2);
  border-radius: var(--r3); padding: 14px 18px; box-shadow: var(--sh3);
  display: flex; align-items: center; gap: 12px;
  position: relative; overflow: hidden;
}
.toast-icon { font-size: 20px; flex-shrink: 0; }
.toast-body { flex: 1; min-width: 0; }
.toast-title { font-size: 13px; font-weight: 700; color: var(--white); }
.toast-sub   { font-size: 11px; color: var(--silver); margin-top: 2px; }
.toast-progress {
  position: absolute; bottom: 0; left: 0; height: 2px;
  border-radius: 0 0 var(--r3) var(--r3); background: var(--gold);
  width: 100%; transform-origin: left;
  animation: progressShrink 2.8s linear forwards;
}
@keyframes progressShrink { from { transform: scaleX(1); } to { transform: scaleX(0); } }
.toast-box.t-ok   .toast-progress { background: var(--green); }
.toast-box.t-warn .toast-progress { background: var(--amber); }
.toast-box.t-err  .toast-progress { background: var(--red); }
.toast-box.t-ok   { border-color: rgba(39,174,96,.3); }
.toast-box.t-warn { border-color: rgba(212,150,26,.3); }
.toast-box.t-err  { border-color: rgba(192,57,43,.3); }

/* â•â• PRINT MENU â•â• */
#printMenu {
  position: fixed; z-index: 9100; display: none;
  /* FIX: centered on screen by default */
  left: 50%; transform: translateX(-50%);
  min-width: min(300px, 92vw);
}
#printMenu.open { display: block; animation: menuIn .18s ease; }
@keyframes menuIn { from { opacity: 0; transform: translateX(-50%) translateY(-6px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
.print-menu-box { background: var(--ink2); border: 1px solid var(--rule2); border-radius: var(--r3); box-shadow: var(--sh3); overflow: hidden; padding: 6px; }
.pm-header { padding: 10px 12px 8px; border-bottom: 1px solid var(--rule); margin-bottom: 6px; }
.pm-title { font-family: 'Cormorant Garamond', serif; font-size: 14px; color: var(--pearl); letter-spacing: .5px; }
.pm-sub { font-size: 10px; color: var(--mist); margin-top: 2px; }
.pm-item {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px;
  border-radius: var(--r2); cursor: pointer; transition: background .15s;
  border: none; background: transparent; width: 100%; text-align: right;
  color: var(--ivory); font-family: 'Cairo', sans-serif;
  font-size: 12px; font-weight: 600; min-height: unset;
}
.pm-item:hover { background: rgba(255,255,255,.06); }
.pm-count {
  font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 700;
  padding: 2px 8px; border-radius: var(--r4);
  border: 1px solid var(--rule); background: rgba(255,255,255,.05);
  color: var(--silver); margin-inline-start: auto;
}
.pm-count.gold { border-color: rgba(201,168,76,.35); background: var(--gold-faint); color: var(--gold); }

/* â•â• TABLE â•â• */
.tbl-wrap { width: 100%; overflow-x: auto; border-radius: var(--r2); border: 1px solid var(--rule); }
table { width: 100%; border-collapse: collapse; min-width: 820px; }
thead { position: sticky; top: 0; z-index: 10; }
thead th {
  background: var(--ink3); border-bottom: 1px solid var(--rule2);
  padding: 9px 14px; text-align: right; font-size: 9px; color: var(--mist);
  text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; white-space: nowrap;
}
tbody tr { border-bottom: 1px solid var(--rule); transition: background .12s; break-inside: avoid; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: rgba(255,255,255,.025); }
tbody td { padding: 11px 14px; font-size: 12px; color: var(--silver); vertical-align: top; }

.td-id { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 600; color: var(--gold) !important; }
.td-name { color: var(--ivory) !important; font-weight: 600; }
.td-phone { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--pearl) !important; }
.td-addr { font-size: 11px; line-height: 1.6; }
.td-amount { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; color: var(--white) !important; }
.td-date { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--mist) !important; }

/* Phone + address inline for print */
.addr-line { display: flex; flex-wrap: wrap; gap: 4px; align-items: baseline; }
.addr-sep { color: var(--rule2); font-size: 10px; }

.badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 9px; border-radius: var(--r4); font-size: 10px; font-weight: 700; border: 1px solid; white-space: nowrap; letter-spacing: .3px; }
.badge-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.b-ok   { color: var(--green); border-color: rgba(39,174,96,.3); background: var(--green-faint); }
.b-ok .badge-dot { background: var(--green); box-shadow: 0 0 5px var(--green); }
.b-warn { color: var(--amber); border-color: rgba(212,150,26,.3); background: var(--amber-faint); }
.b-warn .badge-dot { background: var(--amber); }
.b-err  { color: var(--red); border-color: rgba(192,57,43,.3); background: var(--red-faint); }
.b-err .badge-dot { background: var(--red); }
.b-cancel { color: var(--mist); border-color: rgba(136,136,136,.2); background: rgba(136,136,136,.06); }
.b-cancel .badge-dot { background: var(--mist); }

.days-chip { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; padding: 2px 9px; border-radius: var(--r4); border: 1px solid rgba(212,150,26,.3); background: var(--amber-faint); color: var(--amber); }
.days-chip.danger { border-color: rgba(192,57,43,.3); background: var(--red-faint); color: var(--red); }
.days-chip.safe   { border-color: rgba(39,174,96,.25); background: var(--green-faint); color: var(--green); }

.courier-chip { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: var(--r4); font-size: 10px; font-weight: 600; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); }
.courier-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

input[type=checkbox] { width: 15px; height: 15px; min-height: unset; padding: 0; border-radius: 3px; background: var(--ink3); border: 1px solid var(--rule2); accent-color: var(--gold); cursor: pointer; flex-shrink: 0; }

/* â•â• QR â•â• */
#qrWrap { display: none; margin-top: 12px; animation: fadeUp .3s ease; }
.qr-shell { position: relative; max-width: 460px; border-radius: var(--r2); overflow: hidden; border: 1px solid var(--rule2); background: #000; }
#qr-reader { width: 100%; }
.qr-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; align-items: center; justify-content: center; }
.qr-frame { width: 200px; height: 200px; position: relative; }
.qr-frame::before, .qr-frame::after, .qr-br::before, .qr-br::after { content: ""; position: absolute; width: 22px; height: 22px; border-color: var(--gold); border-style: solid; }
.qr-frame::before { top:0; right:0; border-width: 2px 2px 0 0; }
.qr-frame::after  { top:0; left:0;  border-width: 2px 0 0 2px; }
.qr-br::before    { bottom:0; right:0; border-width: 0 2px 2px 0; }
.qr-br::after     { bottom:0; left:0;  border-width: 0 0 2px 2px; }
.qr-scan { position: absolute; left: 5%; right: 5%; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); box-shadow: 0 0 8px var(--gold); animation: scan 2s ease-in-out infinite alternate; }
@keyframes scan { from { top: 8%; } to { top: 92%; } }
.qr-mask { position: absolute; inset: 0; background: rgba(0,0,0,.4); mask-image: radial-gradient(ellipse 200px 200px at 50% 50%, transparent 50%, black 51%); -webkit-mask-image: radial-gradient(ellipse 200px 200px at 50% 50%, transparent 50%, black 51%); }

/* â•â• SHIP MONITOR TABS â•â• */
.ship-tabs { display: flex; gap: 4px; background: rgba(255,255,255,.03); border: 1px solid var(--rule); border-radius: var(--r2); padding: 3px; width: fit-content; }
.ship-tab { padding: 7px 14px; border-radius: var(--r1); font-size: 11px; font-weight: 700; color: var(--mist); cursor: pointer; transition: all .18s; border: 1px solid transparent; background: transparent; min-height: unset; display: flex; align-items: center; gap: 6px; letter-spacing: .3px; }
.ship-tab:hover { color: var(--silver); }
.ship-tab.tab-normal  { color: var(--green); background: var(--green-faint); border-color: rgba(39,174,96,.25); }
.ship-tab.tab-follow  { color: var(--amber); background: var(--amber-faint); border-color: rgba(212,150,26,.25); }
.ship-tab.tab-overdue { color: var(--red);   background: var(--red-faint);   border-color: rgba(192,57,43,.25); }
.tab-n { font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: var(--r4); background: rgba(255,255,255,.08); }

.c-badges { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }
.c-badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: var(--r4); border: 1px solid var(--rule); background: rgba(255,255,255,.04); cursor: pointer; font-size: 11px; font-weight: 600; color: var(--silver); transition: all .15s; min-height: unset; }
.c-badge:hover { border-color: var(--rule2); color: var(--ivory); }
.c-badge.active { border-color: var(--gold); background: var(--gold-faint); color: var(--gold); }
.c-badge.overdue-c { border-color: rgba(192,57,43,.3); background: var(--red-faint); color: #e74c3c; }
@keyframes redBadgePulse { 0%,100% { box-shadow: 0 0 0 rgba(192,57,43,0); } 50% { box-shadow: 0 0 14px rgba(192,57,43,.3); } }
.c-badge.overdue-c { animation: redBadgePulse 2s ease-in-out infinite; }
.c-n { font-family: 'JetBrains Mono', monospace; font-size: 10px; padding: 1px 6px; border-radius: var(--r4); background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); }

/* â•â• SHIP SUMMARY BAR â•â• */
.ship-summary-bar {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: 8px; margin-bottom: 10px;
  padding: 10px; background: var(--ink3);
  border-radius: var(--r2); border: 1px solid var(--rule);
}
.ssb-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.ssb-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; color: var(--white); }
.ssb-val.gold  { color: var(--gold); }
.ssb-val.green { color: var(--green); }
.ssb-val.red   { color: #e74c3c; }
.ssb-lbl { font-size: 9px; color: var(--mist); text-transform: uppercase; letter-spacing: 1.5px; text-align: center; }

/* â•â• SEARCH CARD â•â• */
#searchCard { border-color: rgba(201,168,76,.25); box-shadow: var(--sh1), 0 0 30px var(--gold-faint); }
#searchCard::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); border-radius: var(--r3) var(--r3) 0 0; }

/* â•â• EMPTY STATE â•â• */
.empty { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; gap: 8px; color: var(--mist); text-align: center; }
.empty-icon { font-size: 32px; opacity: .3; }
.empty-text { font-family: 'Cormorant Garamond', serif; font-size: 16px; }
.empty-sub  { font-size: 11px; opacity: .6; }

/* â•â• PRINT / PDF â•â• */
.print-header, .print-summary { display: none; }
@page { margin: 9mm; size: A4 landscape; }

@media print {
  *, *::before, *::after { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  html, body { background: #fff !important; color: #000 !important; margin: 0 !important; padding: 0 !important; font-family: 'Cairo', Arial, sans-serif !important; font-size: 12px !important; }
  body::before, body::after { display: none !important; }
  .no-print, .topbar, #ctrlCard, #indexCard, #searchCard, #shipCard, #awaitCard, #dashCard, button { display: none !important; }
  .wrap { max-width: none !important; gap: 0 !important; padding: 0 !important; }
  .card, #printArea { background: #fff !important; border: none !important; box-shadow: none !important; border-radius: 0 !important; padding: 0 !important; margin: 0 !important; }
  .print-header { display: block !important; margin-bottom: 14px !important; padding-bottom:10px !important; border-bottom: 2px solid #111 !important; }
  .print-title { font-size: 20px !important; font-weight: 900 !important; color: #111 !important; letter-spacing: 3px !important; text-transform: uppercase !important; }
  #printDate { font-size: 11px !important; color: #666 !important; margin-top: 3px !important; }
  .print-summary { display: grid !important; grid-template-columns: 1fr 1fr 1fr !important; gap: 8px !important; margin: 8px 0 14px !important; }
  .print-box { border: 1px solid #bbb !important; border-radius: 6px !important; padding: 12px 16px !important; font-size: 12px !important; color: #000 !important; background: #fafafa !important; line-height: 1.8 !important; }
  .print-box div { margin-bottom: 5px !important; line-height: 1.6 !important; }
  .print-box b { margin-left: 3px !important; }
  .tbl-wrap { border: 1px solid #ccc !important; overflow: visible !important; box-shadow: none !important; }
  table { width: 100% !important; min-width: 0 !important; border-collapse: collapse !important; }
  thead th { position: static !important; background: #111 !important; border: 1px solid #111 !important; color: #fff !important; font-size: 10px !important; padding: 8px 12px !important; text-transform: uppercase !important; letter-spacing: 1px !important; font-weight: 700 !important; }
  thead th:first-child, tbody td:first-child { display: none !important; }
  tbody td { border: 1px solid #ddd !important; padding: 8px 10px !important; font-size: 11px !important; color: #000 !important; background: #fff !important; }
  tbody td *, .td-id, .td-phone, .td-amount, .td-name, .td-addr, .mono, .td-date { color: #000 !important; font-family: 'Cairo', Arial, sans-serif !important; }
  .badge { border: 1px solid #bbb !important; background: #f5f5f5 !important; color: #000 !important; font-size: 10px !important; padding: 2px 8px !important; border-radius: 999px !important; display: inline-block !important; }
  .badge-dot { display: none !important; }
  .addr-line { display: block !important; }
  tr, td, th { page-break-inside: avoid !important; break-inside: avoid !important; }
  tbody tr { break-inside: avoid !important; }
  .empty { display: none !important; }
  .card-header { display: none !important; }
}

/* â•â• PDF MODE â•â• */
body.pdf-mode { background: #fff !important; color: #000 !important; padding: 0 !important; margin: 0 !important; font-family: 'Cairo', Arial, sans-serif !important; }
body.pdf-mode::before, body.pdf-mode::after { display: none !important; }
body.pdf-mode .no-print, body.pdf-mode .topbar, body.pdf-mode #ctrlCard, body.pdf-mode #indexCard, body.pdf-mode #searchCard, body.pdf-mode #shipCard, body.pdf-mode #awaitCard, body.pdf-mode #dashCard { display: none !important; }
body.pdf-mode .wrap { max-width: none !important; gap: 0 !important; padding: 0 !important; }
body.pdf-mode .card, body.pdf-mode #printArea { background: #fff !important; border: none !important; box-shadow: none !important; border-radius: 0 !important; padding: 6mm !important; margin: 0 !important; }
body.pdf-mode .card-header { display: none !important; }
body.pdf-mode .print-header { display: block !important; margin-bottom: 10px !important; }
body.pdf-mode .print-summary { display: grid !important; grid-template-columns: 1fr 1fr 1fr !important; gap: 8px !important; margin: 8px 0 12px !important; }
body.pdf-mode .print-box { border: 1px solid #bbb !important; border-radius: 6px !important; padding: 8px 12px !important; color: #000 !important; background: #fff !important; font-size: 11px !important; line-height: 1.8 !important; }
body.pdf-mode .tbl-wrap { border: 1px solid #ccc !important; overflow: visible !important; box-shadow: none !important; background: #fff !important; }
body.pdf-mode table { width: 100% !important; min-width: 0 !important; border-collapse: collapse !important; }
body.pdf-mode thead th { position: static !important; background: #f2f2f2 !important; border: 1px solid #ccc !important; color: #000 !important; font-size: 10px !important; padding: 7px 10px !important; backdrop-filter: none !important; letter-spacing: .5px !important; text-transform: uppercase !important; }
body.pdf-mode thead th:first-child, body.pdf-mode tbody td:first-child { display: none !important; }
body.pdf-mode tbody td { border: 1px solid #ddd !important; padding: 8px 10px !important; font-size: 11px !important; color: #000 !important; background: #fff !important; }
body.pdf-mode tbody td *, body.pdf-mode .td-id, body.pdf-mode .td-phone, body.pdf-mode .td-amount, body.pdf-mode .td-name, body.pdf-mode .mono, body.pdf-mode .td-date { color: #000 !important; font-family: 'Cairo', Arial, sans-serif !important; }
body.pdf-mode .badge { border: 1px solid #bbb !important; background: #f5f5f5 !important; color: #000 !important; font-size: 10px !important; padding: 2px 8px !important; border-radius: 999px !important; display: inline-block !important; }
body.pdf-mode .badge-dot { display: none !important; }
body.pdf-mode .addr-line { display: block !important; }
body.pdf-mode tr, body.pdf-mode tbody tr { break-inside: avoid !important; page-break-inside: avoid !important; }
body.pdf-mode .empty, body.pdf-mode button { display: none !important; }
body.pdf-mode #selectionInfo, body.pdf-mode #toggleAllBtn { display: none !important; }

/* â•â• NOTIFICATION PANEL â•â• */
#notifPanel { position: fixed; top: 72px; left: 50%; transform: translateX(-50%); width: min(480px, 94vw); z-index: 8500; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.notif-card { background: var(--ink2); border: 1px solid rgba(201,168,76,.35); border-radius: var(--r3); padding: 12px 16px; box-shadow: var(--sh3), 0 0 30px var(--gold-faint); display: flex; align-items: flex-start; gap: 12px; pointer-events: all; animation: notifSlideIn .35s cubic-bezier(.34,1.56,.64,1); position: relative; overflow: hidden; }
@keyframes notifSlideIn { from { opacity:0; transform:translateY(-12px) scale(.96); } to { opacity:1; transform:translateY(0) scale(1); } }
.notif-card::before { content:""; position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, var(--gold), var(--amber)); }
.notif-card.duplicate { border-color: rgba(192,57,43,.40); }
.notif-card.duplicate::before { background: linear-gradient(90deg, var(--red), #e74c3c); }
.notif-icon { font-size:22px; flex-shrink:0; line-height:1; }
.notif-body { flex:1; min-width:0; }
.notif-title { font-size:13px; font-weight:700; color:var(--white); margin-bottom:3px; }
.notif-sub   { font-size:11px; color:var(--silver); line-height:1.5; }
.notif-actions { display:flex; gap:6px; margin-top:8px; flex-wrap:wrap; }
.notif-btn { font-size:11px; font-weight:700; padding:5px 12px; border-radius:var(--r4); border:1px solid var(--rule2); background: rgba(255,255,255,.07); color: var(--ivory); cursor:pointer; min-height:unset; transition: all .15s; }
.notif-btn:hover { background: rgba(255,255,255,.13); }
.notif-btn.gold { background: var(--gold-faint); border-color: rgba(201,168,76,.35); color: var(--gold); }
.notif-btn.gold:hover { background: rgba(201,168,76,.20); }
.notif-close { position:absolute; top:8px; left:10px; font-size:14px; color:var(--mist); cursor:pointer; background:none; border:none; min-height:unset; padding:2px 6px; }
.notif-close:hover { color:var(--silver); }

@keyframes dupShake { 0%,100%{transform:translateX(0)} 15%{transform:translateX(-8px)} 30%{transform:translateX(8px)} 45%{transform:translateX(-6px)} 60%{transform:translateX(6px)} 75%{transform:translateX(-3px)} 90%{transform:translateX(3px)} }
.dup-shake { animation: dupShake .6s ease; }

/* â•â• QUICK ACTION BUTTONS â•â• */
.qa-wrap { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
.qa-btn {
  font-size: 10px; font-weight: 700; padding: 3px 7px;
  border-radius: var(--r4); border: 1px solid var(--rule2);
  background: rgba(255,255,255,.05); color: var(--silver);
  cursor: pointer; min-height: unset; transition: all .15s;
  white-space: nowrap; font-family: 'Cairo', sans-serif;
}
.qa-btn:hover { background: rgba(255,255,255,.12); color: var(--white); }
.qa-btn.qa-ship  { border-color:rgba(243,156,18,.35); color:#f39c12; }
.qa-btn.qa-ship:hover  { background:rgba(243,156,18,.12); }
.qa-btn.qa-done  { border-color:rgba(39,174,96,.35);  color:#27ae60; }
.qa-btn.qa-done:hover  { background:rgba(39,174,96,.12); }
.qa-btn.qa-ret   { border-color:rgba(192,57,43,.35);  color:var(--red); }
.qa-btn.qa-ret:hover   { background:rgba(192,57,43,.12); }
.qa-btn.qa-print { border-color:rgba(201,168,76,.35); color:var(--gold); }
.qa-btn.qa-print:hover { background:var(--gold-faint); }
.qa-btn.qa-cancel{ border-color:rgba(127,140,141,.3); color:var(--mist); }
.qa-btn.qa-cancel:hover{ background:rgba(127,140,141,.1); }
.qa-btn:disabled { opacity:.35; cursor:not-allowed; }

/* Quick action column */
td.td-qa { min-width: 120px; }
@media(max-width:640px){ td.td-qa { display:none; } }

/* â•â• COURIER MEMORY BAR â•â• */
.courier-bar {
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
  padding: 7px 12px; background: var(--ink3); border-radius: var(--r2);
  border: 1px solid var(--rule); margin-bottom: 8px; font-size: 11px;
}
.cb-label { color: var(--mist); flex-shrink:0; }
.cb-chip {
  padding: 3px 10px; border-radius: var(--r4);
  border: 1px solid var(--rule2); background: rgba(255,255,255,.05);
  color: var(--silver); cursor: pointer; font-size:11px; font-weight:600;
  transition: all .15s; min-height:unset;
}
.cb-chip:hover { background: var(--gold-faint); border-color: rgba(201,168,76,.35); color: var(--gold); }
.cb-chip.active { background: var(--gold-faint); border-color: rgba(201,168,76,.45); color: var(--gold); }

/* â•â• SCROLL TOP â•â• */
#scrollTopBtn { position: fixed; bottom: 24px; left: 24px; width: 42px; height: 42px; border-radius: 50%; background: var(--ink2); border: 1px solid var(--rule2); color: var(--silver); font-size: 16px; cursor: pointer; box-shadow: var(--sh2); display: none; align-items: center; justify-content: center; z-index: 300; transition: all .2s; min-height: unset; padding: 0; }
#scrollTopBtn:hover { background: var(--ink3); border-color: var(--gold); color: var(--gold); transform: translateY(-2px); box-shadow: 0 8px 24px var(--gold-faint); }
#scrollTopBtn.visible { display: flex; }

@keyframes shake { 0%,100% { transform: translateX(0); } 20% { transform: translateX(-7px); } 40% { transform: translateX(7px); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } }
.shake { animation: shake .5s ease; }

@media (max-width: 640px) {
  body { padding: 8px; }
  .topbar { border-radius: 12px; padding: 8px 10px; top: 6px; }
  .brand-name { font-size: 13px; letter-spacing: 1px; }
  .brand-tagline { display: none; }
  .metric-val { font-size: 14px; }
  .metric { padding: 4px 8px; }
  .tb-btn { padding: 7px 10px; font-size: 10px; }
  .clock { display: none; }
  .vr { display: none; }
  .dash-grid { grid-template-columns: repeat(2, 1fr); }
  .topbar-row { margin-bottom: 6px; }
}
</style>
</head>
<body>

<!-- â•â• LOADING OVERLAY â•â• -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-txt" id="loadingTxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦</div>
</div>

<!-- â•â• NOTIFICATION PANEL â•â• -->
<div id="notifPanel"></div>

<!-- â•â• NOTIFICATION DRAWER (Bell) â•â• -->
<div id="notifDrawer">
  <div class="nd-backdrop" onclick="closeNotifDrawer()"></div>
  <div class="nd-panel">
    <div class="nd-header">
      <span class="nd-title">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="nd-clear" onclick="clearNotifHistory()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <button class="nd-clear" onclick="closeNotifDrawer()" style="font-size:16px;padding:2px 6px;">âœ•</button>
      </div>
    </div>
    <div class="nd-list" id="ndList">
      <div class="nd-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>
    </div>
  </div>
</div>

<!-- â•â• STATUS TOAST â•â• -->
<div id="statusToast">
  <div class="toast-box" id="toastBox">
    <div class="toast-icon" id="toastIcon">âœ…</div>
    <div class="toast-body">
      <div class="toast-title" id="toastTitle">ØªÙ…</div>
      <div class="toast-sub" id="toastSub"></div>
    </div>
    <div class="toast-progress" id="toastProgress"></div>
  </div>
</div>

<!-- â•â• PRINT MENU â•â• -->
<div id="printMenu">
  <div class="print-menu-box">
    <div class="pm-header">
      <div class="pm-title">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
      <div class="pm-sub">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ·Ø¨Ø¹Ù‡Ø§</div>
    </div>
    <button class="pm-item" onclick="doPrintBatch('new')">
      <span>ğŸ†•</span><span>Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (new)</span>
      <span class="pm-count gold" id="pmNewCount">0</span>
    </button>
    <button class="pm-item" onclick="doPrintBatch('pending')">
      <span>ğŸ–¨ï¸</span><span>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</span>
      <span class="pm-count gold" id="pmPendingCount">0</span>
    </button>
    <button class="pm-item" onclick="doPrintBatch('both')">
      <span>ğŸ“‹</span><span>Ø§Ù„ÙƒÙ„ (Ø¬Ø¯ÙŠØ¯ + ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)</span>
      <span class="pm-count gold" id="pmBothCount">0</span>
    </button>
  </div>
</div>

<!-- â•â• INLINE MODAL â•â• -->
<div id="inlineModal" style="position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:9500;display:none;align-items:center;justify-content:center;">
  <div id="inlineModalBox" style="background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);padding:24px;min-width:320px;max-width:90vw;box-shadow:var(--sh3);position:relative;animation:fadeUp .25s ease;">
    <div id="inlineModalContent"></div>
  </div>
</div>

<div class="wrap">

  <!-- â•â• TOPBAR â•â• -->
  <div class="topbar no-print">
    <!-- Row 1: Brand + Metrics -->
    <div class="topbar-row">
      <div class="brand">
        <div class="brand-logo">
          <img src="logo.png" alt="WC" onerror="this.parentElement.innerHTML='<span class=\'brand-logo-fallback\'>WC</span>'">
        </div>
        <div class="brand-text">
          <div class="brand-name">White Clothes</div>
          <div class="brand-tagline">Delivery System</div>
        </div>
      </div>
      <div class="topbar-actions">
        <div class="metric"><div class="metric-val" id="metricOrders">0</div><div class="metric-lbl">Ø·Ù„Ø¨Ø§Øª</div></div>
        <div class="metric"><div class="metric-val" id="metricSubtotal">0</div><div class="metric-lbl">ØªØ­ØµÙŠÙ„</div></div>
        <div class="metric"><div class="metric-val" id="metricShipping">0</div><div class="metric-lbl">Ø´Ø­Ù†</div></div>
        <span class="clock" id="clock"></span>
      </div>
    </div>
    <!-- Row 2: Action Buttons - centered -->
    <div class="topbar-btn-row">
      <!-- Bell / Notifications -->
      <button class="tb-btn bell-btn" onclick="toggleNotifDrawer(event)" title="Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª">
        ğŸ””
        <span class="bell-dot" id="bellDot"></span>
      </button>
      <div class="vr"></div>
      <button class="tb-btn" id="printPendingBtn" onclick="togglePrintMenu(event)">
        ğŸ–¨ï¸ ÙÙˆØ§ØªÙŠØ± <span class="tb-badge" id="pendingTotal">0</span>
      </button>
      <button class="tb-btn" id="awaitBtn" onclick="toggleAwaitCard()" title="Ø·Ù„Ø¨Ø§Øª ØªÙ… Ø·Ø¨Ø§Ø¹ØªÙ‡Ø§ ÙˆØ¨ØªÙ†ØªØ¸Ø± Ø§Ù„Ø´Ø­Ù†">
        ğŸ“¦ Ø§Ù†ØªØ¸Ø§Ø± <span class="tb-badge" id="awaitCountBadge">0</span>
      </button>
      <button class="tb-btn ship-normal" id="shipBtn" onclick="toggleShipCard()">
        ğŸšš Ø´Ø­Ù† <span class="tb-badge" id="shipCountBadge">0</span>
        <span class="ship-dot" id="shipDot"></span>
      </button>
    </div>
  </div>

  <!-- â•â• DASHBOARD â•â• -->
  <div class="card no-print" id="dashCard">
    <div class="card-header">
      <div class="card-title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <span class="card-badge" id="dashLastUpdate">â€”</span>
    </div>
    <div class="dash-grid" id="dashGrid">
      <div class="dash-tile dt-gold">
        <div class="dt-icon">ğŸ“¦</div>
        <div class="dt-val dt-gold" id="dTotal">0</div>
        <div class="dt-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
      </div>
      <div class="dash-tile dt-green">
        <div class="dt-icon">âœ…</div>
        <div class="dt-val dt-green" id="dDelivered">0</div>
        <div class="dt-lbl">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div>
        <div class="dt-sub" id="dDeliveredAmt">0 Ø¬Ù†ÙŠÙ‡</div>
      </div>
      <div class="dash-tile dt-amber">
        <div class="dt-icon">ğŸšš</div>
        <div class="dt-val dt-amber" id="dShipped">0</div>
        <div class="dt-lbl">ØªÙ… Ø§Ù„Ø´Ø­Ù†</div>
        <div class="dt-sub" id="dShippedAmt">0 Ø¬Ù†ÙŠÙ‡</div>
      </div>
      <div class="dash-tile dt-blue">
        <div class="dt-icon">ğŸ–¨ï¸</div>
        <div class="dt-val dt-blue" id="dPrinted">0</div>
        <div class="dt-lbl">ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div>
      </div>
      <div class="dash-tile dt-red">
        <div class="dt-icon">â†©ï¸</div>
        <div class="dt-val dt-red" id="dReturned">0</div>
        <div class="dt-lbl">Ù…Ø±ØªØ¬Ø¹</div>
        <div class="dt-sub" id="dReturnedAmt">0 Ø¬Ù†ÙŠÙ‡</div>
      </div>
      <div class="dash-tile dt-pearl">
        <div class="dt-icon">ğŸ’°</div>
        <div class="dt-val" id="dRevenue">0</div>
        <div class="dt-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div>
        <div class="dt-sub" id="dRevenueShip">+0 Ø´Ø­Ù†</div>
      </div>
    </div>
  </div>

  <!-- â•â• CONTROLS â•â• -->
  <div class="card no-print" id="ctrlCard">
    <div class="ctrl-grid">
      <div class="ctrl-group">
        <div class="ctrl-label">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø±</div>
        <div class="input-row">
          <input id="orderIdInput" placeholder="Order ID â€” Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù…Ø³Ø­ QR" class="flex1"/>
          <button class="btn-gold" onclick="addOneWithDupCheck()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="input-row">
          <button style="flex:1" onclick="startScan()">ğŸ“· ØªØ´ØºÙŠÙ„ QR</button>
          <button style="flex:1" onclick="stopScan()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
      </div>
      <div class="ctrl-group">
        <div class="ctrl-label">ØªØ­ÙƒÙ…</div>
        <button class="btn-w100" onclick="showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦'); refreshMine().finally(hideLoading)">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button>
        <button class="btn-danger btn-w100" onclick="clearMine()">ğŸ§¹ Ù…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button>
      </div>
      <div class="ctrl-group">
        <div class="ctrl-label">ØªØµØ¯ÙŠØ±</div>
        <button class="btn-w100" onclick="printA4()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>
        <button class="btn-w100" onclick="downloadSelectedPDF()">â¬‡ï¸ PDF Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        <button class="btn-w100" onclick="downloadAllXLSX()">â¬‡ï¸ Excel Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      </div>
    </div>
    <div class="section-rule"></div>
    <!-- âœ… Courier memory bar â€” Ø¨ÙŠØªØ°ÙƒØ± Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ† -->
    <div class="courier-bar" id="courierBar" style="display:none;">
      <span class="cb-label">ğŸšš Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</span>
      <div id="courierChips" style="display:flex;gap:5px;flex-wrap:wrap;"></div>
      <span style="color:var(--mist);font-size:10px;margin-inline-start:auto;">Ø§Ø¶ØºØ· Ø¹Ø´Ø§Ù† ØªØ­Ø¯Ø¯</span>
    </div>
    <div class="input-row" style="flex-wrap:wrap; gap:8px;">
      <select id="statusSelect" style="flex:1; min-width:200px;">
        <option value="">â€” ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯ â€”</option>
        <option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
        <option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
        <option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
        <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
        <option>Ù…Ø±ØªØ¬Ø¹</option>
        <option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option>
        <option>Ø§Ù„ØºØ§Ø¡</option>
      </select>
      <button class="btn-gold" onclick="bulkUpdate()">âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯</button>
      <span style="font-size:10px; color:var(--mist); align-self:center">(ØªÙ… Ø§Ù„Ø´Ø­Ù†) ÙŠØ·Ù„Ø¨ Ù…Ù†Ø¯ÙˆØ¨ + ØªØ§Ø±ÙŠØ®</span>
    </div>
    <div id="qrWrap">
      <div style="margin-top:10px; padding:10px; background:var(--ink3); border-radius:var(--r2); border:1px solid var(--rule); font-size:11px; color:var(--silver)">
        ğŸ“Œ Ø¶Ø¹ Ø§Ù„Ù€ QR Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” ÙŠÙØ¶Ø§Ù Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙˆØ± Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
      </div>
      <div style="margin-top:10px;">
        <div class="qr-shell">
          <div id="qr-reader"></div>
          <div class="qr-overlay">
            <div class="qr-frame"><div class="qr-br"></div><div class="qr-scan"></div><div class="qr-mask"></div></div>
          </div>
        </div>
        <div style="font-size:10px; color:var(--mist); margin-top:6px;">âš ï¸ ÙŠØ³ØªÙ„Ø²Ù… HTTPS + ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
      </div>
    </div>
  </div>

  <!-- â•â• SEARCH â•â• -->
  <div class="card no-print" id="indexCard">
    <div class="card-header">
      <div class="card-title">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div>
      <span class="card-badge" id="indexStats">â³</span>
    </div>
    <div class="input-row" style="flex-wrap:wrap;">
      <input id="idx_q" placeholder="Ù…ÙˆØ¨Ø§ÙŠÙ„ / Order ID / Ø§Ø³Ù… / Ù…Ø­Ø§ÙØ¸Ø©â€¦" class="flex1"/>
      <button onclick="searchIndex()">Ø¨Ø­Ø«</button>
      <button onclick="closeSearch()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- â•â• SEARCH RESULTS â•â• -->
  <div class="card no-print" id="searchCard" style="display:none; position:relative;">
    <div class="card-header">
      <div class="card-title">ğŸ“Œ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
      <span class="card-badge" id="srCount"></span>
    </div>
    <div class="input-row" style="margin-bottom:10px;">
      <button class="btn-ghost" onclick="srToggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
      <button class="btn-gold" onclick="srAddToMine()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      <button onclick="closeSearch()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th style="width:36px"></th>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody id="srTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â• SHIP MONITOR â•â• -->
  <div class="card no-print" id="shipCard" style="display:none;">
    <div class="card-header">
      <div class="card-title">ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª</div>
      <span class="card-badge" id="shipStats"></span>
    </div>

    <!-- âœ… FIX: Summary bar above ship table -->
    <div class="ship-summary-bar" id="shipSummaryBar">
      <div class="ssb-item"><div class="ssb-val" id="ssTotal">0</div><div class="ssb-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø§Øª</div></div>
      <div class="ssb-item"><div class="ssb-val gold" id="ssSubtotal">0</div><div class="ssb-lbl">ØªØ­ØµÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†</div></div>
      <div class="ssb-item"><div class="ssb-val" id="ssShipping">0</div><div class="ssb-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†</div></div>
      <div class="ssb-item"><div class="ssb-val green" id="ssTotal2">0</div><div class="ssb-lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div></div>
    </div>

    <div class="input-row" style="flex-wrap:wrap; gap:8px; margin-bottom:10px;">
      <div class="ship-tabs">
        <button class="ship-tab" id="tabNormal"  onclick="setShipTab('normal')">ğŸŸ¢ Ø·Ø¨ÙŠØ¹ÙŠ <span class="tab-n" id="bNormal">0</span></button>
        <button class="ship-tab" id="tabFollow"  onclick="setShipTab('follow')">ğŸŸ¡ Ù…ØªØ§Ø¨Ø¹Ø© <span class="tab-n" id="bFollow">0</span></button>
        <button class="ship-tab" id="tabOverdue" onclick="setShipTab('overdue')">ğŸ”´ Ù…ØªØ£Ø®Ø± <span class="tab-n" id="bOverdue">0</span></button>
      </div>
      <select id="shipCourierFilter" style="min-width:180px; flex:1;" onchange="renderShipTable();renderCourierBadges();">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>
      </select>
      <button onclick="printShipCurrent()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button onclick="toggleShipCard()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="c-badges" id="courierBadges"></div>
    <div style="margin-top:8px; padding:8px 12px; background:var(--ink3); border-radius:var(--r2); border:1px solid var(--rule); font-size:10px; color:var(--mist);">
      Ù…ØªØ£Ø®Ø± = Ø£ÙƒØ«Ø± Ù…Ù† <b style="color:var(--silver)">10</b> Ø£ÙŠØ§Ù… Â· Ù…ØªØ§Ø¨Ø¹Ø© = <b style="color:var(--silver)">6â€“9</b> Ø£ÙŠØ§Ù…
    </div>
    <div class="tbl-wrap" style="margin-top:10px;">
      <table>
        <thead><tr>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody id="shipTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â• AWAIT SHIPMENT â•â• -->
  <div class="card no-print" id="awaitCard" style="display:none;">
    <div class="card-header">
      <div class="card-title">ğŸ“¦ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´Ø­Ù†</div>
      <span class="card-badge" id="awaitStats"></span>
    </div>
    <div style="font-size:11px; color:var(--mist); margin-bottom:10px; padding:8px 12px; background:var(--ink3); border-radius:var(--r2); border:1px solid var(--rule);">
      Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ <b style="color:var(--gold)">ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</b> ÙˆØ¨ØªÙ†ØªØ¸Ø± ÙŠØªØ´Ø­Ù†ÙˆØ§
    </div>
    <div class="input-row" style="margin-bottom:10px;">
      <button onclick="toggleAwaitCard()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr></thead>
        <tbody id="awaitTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â•â• PRINT AREA â•â• -->
  <div class="card" id="printArea">
    <div class="print-header">
      <div class="print-title">ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… â€” White Clothes</div>
      <div id="printDate" style="font-size:12px; color:#333; margin-top:3px;"></div>
    </div>
    <div class="print-summary">
      <div class="print-box">
        <div><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: </b><span id="pCount">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†): </b><span id="pSubtotal">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†: </b><span id="pShipping">0</span></div>
      </div>
      <div class="print-box">
        <div><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø´Ø­Ù†): </b><span id="pTotal">0</span></div>
        <div><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: </b>________________________</div>
        <div><b>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: </b>________________________</div>
      </div>
      <div class="print-box">
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©: </b>Ù…Ø·Ø¨ÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­</div>
        <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®: </b><span id="pDate2"></span></div>
      </div>
    </div>
    <div class="card-header no-print" style="justify-content:space-between; margin-bottom:10px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="card-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</span>
        <span class="card-badge" id="selectionInfo">0 Ù…Ø­Ø¯Ø¯</span>
      </div>
      <button class="btn-ghost no-print" id="toggleAllBtn" onclick="toggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th class="no-print" style="width:36px;"></th>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th class="no-print">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹</th>
        </tr></thead>
        <tbody id="tbody">
          <tr><td colspan="8"><div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div>
            <div class="empty-sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ù…Ø³Ø­ QR</div>
          </div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div><!-- /wrap -->

<button id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</button>

<script>
/* â•â• CONFIG â•â• */
const WEB_APP_URL       = "https://script.google.com/macros/s/AKfycbwsMr7euLyvoHz0Sr_k26N_HJYG_O_W5mb061-ljwm-G6I2n0W_Wjb2aiXCk0hg0HkN/exec";
const WEB_APP_PRINT_URL = "https://script.google.com/macros/s/AKfycbwZ68iM4-HzCpfX3tRrVWzzZQIONDuDO2VKXyKxhRY/exec";
const API_KEY           = "123";
const FOLLOW_MIN        = 6;
const FOLLOW_MAX        = 9;
const OVERDUE_MIN       = 10;

/* â•â• DUPLICATE WINDOW: 24 hours in ms â•â• */
const DUP_WINDOW_MS = 24 * 60 * 60 * 1000;

/* â•â• CANCELLED STATUSES â€” never count as duplicate â•â• */
const CANCELLED_STATUSES = new Set(["Ø§Ù„ØºØ§Ø¡", "Ù…Ø±ØªØ¬Ø¹", "Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"]);

/* â•â• STATE â•â• */
let rows = [], selected = new Set(), mineIds = new Set();
let qr = null, lastScan = { id:"", t:0 }, scanLockUntil = 0;
let allCache = [], srSelected = new Set(), lastResults = [];
let shipAll = [], shipTab = "overdue", courierStats = {};
let awaitOrders = [];
let lastKnownIds = new Set();
let notifHistory = []; // bell drawer history

/* â•â• CLOCK â•â• */
function tickClock(){ const e=document.getElementById("clock"); if(e) e.textContent=new Date().toLocaleTimeString("ar-EG"); }
tickClock(); setInterval(tickClock, 1000);

/* â•â• PERSISTENCE â•â• */
const LS_KEY          = "wc_mine_ids_v2";
const ODIDS_KEY       = "wc_overdue_ids";
const COLORS_KEY      = "wc_courier_colors";
const SEEN_IDS_KEY    = "wc_seen_order_ids_v1";
const FOLLOWED_IDS_KEY= "wc_followed_ids_v1";
// âœ… NEW: store {id -> timestamp} for 24h dup window
const DUP_TIMES_KEY   = "wc_dup_scan_times_v1";
const NOTIF_HIST_KEY  = "wc_notif_history_v1";
const COURIERS_KEY    = "wc_couriers_v1";     // âœ… NEW: remembered couriers
const LAST_COURIER_KEY= "wc_last_courier_v1"; // âœ… NEW: last selected courier

function loadMine(){ try{ mineIds=new Set((JSON.parse(localStorage.getItem(LS_KEY)||"[]")).map(String)); }catch(e){ mineIds=new Set(); } }
function saveMine(){ localStorage.setItem(LS_KEY, JSON.stringify([...mineIds])); }
function getOldOverdueIds(){ try{ return JSON.parse(localStorage.getItem(ODIDS_KEY)||"[]"); }catch(e){ return []; } }
function setOldOverdueIds(a){ localStorage.setItem(ODIDS_KEY, JSON.stringify(a||[])); }
function loadColors(){ try{ return JSON.parse(localStorage.getItem(COLORS_KEY)||"{}"); }catch(e){ return {}; } }
function saveColors(m){ localStorage.setItem(COLORS_KEY, JSON.stringify(m||{})); }
function getSeenIds(){ try{ return new Set(JSON.parse(localStorage.getItem(SEEN_IDS_KEY)||"[]")); }catch(e){ return new Set(); } }
function saveSeenIds(s){ localStorage.setItem(SEEN_IDS_KEY, JSON.stringify([...s])); }
function getFollowedIds(){ try{ return new Set(JSON.parse(localStorage.getItem(FOLLOWED_IDS_KEY)||"[]")); }catch(e){ return new Set(); } }
function saveFollowedIds(s){ localStorage.setItem(FOLLOWED_IDS_KEY, JSON.stringify([...s])); }

/* âœ… NEW: 24h duplicate time tracking */
function getDupTimes(){ try{ return JSON.parse(localStorage.getItem(DUP_TIMES_KEY)||"{}"); }catch(e){ return {}; } }
function saveDupTimes(m){ localStorage.setItem(DUP_TIMES_KEY, JSON.stringify(m)); }
function recordScanTime(id){ const m=getDupTimes(); m[String(id)]=Date.now(); saveDupTimes(m); }
function wasScannedRecently(id){ const m=getDupTimes(); const t=m[String(id)]; if(!t) return false; return (Date.now()-t) < DUP_WINDOW_MS; }
function pruneDupTimes(){ const m=getDupTimes(); const now=Date.now(); Object.keys(m).forEach(k=>{ if(now-m[k]>DUP_WINDOW_MS) delete m[k]; }); saveDupTimes(m); }

/* âœ… NEW: Check if order is cancelled/returned (not a real dup) */
function isCancelledStatus(status){ return CANCELLED_STATUSES.has(String(status||"").trim()); }

/* â•â• COURIER MEMORY â•â• */
function getSavedCouriers(){ try{ return JSON.parse(localStorage.getItem(COURIERS_KEY)||"[]"); }catch(e){ return []; } }
function saveCourier(name){
  if(!name) return;
  let list = getSavedCouriers();
  list = [name, ...list.filter(c=>c!==name)].slice(0,8); // Ø¢Ø®Ø± 8 Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†
  localStorage.setItem(COURIERS_KEY, JSON.stringify(list));
  localStorage.setItem(LAST_COURIER_KEY, name);
  renderCourierBar();
}
function getLastCourier(){ return localStorage.getItem(LAST_COURIER_KEY)||""; }
function setActiveCourier(name){
  localStorage.setItem(LAST_COURIER_KEY, name);
  renderCourierBar();
}
function renderCourierBar(){
  const list = getSavedCouriers();
  const bar = document.getElementById("courierBar");
  const chips = document.getElementById("courierChips");
  if(!bar||!chips) return;
  if(!list.length){ bar.style.display="none"; return; }
  bar.style.display="flex";
  const cur = getLastCourier();
  chips.innerHTML = list.map(c=>`<button class="cb-chip${c===cur?" active":""}" onclick="setActiveCourier('${esc(c)}')">${esc(c)}</button>`).join("");
}

/* â•â• NOTIFICATION HISTORY (Bell drawer) â•â• */
function loadNotifHistory(){ try{ notifHistory=JSON.parse(localStorage.getItem(NOTIF_HIST_KEY)||"[]"); }catch(e){ notifHistory=[]; } }
function saveNotifHistory(){ localStorage.setItem(NOTIF_HIST_KEY, JSON.stringify(notifHistory.slice(0,60))); }
function addNotifHistory(icon, txt, sub=""){
  notifHistory.unshift({icon, txt, sub, ts:Date.now()});
  if(notifHistory.length>60) notifHistory.pop();
  saveNotifHistory();
  updateBellDot();
  if(document.getElementById("notifDrawer")?.classList.contains("open")) renderNotifDrawer();
}
function clearNotifHistory(){ notifHistory=[]; saveNotifHistory(); updateBellDot(); renderNotifDrawer(); }
function updateBellDot(){
  const dot=document.getElementById("bellDot"); if(!dot) return;
  dot.className="bell-dot"+(notifHistory.length>0?" active":"");
}
function renderNotifDrawer(){
  const list=document.getElementById("ndList"); if(!list) return;
  if(!notifHistory.length){ list.innerHTML='<div class="nd-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>'; return; }
  const now=Date.now();
  list.innerHTML=notifHistory.map(n=>{
    const mins=Math.round((now-n.ts)/60000);
    const ago=mins<1?"Ø§Ù„Ø¢Ù†":mins<60?mins+" Ø¯Ù‚ÙŠÙ‚Ø©":Math.round(mins/60)+" Ø³Ø§Ø¹Ø©";
    return `<div class="nd-item"><div class="nd-icon">${esc(n.icon)}</div><div class="nd-body"><div class="nd-txt">${esc(n.txt)}</div><div class="nd-sub">${esc(n.sub||"")}${n.sub?" Â· ":""}${ago}</div></div></div>`;
  }).join("");
}
function toggleNotifDrawer(e){
  e.stopPropagation();
  const d=document.getElementById("notifDrawer");
  const isOpen=d.classList.toggle("open");
  if(isOpen) renderNotifDrawer();
}
function closeNotifDrawer(){ document.getElementById("notifDrawer")?.classList.remove("open"); }

/* â•â• LOADING â•â• */
function showLoading(txt="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"){ document.getElementById("loadingTxt").textContent=txt; document.getElementById("loadingOverlay").classList.add("active"); }
function hideLoading(){ document.getElementById("loadingOverlay").classList.remove("active"); }

/* â•â• TOAST â•â• */
let toastTimer = null;
function toast(title, sub="", type="default", dur=2800){
  const el=document.getElementById("statusToast"), box=document.getElementById("toastBox");
  const icon=document.getElementById("toastIcon"), tEl=document.getElementById("toastTitle");
  const sEl=document.getElementById("toastSub"), prog=document.getElementById("toastProgress");
  const icons={ok:"âœ…",warn:"âš ï¸",err:"âŒ",default:"â„¹ï¸"};
  icon.textContent=icons[type]||"â„¹ï¸"; tEl.textContent=title; sEl.textContent=sub;
  box.className="toast-box"+(type!=="default"?" t-"+type:"");
  prog.style.animation="none"; prog.offsetHeight;
  prog.style.animation=`progressShrink ${dur}ms linear forwards`;
  el.classList.add("show"); clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove("show"), dur+300);
}

/* â•â• BEEP â•â• */
let audioCtx = null;
function beep(){
  try{ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type="sine"; o.frequency.value=880; g.gain.value=0.07; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(),110); }catch(e){}
  try{ navigator.vibrate?.([40]); }catch(e){}
}
function beepDuplicate(){
  try{ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); [0,180,360].forEach(d=>{ setTimeout(()=>{ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type="sawtooth"; o.frequency.value=440; g.gain.value=0.09; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.15); o.stop(audioCtx.currentTime+0.16); },140); },d); }); }catch(e){}
  try{ navigator.vibrate?.([80,60,80,60,80]); }catch(e){}
}

/* â•â• API â•â• */
function jsonp(url){ return new Promise((res,rej)=>{ const cb="cb_"+Math.random().toString(36).slice(2); window[cb]=(data)=>{ cleanup(); res(data); }; function cleanup(){ try{delete window[cb];}catch(e){window[cb]=undefined;} script.remove(); } const script=document.createElement("script"); script.src=url+(url.includes("?")?"&":"?")+`callback=${cb}`; script.onerror=()=>{ cleanup(); rej(new Error("JSONP fail")); }; document.body.appendChild(script); }); }
async function api(action, params={}){ const qs=new URLSearchParams({action,key:API_KEY,_t:Date.now(),...params}).toString(); return jsonp(WEB_APP_URL+"?"+qs); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function nextFrame(){ return new Promise(r=>requestAnimationFrame(r)); }

/* â•â• SMART DATA CACHE â€” Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¨Ø³ ÙˆØªÙˆØ²ÙŠØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„ â•â• */
const CACHE_KEY     = "wc_data_cache_v1";
const CACHE_TTL_MS  = 30000; // 30 Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ù…Ø§ Ù†Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ØªØ§Ù†ÙŠ
let   _fetchPromise = null;  // Ù„Ùˆ ÙÙŠ Ø·Ù„Ø¨ Ø´ØºØ§Ù„ØŒ Ù…Ø³ØªÙ†Ù†Ø§Ù‡ Ø¨Ø¯Ù„ Ù…Ø§ Ù†Ø¹Ù…Ù„ ØªØ§Ù†ÙŠ

/* Ø­Ù…Ù‘Ù„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ø§Ù‹ (Stale-While-Revalidate) */
function loadCachedData(){
  try{
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return null;
    const {rows, ts} = JSON.parse(raw);
    if(!rows||!rows.length) return null;
    return {rows, ts, stale: (Date.now()-ts) > CACHE_TTL_MS};
  }catch(e){ return null; }
}
function saveCachedData(rows){
  try{ localStorage.setItem(CACHE_KEY, JSON.stringify({rows, ts:Date.now()})); }catch(e){}
}

/* Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ â€” Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† ÙƒÙ„ Ø§Ù„Ù€ functions */
async function fetchAllRows(forceRefresh=false){
  // Ù„Ùˆ ÙÙŠ Ø·Ù„Ø¨ Ø´ØºØ§Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø§Ø³ØªÙ†Ù‰ Ù†ØªÙŠØ¬ØªÙ‡ Ø¨Ø¯Ù„ Ù…Ø§ ØªØ¹Ù…Ù„ request ØªØ§Ù†ÙŠ
  if(_fetchPromise) return _fetchPromise;

  // Ù„Ùˆ Ø§Ù„ÙƒØ§Ø´ Ù„Ø³Ù‡ Ø·Ø§Ø²Ø¬ ÙˆÙ…Ø´ Ù…Ø¶Ø·Ø±ÙŠÙ† Ù†Ø­Ø¯Ø«
  if(!forceRefresh){
    const cached = loadCachedData();
    if(cached && !cached.stale) return {ok:true, rows:cached.rows, fromCache:true};
  }

  _fetchPromise = (async()=>{
    try{
      const res = await api("scanList");
      if(res?.ok && res.rows){
        saveCachedData(res.rows);
      }
      return res;
    }finally{
      _fetchPromise = null;
    }
  })();

  return _fetchPromise;
}

/* processAllRows â€” Ø¨ÙŠØ£Ø®Ø° Ø§Ù„Ø¯Ø§ØªØ§ ÙˆÙŠØ­Ø¯Ø« ÙƒÙ„ section */
function processAllRows(all){
  if(!all?.length) return;
  allCache = all;

  // Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ
  const mine = all.filter(r=>mineIds.has(String(r.orderId)));
  const order = [...mineIds];
  mine.sort((a,b)=>order.indexOf(String(b.orderId))-order.indexOf(String(a.orderId)));
  rows = mine; selected = new Set(rows.map(r=>String(r.orderId)));

  // Ø´Ø­Ù†Ø§Øª
  shipAll = all.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†");

  // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´Ø­Ù†
  awaitOrders = all.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");

  // pending counts
  const newOrders  = all.filter(r=>{const s=String(r.status||"").trim();return s===""||s.toLowerCase()==="new"||s==="Ø¬Ø¯ÙŠØ¯";});
  const underPrint = all.filter(r=>String(r.status||"").trim()==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  pendingCache.newOrders = newOrders;
  pendingCache.pending   = underPrint;
  const total = newOrders.length + underPrint.length;
  document.getElementById("pmNewCount").textContent     = newOrders.length;
  document.getElementById("pmPendingCount").textContent = underPrint.length;
  document.getElementById("pmBothCount").textContent    = total;
  document.getElementById("pendingTotal").textContent   = total;
  const printBtn = document.getElementById("printPendingBtn");
  if(total>0) printBtn.classList.add("pending-active"); else printBtn.classList.remove("pending-active");

  // await badge
  const awaitCount = awaitOrders.length;
  const awaitBadge = document.getElementById("awaitCountBadge");
  const awaitBtn   = document.getElementById("awaitBtn");
  if(awaitBadge) awaitBadge.textContent = awaitCount;
  if(awaitBtn){
    if(awaitCount>0){ awaitBtn.style.borderColor="rgba(201,168,76,.35)"; awaitBtn.style.background="rgba(201,168,76,.08)"; awaitBtn.style.color="var(--gold)"; }
    else { awaitBtn.style.borderColor=""; awaitBtn.style.background=""; awaitBtn.style.color=""; }
  }

  // ship monitor stats
  let ov=0,fw=0,nm=0;
  shipAll.forEach(r=>{const d=daysSince(parseShipDate(r));if(d===null){nm++;return;}if(d>=OVERDUE_MIN)ov++;else if(d>=FOLLOW_MIN)fw++;else nm++;});
  const ovIds = shipAll.filter(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=OVERDUE_MIN;}).map(r=>String(r.orderId));
  const lastIds = getOldOverdueIds(); const newOv = ovIds.filter(id=>!lastIds.includes(id));
  if(newOv.length){
    const names=new Set(shipAll.filter(r=>newOv.includes(String(r.orderId))).map(r=>String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")));
    toast("Ù…ØªØ£Ø®Ø± Ø¬Ø¯ÙŠØ¯ ğŸš¨",[...names].join(" ØŒ "),"err",5000);
    addNotifHistory("ğŸš¨","Ø´Ø­Ù†Ø§Øª Ù…ØªØ£Ø®Ø±Ø©",[...names].join(" ØŒ "));
    document.body.classList.add("shake"); setTimeout(()=>document.body.classList.remove("shake"),600);
  }
  setOldOverdueIds(ovIds);
  courierStats={};
  shipAll.forEach(r=>{const nm2=String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";const d=daysSince(parseShipDate(r));if(!courierStats[nm2]) courierStats[nm2]={total:0,overdue:0};courierStats[nm2].total++;if(d!==null&&d>=OVERDUE_MIN) courierStats[nm2].overdue++;});
  setShipBtn({total:shipAll.length,follow:fw,overdue:ov});
  document.getElementById("bNormal").textContent=nm;
  document.getElementById("bFollow").textContent=fw;
  document.getElementById("bOverdue").textContent=ov;
  buildCourierFilter(shipAll); renderCourierBadges();

  // dashboard + search index
  updateDashboard(all);
  document.getElementById("indexStats").textContent=`âœ… ${all.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`;

  // render UI
  render();
  if(document.getElementById("shipCard")?.style.display!=="none") renderShipTable();
  if(document.getElementById("awaitCard")?.style.display!=="none") renderAwaitTable();

  // check for new orders
  _checkNewOrders(all);
}

/* â•â• Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„ØªØ­Ø¯ÙŠØ« â•â• */
async function refreshAll(forceRefresh=false){
  const cached = loadCachedData();

  // Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ø´ ÙÙˆØ±Ø§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª)
  if(cached && cached.rows.length){
    processAllRows(cached.rows);
  }

  // Ù„Ùˆ Ø§Ù„ÙƒØ§Ø´ Ø·Ø§Ø²Ø¬ ÙˆÙ…Ø´ Ù…Ø­ØªØ§Ø¬ÙŠÙ† Ù†Ø­Ø¯Ø«
  if(!forceRefresh && cached && !cached.stale) return;

  // Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  try{
    const res = await fetchAllRows(forceRefresh);
    if(res?.ok && res.rows && !res.fromCache){
      processAllRows(res.rows);
    }
  }catch(e){ toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err"); }
}

/* â•â• REFRESH WRAPPERS â€” Ø¨ÙŠØ³ØªØ®Ø¯Ù…ÙˆØ§ refreshAll Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ¹Ù…Ù„ÙˆØ§ requests Ù…Ù†ÙØµÙ„Ø© â•â• */
async function refreshMine(){ await refreshAll(true); }
async function loadAllForIndex(){ await refreshAll(); }
async function refreshShipMonitor(){ await refreshAll(); }
async function refreshPendingCount(){ await refreshAll(); }
async function refreshAwaitCount(){ await refreshAll(); }
async function checkForNewOrders(){ await refreshAll(); }

/* â•â• NEW ORDER DETECTION â•â• */
function _checkNewOrders(all){
  const currentIds = new Set(all.map(r=>String(r.orderId)));
  const seenIds = getSeenIds(), followedIds = getFollowedIds();
  if(lastKnownIds.size===0){
    all.forEach(r=>lastKnownIds.add(String(r.orderId)));
    all.forEach(r=>seenIds.add(String(r.orderId)));
    saveSeenIds(seenIds); return;
  }
  const newIds = [...currentIds].filter(id=>!lastKnownIds.has(id));
  newIds.forEach(id=>{
    const order=all.find(r=>String(r.orderId)===id); if(!order) return;
    if(isCancelledStatus(order.status)){ seenIds.add(id); saveSeenIds(seenIds); lastKnownIds.add(id); return; }
    if(seenIds.has(id)&&!followedIds.has(id)){
      if(wasScannedRecently(id)){
        beepDuplicate(); document.body.classList.add("dup-shake"); setTimeout(()=>document.body.classList.remove("dup-shake"),700);
        showDuplicateNotif(id,order);
      }
    } else if(!seenIds.has(id)){
      seenIds.add(id); saveSeenIds(seenIds);
      beep(); showNewOrderNotif(id,{name:order.name,phone:order.phone,status:order.status});
    }
    lastKnownIds.add(id);
  });
  updateDashboard(all);
}

/* â•â• UTILS â•â• */
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function n(v){ const x=Number(v); return isNaN(x)?0:x; }
function fmt(v){ return n(v).toLocaleString("ar-EG"); }
function fmtYMD(dt){ return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`; }
function colorFor(name){ const m=loadColors(); const k=String(name||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"; if(!m[k]){ let h=0; for(let i=0;i<k.length;i++) h=(h*31+k.charCodeAt(i))>>>0; m[k]=`hsl(${h%360} 60% 55%)`; saveColors(m); } return m[k]; }
function courierChip(name){ const n2=String(name||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",c=colorFor(n2); return `<span class="courier-chip"><span class="courier-dot" style="background:${c};box-shadow:0 0 5px ${c}80"></span>${esc(n2)}</span>`; }

/* âœ… FIX: Distinguish cancelled from other statuses in badge */
function statusBadge(status){ 
  const s=(status||"").trim(); 
  if(s==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"||s==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") return `<span class="badge b-ok"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`; 
  if(s==="Ù…Ø±ØªØ¬Ø¹"||s==="Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ") return `<span class="badge b-err"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`; 
  if(s==="Ø§Ù„ØºØ§Ø¡") return `<span class="badge b-cancel"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`; 
  return `<span class="badge b-warn"><span class="badge-dot"></span>${esc(s||"â€”")}</span>`; 
}

/* âœ… FIX: Format phone number â€” ensure leading 0 */
function fmtPhone(p){ 
  const clean=String(p||"").replace(/\s/g,""); 
  if(!clean) return ""; 
  // If starts with +20, convert to 0
  if(clean.startsWith("+20")) return "0"+clean.slice(3); 
  // If starts with 20 and length ~12, add 0
  if(clean.startsWith("20")&&clean.length>=11) return "0"+clean.slice(2); 
  // If 10 digits starting with 1 (mobile without 0)
  if(/^1\d{9}$/.test(clean)) return "0"+clean;
  return clean; 
}

/* âœ… FIX: Format date from order */
function fmtOrderDate(r){ 
  const raw = String(r.orderDate||r.order_date||r.createdDate||r.created_date||r.date||"").trim();
  if(!raw) return "â€”"; 
  const dt = new Date(raw); 
  if(isNaN(dt.getTime())) return raw.slice(0,10)||"â€”";
  return fmtYMD(dt); 
}

/* âœ… NEW: Address cell â€” phone(s) + city + address inline */
function addrCell(r){ 
  const p1=fmtPhone(r.phone), p2=fmtPhone(r.altPhone); 
  const city=String(r.city||"").trim(), addr=String(r.address||"").trim();
  const phonePart=p2?`${esc(p1)} â€” ${esc(p2)}`:esc(p1);
  const locPart=[city&&esc(city), addr&&esc(addr)].filter(Boolean).join(" / ");
  return `<div class="addr-line"><span class="td-phone">${phonePart}</span>${locPart?`<span class="addr-sep">|</span><span style="font-size:11px;color:var(--mist)">${locPart}</span>`:""}</div>`;
}

/* â•â• DASHBOARD UPDATE â•â• */
function updateDashboard(allRows){
  if(!allRows||!allRows.length){ return; }
  const total = allRows.length;
  const delivered = allRows.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…");
  const shipped = allRows.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†");
  const printed = allRows.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  const returned = allRows.filter(r=>["Ù…Ø±ØªØ¬Ø¹","Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"].includes(String(r.status||"").trim()));
  const sumSubtotal = arr => arr.reduce((a,r)=>a+n(r.subtotal),0);
  const sumShipping = arr => arr.reduce((a,r)=>a+n(r.shipping),0);
  const totalSub = sumSubtotal(allRows), totalShip = sumShipping(allRows);

  document.getElementById("dTotal").textContent = total.toLocaleString("ar-EG");
  document.getElementById("dDelivered").textContent = delivered.length;
  document.getElementById("dDeliveredAmt").textContent = fmt(sumSubtotal(delivered))+" Ø¬Ù†ÙŠÙ‡";
  document.getElementById("dShipped").textContent = shipped.length;
  document.getElementById("dShippedAmt").textContent = fmt(sumSubtotal(shipped))+" Ø¬Ù†ÙŠÙ‡";
  document.getElementById("dPrinted").textContent = printed.length;
  document.getElementById("dReturned").textContent = returned.length;
  document.getElementById("dReturnedAmt").textContent = fmt(sumSubtotal(returned))+" Ø¬Ù†ÙŠÙ‡";
  document.getElementById("dRevenue").textContent = fmt(totalSub);
  document.getElementById("dRevenueShip").textContent = "+"+fmt(totalShip)+" Ø´Ø­Ù†";
  document.getElementById("dashLastUpdate").textContent = "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: "+new Date().toLocaleTimeString("ar-EG");
}

/* â•â• RENDER â•â• */
function quickActionBtn(r){
  const s = String(r.status||"").trim();
  const id = String(r.orderId);
  if(s===""||s==="Ø¬Ø¯ÙŠØ¯"||s.toLowerCase()==="new")
    return `<div class="qa-wrap"><button class="qa-btn qa-print" onclick="quickUpdate('${id}','ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>`;
  if(s==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
    return `<div class="qa-wrap"><button class="qa-btn qa-print" onclick="quickUpdate('${id}','ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©')">âœ… ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</button></div>`;
  if(s==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")
    return `<div class="qa-wrap"><button class="qa-btn qa-ship" onclick="quickShip('${id}')">ğŸšš Ø´Ø­Ù†</button></div>`;
  if(s==="ØªÙ… Ø§Ù„Ø´Ø­Ù†")
    return `<div class="qa-wrap"><button class="qa-btn qa-done" onclick="quickUpdate('${id}','ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…')">ğŸ“¦ ØªØ³Ù„ÙŠÙ…</button><button class="qa-btn qa-ret" onclick="quickUpdate('${id}','Ù…Ø±ØªØ¬Ø¹')">â†©ï¸</button></div>`;
  if(s==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…")
    return `<div class="qa-wrap" style="color:var(--mist);font-size:10px;">âœ“ Ù…ÙƒØªÙ…Ù„</div>`;
  if(s==="Ù…Ø±ØªØ¬Ø¹"||s==="Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"||s==="Ø§Ù„ØºØ§Ø¡")
    return `<div class="qa-wrap"><button class="qa-btn" onclick="quickUpdate('${id}','Ø¬Ø¯ÙŠØ¯')">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button></div>`;
  return "";
}

function render(){
  updateToggleBtn();
  const tbody=document.getElementById("tbody"); tbody.innerHTML="";
  const subtotalSum=rows.reduce((a,r)=>a+n(r.subtotal),0);
  const shippingSum=rows.reduce((a,r)=>a+n(r.shipping),0);
  document.getElementById("metricOrders").textContent=rows.length;
  document.getElementById("metricSubtotal").textContent=fmt(subtotalSum);
  document.getElementById("metricShipping").textContent=fmt(shippingSum);
  const si=document.getElementById("selectionInfo"); if(si) si.textContent=selected.size+" Ù…Ø­Ø¯Ø¯";
  if(!rows.length){ tbody.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div><div class="empty-sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ù…Ø³Ø­ QR</div></div></td></tr>`; return; }
  rows.forEach(r=>{
    const tr=document.createElement("tr"); const checked=selected.has(String(r.orderId));
    tr.innerHTML=`<td class="no-print" style="text-align:center"><input type="checkbox" ${checked?"checked":""}></td>
    <td class="td-id"><b>${esc(r.orderId)}</b></td>
    <td class="td-name">${esc(r.name||"")}</td>
    <td class="td-addr">${addrCell(r)}</td>
    <td class="td-amount">${fmt(r.subtotal)}</td>
    <td class="mono" style="font-size:11px;color:var(--silver)">${fmt(r.shipping)}</td>
    <td>${statusBadge(r.status)}</td>
    <td class="td-date no-print">${fmtOrderDate(r)}</td>
    <td class="td-qa no-print">${quickActionBtn(r)}</td>`;
    tr.querySelector("input").addEventListener("change",e=>{ const id=String(r.orderId); e.target.checked?selected.add(id):selected.delete(id); if(si) si.textContent=selected.size+" Ù…Ø­Ø¯Ø¯"; updateToggleBtn(); });
    tbody.appendChild(tr);
  });
}
function toggleAll(){ const allIds=rows.map(r=>String(r.orderId)); const allSel=allIds.length&&allIds.every(id=>selected.has(id)); if(allSel) selected.clear(); else allIds.forEach(id=>selected.add(id)); updateToggleBtn(); render(); }
function updateToggleBtn(){ const btn=document.getElementById("toggleAllBtn"); if(!btn) return; const allIds=rows.map(r=>String(r.orderId)); btn.textContent=(allIds.length&&allIds.every(id=>selected.has(id)))?"Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„":"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"; }

/* â•â• QUICK SINGLE-ORDER UPDATE â•â• */
async function quickUpdate(orderId, status){
  const id = String(orderId);
  // Optimistic
  const prevCache=allCache.map(r=>({...r})), prevRows=rows.map(r=>({...r}));
  allCache=allCache.map(r=>String(r.orderId)===id?{...r,status}:r);
  rows=rows.map(r=>String(r.orderId)===id?{...r,status}:r);
  saveCachedData(allCache); render();
  toast(status, "Order "+id, "ok", 2200);
  if(["Ø§Ù„ØºØ§Ø¡","Ù…Ø±ØªØ¬Ø¹","Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"].includes(status)){
    const m=getDupTimes(); delete m[id]; saveDupTimes(m);
  }
  try{
    const res=await api("bulkUpdate",{ids:id,status,courier:"",shipDate:"",deliveryDate:"",partialAmount:""});
    if(!res?.ok){ allCache=prevCache; rows=prevRows; saveCachedData(allCache); render(); toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err"); return; }
    refreshAll(true);
  }catch(e){ allCache=prevCache; rows=prevRows; saveCachedData(allCache); render(); toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err"); }
}

async function quickShip(orderId){
  // Ø¨ÙŠØ¬ÙŠØ¨ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸ â€” Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨ÙŠØ³Ø£Ù„
  const savedCourier = getLastCourier();
  const today = new Date().toISOString().slice(0,10);
  if(savedCourier){
    // Ø¹Ù†Ø¯Ù‡ Ù…Ù†Ø¯ÙˆØ¨ Ù…Ø­ÙÙˆØ¸ â†’ Ø¨ÙŠØ³Ø£Ù„ ØªØ£ÙƒÙŠØ¯ Ø³Ø±ÙŠØ¹
    const confirmed = await showQuickShipConfirm(orderId, savedCourier, today);
    if(!confirmed) return;
    await _doQuickShip(orderId, confirmed.courier, confirmed.shipDate);
  } else {
    // Ù…ÙÙŠØ´ Ù…Ù†Ø¯ÙˆØ¨ â†’ ÙŠÙØªØ­ modal Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    const r = await showShipModal();
    if(!r) return;
    saveCourier(r.courier);
    await _doQuickShip(orderId, r.courier, r.shipDate);
  }
}

function showQuickShipConfirm(orderId, defaultCourier, defaultDate){
  return new Promise(resolve=>{
    const couriers = getSavedCouriers();
    const chipsHtml = couriers.map(c=>`<button class="cb-chip${c===defaultCourier?" active":""}" onclick="this.closest('.qsc-couriers').querySelectorAll('.cb-chip').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('qsc_courier').value='${esc(c)}'">${esc(c)}</button>`).join("");
    openModal(`
      <div style="margin-bottom:12px">
        <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:3px;">ğŸšš ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</div>
        <div style="font-size:11px;color:var(--mist);">Order ID: <b style="color:var(--silver)">${esc(String(orderId))}</b></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        ${chipsHtml?`<div class="qsc-couriers" style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:2px;">${chipsHtml}</div>`:""}
        <div>
          <div style="font-size:10px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *</div>
          <input id="qsc_courier" value="${esc(defaultCourier)}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" style="width:100%;"/>
        </div>
        <div>
          <div style="font-size:10px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† *</div>
          <input id="qsc_date" type="date" value="${defaultDate}" style="width:100%;"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:4px;">
          <button class="btn-gold" style="flex:1" onclick="_qscOk()">âœ… ØªØ£ÙƒÙŠØ¯</button>
          <button style="flex:1" onclick="_qscCancel()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div id="qsc_err" style="color:var(--red);font-size:11px;display:none;"></div>
      </div>
    `);
    setTimeout(()=>document.getElementById("qsc_courier")?.select(),80);
    window._qscOk=()=>{
      const courier=(document.getElementById("qsc_courier")?.value||"").trim();
      const shipDate=(document.getElementById("qsc_date")?.value||"").trim();
      const err=document.getElementById("qsc_err");
      if(!courier){err.textContent="â›” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨";err.style.display="block";return;}
      if(!shipDate){err.textContent="â›” Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†";err.style.display="block";return;}
      saveCourier(courier); closeModal(); resolve({courier,shipDate});
      delete window._qscOk; delete window._qscCancel;
    };
    window._qscCancel=()=>{ closeModal(); resolve(null); delete window._qscOk; delete window._qscCancel; };
  });
}

async function _doQuickShip(orderId, courier, shipDate){
  const id=String(orderId);
  const prevCache=allCache.map(r=>({...r})), prevRows=rows.map(r=>({...r}));
  allCache=allCache.map(r=>String(r.orderId)===id?{...r,status:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",courier,shipDate}:r);
  rows=rows.map(r=>String(r.orderId)===id?{...r,status:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",courier,shipDate}:r);
  saveCachedData(allCache); render();
  toast("ØªÙ… Ø§Ù„Ø´Ø­Ù†","Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+courier,"ok",2500);
  try{
    const res=await api("bulkUpdate",{ids:id,status:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",courier,shipDate,deliveryDate:"",partialAmount:""});
    if(!res?.ok){ allCache=prevCache; rows=prevRows; saveCachedData(allCache); render(); toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err"); return; }
    refreshAll(true);
  }catch(e){ allCache=prevCache; rows=prevRows; saveCachedData(allCache); render(); toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err"); }
}

/* â•â• BULK UPDATE â•â• */
async function bulkUpdate(){
  const status=document.getElementById("statusSelect").value.trim();
  if(!status){ toast("Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  const ids=[...selected]; if(!ids.length){ toast("Ù„Ù… ØªØ­Ø¯Ø¯ Ø£ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª","","warn"); return; }
  let courier="", shipDate="", deliveryDate="", partialAmount="";
  if(status==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"){ const r=await showShipModal(); if(!r){ toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","warn"); return; } courier=r.courier; shipDate=r.shipDate; if(!courier.trim()){ toast("â›” Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨","","err"); return; } if(!shipDate.trim()){ toast("â›” Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†","","err"); return; } }
  if(status==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"){ const r=await showDeliveryModal(); if(!r){ toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","warn"); return; } deliveryDate=r.deliveryDate; if(!deliveryDate.trim()){ toast("â›” Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…","","err"); return; } }
  if(status==="Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"){ const r=await showPartialModal(); if(!r){ toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","warn"); return; } partialAmount=r.amount; if(!partialAmount.trim()){ toast("â›” Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº","","err"); return; } }

  // â•â• OPTIMISTIC UPDATE: Ø­Ø¯Ù‘Ø« Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ â•â•
  const idSet = new Set(ids.map(String));

  // Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ù€ rollback Ù„Ùˆ ÙØ´Ù„
  const prevRows = rows.map(r=>({...r}));
  const prevCache = allCache.map(r=>({...r}));

  // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ state Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
  const now = new Date().toISOString();
  allCache = allCache.map(r=>{
    if(!idSet.has(String(r.orderId))) return r;
    return {...r, status, courier:courier||r.courier, shipDate:shipDate||r.shipDate, deliveryDate:deliveryDate||r.deliveryDate};
  });
  rows = rows.map(r=>{
    if(!idSet.has(String(r.orderId))) return r;
    return {...r, status, courier:courier||r.courier, shipDate:shipDate||r.shipDate, deliveryDate:deliveryDate||r.deliveryDate};
  });

  // Ø­Ø¯Ù‘Ø« Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙˆØ±Ø§Ù‹
  saveCachedData(allCache);

  // Ø§Ø±Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø© ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙ†Ù†Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±
  render();
  toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«",`${ids.length} Ø£ÙˆØ±Ø¯Ø± â€” ${status}`,"ok",3500);
  document.getElementById("statusSelect").value="";

  if(["Ø§Ù„ØºØ§Ø¡","Ù…Ø±ØªØ¬Ø¹","Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"].includes(status)){
    const m=getDupTimes(); ids.forEach(id=>delete m[String(id)]); saveDupTimes(m);
  }

  // Ø§Ø¨Ø¹Øª Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  try{
    const res=await api("bulkUpdate",{ids:ids.join(","),status,courier,shipDate,deliveryDate,partialAmount});
    if(!res?.ok){
      // ÙØ´Ù„ â†’ Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù‚Ø¯ÙŠÙ…
      allCache=prevCache; rows=prevRows; saveCachedData(allCache); render();
      toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« â€” ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡",res?.error||"","err"); return;
    }
    // Ù†Ø¬Ø­ â†’ Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ù‡Ø¯ÙˆØ¡ (Ø¨Ø¯ÙˆÙ† loading)
    refreshAll(true);
  }catch(e){
    // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ â†’ Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù‚Ø¯ÙŠÙ…
    allCache=prevCache; rows=prevRows; saveCachedData(allCache); render();
    toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ â€” ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","err");
  }
}

/* â•â• QR â•â• */
async function startScan(){
  document.getElementById("qrWrap").style.display="block";
  if(!qr) qr=new Html5Qrcode("qr-reader");
  const cfg={fps:15,qrbox:{width:200,height:200},aspectRatio:1.0}; let camId=null;
  try{ const cams=await Html5Qrcode.getCameras(); if(cams?.length){ const bk=cams.find(c=>/back|rear|environment/i.test(c.label)); camId=(bk||cams[0]).id; } }catch(e){}
  try{ await qr.start(camId||{facingMode:"environment"},cfg,onQrSuccess,()=>{}); toast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø©","","ok"); }
  catch(e){ toast("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§",String(e),"err"); }
}
async function stopScan(){ document.getElementById("qrWrap").style.display="none"; if(qr){ try{await qr.stop();}catch(e){} } toast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"); }

async function onQrSuccess(txt){
  const now=Date.now(); if(now<scanLockUntil) return;
  const raw=String(txt||"").trim(); const clean=raw.match(/\d+/)?raw.match(/\d+/)[0]:raw;
  if(!clean) return; if(lastScan.id===clean&&(now-lastScan.t)<3000) return;
  lastScan={id:clean,t:now}; scanLockUntil=now+2000;

  // Already in my list = definite duplicate
  if(mineIds.has(String(clean))){ 
    beepDuplicate(); document.body.classList.add("dup-shake"); setTimeout(()=>document.body.classList.remove("dup-shake"),700); 
    const ex=allCache.find(r=>String(r.orderId).trim()===String(clean)); 
    showDuplicateNotif(clean,ex||{name:"Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ Ø¨Ø§Ù„ÙØ¹Ù„",status:"â€”"}); 
    addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ","ID: "+clean);
    return; 
  }

  // âœ… FIX: Check cache â€” if cancelled/returned, NOT a duplicate warning â€” add normally
  const inCache=allCache.find(r=>String(r.orderId).trim()===String(clean));
  if(inCache && !isCancelledStatus(inCache.status)){
    // âœ… FIX: Only warn as dup if scanned within last 24h
    if(wasScannedRecently(clean)){
      beepDuplicate(); document.body.classList.add("dup-shake"); setTimeout(()=>document.body.classList.remove("dup-shake"),700); 
      showDuplicateNotif(clean,inCache);
      addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø±","ID: "+clean+" | "+inCache.name);
      // Still add to list after short delay
      setTimeout(async()=>{ mineIds.add(String(clean)); saveMine(); recordScanTime(clean); await api("scanAdd",{orderId:clean}); await refreshMine(); },600); 
      return;
    }
  }

  // Normal add â€” record scan time so next scan within 24h triggers dup warning
  beep(); toast("ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·",clean,"ok");
  mineIds.add(String(clean)); saveMine();
  recordScanTime(clean);  // âœ… record AFTER confirming normal add
  addNotifHistory("âœ…","ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±","ID: "+clean+(inCache?" | "+inCache.name:""));
  const res=await api("scanAdd",{orderId:clean}); if(!res?.ok){ toast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©",res?.error||"","err"); return; } await refreshMine();
}

function clearMine(){ if(!confirm("Ù‡ØªÙ…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø© (Ù…Ø´ Ù…Ù† Ø§Ù„Ø´ÙŠØª). Ù…ØªØ£ÙƒØ¯ØŸ")) return; mineIds=new Set(); saveMine(); rows=[]; selected=new Set(); render(); toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª","","warn"); }

/* â•â• PRINT / PDF â•â• */
function updatePrintSummary(){
  const sub=rows.reduce((a,r)=>a+n(r.subtotal),0), shp=rows.reduce((a,r)=>a+n(r.shipping),0), now=new Date().toLocaleString("ar-EG");
  document.getElementById("printDate").textContent="ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…: "+now;
  document.getElementById("pDate2").textContent=now;
  document.getElementById("pCount").textContent=rows.length;
  document.getElementById("pSubtotal").textContent=sub;
  document.getElementById("pShipping").textContent=shp;
  document.getElementById("pTotal").textContent=sub+shp;
}
function printA4(){ updatePrintSummary(); window.print(); }

async function downloadSelectedPDF(){
  const ids=[...selected]; if(!ids.length){ toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  const prevRows=rows.slice(), prevSel=new Set(selected);
  rows=rows.filter(r=>ids.includes(String(r.orderId))); selected=new Set(ids);
  updatePrintSummary(); render();
  document.body.classList.add("pdf-mode");
  const area=document.getElementById("printArea");
  await nextFrame(); await nextFrame(); await sleep(200); area.offsetHeight; await nextFrame();
  const opt={ margin:[6,6,6,6], filename:`wc-delivery-${new Date().toISOString().slice(0,10)}.pdf`, enableLinks:false, image:{type:"jpeg",quality:1.0}, html2canvas:{scale:2.5,useCORS:true,backgroundColor:"#ffffff",scrollX:0,scrollY:0,logging:false, onclone(doc){ const s=doc.createElement("style"); s.textContent=`*{color:#111!important;background:transparent!important;font-family:'Cairo',Arial,sans-serif!important;box-shadow:none!important;text-shadow:none!important;backdrop-filter:none!important;}html,body{background:#fff!important;margin:0!important;padding:0!important;direction:rtl!important;}.no-print,.topbar,#ctrlCard,#indexCard,#searchCard,#shipCard,#awaitCard,#dashCard,#notifPanel,button{display:none!important}.wrap{max-width:none!important;padding:0!important;gap:0!important;}.card,#printArea{background:#fff!important;border:none!important;border-radius:0!important;padding:8mm!important;margin:0!important;}.card-header{display:none!important;}.print-header{display:block!important;margin-bottom:14px!important;}.print-title{font-size:22px!important;font-weight:900!important;color:#111!important;}.print-summary{display:grid!important;grid-template-columns:1fr 1fr 1fr!important;gap:10px!important;margin:12px 0 16px!important;}.print-box{border:1px solid #ddd!important;border-radius:6px!important;padding:10px 14px!important;background:#fafafa!important;color:#111!important;line-height:2!important;font-size:11px!important;}.tbl-wrap{border:1px solid #ccc!important;overflow:visible!important;background:#fff!important;}.tbl-wrap table{width:100%!important;min-width:0!important;border-collapse:collapse!important;}thead th:first-child,tbody td:first-child{display:none!important;}thead th{position:static!important;background:#111!important;color:#fff!important;border:1px solid #111!important;padding:9px 12px!important;font-size:10px!important;font-weight:700!important;text-align:right!important;}tbody tr:nth-child(even) td{background:#f9f9f9!important;}tbody td{border:1px solid #e0e0e0!important;padding:9px 12px!important;font-size:11px!important;color:#111!important;background:#fff!important;vertical-align:top!important;}.addr-line{display:block!important;}.badge{border:1px solid #999!important;background:#f0f0f0!important;color:#111!important;font-size:10px!important;padding:2px 10px!important;border-radius:999px!important;display:inline-block!important;}.badge-dot,.courier-chip,.courier-dot{display:none!important;}.empty,#selectionInfo,#toggleAllBtn{display:none!important;}`; doc.head.appendChild(s); } }, jsPDF:{unit:"mm",format:"a4",orientation:"landscape"}, pagebreak:{mode:["css","legacy"],avoid:["tr","td"]} };
  try{ await html2pdf().set(opt).from(area).save(); toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ PDF","","ok"); }
  catch(e){ toast("Ø®Ø·Ø£ ÙÙŠ PDF","","err"); }
  finally{ document.body.classList.remove("pdf-mode"); rows=prevRows; selected=prevSel; render(); }
}

function downloadAllXLSX(){
  const ids=[...selected]; if(!ids.length){ toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn"); return; }
  const exp=rows.filter(r=>ids.includes(String(r.orderId)));
  const sub=exp.reduce((a,r)=>a+(Number(r.subtotal)||0),0), shp=exp.reduce((a,r)=>a+(Number(r.shipping)||0),0), now=new Date().toLocaleString("ar-EG");
  const header=["Order ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‡Ø§ØªÙ","Ù‡Ø§ØªÙ Ø¥Ø¶Ø§ÙÙŠ","Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©","Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","Ø§Ù„ØªØ­ØµÙŠÙ„","Ø§Ù„Ø´Ø­Ù†","Ø§Ù„Ø­Ø§Ù„Ø©"];
  const aoa=[];
  aoa.push(["ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… â€” White Clothes"]); aoa.push([`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now}`]); aoa.push([""]);
  aoa.push(["Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:",exp.length,"","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø´Ø­Ù†):",sub+shp,"","Ù…Ù„Ø§Ø­Ø¸Ø©:","Ù…Ø·Ø¨ÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­",""]);
  aoa.push(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„:",sub,"","Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:","___________","","Ø§Ù„ØªØ§Ø±ÙŠØ®:",now,""]);
  aoa.push(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†:",shp,"","Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:","___________","","",""]);
  aoa.push([""]); const hRow=aoa.length; aoa.push(header);
  exp.forEach(r=>aoa.push([String(r.orderId??""),String(r.name??""),fmtPhone(r.phone),fmtPhone(r.altPhone),String(r.city??""),String(r.address??""),Number(r.subtotal||0),Number(r.shipping||0),String(r.status??"")]));
  const wb=XLSX.utils.book_new(); wb.Workbook={Views:[{RTL:true}]};
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  ws["!rows"]=[{hpt:36},{hpt:22}];
  ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:9}},{s:{r:1,c:0},e:{r:1,c:9}}];
  ws["!cols"]=[{wch:12},{wch:20},{wch:14},{wch:14},{wch:12},{wch:40},{wch:16},{wch:10},{wch:14},{wch:12}];
  ws["!freeze"]={xSplit:0,ySplit:hRow+1};
  const bdr=(s="thin")=>{ const b={style:s,color:{rgb:"000000"}}; return{top:b,bottom:b,left:b,right:b}; };
  const range=XLSX.utils.decode_range(ws["!ref"]);
  for(let R=range.s.r;R<=range.e.r;R++) for(let C=range.s.c;C<=range.e.c;C++){ const a=XLSX.utils.encode_cell({r:R,c:C}); if(!ws[a]) continue; ws[a].s={alignment:{wrapText:true,vertical:"top",horizontal:"right"}}; if(R===0){ws[a].s.font={bold:true,sz:16};ws[a].s.alignment.horizontal="center";ws[a].s.alignment.vertical="center";} if(R===1){ws[a].s.font={bold:true,sz:11};} if(R>=3&&R<=5){ws[a].s.border=bdr();} if(R===hRow){ws[a].s.font={bold:true};ws[a].s.fill={patternType:"solid",fgColor:{rgb:"EFEFEF"}};ws[a].s.border=bdr("medium");} if(R>hRow){ws[a].s.border=bdr();} }
  XLSX.utils.book_append_sheet(wb,ws,"Delivery Sheet");
  XLSX.writeFile(wb,`wc-${new Date().toISOString().slice(0,10)}.xlsx`);
  toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Excel","","ok");
}

/* â•â• PRINT MENU â•â• */
let printMenuOpen=false, pendingCache={newOrders:[],pending:[]};
function togglePrintMenu(e){
  e.stopPropagation();
  const menu=document.getElementById("printMenu");
  if(printMenuOpen){ closePrintMenu(); return; }
  // FIX: position below the button but centered on screen
  const btn=document.getElementById("printPendingBtn");
  const rect=btn.getBoundingClientRect();
  menu.style.top=(rect.bottom+window.scrollY+6)+"px";
  menu.classList.add("open"); printMenuOpen=true;
}
function closePrintMenu(){ document.getElementById("printMenu").classList.remove("open"); printMenuOpen=false; }
document.addEventListener("click",e=>{
  if(!e.target.closest("#printMenu") && !e.target.closest("#printPendingBtn")) closePrintMenu();
});

async function doPrintBatch(which){
  closePrintMenu();
  let ids=[];
  if(which==="new")     ids=pendingCache.newOrders.map(r=>r.orderId).filter(Boolean);
  if(which==="pending") ids=pendingCache.pending.map(r=>r.orderId).filter(Boolean);
  if(which==="both")    ids=[...pendingCache.newOrders,...pendingCache.pending].map(r=>r.orderId).filter(Boolean);
  if(!ids.length){ toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©","","warn"); return; }
  const btn=document.getElementById("printPendingBtn"); btn.disabled=true;
  showLoading(`Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² ${ids.length} ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©â€¦`);
  try{
    const url=WEB_APP_PRINT_URL+"?action=printBatch&ids="+encodeURIComponent(ids.join(","))+"&v="+Date.now();
    const w=window.open(url,"_blank"); hideLoading();
    if(!w){ toast("Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°","Ø§Ø³Ù…Ø­ Ø¨Ù€ Pop-up ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©","err"); return; }
    showPrintConfirmPanel(ids);
  }catch(e){ hideLoading(); toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©","","err"); }
  finally{ btn.disabled=false; }
}

function showPrintConfirmPanel(ids){
  const old=document.getElementById("printConfirmPanel"); if(old) old.remove();
  const panel=document.getElementById("notifPanel"); const div=document.createElement("div");
  div.id="printConfirmPanel"; div.className="notif-card"; div.style.borderColor="rgba(201,168,76,.45)";
  div.innerHTML=`<div class="notif-icon">ğŸ–¨ï¸</div><div class="notif-body"><div class="notif-title">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${ids.length} ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</div><div class="notif-sub">Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ØªØ®Ù„Øµ â€” Ø§Ø¶ØºØ· "ØªØ£ÙƒÙŠØ¯" Ù„ØªØ­ÙˆÙŠÙ„ Ø­Ø§Ù„ØªÙ‡Ù… Ù„Ù€ <b>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</b></div><div class="notif-actions"><button class="notif-btn gold" id="confirmPrintedBtn">âœ… ØªØ£ÙƒÙŠØ¯ â€” Ø­ÙˆÙ‘Ù„ Ù„Ù€ "ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"</button><button class="notif-btn" onclick="dismissNotif('printConfirmPanel')">ØªØ¬Ø§Ù‡Ù„</button></div></div><button class="notif-close" onclick="dismissNotif('printConfirmPanel')">âœ•</button>`;
  panel.appendChild(div);
  document.getElementById("confirmPrintedBtn").addEventListener("click", function(){
    confirmMarkPrinted(ids, "printConfirmPanel");
  });
}

async function confirmMarkPrinted(ids, notifId){
  dismissNotif(notifId);

  // â•â• OPTIMISTIC UPDATE ÙÙˆØ±ÙŠ â•â•
  const idSet=new Set(ids.map(String));
  const prevCache=allCache.map(r=>({...r}));
  const prevRows=rows.map(r=>({...r}));

  allCache=allCache.map(r=>idSet.has(String(r.orderId))?{...r,status:"ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"}:r);
  rows=rows.map(r=>idSet.has(String(r.orderId))?{...r,status:"ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"}:r);
  saveCachedData(allCache);
  render();
  toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«",`${ids.length} Ø£ÙˆØ±Ø¯Ø± â†’ ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©`,"ok",3500);

  // Ø§Ø¨Ø¹Øª Ù„Ù„Ø³ÙŠØ±ÙØ± ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
  try{
    const res=await api("bulkUpdate",{ids:ids.join(","),status:"ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",courier:"",shipDate:"",deliveryDate:"",partialAmount:""});
    if(!res?.ok){
      allCache=prevCache; rows=prevRows; saveCachedData(allCache); render();
      toast("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©",res?.error||"","err"); return;
    }
    refreshAll(true);
  }catch(e){
    allCache=prevCache; rows=prevRows; saveCachedData(allCache); render();
    toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err");
  }
}

/* â•â• SEARCH â•â• */
function searchIndex(){
  const q=(document.getElementById("idx_q").value||"").trim().toLowerCase(); if(!q){closeSearch();return;}
  if(!allCache.length){toast("Ø§Ù„Ø¯Ø§ØªØ§ Ù„Ø³Ù‡ Ø¨ØªØªØ­Ù…Ù‘Ù„","","warn");return;}
  const digits=q.replace(/\D/g,""),isD=digits.length>=4;
  lastResults=allCache.filter(r=>{ const h=[r.orderId,r.name,r.phone,r.altPhone,r.city,r.address,r.status].join("|").toLowerCase(); if(isD) return String(r.orderId??"").includes(digits)||String(r.phone??"").includes(digits)||String(r.altPhone??"").includes(digits)||h.includes(q); return h.includes(q); });
  srSelected.clear(); renderSearchResults();
  document.getElementById("searchCard")?.scrollIntoView({behavior:"smooth",block:"start"});
}
function renderSearchResults(){
  const card=document.getElementById("searchCard"),tbody=document.getElementById("srTbody"),cnt=document.getElementById("srCount");
  if(!lastResults?.length){card.style.display="none";tbody.innerHTML="";return;}
  card.style.display="block"; cnt.textContent=lastResults.length+" Ù†ØªÙŠØ¬Ø©"; tbody.innerHTML="";
  lastResults.forEach(r=>{ const id=String(r.orderId??""),tr=document.createElement("tr"); tr.innerHTML=`<td style="text-align:center"><input type="checkbox" ${srSelected.has(id)?"checked":""}></td><td class="td-id"><b>${esc(id)}</b></td><td class="td-name">${esc(r.name||"")}</td><td class="td-addr">${addrCell(r)}</td><td class="td-amount">${fmt(r.subtotal)}</td><td class="mono" style="font-size:11px">${fmt(r.shipping)}</td><td>${statusBadge(r.status)}</td>`; tr.querySelector("input").addEventListener("change",e=>{e.target.checked?srSelected.add(id):srSelected.delete(id);}); tbody.appendChild(tr); });
}
function srToggleAll(){ if(!lastResults?.length) return; const allIds=lastResults.map(r=>String(r.orderId)); const allSel=allIds.every(id=>srSelected.has(id)); if(allSel) srSelected.clear(); else allIds.forEach(id=>srSelected.add(id)); renderSearchResults(); }
function closeSearch(){ lastResults=[];srSelected.clear();document.getElementById("searchCard").style.display="none";document.getElementById("srTbody").innerHTML="";document.getElementById("idx_q").value="";document.getElementById("indexStats").textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`; }
async function srAddToMine(){ const ids=[...srSelected]; if(!ids.length){toast("Ø­Ø¯Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø£ÙˆÙ„Ø§Ù‹","","warn");return;} let added=0; ids.forEach(id=>{if(!mineIds.has(String(id))){mineIds.add(String(id));added++;}}); saveMine(); toast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${added} Ø£ÙˆØ±Ø¯Ø±`,"","ok"); closeSearch(); showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦"); await refreshMine(); hideLoading(); }
document.getElementById("idx_q").addEventListener("input",()=>{ const q=document.getElementById("idx_q").value.trim().toLowerCase(); const el=document.getElementById("indexStats"); if(!q){el.textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`;return;} const cnt=allCache.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))).length; el.textContent=`ğŸ” ${cnt.toLocaleString("ar-EG")} Ù…ØªÙˆÙ‚Ø¹`; });

/* â•â• SHIP MONITOR â•â• */
function parseShipDate(r){ const raw=String(r.shipDate??r.ship_date??r.shippedDate??r.shipped_date??r.shipDateText??"").trim(); if(!raw) return null; const m=raw.match(/^(\d{4})-(\d{2})-(\d{2})/); if(m){const dt=new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);return isNaN(dt.getTime())?null:dt;} const dt=new Date(raw); return isNaN(dt.getTime())?null:dt; }
function daysSince(dt){ if(!dt) return null; return Math.floor((Date.now()-dt.getTime())/86400000); }
function setShipBtn({total=0,follow=0,overdue=0}){ const btn=document.getElementById("shipBtn"),dot=document.getElementById("shipDot"); document.getElementById("shipCountBadge").textContent=total; btn.className="tb-btn "+(overdue>0?"ship-overdue":follow>0?"ship-follow":"ship-normal"); if(overdue>0){dot.textContent=overdue;dot.style.display="inline-flex";}else{dot.style.display="none";} }

/* âœ… FIX: Update ship summary bar with totals */
function updateShipSummary(list){
  const total = list.length;
  const subtotal = list.reduce((a,x)=>a+n(x.r.subtotal),0);
  const shipping = list.reduce((a,x)=>a+n(x.r.shipping),0);
  document.getElementById("ssTotal").textContent = total.toLocaleString("ar-EG");
  document.getElementById("ssSubtotal").textContent = fmt(subtotal)+" Ø¬";
  document.getElementById("ssShipping").textContent = fmt(shipping)+" Ø¬";
  document.getElementById("ssTotal2").textContent = fmt(subtotal+shipping)+" Ø¬";
}


function toggleShipCard(){ const card=document.getElementById("shipCard"); if(!card) return; if(card.style.display!=="none"){card.style.display="none";return;} card.style.display="block"; const hasOv=shipAll.some(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=OVERDUE_MIN;}); const hasFw=shipAll.some(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=FOLLOW_MIN&&d<=FOLLOW_MAX;}); shipTab=hasOv?"overdue":hasFw?"follow":"normal"; setShipTab(shipTab); card.scrollIntoView({behavior:"smooth",block:"start"}); }
function setShipTab(tab){ shipTab=tab; ["normal","follow","overdue"].forEach(t=>{const btn=document.getElementById("tab"+t.charAt(0).toUpperCase()+t.slice(1));if(btn) btn.className="ship-tab"+(t===tab?" tab-"+t:"");}); renderShipTable(); }
function renderShipTable(){
  const tbody=document.getElementById("shipTbody"); if(!tbody) return; tbody.innerHTML="";
  const cf=(document.getElementById("shipCourierFilter")?.value||"").trim();
  let list=shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}));
  list=list.filter(x=>{if(x.days===null) return shipTab==="normal";if(shipTab==="overdue") return x.days>=OVERDUE_MIN;if(shipTab==="follow") return x.days>=FOLLOW_MIN&&x.days<=FOLLOW_MAX;return x.days<FOLLOW_MIN;});
  if(cf) list=list.filter(x=>(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list.sort((a,b)=>{const da=a.days??-1,db=b.days??-1;return shipTab==="normal"?da-db:db-da;});
  
  // âœ… FIX: Update summary with current filtered list (all tab, not just current)
  const allFiltered = shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}))
    .filter(x=>!cf || (String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  updateShipSummary(allFiltered);

  if(!list.length){tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</div></div></td></tr>`;return;}
  list.forEach(x=>{ const r=x.r,isOv=x.days!==null&&x.days>=OVERDUE_MIN,isWrn=!isOv&&x.days!==null&&x.days>=FOLLOW_MIN,dc=isOv?"danger":isWrn?"":"safe"; const tr=document.createElement("tr"); if(isOv) tr.style.background="rgba(192,57,43,.04)"; tr.innerHTML=`<td class="td-id"><b>${esc(r.orderId)}</b></td><td class="td-name">${esc(r.name||"")}</td><td class="td-addr">${addrCell(r)}</td><td>${courierChip(r.courier)}</td><td class="mono" style="font-size:11px;color:var(--silver)">${x.dt?fmtYMD(x.dt):"â€”"}</td><td><span class="days-chip ${dc}">${x.days??"â€”"} ÙŠÙˆÙ…</span></td><td>${statusBadge(r.status)}</td>`; tbody.appendChild(tr); });
}
function buildCourierFilter(list){ const sel=document.getElementById("shipCourierFilter");if(!sel) return; const prev=(sel.value||"").trim(); const arr=[...new Set(list.map(r=>String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"))].sort((a,b)=>a.localeCompare(b,"ar")); sel.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>`+arr.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join(""); if(prev&&arr.includes(prev)) sel.value=prev; else sel.value=""; }
function renderCourierBadges(){ const wrap=document.getElementById("courierBadges");if(!wrap) return; const cur=(document.getElementById("shipCourierFilter")?.value||"").trim(); const names=Object.keys(courierStats).sort((a,b)=>a.localeCompare(b,"ar")); let html=`<button class="c-badge${cur===""?" active":""}" onclick="setCourierFilter('')">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† <span class="c-n">${names.reduce((s,n2)=>s+(courierStats[n2]?.total||0),0)}</span></button>`; names.forEach(nm=>{const st=courierStats[nm]||{total:0,overdue:0};const cls=["c-badge",st.overdue>0?"overdue-c":"",cur===nm?"active":""].filter(Boolean).join(" ");html+=`<button class="${cls}" onclick='setCourierFilter(${JSON.stringify(nm)})'>${esc(nm)} <span class="c-n">${st.total}</span></button>`;}); wrap.innerHTML=html; }
function setCourierFilter(name){ const sel=document.getElementById("shipCourierFilter");if(sel) sel.value=(name||"").trim(); renderCourierBadges();renderShipTable(); }

function printShipCurrent(){
  const cf=(document.getElementById("shipCourierFilter")?.value||"").trim();
  let list=shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}));
  if(cf) list=list.filter(x=>(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  // âœ… FIX: Print ALL shipped (not filtered by tab) but compute totals
  const allForPrint = [...list];
  list=list.filter(x=>{if(x.days===null) return shipTab==="normal";if(shipTab==="overdue") return x.days>=OVERDUE_MIN;if(shipTab==="follow") return x.days>=FOLLOW_MIN&&x.days<=FOLLOW_MAX;return x.days<FOLLOW_MIN;});
  list.sort((a,b)=>{const da=a.days??-1,db=b.days??-1;return shipTab==="normal"?da-db:db-da;});
  if(!list.length){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª","","warn");return;}
  const totalSubtotal = allForPrint.reduce((a,x)=>a+n(x.r.subtotal),0);
  const totalShipping = allForPrint.reduce((a,x)=>a+n(x.r.shipping),0);
  const rowsHtml=list.map(x=>{const r=x.r,isOv=x.days!==null&&x.days>=OVERDUE_MIN;const p1=fmtPhone(r.phone),p2=fmtPhone(r.altPhone);return`<tr style="${isOv?"background:#fff8f8":""}"><td><b>${esc(r.orderId??"")}</b></td><td>${esc(r.name||"")}</td><td>${p2?esc(p1)+" - "+esc(p2):esc(p1)}<br>${esc(r.city||"")} / ${esc(r.address||"")}</td><td>${esc(String(r.courier||""))}</td><td>${x.dt?fmtYMD(x.dt):"â€”"}</td><td style="${isOv?"color:#c0392b;font-weight:800":""}">${x.days??"â€”"} ÙŠÙˆÙ…</td><td>${esc(r.status||"")}</td></tr>`;}).join("");
  const now=new Date().toLocaleString("ar-EG"),tabLabel={overdue:"Ù…ØªØ£Ø®Ø±",follow:"Ù…ØªØ§Ø¨Ø¹Ø©",normal:"Ø·Ø¨ÙŠØ¹ÙŠ"}[shipTab]||"";
  const w=window.open("","_blank");if(!w){toast("Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°","","err");return;}
  w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>Ø´Ø­Ù†Ø§Øª</title><style>
body{font-family:Cairo,Arial,sans-serif;margin:0;padding:12px;background:#fff;color:#000}
h1{font-size:15px;margin:0 0 4px}
.meta{font-size:11px;color:#555;margin-bottom:8px}
.summary-bar{display:flex;gap:16px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:10px 16px;margin-bottom:12px;flex-wrap:wrap}
.sb-item{display:flex;flex-direction:column;align-items:center;min-width:100px}
.sb-val{font-size:18px;font-weight:800;color:#111}
.sb-val.gold{color:#b8941e}
.sb-val.green{color:#27ae60}
.sb-lbl{font-size:9px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-top:2px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:7px 10px;font-size:11px;text-align:right;vertical-align:top}
th{background:#f5f5f5;font-weight:700}
@media print{body{padding:0}.summary-bar{-webkit-print-color-adjust:exact;print-color-adjust:exact}tr,td,th{page-break-inside:avoid}tbody tr{break-inside:avoid}}</style></head><body onload="window.print()">
<h1>ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª â€” ${esc(tabLabel)}</h1>
<div class="meta">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${esc(now)} Â· Ø§Ù„ÙÙ„ØªØ±: ${cf?"Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+esc(cf):"ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†"} Â· Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${list.length}</b></div>
<div class="summary-bar">
  <div class="sb-item"><div class="sb-val">${allForPrint.length}</div><div class="sb-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø§Øª</div></div>
  <div class="sb-item"><div class="sb-val gold">${totalSubtotal.toLocaleString("ar-EG")}</div><div class="sb-lbl">ØªØ­ØµÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†</div></div>
  <div class="sb-item"><div class="sb-val">${totalShipping.toLocaleString("ar-EG")}</div><div class="sb-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†</div></div>
  <div class="sb-item"><div class="sb-val green">${(totalSubtotal+totalShipping).toLocaleString("ar-EG")}</div><div class="sb-lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div></div>
</div>
<table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ/Ù…Ø­Ø§ÙØ¸Ø©/Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${rowsHtml}</tbody></table></body></html>`);
  w.document.close();
}

/* â•â• MODALS â•â• */
function openModal(contentHtml){ const el=document.getElementById("inlineModal"); document.getElementById("inlineModalContent").innerHTML=contentHtml; el.style.display="flex"; }
function closeModal(){ document.getElementById("inlineModal").style.display="none"; }
function showShipModal(){ 
  return new Promise(resolve=>{
    const today=new Date().toISOString().slice(0,10);
    const lastCourier=getLastCourier();
    const couriers=getSavedCouriers();
    const chipsHtml=couriers.map(c=>`<button class="cb-chip${c===lastCourier?" active":""}" onclick="this.closest('.qsc-couriers').querySelectorAll('.cb-chip').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('m_courier').value='${esc(c)}'">${esc(c)}</button>`).join("");
    openModal(`
      <div style="margin-bottom:16px;">
        <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:4px;">ğŸšš ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</div>
        <div style="font-size:11px;color:var(--mist);">Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯ÙŠ Ù…Ø·Ù„ÙˆØ¨Ø© â€” Ù…Ø´ Ù‡ÙŠØªØ³Ø¬Ù„ Ù…Ù† ØºÙŠØ±Ù‡Ø§</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        ${chipsHtml?`<div class="qsc-couriers" style="display:flex;gap:5px;flex-wrap:wrap;">${chipsHtml}</div>`:""}
        <div>
          <div style="font-size:10px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *</div>
          <input id="m_courier" value="${esc(lastCourier)}" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯" style="width:100%;"/>
        </div>
        <div>
          <div style="font-size:10px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† *</div>
          <input id="m_shipDate" type="date" value="${today}" style="width:100%;"/>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px;">
          <button class="btn-gold" style="flex:1;" onclick="_modalShipOk()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</button>
          <button style="flex:1;" onclick="_modalCancel()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
        <div id="m_err" style="color:var(--red);font-size:11px;display:none;margin-top:-4px;"></div>
      </div>
    `);
    setTimeout(()=>{ const el=document.getElementById("m_courier"); if(el){el.focus();if(lastCourier)el.select();} },80);
    window._modalShipOk=()=>{
      const courier=(document.getElementById("m_courier")?.value||"").trim();
      const shipDate=(document.getElementById("m_shipDate")?.value||"").trim();
      const errEl=document.getElementById("m_err");
      if(!courier){errEl.textContent="â›” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨";errEl.style.display="block";return;}
      if(!shipDate){errEl.textContent="â›” Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†";errEl.style.display="block";return;}
      saveCourier(courier);
      closeModal(); resolve({courier,shipDate});
      delete window._modalShipOk; delete window._modalCancel;
    };
    window._modalCancel=()=>{closeModal();resolve(null);delete window._modalShipOk;delete window._modalCancel;};
  });
}
function showDeliveryModal(){ return new Promise(resolve=>{const today=new Date().toISOString().slice(0,10); openModal(`<div style="margin-bottom:16px;"><div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:4px;">ğŸ“¦ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><div style="font-size:11px;color:var(--mist);">Ø§ÙƒØªØ¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div></div><div style="display:flex;flex-direction:column;gap:10px;"><div><div style="font-size:10px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… *</div><input id="m_delivDate" type="date" value="${today}" style="width:100%;"/></div><div style="display:flex;gap:8px;margin-top:6px;"><button class="btn-gold" style="flex:1;" onclick="_modalDelivOk()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</button><button style="flex:1;" onclick="_modalCancel()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`); window._modalDelivOk=()=>{const deliveryDate=(document.getElementById("m_delivDate")?.value||"").trim();if(!deliveryDate){toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…","","err");return;}closeModal();resolve({deliveryDate});delete window._modalDelivOk;delete window._modalCancel;}; window._modalCancel=()=>{closeModal();resolve(null);delete window._modalDelivOk;delete window._modalCancel;}; }); }
function showPartialModal(){ return new Promise(resolve=>{openModal(`<div style="margin-bottom:16px;"><div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:4px;">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</div><div style="font-size:11px;color:var(--mist);">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø¯ÙØ¹Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙØ¹Ù„Ø§Ù‹</div></div><div style="display:flex;flex-direction:column;gap:10px;"><div><div style="font-size:10px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:5px;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</div><input id="m_partial" type="number" placeholder="Ù…Ø«Ø§Ù„: 250" style="width:100%;"/></div><div style="display:flex;gap:8px;margin-top:6px;"><button class="btn-gold" style="flex:1;" onclick="_modalPartOk()">âœ… ØªØ£ÙƒÙŠØ¯</button><button style="flex:1;" onclick="_modalCancel()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`); setTimeout(()=>document.getElementById("m_partial")?.focus(),80); window._modalPartOk=()=>{const amount=(document.getElementById("m_partial")?.value||"").trim();if(!amount){toast("Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº","","err");return;}closeModal();resolve({amount});delete window._modalPartOk;delete window._modalCancel;}; window._modalCancel=()=>{closeModal();resolve(null);delete window._modalPartOk;delete window._modalCancel;}; }); }

/* â•â• NOTIFICATIONS â•â• */
function showDuplicateNotif(orderId, existingOrder){
  const panel=document.getElementById("notifPanel"); if(!panel) return;
  const notifId="dup_"+orderId+"_"+Date.now(), status=existingOrder?existingOrder.status||"â€”":"â€”", name=existingOrder?existingOrder.name||"":"", phone=existingOrder?fmtPhone(existingOrder.phone)||"":"";
  const div=document.createElement("div"); div.id=notifId; div.className="notif-card duplicate";
  div.innerHTML=`<div class="notif-icon">âš ï¸</div><div class="notif-body"><div class="notif-title">Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± â€” ${esc(String(orderId))}</div><div class="notif-sub">${name?"Ø§Ù„Ø§Ø³Ù…: <b>"+esc(name)+"</b><br>":""}${phone?"ğŸ“ "+esc(phone)+"<br>":""}Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${esc(status)}</b></div><div class="notif-actions"><button class="notif-btn gold" onclick="markFollowed('${esc(String(orderId))}','${notifId}')">âœ… ØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button><button class="notif-btn" onclick="dismissNotif('${notifId}')">ØªØ¬Ø§Ù‡Ù„</button></div></div><button class="notif-close" onclick="dismissNotif('${notifId}')">âœ•</button>`;
  panel.appendChild(div); setTimeout(()=>dismissNotif(notifId),30000);
  addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± â€” "+String(orderId), name||status);
}
function showNewOrderNotif(orderId, info={}){
  const panel=document.getElementById("notifPanel");if(!panel) return;
  const notifId="new_"+orderId+"_"+Date.now(); const div=document.createElement("div"); div.id=notifId; div.className="notif-card";
  div.innerHTML=`<div class="notif-icon">ğŸ†•</div><div class="notif-body"><div class="notif-title">Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ â€” ${esc(String(orderId))}</div><div class="notif-sub">${info.name?"Ø§Ù„Ø§Ø³Ù…: <b>"+esc(info.name)+"</b><br>":""}${info.phone?"ğŸ“ "+esc(fmtPhone(info.phone))+"<br>":""}${info.status?"Ø§Ù„Ø­Ø§Ù„Ø©: <b>"+esc(info.status)+"</b>":""}</div><div class="notif-actions"><button class="notif-btn gold" onclick="markFollowed('${esc(String(orderId))}','${notifId}')">âœ… ØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button><button class="notif-btn" onclick="addOrderFromNotif('${esc(String(orderId))}','${notifId}')">â• Ø£Ø¶Ù Ù„Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button><button class="notif-btn" onclick="dismissNotif('${notifId}')">ØªØ¬Ø§Ù‡Ù„</button></div></div><button class="notif-close" onclick="dismissNotif('${notifId}')">âœ•</button>`;
  panel.appendChild(div); setTimeout(()=>dismissNotif(notifId),60000);
  addNotifHistory("ğŸ†•","Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ â€” "+String(orderId), info.name||"");
}
function dismissNotif(id){ const el=document.getElementById(id);if(!el) return; el.style.animation="none";el.style.transition="all .25s ease";el.style.opacity="0";el.style.transform="translateY(-8px) scale(.96)"; setTimeout(()=>el.remove(),280); }
function markFollowed(orderId,notifId){ const followed=getFollowedIds();followed.add(String(orderId));saveFollowedIds(followed);dismissNotif(notifId);toast("ØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©","Order ID: "+orderId,"ok"); }
async function addOrderFromNotif(orderId,notifId){ const id=String(orderId).trim(); if(!mineIds.has(id)){mineIds.add(id);saveMine();recordScanTime(id);const res=await api("scanAdd",{orderId:id});if(res?.ok){toast("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©",id,"ok");await refreshMine();}} dismissNotif(notifId); }

/* âœ… FIX: addOneWithDupCheck â€” respect cancelled status + 24h window */
async function addOneWithDupCheck(){
  const id=document.getElementById("orderIdInput").value.trim(); if(!id) return;
  if(mineIds.has(String(id))){ toast("Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ","","warn"); return; }
  const inCache=allCache.find(r=>String(r.orderId).trim()===String(id));
  const shouldWarnDup = inCache && !isCancelledStatus(inCache.status) && wasScannedRecently(id);
  if(shouldWarnDup){ 
    beepDuplicate(); document.body.classList.add("dup-shake"); setTimeout(()=>document.body.classList.remove("dup-shake"),700); 
    showDuplicateNotif(id,inCache); 
    const proceed=await confirmDupProceed(); 
    if(!proceed) return; 
  }
  mineIds.add(String(id));saveMine();beep();toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±",id,"ok");
  recordScanTime(id);
  const res=await api("scanAdd",{orderId:id}); if(!res?.ok){toast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©",res?.error||"","err");return;}
  document.getElementById("orderIdInput").value="";
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦"); await refreshAll(true); hideLoading();
}

function confirmDupProceed(){ 
  return new Promise(resolve=>{ 
    const panel=document.getElementById("notifPanel"),id="confirm_"+Date.now(),div=document.createElement("div"); 
    div.id=id;div.className="notif-card";div.style.borderColor="rgba(212,150,26,.4)"; 
    div.innerHTML=`<div class="notif-icon">â“</div><div class="notif-body"><div class="notif-title">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ â€” ØªÙƒÙ…Ù‘Ù„ØŸ</div><div class="notif-sub">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø´ÙŠØª. Ø¹Ø§ÙŠØ² ØªØ¶ÙŠÙÙ‡ Ù„Ù‚Ø§Ø¦Ù…ØªÙƒ Ø¨Ø±Ø¯Ù‡ØŸ</div><div class="notif-actions"><button class="notif-btn gold" onclick="_dupResolve('${id}',true)">Ù†Ø¹Ù…ØŒ Ø£Ø¶Ù</button><button class="notif-btn" onclick="_dupResolve('${id}',false)">Ù„Ø£ØŒ Ø¥Ù„ØºØ§Ø¡</button></div></div>`; 
    panel.appendChild(div); 
    window["_dupResolve"]=(nId,val)=>{dismissNotif(nId);resolve(val);delete window["_dupResolve"];}; 
  }); 
}
function toggleAwaitCard(){ const card=document.getElementById("awaitCard");if(!card) return; if(card.style.display!=="none"){card.style.display="none";return;} card.style.display="block"; renderAwaitTable(); card.scrollIntoView({behavior:"smooth",block:"start"}); }
function renderAwaitTable(){
  const tbody=document.getElementById("awaitTbody");if(!tbody) return; tbody.innerHTML="";
  const stats=document.getElementById("awaitStats");if(stats) stats.textContent=awaitOrders.length+" Ø·Ù„Ø¨";
  if(!awaitOrders.length){tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªÙ†ØªØ¸Ø± Ø§Ù„Ø´Ø­Ù†</div></div></td></tr>`;return;}
  awaitOrders.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=`<td class="td-id"><b>${esc(r.orderId)}</b></td><td class="td-name">${esc(r.name||"")}</td><td class="td-addr">${addrCell(r)}</td><td class="td-amount">${fmt(r.subtotal)}</td><td class="mono" style="font-size:11px;color:var(--silver)">${fmt(r.shipping)}</td><td>${statusBadge(r.status)}</td>`;tbody.appendChild(tr);});
}

/* â•â• KEYBOARD â•â• */
document.getElementById("orderIdInput").addEventListener("keydown",e=>{if(e.key==="Enter") addOneWithDupCheck();});
document.getElementById("idx_q").addEventListener("keydown",e=>{if(e.key==="Enter") searchIndex();});

// âœ… Show courier bar when "ØªÙ… Ø§Ù„Ø´Ø­Ù†" is selected
document.getElementById("statusSelect").addEventListener("change",e=>{
  const bar=document.getElementById("courierBar");
  if(!bar) return;
  if(e.target.value==="ØªÙ… Ø§Ù„Ø´Ø­Ù†") renderCourierBar();
  else bar.style.display="none";
});

/* â•â• SCROLL TOP â•â• */
window.addEventListener("scroll",()=>{ const btn=document.getElementById("scrollTopBtn");if(!btn) return; if(window.scrollY>300) btn.classList.add("visible"); else btn.classList.remove("visible"); });

/* â•â• BOOT â•â• */
loadMine(); loadNotifHistory(); pruneDupTimes(); updateBellDot(); renderCourierBar(); render();

// Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ø´ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ­Ù…ÙŠÙ„
const _boot = loadCachedData();
if(_boot && _boot.rows.length){
  processAllRows(_boot.rows);
  // Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ùˆ Ø§Ù„ÙƒØ§Ø´ Ø­Ø¯ÙŠØ«
  if(!_boot.stale){ refreshAll(false); }
  else { showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦"); refreshAll(true).finally(hideLoading); }
} else {
  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øªâ€¦");
  refreshAll(true).finally(hideLoading);
}

// ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ â€” Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¨Ø³ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(()=>refreshAll(true), 60000);
setInterval(pruneDupTimes, 300000);
</script>
</body>
</html>
