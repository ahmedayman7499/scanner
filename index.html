<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scanner + A4 Delivery Sheet</title>

  <!-- QR library (CDN) -->
<script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Arial; margin:16px; background:#0b1220; color:#e8eefc;}
    .card{background:#111a2e; border:1px solid #223055; border-radius:14px; padding:14px; margin-bottom:12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    input,select,button{border-radius:12px; border:1px solid #2b3a67; background:#0e1730; color:#e8eefc; padding:10px 12px;}
    button{cursor:pointer; border:0; background:#2563eb;}
    button.secondary{background:#334155;}
    button.danger{background:#b91c1c;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#1f2a4a; border:1px solid #2b3a67; font-size:12px;}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px;}
    th,td{border-bottom:1px solid #223055; padding:10px; text-align:right; vertical-align:top;}
    th{background:#0e1730; position:sticky; top:0;}
    .muted{opacity:.7}
    .big{font-size:18px; font-weight:700}
    .right{margin-inline-start:auto}
    .no-print{display:block}
    .ok{color:#7CFC98}
    .warn{color:#ffd36a}
    .err{color:#ff7b7b}

@page { size: A4 landscape; margin: 8mm; }

@media print{
  body{background:#fff; color:#000; margin:0; font-size:12px}
  .no-print{display:none !important}
  .card{border:0; background:#fff; padding:0; margin:0}
  table{width:100%; border-collapse:collapse}
  th,td{border:1px solid #ddd; padding:6px 8px; text-align:right; vertical-align:top}
  th{background:#f5f5f5; font-weight:700}
  .print-header{display:block !important}
  .print-summary{display:flex !important; gap:10px; margin:8px 0 12px 0}
  .print-box{border:1px solid #ddd; border-radius:10px; padding:8px 10px; flex:1}
  .print-title{font-size:16px; font-weight:800; margin-bottom:4px}
  .muted{opacity:1}
}

    /* Ø£Ø¹Ù…Ø¯Ø© ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· */
.print-only { display:none; }
@media print { .print-only { display:table-cell; } }
    
/* Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§ Ù…Ø®ÙÙŠÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© */
.print-header, .print-summary { display:none; }

    /* QR frame */
    #qrWrap{display:none; margin-top:12px;}
    #qrBoxOuter{
      position:relative;
      width:100%;
      max-width:520px;
      border-radius:18px;
      border:2px solid #223055;
      overflow:hidden;
      background:#0e1730;
    }
    #qr-reader{width:100%;}
    /* overlay square frame in middle */
    #qrOverlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #qrOverlay .frame{
      width:260px;
      height:260px;
      border-radius:18px;
      border:3px solid rgba(124,252,152,.95);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      position:relative;
    }
    /* corner accents */
    #qrOverlay .frame:before, #qrOverlay .frame:after{
      content:"";
      position:absolute;
      inset:-8px;
      border-radius:22px;
      border:2px dashed rgba(255,211,106,.55);
    }

    /* small toast */
    #toast{
      position:fixed;
      bottom:14px;
      left:14px;
      right:14px;
      max-width:520px;
      margin:auto;
      background:#0e1730;
      border:1px solid #223055;
      border-radius:14px;
      padding:10px 12px;
      display:none;
      z-index:9999;
    }
  </style>
</head>
<body>

<div class="card no-print">
  <div class="row">
    <div class="big">ğŸ“„ ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… A4</div>
    <span class="pill" id="countPill">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„: 0</span>
    <span class="pill" id="sumPill">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†): 0</span>
    <span class="pill right" id="datePill"></span>
  </div>
  <div class="muted" style="margin-top:8px">
    âœ… Ø§Ù„ØµÙØ­Ø© Ø¨ØªÙØªØ­ ÙØ§Ø¶ÙŠØ© â€” Ù‡ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ <b>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØ¹Ù…Ù„Ù‡Ø§ Scan/Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø·</b>.
  </div>
</div>

<div class="card no-print">
  <div class="row">
    <input id="orderIdInput" placeholder="Ø§Ø¯Ø®Ù„ Order ID ÙŠØ¯ÙˆÙŠÙ‹Ø§" />
    <button onclick="addOne()">â• Ø¥Ø¶Ø§ÙØ©</button>

    <button class="secondary" onclick="startScan()">ğŸ“· ØªØ´ØºÙŠÙ„ QR</button>
    <button class="secondary" onclick="stopScan()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>

    <button class="secondary" onclick="refreshMine()">ğŸ”„ ØªØ­Ø¯ÙŠØ« (Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ ÙÙ‚Ø·)</button>
    <button class="danger" onclick="clearMine()">ğŸ§¹ Ù…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button>

    <button onclick="printA4()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4</button>
  </div>

  <div class="row" style="margin-top:10px;">
    <select id="statusSelect">
      <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„ØªØºÙŠÙŠØ± Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©â€¦</option>
      <option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
      <option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
      <option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
      <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
      <option>Ù…Ø±ØªØ¬Ø¹</option>
      <option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option>
      <option>Ø§Ù„ØºØ§Ø¡</option>
    </select>

    <button class="danger" onclick="bulkUpdate()">âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ„</button>

    <span class="muted">* Ø¹Ù†Ø¯ (ØªÙ… Ø§Ù„Ø´Ø­Ù†) Ù‡ÙŠØ·Ù„Ø¨ Ù…Ù†Ø¯ÙˆØ¨ + ØªØ§Ø±ÙŠØ® Ø´Ø­Ù†ØŒ ÙˆØ¹Ù†Ø¯ (Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ) Ù‡ÙŠØ·Ù„Ø¨ Ù…Ø¨Ù„Øº.</span>
  </div>

  <div id="qrWrap">
    <div class="muted" style="margin-bottom:8px">
      ğŸ“Œ Ø­Ø· Ø§Ù„Ù€ QR Ø¬ÙˆÙ‘Ù‡ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®Ø¶Ø±. Ø£ÙˆÙ„ Ù…Ø§ ÙŠÙ„Ù‚Ø·: <b class="ok">ÙŠØ±Ù† ÙÙˆØ±Ù‹Ø§</b> + ÙŠØ¶ÙŠÙ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ØªØ­Øª.
    </div>

    <div id="qrBoxOuter">
      <div id="qr-reader"></div>
      <div id="qrOverlay"><div class="frame"></div></div>
    </div>

    <div class="muted" style="margin-top:8px">
      Ù„Ùˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø´ Ø¨ØªÙØªØ­: Ø¬Ø±Ù‘Ø¨ https Ø¨Ø¯Ù„ httpØŒ ÙˆØ§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.
    </div>
  </div>
</div>

<div class="card no-print">
  <div class="big">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ (Ù„Ùˆ Ù…ÙÙŠØ´ ÙÙˆØ§ØªÙŠØ±)</div>
  <div class="row" style="margin-top:10px;">
    <input id="m_id" placeholder="Order ID" />
    <input id="m_name" placeholder="Ø§Ù„Ø§Ø³Ù…" />
    <input id="m_phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" />
    <input id="m_city" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" />
    <input id="m_addr" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="min-width:280px; flex:1;" />
    <input id="m_sub" placeholder="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†" />
    <button onclick="manualAdd()">ğŸ’¾ Ø­ÙØ¸</button>
  </div>
</div>

<div class="card">
  <div class="print-header">
  <div class="print-title">ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… - A4 (Landscape)</div>
  <div class="muted" id="printDate"></div>
</div>

<div class="print-summary">
  <div class="print-box">
    <div><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</b> <span id="pCount">0</span></div>
    <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†):</b> <span id="pSubtotal">0</span></div>
    <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†:</b> <span id="pShipping">0</span></div>
  </div>

  <div class="print-box">
    <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø¨ÙˆØ¹Ø© Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­</div>
    <div><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</b> ____________</div>
    <div><b>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</b> ____________</div>
  </div>
</div>
  <table>
    <thead>
  <tr>
    <th class="no-print">âœ…</th>
    <th>Order ID</th>
    <th>Ø§Ù„Ø§Ø³Ù…</th>
    <th class="print-only">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th>
    <th class="print-only">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†)</th>
    <th>Ù…ÙˆØ¨Ø§ÙŠÙ„ / Ù…Ø­Ø§ÙØ¸Ø© / Ø¹Ù†ÙˆØ§Ù†</th>
    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†)</th>
    <th class="print-only">Ø§Ù„Ø´Ø­Ù†</th>
    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
  </tr>
</thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div id="toast"></div>

<script>
/** ================== CONFIG ================== **/
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwZ68iM4-HzCpfX3tRrVWzzZQIONDuDO2VKXyKxhRY/exec";
const API_KEY = "123";

/** ================== STATE ================== **/
let rows = [];
let selected = new Set();
let mineIds = new Set();     // IDs scanned/added in this session (persisted)
let qr = null;
let lastScan = { id:"", t:0 };

document.getElementById("datePill").textContent = new Date().toLocaleString("ar-EG");

/** ================== Persistence ================== **/
const LS_KEY = "scanner_mine_ids_v1";
function loadMine(){
  try{
    const arr = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
    mineIds = new Set(arr.map(x => String(x)));
  }catch(e){
    mineIds = new Set();
  }
}
function saveMine(){
  localStorage.setItem(LS_KEY, JSON.stringify(Array.from(mineIds)));
}

/** ================== Toast ================== **/
let toastTimer=null;
function toast(msg, cls=""){
  const el = document.getElementById("toast");
  el.className = cls;
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.style.display="none", 2200);
}

/** ================== BEEP (instant) ================== **/
let audioCtx = null;
function beep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 880; // high pitch
    g.gain.value = 0.07;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
  try{ if(navigator.vibrate) navigator.vibrate([60]); }catch(e){}
}

/** ================== HTTP (GET JSON with fallback JSONP) ================== **/
async function api(action, params={}){
  const qs = new URLSearchParams({ action, key: API_KEY, ...params }).toString();
  const url = WEB_APP_URL + "?" + qs;

  // 1) try fetch (if CORS allows)
  try{
    const res = await fetch(url, { method:"GET" });
    const txt = await res.text();
    // sometimes Apps Script returns HTML on error
    const data = JSON.parse(txt);
    return data;
  }catch(err){
    // 2) fallback JSONP (requires server to support callback; if not, you will see JSONP failed)
    return await jsonp(url);
  }
}

function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      script.remove();
    }
    const script = document.createElement("script");
    // callback param for JSONP (if server supports it)
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    script.onerror = ()=>{ cleanup(); reject(new Error("JSONP failed")); };
    document.body.appendChild(script);
  });
}

/** ================== UI ================== **/
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  let sum = 0;
  rows.forEach(r => sum += Number(r.subtotal||0));

  document.getElementById("countPill").textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„: " + rows.length;
  document.getElementById("sumPill").textContent = "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†): " + sum;

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const checked = selected.has(r.orderId);

    tr.innerHTML = `
  <td class="no-print"><input type="checkbox" ${checked?"checked":""} /></td>
  <td><b>${esc(r.orderId)}</b></td>
  <td>${esc(r.name||"")}</td>
  <td class="print-only">${esc(r.shipDate || "")}</td>
  <td class="print-only"><b>${esc(String(r.subtotal||0))}</b></td>
  <td>${esc((r.phone||"") + " / " + (r.city||"") + " / " + (r.address||""))}</td>
  <td><b>${esc(String(r.subtotal||0))}</b></td>
  <td class="print-only">${esc(String(r.shipping||0))}</td>
  <td>${esc(r.status||"")}</td>
`;

    tr.querySelector("input").addEventListener("change",(e)=>{
      if (e.target.checked) selected.add(r.orderId);
      else selected.delete(r.orderId);
    });

    tbody.appendChild(tr);
  });
}

function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** ================== Core: only show MY scanned IDs ================== **/
async function refreshMine(){
  if (mineIds.size === 0){
    rows = [];
    selected = new Set();
    render();
    toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¹Ù†Ø¯Ùƒ Ù„Ø³Ù‡ â€” Ø§Ø¨Ø¯Ø£ Scan/Ø¥Ø¶Ø§ÙØ©.", "warn");
    return;
  }

  const res = await api("scanList");
  if(!res.ok){ toast(res.error || "Error", "err"); return; }

  const all = res.rows || [];
  const mine = all.filter(r => mineIds.has(String(r.orderId)));

  // order by most recent scanned (based on mineIds order in LS)
  const mineOrder = Array.from(mineIds);
  mine.sort((a,b)=> mineOrder.indexOf(String(b.orderId)) - mineOrder.indexOf(String(a.orderId)));

  rows = mine;
  selected = new Set(rows.map(r=>r.orderId)); // default select all shown
  render();
}

/** ================== Add one (manual Order ID) ================== **/
async function addOne(){
  const id = document.getElementById("orderIdInput").value.trim();
  if(!id) return;

  // add to mine immediately (so it never loads all)
  mineIds.add(String(id));
  saveMine();

  // quick feedback instantly
  beep();
  toast("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø·/Ø¥Ø¶Ø§ÙØ©: " + id, "ok");

  const res = await api("scanAdd", { orderId:id });
  if(!res.ok){
    toast(res.error || "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±", "err");
    return;
  }

  document.getElementById("orderIdInput").value="";
  await refreshMine(); // will show only mine
}

/** ================== Manual minimal add (local only) ================== **/
async function manualAdd(){
  const d = {
    orderId: document.getElementById("m_id").value.trim(),
    name: document.getElementById("m_name").value.trim(),
    phone: document.getElementById("m_phone").value.trim(),
    city: document.getElementById("m_city").value.trim(),
    address: document.getElementById("m_addr").value.trim(),
    subtotal: document.getElementById("m_sub").value.trim(),
  };
  if(!d.orderId) return alert("Ø§ÙƒØªØ¨ Order ID");

  mineIds.add(String(d.orderId));
  saveMine();

  // If you have manualAdd action on server, keep it; otherwise comment this block.
  try{
    const res = await api("manualAdd", d);
    if(!res.ok){ alert(res.error||"Error"); return; }
  }catch(e){
    // ignore if server doesn't support manualAdd
  }

  ["m_id","m_name","m_phone","m_city","m_addr","m_sub"].forEach(id=>document.getElementById(id).value="");
  beep();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙŠØ¯ÙˆÙŠÙ‹Ø§: " + d.orderId, "ok");
  await refreshMine();
}

/** ================== Bulk Update (uses selected in UI) ================== **/
async function bulkUpdate(){
  const status = document.getElementById("statusSelect").value.trim();
  if(!status) return alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø©");

  const ids = Array.from(selected);
  if(ids.length===0) return alert("Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ø¯Ø¯Ø©");

  let courier="", shipDate="", deliveryDate="", partialAmount="";

  if(status === "ØªÙ… Ø§Ù„Ø´Ø­Ù†"){
    courier = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ", "") || "";
    shipDate = prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† (YYYY-MM-DD)ØŸ", new Date().toISOString().slice(0,10)) || "";
    if(!courier) return alert("Ù„Ø§Ø²Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨");
  }

  if(status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"){
    deliveryDate = prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD)ØŸ", new Date().toISOString().slice(0,10)) || "";
  }

  if(status === "Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"){
    partialAmount = prompt("Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹Ù‡ (Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ)ØŸ", "") || "";
    if(!partialAmount) return alert("Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº");
  }

  const res = await api("bulkUpdate", {
  ids: ids.join(","),
  status,
  courier,
  shipDate,
  deliveryDate,
  partialAmount
});

if(!res || !res.ok){
  toast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: " + (res?.error || "Unknown"), "err");
  return;
}

const updatedCount = res.updatedCount ?? ids.length;  // Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ø¨ÙŠØ±Ø¬Ø¹Ù‡Ø§ Ù‡Ù†ÙØªØ±Ø¶ ÙƒÙ„Ù‡Ø§
toast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (${updatedCount}) Ø·Ù„Ø¨`, "ok");

if(res.missing && res.missing.length){
  toast("âš ï¸ Ø·Ù„Ø¨Ø§Øª Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©: " + res.missing.join(","), "warn");
}

await refreshMine();
    ids: ids.join(","),
    status,
    courier,
    shipDate,
    deliveryDate,
    partialAmount
  });

  if(!res.ok){ alert(res.error||"Error"); return; }
  if(res.missing && res.missing.length){
    alert("Ø·Ù„Ø¨Ø§Øª Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©: " + res.missing.join(","));
  }
  toast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© âœ…", "ok");
  await refreshMine();
}

function printA4(){
  window.print();
}

/** ================== QR Scan ================== **/
async function startScan(){
  document.getElementById("qrWrap").style.display = "block";

  if(!qr){
    qr = new Html5Qrcode("qr-reader");
  }

  const config = {
    fps: 15,
    qrbox: { width: 260, height: 260 }, // match overlay square
    aspectRatio: 1.0,
    disableFlip: false
  };

  // pick camera
  let camId = null;
  try{
    const cams = await Html5Qrcode.getCameras();
    if(cams && cams.length){
      // prefer back camera by label
      const back = cams.find(c => /back|rear|environment/i.test(c.label));
      camId = (back || cams[0]).id;
    }
  }catch(e){}

  try{
    await qr.start(
      camId || { facingMode: "environment" },
      config,
      onQrSuccess,
      ()=>{} // ignore scan errors spam
    );
    toast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø© âœ…", "ok");
  }catch(e){
    toast("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e, "err");
  }
}

async function stopScan(){
  document.getElementById("qrWrap").style.display = "none";
  if(qr){
    try{ await qr.stop(); }catch(e){}
  }
  toast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ QR", "warn");
}

async function onQrSuccess(decodedText){
  const now = Date.now();
  const id = String(decodedText || "").trim();

  // extract ID if QR contains extra text
  const clean = id.match(/\d+/) ? (id.match(/\d+/)[0]) : id;
  if(!clean) return;

  // anti-duplicate rapid fire (2 seconds)
  if (lastScan.id === clean && (now - lastScan.t) < 2000) return;
  lastScan = { id: clean, t: now };
  if(mineIds.has(String(clean))){
  toast("âš ï¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ù…ØªØ³Ø¬Ù„ Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„", "warn");
  return;
}

  // instant feedback BEFORE any network
  beep();
  toast("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· QR: " + clean, "ok");

  // add to mine
  mineIds.add(String(clean));
  saveMine();

  // call server to mark Selected
  const res = await api("scanAdd", { orderId: clean });
  if(!res.ok){
    toast("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±: " + (res.error||"Error"), "err");
    return;
  }

  // show it immediately (only mine)
  await refreshMine();
}

/** ================== Mine management ================== **/
function clearMine(){
  if(!confirm("Ù‡ØªÙ…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø© (Ù…Ø´ Ù…Ù† Ø§Ù„Ø´ÙŠØª). Ù…ØªØ£ÙƒØ¯ØŸ")) return;
  mineIds = new Set();
  saveMine();
  rows = [];
  selected = new Set();
  render();
  toast("ØªÙ… Ù…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø©.", "warn");
}

/** ================== Boot ================== **/
loadMine();
// Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­ ÙØ§Ø¶ÙŠØ© â€” Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ¸Ù‡Ø± Ø§Ù„Ù„ÙŠ ÙƒÙ†Øª Ù…Ø§Ø³Ø­Ù‡Ù…/Ù…Ø®Ø²Ù†Ù‡Ù… Ù…Ù† Ù‚Ø¨Ù„ØŒ ÙØ¹Ù‘Ù„ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡:
// refreshMine();
render();

function updatePrintSummary(){
  const count = rows.length;
  const subtotalSum = rows.reduce((a,r)=>a + Number(r.subtotal||0), 0);
  const shippingSum = rows.reduce((a,r)=>a + Number(r.shipping||0), 0);

  document.getElementById("printDate").textContent = "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: " + new Date().toLocaleString("ar-EG");
  document.getElementById("pCount").textContent = count;
  document.getElementById("pSubtotal").textContent = subtotalSum;
  document.getElementById("pShipping").textContent = shippingSum;
}

function printA4(){
  updatePrintSummary();
  window.print();
}
  
</script>
</body>
</html>
