<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>WC â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Cairo:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
:root{
  --ink:#0a0a0a;--ink2:#141414;--ink3:#1e1e1e;--ink4:#2a2a2a;
  --rule:#2e2e2e;--rule2:#3a3a3a;
  --mist:#888;--silver:#aaa;--pearl:#ccc;--ivory:#e8e4dc;--white:#f5f2ed;
  --gold:#c9a84c;--gold2:#b8941e;--gold-faint:rgba(201,168,76,.12);--gold-glow:rgba(201,168,76,.25);
  --red:#c0392b;--red-faint:rgba(192,57,43,.12);
  --green:#27ae60;--green-faint:rgba(39,174,96,.10);
  --amber:#d4961a;--amber-faint:rgba(212,150,26,.12);
  --blue:#3498db;--blue-faint:rgba(52,152,219,.10);
  --purple:#8e44ad;
  --r1:4px;--r2:8px;--r3:16px;--r4:999px;
  --sh1:0 2px 16px rgba(0,0,0,.40);--sh2:0 8px 40px rgba(0,0,0,.55);--sh3:0 20px 80px rgba(0,0,0,.70);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{height:100%;}
body{
  font-family:'Cairo',sans-serif;background:var(--ink);color:var(--ivory);
  min-height:100vh;overflow-x:hidden;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
}
.mono{font-family:'JetBrains Mono',monospace;}

/* â•â• NAV SHELL â•â• */
.nav-shell{position:sticky;top:0;z-index:200;background:rgba(10,10,10,.97);backdrop-filter:blur(20px) saturate(1.4);border-bottom:1px solid var(--rule2);box-shadow:var(--sh2);overflow:visible;}
.nav-shell::before{content:"";position:absolute;top:0;left:20%;right:20%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:.7;}
.nav-top{display:flex;align-items:center;gap:10px;padding:10px 16px 0;flex-wrap:nowrap;}
.brand{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.brand-logo{width:36px;height:36px;border-radius:50%;border:1px solid var(--rule2);background:var(--ink2);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.brand-logo img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.brand-logo-fallback{font-family:'Cormorant Garamond',serif;font-size:14px;font-weight:700;color:var(--ivory);}
.brand-text{line-height:1.1;}
.brand-name{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:700;color:var(--white);letter-spacing:2px;text-transform:uppercase;}
.brand-tag{font-size:8px;color:var(--mist);letter-spacing:2px;text-transform:uppercase;margin-top:1px;}
.nav-metrics{display:flex;gap:6px;align-items:center;margin-inline-start:auto;flex-wrap:wrap;}
.nav-metric{display:inline-flex;flex-direction:column;align-items:center;padding:4px 10px;border-radius:var(--r2);border:1px solid var(--rule);background:rgba(255,255,255,.03);cursor:default;}
.nm-val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600;color:var(--white);}
.nm-lbl{font-size:8px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;}
.clock-nav{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mist);}

/* BELL */
.bell-wrap{position:relative;}
.bell-btn{font-size:15px;padding:6px 10px;background:rgba(255,255,255,.05);border:1px solid var(--rule);border-radius:var(--r2);cursor:pointer;color:var(--silver);min-height:unset;transition:all .15s;}
.bell-btn:hover{background:rgba(255,255,255,.10);color:var(--white);}
.bell-dot{position:absolute;top:-4px;right:-4px;width:10px;height:10px;border-radius:50%;background:var(--red);border:2px solid var(--ink);display:none;}
.bell-dot.active{display:block;animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}

/* NOTIF DRAWER */
#notifDrawer{position:fixed;top:0;left:0;right:0;bottom:0;z-index:9200;pointer-events:none;}
#notifDrawer.open{pointer-events:all;}
.nd-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);opacity:0;transition:opacity .2s;}
#notifDrawer.open .nd-backdrop{opacity:1;}
.nd-panel{position:absolute;top:72px;left:50%;transform:translateX(-50%) translateY(-10px);width:min(420px,92vw);background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);box-shadow:var(--sh3);overflow:hidden;max-height:60vh;display:flex;flex-direction:column;opacity:0;transition:all .25s cubic-bezier(.34,1.2,.64,1);}
#notifDrawer.open .nd-panel{opacity:1;transform:translateX(-50%) translateY(0);}
.nd-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--rule);flex-shrink:0;}
.nd-title{font-family:'Cormorant Garamond',serif;font-size:15px;color:var(--pearl);font-weight:600;}
.nd-clear{font-size:10px;color:var(--mist);background:none;border:none;cursor:pointer;min-height:unset;padding:3px 8px;border-radius:var(--r1);}
.nd-clear:hover{color:var(--silver);background:rgba(255,255,255,.05);}
.nd-list{overflow-y:auto;flex:1;}
.nd-item{display:flex;align-items:flex-start;gap:10px;padding:11px 16px;border-bottom:1px solid var(--rule);}
.nd-item:last-child{border-bottom:none;}
.nd-icon{font-size:18px;flex-shrink:0;margin-top:1px;}
.nd-body{flex:1;min-width:0;}
.nd-txt{font-size:12px;color:var(--ivory);font-weight:600;}
.nd-sub{font-size:10px;color:var(--mist);margin-top:2px;}
.nd-empty{padding:28px;text-align:center;color:var(--mist);font-size:12px;}

/* TAB BAR */
.tab-bar{display:flex;gap:2px;padding:8px 16px 0;overflow-x:auto;scrollbar-width:none;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab-btn{font-family:'Cairo',sans-serif;font-size:11px;font-weight:700;color:var(--mist);background:transparent;border:none;padding:8px 14px;border-radius:var(--r2) var(--r2) 0 0;cursor:pointer;transition:all .18s;white-space:nowrap;display:flex;align-items:center;gap:5px;border-bottom:2px solid transparent;min-height:unset;}
.tab-btn:hover{color:var(--silver);background:rgba(255,255,255,.04);}
.tab-btn.active{color:var(--gold);background:rgba(201,168,76,.08);border-bottom-color:var(--gold);}
.tab-badge{font-family:'JetBrains Mono',monospace;font-size:9px;padding:1px 6px;border-radius:var(--r4);background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);}

/* ACTION BAR */
.action-bar{display:flex;align-items:center;gap:6px;padding:8px 16px;flex-wrap:wrap;border-top:1px solid var(--rule);}
.tb-btn{font-family:'Cairo',sans-serif;font-size:11px;font-weight:700;color:var(--silver);background:rgba(255,255,255,.05);border:1px solid var(--rule);border-radius:var(--r2);padding:7px 12px;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;position:relative;min-height:unset;}
.tb-btn:hover{background:rgba(255,255,255,.08);color:var(--white);}
.tb-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:1px 7px;border-radius:var(--r4);background:rgba(201,168,76,.2);border:1px solid rgba(201,168,76,.3);color:var(--gold);}
@keyframes goldPulse{0%,100%{box-shadow:0 0 0 rgba(201,168,76,0)}50%{box-shadow:0 0 20px var(--gold-glow)}}
.tb-btn.pending-active{color:var(--gold);border-color:rgba(201,168,76,.35);background:var(--gold-faint);animation:goldPulse 2.5s ease-in-out infinite;}
.tb-btn.ship-overdue{color:#e74c3c;border-color:rgba(192,57,43,.35);background:var(--red-faint);}
@keyframes redPulse{0%,100%{box-shadow:0 0 0 rgba(192,57,43,0)}50%{box-shadow:0 0 22px rgba(192,57,43,.3)}}
.tb-btn.ship-overdue{animation:redPulse 2.2s ease-in-out infinite;}
.ship-dot{position:absolute;top:-5px;left:-5px;min-width:17px;height:17px;padding:0 5px;border-radius:var(--r4);background:var(--red);color:#fff;font-size:9px;font-weight:800;display:none;align-items:center;justify-content:center;border:2px solid var(--ink);font-family:'JetBrains Mono',monospace;}

/* TAB PANELS */
.tab-panel{display:none;padding:14px;animation:fadeUp .25s ease;}
.tab-panel.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* CARDS */
.card{background:var(--ink2);border:1px solid var(--rule);border-radius:var(--r3);padding:16px;box-shadow:var(--sh1);margin-bottom:12px;}
.card-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.card-title{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:600;color:var(--pearl);}
.card-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 8px;border-radius:var(--r4);border:1px solid var(--rule);color:var(--silver);background:rgba(255,255,255,.04);margin-inline-start:auto;}
.section-rule{height:1px;background:var(--rule);margin:12px 0;}
.form-section-title{font-family:'Cormorant Garamond',serif;font-size:13px;font-weight:600;color:var(--gold);letter-spacing:1px;padding-bottom:6px;border-bottom:1px solid var(--rule);margin:4px 0 8px;}

/* INPUTS */
input,select,textarea{font-family:'Cairo',sans-serif;font-size:13px;color:var(--ivory);background:var(--ink3);border:1px solid var(--rule);border-radius:var(--r2);padding:9px 13px;outline:none;width:100%;min-height:38px;transition:border-color .18s,box-shadow .18s;}
input::placeholder,textarea::placeholder{color:var(--mist);}
input:focus,select:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-faint);}
select option{background:var(--ink2);}
textarea{min-height:80px;resize:vertical;}
.input-row{display:flex;gap:8px;align-items:center;}
.flex1{flex:1;min-width:0;}
label.field-label{font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;display:block;margin-bottom:4px;}
input[type=checkbox]{width:15px;height:15px;min-height:unset;padding:0;border-radius:3px;accent-color:var(--gold);cursor:pointer;flex-shrink:0;}

/* BUTTONS */
button{font-family:'Cairo',sans-serif;font-size:12px;font-weight:700;color:var(--ivory);background:rgba(255,255,255,.06);border:1px solid var(--rule);border-radius:var(--r2);padding:9px 16px;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap;min-height:38px;letter-spacing:.3px;}
button:hover{background:rgba(255,255,255,.10);border-color:var(--rule2);}
button:active{transform:scale(.97);}
button:disabled{opacity:.4;cursor:not-allowed;transform:none!important;}
.btn-gold{background:linear-gradient(145deg,var(--gold),var(--gold2));border-color:rgba(201,168,76,.4);color:#0a0a0a;font-weight:900;box-shadow:0 4px 18px var(--gold-faint);}
.btn-gold:hover{box-shadow:0 6px 28px var(--gold-glow);transform:translateY(-1px);}
.btn-danger{background:rgba(192,57,43,.15);border-color:rgba(192,57,43,.35);color:#e74c3c;}
.btn-green{background:rgba(39,174,96,.15);border-color:rgba(39,174,96,.35);color:var(--green);}
.btn-blue{background:rgba(52,152,219,.15);border-color:rgba(52,152,219,.35);color:var(--blue);}
.btn-ghost{background:transparent;border-color:var(--rule);font-size:11px;padding:6px 12px;min-height:32px;}
.btn-sm{padding:5px 10px;min-height:28px;font-size:11px;}
.btn-w100{width:100%;}

/* GRIDS */
.form-grid{display:grid;gap:12px;}
.form-grid-2{grid-template-columns:1fr 1fr;}
.form-grid-3{grid-template-columns:1fr 1fr 1fr;}
@media(max-width:700px){.form-grid-2,.form-grid-3{grid-template-columns:1fr;}}

/* KPI TILES */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:14px;}
.kpi-tile{background:var(--ink2);border:1px solid var(--rule);border-radius:var(--r3);padding:14px 16px;position:relative;overflow:hidden;transition:border-color .2s,transform .15s;cursor:default;}
.kpi-tile:hover{border-color:var(--rule2);transform:translateY(-1px);}
.kpi-tile::after{content:"";position:absolute;bottom:0;left:0;right:0;height:2px;border-radius:0 0 var(--r3) var(--r3);}
.kt-gold::after{background:linear-gradient(90deg,var(--gold2),var(--gold));}
.kt-green::after{background:linear-gradient(90deg,#1e8449,var(--green));}
.kt-red::after{background:linear-gradient(90deg,#922b21,var(--red));}
.kt-amber::after{background:linear-gradient(90deg,#b7770d,var(--amber));}
.kt-blue::after{background:linear-gradient(90deg,#1a5276,var(--blue));}
.kt-purple::after{background:linear-gradient(90deg,#6c3483,var(--purple));}
.kpi-icon{font-size:18px;margin-bottom:6px;}
.kpi-val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600;color:var(--white);line-height:1;margin-bottom:4px;}
.kpi-val.kv-gold{color:var(--gold);}.kpi-val.kv-green{color:var(--green);}.kpi-val.kv-red{color:#e74c3c;}
.kpi-val.kv-amber{color:var(--amber);}.kpi-val.kv-blue{color:var(--blue);}.kpi-val.kv-purple{color:var(--purple);}
.kpi-lbl{font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;}
.kpi-sub{font-size:10px;color:var(--mist);margin-top:3px;}

/* TABLE */
.tbl-wrap{width:100%;overflow-x:auto;border-radius:var(--r2);border:1px solid var(--rule);}
table{width:100%;border-collapse:collapse;min-width:600px;}
thead{position:sticky;top:0;z-index:10;}
thead th{background:var(--ink3);border-bottom:1px solid var(--rule2);padding:9px 12px;text-align:right;font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--rule);transition:background .12s;break-inside:avoid;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(255,255,255,.025);}
tbody td{padding:10px 12px;font-size:12px;color:var(--silver);vertical-align:top;}
.td-id{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--gold)!important;}
.td-name{color:var(--ivory)!important;font-weight:600;}
.td-phone{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--pearl)!important;}
.td-amount{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--white)!important;}
.td-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mist)!important;}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:var(--r4);font-size:10px;font-weight:700;border:1px solid;white-space:nowrap;letter-spacing:.3px;}
.badge-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.b-ok{color:var(--green);border-color:rgba(39,174,96,.3);background:var(--green-faint);}
.b-ok .badge-dot{background:var(--green);box-shadow:0 0 5px var(--green);}
.b-warn{color:var(--amber);border-color:rgba(212,150,26,.3);background:var(--amber-faint);}
.b-warn .badge-dot{background:var(--amber);}
.b-err{color:var(--red);border-color:rgba(192,57,43,.3);background:var(--red-faint);}
.b-err .badge-dot{background:var(--red);}
.b-cancel{color:var(--mist);border-color:rgba(136,136,136,.2);background:rgba(136,136,136,.06);}
.b-cancel .badge-dot{background:var(--mist);}

/* CHIPS */
.days-chip{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:2px 9px;border-radius:var(--r4);border:1px solid rgba(212,150,26,.3);background:var(--amber-faint);color:var(--amber);}
.days-chip.danger{border-color:rgba(192,57,43,.3);background:var(--red-faint);color:var(--red);}
.days-chip.safe{border-color:rgba(39,174,96,.25);background:var(--green-faint);color:var(--green);}
.courier-chip{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:var(--r4);font-size:10px;font-weight:600;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);}
.courier-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}

/* PRODUCT ITEMS */
.product-item{background:var(--ink3);border:1px solid var(--rule);border-radius:var(--r2);padding:12px;margin-bottom:10px;}
.product-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.product-item-title{font-size:12px;font-weight:700;color:var(--gold);}
.remove-product-btn{padding:3px 8px;font-size:11px;background:rgba(192,57,43,.15);border-color:rgba(192,57,43,.3);color:var(--red);border-radius:var(--r1);min-height:unset;}

/* QR */
#qrWrap{display:none;margin-top:12px;}
.qr-shell{position:relative;max-width:460px;border-radius:var(--r2);overflow:hidden;border:1px solid var(--rule2);background:#000;}
.qr-overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;}
.qr-frame{width:200px;height:200px;position:relative;}
.qr-frame::before,.qr-frame::after,.qr-br::before,.qr-br::after{content:"";position:absolute;width:22px;height:22px;border-color:var(--gold);border-style:solid;}
.qr-frame::before{top:0;right:0;border-width:2px 2px 0 0;}
.qr-frame::after{top:0;left:0;border-width:2px 0 0 2px;}
.qr-br::before{bottom:0;right:0;border-width:0 2px 2px 0;}
.qr-br::after{bottom:0;left:0;border-width:0 0 2px 2px;}
.qr-scan{position:absolute;left:5%;right:5%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);box-shadow:0 0 8px var(--gold);animation:scan 2s ease-in-out infinite alternate;}
@keyframes scan{from{top:8%}to{top:92%}}

/* COURIER BAR */
.courier-bar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:7px 12px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);margin-bottom:8px;font-size:11px;}
.cb-label{color:var(--mist);flex-shrink:0;}
.cb-chip{padding:3px 10px;border-radius:var(--r4);border:1px solid var(--rule2);background:rgba(255,255,255,.05);color:var(--silver);cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;min-height:unset;}
.cb-chip:hover,.cb-chip.active{background:var(--gold-faint);border-color:rgba(201,168,76,.35);color:var(--gold);}

/* SHIP MONITOR */
.ship-tabs{display:flex;gap:4px;background:rgba(255,255,255,.03);border:1px solid var(--rule);border-radius:var(--r2);padding:3px;width:fit-content;}
.ship-tab{padding:7px 14px;border-radius:var(--r1);font-size:11px;font-weight:700;color:var(--mist);cursor:pointer;transition:all .18s;border:1px solid transparent;background:transparent;min-height:unset;display:flex;align-items:center;gap:6px;letter-spacing:.3px;}
.ship-tab.tab-normal{color:var(--green);background:var(--green-faint);border-color:rgba(39,174,96,.25);}
.ship-tab.tab-follow{color:var(--amber);background:var(--amber-faint);border-color:rgba(212,150,26,.25);}
.ship-tab.tab-overdue{color:var(--red);background:var(--red-faint);border-color:rgba(192,57,43,.25);}
.tab-n{font-family:'JetBrains Mono',monospace;font-size:10px;padding:1px 6px;border-radius:var(--r4);background:rgba(255,255,255,.08);}
.c-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.c-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:var(--r4);border:1px solid var(--rule);background:rgba(255,255,255,.04);cursor:pointer;font-size:11px;font-weight:600;color:var(--silver);transition:all .15s;min-height:unset;}
.c-badge.active{border-color:var(--gold);background:var(--gold-faint);color:var(--gold);}
.c-badge.overdue-c{border-color:rgba(192,57,43,.3);background:var(--red-faint);color:#e74c3c;}
.c-n{font-family:'JetBrains Mono',monospace;font-size:10px;padding:1px 6px;border-radius:var(--r4);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);}
.ship-summary-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:10px;padding:10px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);}
.ssb-item{display:flex;flex-direction:column;align-items:center;gap:2px;}
.ssb-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--white);}
.ssb-val.gold{color:var(--gold);}.ssb-val.green{color:var(--green);}

/* QUICK ACTION BUTTONS */
.qa-wrap{display:flex;gap:4px;flex-wrap:wrap;}
.qa-btn{font-size:10px;font-weight:700;padding:3px 7px;border-radius:var(--r4);border:1px solid var(--rule2);background:rgba(255,255,255,.05);color:var(--silver);cursor:pointer;min-height:unset;transition:all .15s;white-space:nowrap;font-family:'Cairo',sans-serif;}
.qa-btn:hover{background:rgba(255,255,255,.12);color:var(--white);}
.qa-btn.qa-ship{border-color:rgba(243,156,18,.35);color:#f39c12;}
.qa-btn.qa-done{border-color:rgba(39,174,96,.35);color:#27ae60;}
.qa-btn.qa-ret{border-color:rgba(192,57,43,.35);color:var(--red);}
.qa-btn.qa-print{border-color:rgba(201,168,76,.35);color:var(--gold);}
.qa-btn:disabled{opacity:.35;cursor:not-allowed;}

/* PRINT MENU */
#printMenu{position:fixed;z-index:9100;display:none;left:50%;transform:translateX(-50%);min-width:min(300px,92vw);}
#printMenu.open{display:block;animation:menuIn .18s ease;}
@keyframes menuIn{from{opacity:0;transform:translateX(-50%) translateY(-6px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.print-menu-box{background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);box-shadow:var(--sh3);overflow:hidden;padding:6px;}
.pm-header{padding:10px 12px 8px;border-bottom:1px solid var(--rule);margin-bottom:6px;}
.pm-title{font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--pearl);font-weight:600;}
.pm-sub{font-size:10px;color:var(--mist);margin-top:2px;}
.pm-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r2);cursor:pointer;transition:background .15s;border:none;background:transparent;width:100%;text-align:right;color:var(--ivory);font-family:'Cairo',sans-serif;font-size:12px;font-weight:600;min-height:unset;}
.pm-item:hover{background:rgba(255,255,255,.06);}
.pm-count{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;padding:2px 8px;border-radius:var(--r4);border:1px solid var(--rule);background:rgba(255,255,255,.05);color:var(--silver);margin-inline-start:auto;}
.pm-count.gold{border-color:rgba(201,168,76,.35);background:var(--gold-faint);color:var(--gold);}

/* LOADING */
#loadingOverlay{position:fixed;inset:0;background:rgba(10,10,10,.75);backdrop-filter:blur(6px);z-index:9000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
#loadingOverlay.active{display:flex;}
.spinner{width:44px;height:44px;border-radius:50%;border:2px solid var(--rule2);border-top-color:var(--gold);animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--pearl);letter-spacing:2px;}

/* TOAST */
#statusToast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);z-index:8000;pointer-events:none;min-width:280px;max-width:90vw;}
#statusToast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast-box{background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);padding:14px 18px;box-shadow:var(--sh3);display:flex;align-items:center;gap:12px;position:relative;overflow:hidden;}
.toast-icon{font-size:20px;flex-shrink:0;}.toast-body{flex:1;min-width:0;}
.toast-title{font-size:13px;font-weight:700;color:var(--white);}
.toast-sub{font-size:11px;color:var(--silver);margin-top:2px;}
.toast-progress{position:absolute;bottom:0;left:0;height:2px;background:var(--gold);width:100%;transform-origin:left;animation:progressShrink 2.8s linear forwards;}
@keyframes progressShrink{from{transform:scaleX(1)}to{transform:scaleX(0)}}
.toast-box.t-ok{border-color:rgba(39,174,96,.3);}.toast-box.t-ok .toast-progress{background:var(--green);}
.toast-box.t-warn{border-color:rgba(212,150,26,.3);}.toast-box.t-warn .toast-progress{background:var(--amber);}
.toast-box.t-err{border-color:rgba(192,57,43,.3);}.toast-box.t-err .toast-progress{background:var(--red);}

/* MODAL */
#inlineModal{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:9500;display:none;align-items:center;justify-content:center;}
#inlineModal.open{display:flex;}
#inlineModalBox{background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);padding:24px;min-width:340px;max-width:92vw;max-height:90vh;overflow-y:auto;box-shadow:var(--sh3);animation:fadeUp .25s ease;}

/* NOTIF PANEL */
#notifPanel{position:fixed;top:90px;left:50%;transform:translateX(-50%);width:min(480px,94vw);z-index:8500;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.notif-card{background:var(--ink2);border:1px solid rgba(201,168,76,.35);border-radius:var(--r3);padding:12px 16px;box-shadow:var(--sh3);display:flex;align-items:flex-start;gap:12px;pointer-events:all;animation:fadeUp .35s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
.notif-card::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),var(--amber));}
.notif-card.duplicate{border-color:rgba(192,57,43,.40);}.notif-card.duplicate::before{background:linear-gradient(90deg,var(--red),#e74c3c);}
.notif-icon{font-size:22px;flex-shrink:0;}.notif-body{flex:1;min-width:0;}
.notif-title{font-size:13px;font-weight:700;color:var(--white);margin-bottom:3px;}
.notif-sub{font-size:11px;color:var(--silver);line-height:1.5;}
.notif-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.notif-btn{font-size:11px;font-weight:700;padding:5px 12px;border-radius:var(--r4);border:1px solid var(--rule2);background:rgba(255,255,255,.07);color:var(--ivory);cursor:pointer;min-height:unset;transition:all .15s;}
.notif-btn:hover{background:rgba(255,255,255,.13);}
.notif-btn.gold{background:var(--gold-faint);border-color:rgba(201,168,76,.35);color:var(--gold);}
.notif-close{position:absolute;top:8px;left:10px;font-size:14px;color:var(--mist);cursor:pointer;background:none;border:none;min-height:unset;padding:2px 6px;}
@keyframes dupShake{0%,100%{transform:translateX(0)}15%{transform:translateX(-8px)}30%{transform:translateX(8px)}45%{transform:translateX(-6px)}60%{transform:translateX(6px)}75%{transform:translateX(-3px)}90%{transform:translateX(3px)}}
.dup-shake{animation:dupShake .6s ease;}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;padding:40px 20px;gap:8px;color:var(--mist);text-align:center;}
.empty-icon{font-size:32px;opacity:.3;}
.empty-text{font-family:'Cormorant Garamond',serif;font-size:16px;}
.empty-sub{font-size:11px;opacity:.6;}

/* ADDR LINE */
.addr-line{display:flex;flex-wrap:wrap;gap:4px;align-items:baseline;}
.addr-sep{color:var(--rule2);font-size:10px;}

/* SCROLL TOP */
#scrollTopBtn{position:fixed;bottom:24px;left:24px;width:42px;height:42px;border-radius:50%;background:var(--ink2);border:1px solid var(--rule2);color:var(--silver);font-size:16px;cursor:pointer;box-shadow:var(--sh2);display:none;align-items:center;justify-content:center;z-index:300;transition:all .2s;min-height:unset;padding:0;}
#scrollTopBtn:hover{background:var(--ink3);border-color:var(--gold);color:var(--gold);transform:translateY(-2px);}
#scrollTopBtn.visible{display:flex;}
.stock-ok{color:var(--green);font-weight:700;}.stock-low{color:var(--amber);font-weight:700;}.stock-critical{color:var(--red);font-weight:700;}.stock-empty{color:#666;font-weight:700;}

/* PRINT */
.print-header,.print-summary{display:none;}
@page{margin:9mm;size:A4 landscape;}
@media print{
  *,*::before,*::after{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  html,body{background:#fff!important;color:#000!important;margin:0!important;padding:0!important;font-family:'Cairo',Arial,sans-serif!important;}
  .no-print,.nav-shell,button{display:none!important;}
  .tab-panel{display:none!important;}
  #panel-delivery{display:block!important;}
  .card{background:#fff!important;border:none!important;box-shadow:none!important;border-radius:0!important;padding:0!important;margin:0!important;}
  .print-header{display:block!important;margin-bottom:14px!important;padding-bottom:10px!important;border-bottom:2px solid #111!important;}
  .print-title{font-size:20px!important;font-weight:900!important;color:#111!important;letter-spacing:3px!important;text-transform:uppercase!important;}
  .print-summary{display:grid!important;grid-template-columns:1fr 1fr 1fr!important;gap:8px!important;margin:8px 0 14px!important;}
  .print-box{border:1px solid #bbb!important;border-radius:6px!important;padding:12px 16px!important;font-size:12px!important;color:#000!important;background:#fafafa!important;line-height:1.8!important;}
  .tbl-wrap{border:1px solid #ccc!important;overflow:visible!important;}
  table{width:100%!important;min-width:0!important;border-collapse:collapse!important;}
  thead th{position:static!important;background:#111!important;border:1px solid #111!important;color:#fff!important;font-size:10px!important;padding:8px 12px!important;}
  thead th:first-child,tbody td:first-child{display:none!important;}
  tbody td{border:1px solid #ddd!important;padding:8px 10px!important;font-size:11px!important;color:#000!important;background:#fff!important;}
  tbody td *,.td-id,.td-phone,.td-amount,.mono,.td-date{color:#000!important;font-family:'Cairo',Arial,sans-serif!important;}
  .badge{border:1px solid #bbb!important;background:#f5f5f5!important;color:#000!important;font-size:10px!important;padding:2px 8px!important;border-radius:999px!important;display:inline-block!important;}
  .badge-dot{display:none!important;}
  .addr-line{display:block!important;}
  tr,td,th{page-break-inside:avoid!important;break-inside:avoid!important;}
  .card-header,.ship-tabs,.c-badges,.ship-summary-bar,.input-row,.courier-bar{display:none!important;}
  #searchCard,#shipCard,#awaitCard,#dashCard{display:none!important;}
}

@media(max-width:640px){
  .nav-top{padding:8px 10px 0;}
  .tab-bar{padding:6px 10px 0;}
  .tab-panel{padding:10px;}
  .kpi-grid{grid-template-columns:repeat(2,1fr);}
  .brand-tag{display:none;}
  .clock-nav{display:none;}
}
/* Ø¨Ø¹Ø¯ â€” Ø¶ÙŠÙ Ø§Ù„Ø³Ø·Ø±ÙŠÙ† Ø¯ÙˆÙ„ */
@media print{
  .days-chip, .courier-chip { display:none !important; }
}
</style>
</head>
<body>

<!-- â•â• LOADING â•â• -->
<div id="loadingOverlay"><div class="spinner"></div><div class="loading-txt" id="loadingTxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div>

<!-- â•â• TOAST â•â• -->
<div id="statusToast"><div class="toast-box" id="toastBox"><div class="toast-icon" id="toastIcon">âœ…</div><div class="toast-body"><div class="toast-title" id="toastTitle">ØªÙ…</div><div class="toast-sub" id="toastSub"></div></div><div class="toast-progress" id="toastProgress"></div></div></div>

<!-- â•â• NOTIF PANEL (floating cards) â•â• -->
<div id="notifPanel"></div>

<!-- â•â• NOTIF DRAWER (bell) â•â• -->
<div id="notifDrawer">
  <div class="nd-backdrop" onclick="closeNotifDrawer()"></div>
  <div class="nd-panel">
    <div class="nd-header">
      <span class="nd-title">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="nd-clear" onclick="clearNotifHistory()">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        <button class="nd-clear" onclick="closeNotifDrawer()" style="font-size:16px;padding:2px 6px;">âœ•</button>
      </div>
    </div>
    <div class="nd-list" id="ndList"><div class="nd-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div></div>
  </div>
</div>

<!-- â•â• PRINT MENU â•â• -->
<div id="printMenu">
  <div class="print-menu-box">
    <div class="pm-header"><div class="pm-title">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div><div class="pm-sub">Ø§Ø®ØªØ§Ø± Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ·Ø¨Ø¹Ù‡Ø§</div></div>
    <button class="pm-item" onclick="doPrintBatch('new')">ğŸ†• Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©<span class="pm-count gold" id="pmNewCount">0</span></button>
    <button class="pm-item" onclick="doPrintBatch('pending')">ğŸ–¨ï¸ ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©<span class="pm-count gold" id="pmPendingCount">0</span></button>
    <button class="pm-item" onclick="doPrintBatch('both')">ğŸ“‹ Ø§Ù„ÙƒÙ„ (Ø¬Ø¯ÙŠØ¯ + ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©)<span class="pm-count gold" id="pmBothCount">0</span></button>
  </div>
</div>

<!-- â•â• INLINE MODAL â•â• -->
<div id="inlineModal"><div id="inlineModalBox"><div id="inlineModalContent"></div></div></div>

<!-- â•â• NAV SHELL â•â• -->
<div class="nav-shell no-print">
  <div class="nav-top">
    <div class="brand">
      <div class="brand-logo">
        <img src="logo.png" alt="WC" onerror="this.parentElement.innerHTML='<span class=\'brand-logo-fallback\'>WC</span>'">
      </div>
      <div class="brand-text">
        <div class="brand-name">White Clothes</div>
        <div class="brand-tag">Management System</div>
      </div>
    </div>
    <div class="nav-metrics">
      <div class="nav-metric"><div class="nm-val" id="metricOrders">0</div><div class="nm-lbl">Ø·Ù„Ø¨Ø§Øª</div></div>
      <div class="nav-metric"><div class="nm-val" id="metricSubtotal">0</div><div class="nm-lbl">ØªØ­ØµÙŠÙ„</div></div>
      <div class="nav-metric"><div class="nm-val" id="metricShipping">0</div><div class="nm-lbl">Ø´Ø­Ù†</div></div>
      <span class="clock-nav" id="clock"></span>
      <div class="bell-wrap">
        <button class="bell-btn" onclick="toggleNotifDrawer(event)" title="Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª">ğŸ””<span class="bell-dot" id="bellDot"></span></button>
      </div>
    </div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('delivery',this)">ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„ <span class="tab-badge" id="tabDeliveryBadge">0</span></button>
    <button class="tab-btn" onclick="switchTab('order-form',this)">â• Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯</button>
    <button class="tab-btn" onclick="switchTab('edit-order',this)">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆØ±Ø¯Ø±</button>
    <button class="tab-btn" onclick="switchTab('products',this)">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª <span class="tab-badge" id="tabProductsBadge">0</span></button>
    <button class="tab-btn" onclick="switchTab('purchases',this)">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="switchTab('expenses',this)">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
    <button class="tab-btn" onclick="switchTab('treasury',this)">ğŸ’° Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
  </div>
  <div class="action-bar" id="deliveryActionBar">
    <button class="tb-btn" id="printPendingBtn" onclick="togglePrintMenu(event)">ğŸ–¨ï¸ ÙÙˆØ§ØªÙŠØ± <span class="tb-badge" id="pendingTotal">0</span></button>
    <button class="tb-btn" id="awaitBtn" onclick="toggleCard('awaitCard')">ğŸ“¦ Ø§Ù†ØªØ¸Ø§Ø± <span class="tb-badge" id="awaitCountBadge">0</span></button>
    <button class="tb-btn" id="shipBtn" onclick="toggleCard('shipCard')">ğŸšš Ø´Ø­Ù† <span class="tb-badge" id="shipCountBadge">0</span><span class="ship-dot" id="shipDot"></span></button>
    <button class="tb-btn" onclick="showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦');refreshAll(true).finally(hideLoading)">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    <button class="tb-btn" onclick="printA4()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø©</button>
    <button class="tb-btn" onclick="downloadSelectedPDF()">â¬‡ï¸ PDF</button>
    <button class="tb-btn" onclick="downloadAllXLSX()">â¬‡ï¸ Excel</button>
    <div style="margin-inline-start:auto;display:flex;gap:6px;">
      <button class="tb-btn btn-danger" style="border-color:rgba(192,57,43,.3)" onclick="clearMine()">ğŸ§¹ Ù…Ø³Ø­</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• DELIVERY TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel active" id="panel-delivery">

  <!-- DASHBOARD KPIs -->
  <div class="card no-print">
  <div class="kpi-grid" id="dashGrid">
    <div class="kpi-tile kt-gold"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-val kv-gold" id="dTotal">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div></div>
    <div class="kpi-tile kt-green"><div class="kpi-icon">âœ…</div><div class="kpi-val kv-green" id="dDelivered">0</div><div class="kpi-lbl">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</div><div class="kpi-sub" id="dDeliveredAmt">0 Ø¬</div></div>
    <div class="kpi-tile kt-amber"><div class="kpi-icon">ğŸšš</div><div class="kpi-val kv-amber" id="dShipped">0</div><div class="kpi-lbl">ØªÙ… Ø§Ù„Ø´Ø­Ù†</div><div class="kpi-sub" id="dShippedAmt">0 Ø¬</div></div>
    <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸ–¨ï¸</div><div class="kpi-val kv-blue" id="dPrinted">0</div><div class="kpi-lbl">ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</div></div>
    <div class="kpi-tile kt-red"><div class="kpi-icon">â†©ï¸</div><div class="kpi-val kv-red" id="dReturned">0</div><div class="kpi-lbl">Ù…Ø±ØªØ¬Ø¹</div><div class="kpi-sub" id="dReturnedAmt">0 Ø¬</div></div>
    <div class="kpi-tile kt-purple"><div class="kpi-icon">ğŸ’°</div><div class="kpi-val kv-purple" id="dRevenue">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„</div><div class="kpi-sub" id="dRevenueShip">+0 Ø´Ø­Ù†</div></div>
  </div>
  </div>

  <!-- ADD ORDER -->
  <div class="card no-print">
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ“· Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div></div>
    <div class="form-grid form-grid-3" style="margin-bottom:10px;">
      <div><label class="field-label">Order ID ÙŠØ¯ÙˆÙŠ</label>
      
        <div class="input-row"><input id="orderIdInput" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù…Ø³Ø­ QR" class="flex1"/><button class="btn-gold" onclick="addOneWithDupCheck()">Ø¥Ø¶Ø§ÙØ©</button></div></div>
      <div><label class="field-label">QR Scanner</label>
        <div class="input-row"><button style="flex:1" onclick="startScan()">ğŸ“· ØªØ´ØºÙŠÙ„</button><button style="flex:1" onclick="stopScan()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button></div></div>
      <div><label class="field-label">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯</label>
        <div class="input-row">
          <select id="statusSelect" class="flex1"><option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© â€”</option>
            <option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
            <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option><option>Ù…Ø±ØªØ¬Ø¹</option><option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option><option>Ø§Ù„ØºØ§Ø¡</option>
          </select>
          <button class="btn-gold" onclick="bulkUpdate()">âœï¸ ØªØ­Ø¯ÙŠØ«</button>
        </div></div>
    </div>
    <div class="courier-bar" id="courierBar" style="display:none;"><span class="cb-label">ğŸšš Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</span><div id="courierChips" style="display:flex;gap:5px;flex-wrap:wrap;"></div></div>
    <div id="qrWrap"><div style="margin-top:10px;padding:10px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);font-size:11px;color:var(--silver);">ğŸ“Œ Ø¶Ø¹ Ø§Ù„Ù€ QR Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
      <div style="margin-top:10px;"><div class="qr-shell"><div id="qr-reader"></div><div class="qr-overlay"><div class="qr-frame"><div class="qr-br"></div><div class="qr-scan"></div></div></div></div></div>
    </div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div><span class="card-badge" id="indexStats">â³</span></div>
    <div class="input-row"><input id="idx_q" placeholder="Ù…ÙˆØ¨Ø§ÙŠÙ„ / Order ID / Ø§Ø³Ù… / Ù…Ø­Ø§ÙØ¸Ø©â€¦" class="flex1"/><button onclick="searchIndex()">Ø¨Ø­Ø«</button><button onclick="closeSearch()">âœ–ï¸</button></div>
  </div>
  </div>

  <!-- SEARCH RESULTS -->
  <div class="card" id="searchCard" style="display:none;">
    <div class="card-header"><div class="card-title">ğŸ“Œ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div><span class="card-badge" id="srCount"></span></div>
    <div class="input-row" style="margin-bottom:10px;"><button class="btn-ghost" onclick="srToggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button><button class="btn-gold" onclick="srAddToMine()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯</button><button onclick="closeSearch()">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="tbl-wrap"><table><thead><tr><th></th><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="srTbody"></tbody></table></div>
  </div>

  <!-- SHIP MONITOR -->
  <div class="card" id="shipCard" style="display:none;">
    <div class="card-header"><div class="card-title">ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª</div><span class="card-badge" id="shipStats"></span></div>
    <div class="ship-summary-bar">
      <div class="ssb-item"><div class="ssb-val" id="ssTotal">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø§Øª</div></div>
      <div class="ssb-item"><div class="ssb-val gold" id="ssSubtotal">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">ØªØ­ØµÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†</div></div>
      <div class="ssb-item"><div class="ssb-val" id="ssShipping">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†</div></div>
      <div class="ssb-item"><div class="ssb-val green" id="ssTotal2">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div></div>
    </div>
    <div class="input-row" style="flex-wrap:wrap;gap:8px;margin-bottom:10px;">
      <div class="ship-tabs"><button class="ship-tab" id="tabNormal" onclick="setShipTab('normal')">ğŸŸ¢ Ø·Ø¨ÙŠØ¹ÙŠ <span class="tab-n" id="bNormal">0</span></button><button class="ship-tab" id="tabFollow" onclick="setShipTab('follow')">ğŸŸ¡ Ù…ØªØ§Ø¨Ø¹Ø© <span class="tab-n" id="bFollow">0</span></button><button class="ship-tab" id="tabOverdue" onclick="setShipTab('overdue')">ğŸ”´ Ù…ØªØ£Ø®Ø± <span class="tab-n" id="bOverdue">0</span></button></div>
      <select id="shipCourierFilter" style="min-width:160px;flex:1;" onchange="renderShipTable();renderCourierBadges();"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option></select>
      <button onclick="printShipCurrent()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button onclick="toggleCard('shipCard')">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="c-badges" id="courierBadges"></div>
    <div style="margin-top:8px;padding:8px 12px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);font-size:10px;color:var(--mist);">Ù…ØªØ£Ø®Ø± = Ø£ÙƒØ«Ø± Ù…Ù† <b style="color:var(--silver)">10</b> Ø£ÙŠØ§Ù… Â· Ù…ØªØ§Ø¨Ø¹Ø© = <b style="color:var(--silver)">6â€“9</b> Ø£ÙŠØ§Ù…</div>
    <div class="tbl-wrap" style="margin-top:10px;"><table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="shipTbody"></tbody></table></div>
  </div>

  <!-- AWAIT SHIPMENT -->
  <div class="card" id="awaitCard" style="display:none;">
    <div class="card-header"><div class="card-title">ğŸ“¦ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´Ø­Ù†</div><span class="card-badge" id="awaitStats"></span></div>
    <div style="font-size:11px;color:var(--mist);margin-bottom:10px;padding:8px 12px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù„ÙŠ Ø­Ø§Ù„ØªÙ‡Ø§ <b style="color:var(--gold)">ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</b> ÙˆØ¨ØªÙ†ØªØ¸Ø± ÙŠØªØ´Ø­Ù†ÙˆØ§</div>
    <div class="input-row" style="margin-bottom:10px;"><button onclick="toggleCard('awaitCard')">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="awaitTbody"></tbody></table></div>
  </div>

  <!-- PRINT AREA / MY ORDERS -->
  <div class="card" id="printArea">
    <div class="print-header">
      <div class="print-title">ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… â€” White Clothes</div>
      <div id="printDate" style="font-size:12px; color:#333; margin-top:3px;"></div>
    </div>
    <div class="print-summary">
      <div class="print-box">
        <div><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: </b><span id="pCount">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†): </b><span id="pSubtotal">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†: </b><span id="pShipping">0</span></div>
      </div>
      <div class="print-box">
        <div><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø´Ø­Ù†): </b><span id="pTotal">0</span></div>
        <div><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: </b>________________________</div>
        <div><b>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: </b>________________________</div>
      </div>
      <div class="print-box">
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©: </b>Ù…Ø·Ø¨ÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­</div>
        <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®: </b><span id="pDate2"></span></div>
      </div>
    </div>
    <div class="card-header no-print" style="justify-content:space-between; margin-bottom:10px;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span class="card-title">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</span>
        <span class="card-badge" id="selectionInfo">0 Ù…Ø­Ø¯Ø¯</span>
      </div>
      <button class="btn-ghost no-print" id="toggleAllBtn" onclick="toggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="tbl-wrap">
      <table>
        <thead><tr>
          <th class="no-print" style="width:36px;"></th>
          <th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
          <th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th class="no-print">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹</th>
        </tr></thead>
        <tbody id="tbody">
          <tr><td colspan="8"><div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div>
            <div class="empty-sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ù…Ø³Ø­ QR</div>
          </div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div><!-- /panel-delivery -->

<!-- â•â•â•â•â•â•â•â•â•â• ORDER FORM TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-order-form">
  <div class="card">
    <div class="card-header"><div class="card-title">â• Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯</div><span class="card-badge" id="newOrderIdBadge">ID: â€”</span></div>
    <div class="form-section-title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
    <div class="form-grid form-grid-2" style="margin-bottom:14px;">
      <div><label class="field-label">Ø§Ù„Ø§Ø³Ù… *</label><input id="of_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„"/></div>
      <div><label class="field-label">Ø§Ù„Ù…ØµØ¯Ø±</label><select id="of_source"><option value="Direct">Direct</option><option value="Facebook">Facebook</option><option value="TikTok">TikTok</option><option value="Instagram">Instagram</option></select></div>
      <div><label class="field-label">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ *</label><input id="of_phone" placeholder="01xxxxxxxxx" type="tel"/></div>
      <div><label class="field-label">Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ</label><input id="of_phone2" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" type="tel"/></div>
      <div><label class="field-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</label>
        <select id="of_city"><option value="">â€” Ø§Ø®ØªØ± â€”</option>
          <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option><option>Ø§Ù„Ø¬ÙŠØ²Ø©</option><option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option><option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option><option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option><option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option><option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option><option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option><option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option><option>Ø¯Ù…ÙŠØ§Ø·</option><option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option><option>Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option><option>Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option><option>Ø§Ù„Ø³ÙˆÙŠØ³</option><option>Ø§Ù„ÙÙŠÙˆÙ…</option><option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option><option>Ø§Ù„Ù…Ù†ÙŠØ§</option><option>Ø£Ø³ÙŠÙˆØ·</option><option>Ø³ÙˆÙ‡Ø§Ø¬</option><option>Ù‚Ù†Ø§</option><option>Ø§Ù„Ø£Ù‚ØµØ±</option><option>Ø£Ø³ÙˆØ§Ù†</option><option>Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option><option>Ù…Ø·Ø±ÙˆØ­</option>
        </select>
      </div>
      <div><label class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ *</label><input id="of_address" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ ÙˆØ§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©â€¦"/></div>
    </div>
    <div class="form-section-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div id="of_products_container"></div>
    <button class="btn-blue" style="margin-bottom:14px;" onclick="addProductRow('of_products_container','of_prod')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
    <div class="form-section-title">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</div>
    <div class="form-grid form-grid-3" style="margin-bottom:14px;">
      <div><label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="of_payment"><option value="cod">ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</option><option value="transfer_receipt">ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø¨Ù‚</option></select></div>
      <div><label class="field-label">Ø§Ù„Ø´Ø­Ù† (Ø¬)</label><input id="of_shipping" type="number" value="60" min="0" oninput="calcOrderTotal()"/></div>
      <div><label class="field-label">Ø®ØµÙ… (Ø¬)</label><input id="of_discount" type="number" value="0" min="0" oninput="calcOrderTotal()"/></div>
      <div><label class="field-label">ÙƒÙˆØ¨ÙˆÙ†</label><input id="of_coupon" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
      <div style="grid-column:span 2;"><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="of_note" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"/></div>
    </div>
    <div style="background:var(--ink3);border:1px solid var(--rule);border-radius:var(--r2);padding:14px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
        <div style="font-size:12px;color:var(--mist);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <b style="color:var(--white)" id="of_subtotal_display">0 Ø¬</b></div>
        <div style="font-size:12px;color:var(--mist);">Ø§Ù„Ø´Ø­Ù†: <b style="color:var(--white)" id="of_shipping_display">0 Ø¬</b></div>
        <div style="font-size:12px;color:var(--mist);">Ø®ØµÙ…: <b style="color:#e74c3c" id="of_discount_display">0 Ø¬</b></div>
        <div style="font-size:16px;font-weight:900;color:var(--gold);">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <span id="of_total_display">0</span> Ø¬</div>
      </div>
    </div>
    <div class="input-row" style="justify-content:flex-end;gap:10px;">
      <button onclick="resetOrderForm()">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„ÙÙˆØ±Ù…</button>
      <button class="btn-gold" style="min-width:180px;" onclick="submitNewOrder()">âœ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• EDIT ORDER TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-edit-order">
  <div class="card">
    <div class="card-header"><div class="card-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯</div></div>
    <div class="input-row" style="margin-bottom:16px;"><input id="eo_search_id" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ Order ID Ø£Ùˆ Ù…ÙˆØ¨Ø§ÙŠÙ„â€¦" class="flex1"/><button class="btn-gold" onclick="searchOrderForEdit()">ğŸ” Ø¨Ø­Ø«</button></div>
    <div id="eo_empty" style="padding:30px;text-align:center;color:var(--mist);">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆØ±Ø¯Ø± Ø¹Ø´Ø§Ù† ØªØ¹Ø¯Ù„Ù‡</div>
    <div id="eo_result" style="display:none;">
      <div style="background:var(--ink3);border:1px solid var(--gold);border-radius:var(--r2);padding:12px;margin-bottom:14px;">
        <div style="font-size:11px;color:var(--mist);">ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:</div>
        <div style="font-size:14px;font-weight:700;color:var(--gold);margin-top:3px;" id="eo_found_info"></div>
      </div>
      <div class="form-section-title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
      <div class="form-grid form-grid-2" style="margin-bottom:14px;">
        <div><label class="field-label">Ø§Ù„Ø§Ø³Ù…</label><input id="eo_name"/></div>
        <div><label class="field-label">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="eo_phone" type="tel"/></div>
        <div><label class="field-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label><select id="eo_city"><option value="">â€” Ø§Ø®ØªØ± â€”</option><option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option><option>Ø§Ù„Ø¬ÙŠØ²Ø©</option><option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option><option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option><option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option><option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option><option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option><option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option><option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option><option>Ø¯Ù…ÙŠØ§Ø·</option><option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option><option>Ø§Ù„ÙÙŠÙˆÙ…</option><option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option><option>Ø§Ù„Ù…Ù†ÙŠØ§</option><option>Ø£Ø³ÙŠÙˆØ·</option><option>Ø³ÙˆÙ‡Ø§Ø¬</option></select></div>
        <div><label class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="eo_address"/></div>
      </div>
      <div class="form-section-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <div id="eo_products_container" style="margin-bottom:10px;"></div>
      <button class="btn-blue" style="margin-bottom:14px;" onclick="addProductRow('eo_products_container','eo_prod')">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
      <div class="form-section-title">ğŸ“ ØªÙØ§ØµÙŠÙ„</div>
      <div class="form-grid form-grid-3" style="margin-bottom:14px;">
        <div><label class="field-label">Ø§Ù„Ø´Ø­Ù† (Ø¬)</label><input id="eo_shipping" type="number"/></div>
        <div><label class="field-label">Ø®ØµÙ… (Ø¬)</label><input id="eo_discount" type="number" value="0"/></div>
        <div><label class="field-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="eo_status"><option>New</option><option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option><option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option><option>Ù…Ø±ØªØ¬Ø¹</option><option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option><option>Ø§Ù„ØºØ§Ø¡</option></select></div>
        <div style="grid-column:span 3;"><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="eo_note"/></div>
      </div>
      <input type="hidden" id="eo_order_id"/><input type="hidden" id="eo_row_index"/>
      <div class="input-row" style="justify-content:flex-end;gap:10px;">
        <button onclick="document.getElementById('eo_result').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-gold" style="min-width:180px;" onclick="submitEditOrder()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• PRODUCTS TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-products">
  <div class="kpi-grid">
    <div class="kpi-tile kt-gold"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-val kv-gold" id="kpi_total_skus">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ SKUs</div></div>
    <div class="kpi-tile kt-green"><div class="kpi-icon">âœ…</div><div class="kpi-val kv-green" id="kpi_in_stock">0</div><div class="kpi-lbl">Ù…ØªÙˆÙØ±</div></div>
    <div class="kpi-tile kt-amber"><div class="kpi-icon">âš ï¸</div><div class="kpi-val kv-amber" id="kpi_low_stock">0</div><div class="kpi-lbl">Ù‚Ù„ÙŠÙ„ (â‰¤10)</div></div>
    <div class="kpi-tile kt-red"><div class="kpi-icon">âŒ</div><div class="kpi-val kv-red" id="kpi_out_stock">0</div><div class="kpi-lbl">Ù†ÙØ¯</div></div>
    <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸ“Š</div><div class="kpi-val kv-blue" id="kpi_total_sold">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø¹</div></div>
    <div class="kpi-tile kt-purple"><div class="kpi-icon">ğŸ’°</div><div class="kpi-val kv-purple" id="kpi_inv_value">0</div><div class="kpi-lbl">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></div>
  </div>
  <div class="card"><div class="input-row" style="flex-wrap:wrap;gap:8px;">
    <input id="prod_search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ SKUâ€¦" class="flex1" oninput="renderProductsTable()"/>
    <select id="prod_filter_status" onchange="renderProductsTable()" style="min-width:160px;"><option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option><option value="ok">âœ… Ù…ØªÙˆÙØ±</option><option value="low">âš ï¸ Ù‚Ù„ÙŠÙ„</option><option value="empty">âŒ Ù†ÙØ¯</option></select>
    <button class="btn-gold" onclick="loadProducts()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  </div></div>
  <div class="card">
    <div class="card-header">
      <div class="card-title">ğŸ“¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <span class="card-badge" id="prodTableBadge">â€”</span>
      <button class="btn-gold btn-sm" style="margin-inline-start:auto;" onclick="openAddProductModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
    </div>
    <div class="tbl-wrap"><table><thead><tr><th>SKU</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù„ÙˆÙ†</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ù‡Ø§Ù…Ø´ %</th><th>Ø§Ù„Ù…Ø¨Ø§Ø¹</th><th>Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="prodTbody"><tr><td colspan="12"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• PURCHASES TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-purchases">
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±ÙŠØ§Øª</div></div>
    <div class="form-grid form-grid-3" style="margin-bottom:12px;">
      <div><label class="field-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ (SKU)</label><select id="pur_sku" onchange="onPurchaseSKUSelect()"><option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ â€”</option></select></div>
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="pur_product_name" readonly style="background:var(--ink3);color:var(--mist);"/></div>
      <div><label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label><input id="pur_qty" type="number" min="1" value="1" oninput="calcPurchaseTotal()"/></div>
      <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬) *</label><input id="pur_unit_price" type="number" min="0" oninput="calcPurchaseTotal()"/></div>
      <div><label class="field-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¬)</label><input id="pur_total" readonly style="background:var(--ink3);color:var(--gold);font-weight:700;"/></div>
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ *</label><input id="pur_supplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯"/></div>
      <div><label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="pur_method"><option>ÙƒØ§Ø´</option><option>ØªØ­ÙˆÙŠÙ„</option><option>Ø´ÙŠÙƒ</option><option>Ø¢Ø¬Ù„</option></select></div>
      <div><label class="field-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="pur_status"><option>Ù…Ø¯ÙÙˆØ¹</option><option>Ø¬Ø²Ø¦ÙŠ</option><option>Ø¢Ø¬Ù„</option></select></div>
      <div><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="pur_notes" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;"><button onclick="resetPurchaseForm()">ğŸ”„ Ù…Ø³Ø­</button><button class="btn-gold" onclick="submitPurchase()">âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button></div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div><span class="card-badge" id="purTableBadge">â€”</span></div>
    <div class="input-row" style="margin-bottom:10px;"><input id="pur_search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ SKU Ø£Ùˆ Ù…ÙˆØ±Ø¯â€¦" class="flex1" oninput="renderPurchasesTable()"/><button class="btn-gold" onclick="loadPurchases()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>SKU</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="purTbody"><tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø¹Ø¯</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• EXPENSES TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-expenses">
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</div></div>
    <div class="form-grid form-grid-3" style="margin-bottom:12px;">
      <div><label class="field-label">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ *</label><select id="exp_type"><option>Ø¥ÙŠØ¬Ø§Ø±</option><option>Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</option><option>Ø±ÙˆØ§ØªØ¨</option><option>Ø´Ø­Ù†</option><option>Ù…ÙˆØ§Ø¯ ØªØºÙ„ÙŠÙ</option><option>ØµÙŠØ§Ù†Ø©</option><option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØºØ§Ø²</option><option>Ø£Ø¯ÙˆØ§Øª Ù…ÙƒØªØ¨ÙŠØ©</option><option>Ù…ØªÙ†ÙˆØ¹</option></select></div>
      <div><label class="field-label">Ø§Ù„ÙˆØµÙ *</label><input id="exp_desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"/></div>
      <div><label class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬) *</label><input id="exp_amount" type="number" min="0" placeholder="0"/></div>
      <div><label class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="exp_date" type="date"/></div>
      <div><label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="exp_method"><option>ÙƒØ§Ø´</option><option>ØªØ­ÙˆÙŠÙ„</option><option>Ø´ÙŠÙƒ</option></select></div>
      <div><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="exp_notes" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;"><button onclick="resetExpenseForm()">ğŸ”„ Ù…Ø³Ø­</button><button class="btn-gold" onclick="submitExpense()">âœ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button></div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div><span class="card-badge" id="expTableBadge">â€”</span></div>
    <div class="input-row" style="margin-bottom:10px;"><select id="exp_filter_type" onchange="renderExpensesTable()" style="min-width:160px;"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option><option>Ø¥ÙŠØ¬Ø§Ø±</option><option>Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</option><option>Ø±ÙˆØ§ØªØ¨</option><option>Ø´Ø­Ù†</option><option>Ù…ÙˆØ§Ø¯ ØªØºÙ„ÙŠÙ</option><option>Ù…ØªÙ†ÙˆØ¹</option></select><button class="btn-gold" onclick="loadExpenses()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody id="expTbody"><tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ’¸</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• TREASURY TAB â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="panel-treasury">
  <div class="kpi-grid">
    <div class="kpi-tile kt-green"><div class="kpi-icon">ğŸ’°</div><div class="kpi-val kv-green" id="tr_sales">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­ØµÙ‘Ù„Ø©</div><div class="kpi-sub">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙÙ‚Ø·</div></div>
    <div class="kpi-tile kt-red"><div class="kpi-icon">ğŸ›’</div><div class="kpi-val kv-red" id="tr_purchases">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div></div>
    <div class="kpi-tile kt-amber"><div class="kpi-icon">ğŸ’¸</div><div class="kpi-val kv-amber" id="tr_expenses">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div></div>
    <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸšš</div><div class="kpi-val kv-blue" id="tr_shipping_cost">0</div><div class="kpi-lbl">ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†</div></div>
    <div class="kpi-tile kt-gold"><div class="kpi-icon">ğŸ“ˆ</div><div class="kpi-val kv-gold" id="tr_net_profit">0</div><div class="kpi-lbl">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div class="kpi-sub" id="tr_margin">Ù‡Ø§Ù…Ø´: â€”%</div></div>
    <div class="kpi-tile kt-purple"><div class="kpi-icon">â†©ï¸</div><div class="kpi-val kv-purple" id="tr_returns">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</div></div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ“… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><button class="btn-ghost" onclick="loadTreasury()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬)</th><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¬)</th><th>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø¬)</th><th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¬)</th><th>Ù‡Ø§Ù…Ø´ %</th><th>Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (Ø¬)</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¬)</th></tr></thead><tbody id="treasuryTbody"></tbody></table></div>
  </div>
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ“¦ Ù„Ù…Ø­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></div>
    <div class="kpi-grid">
      <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸ’µ</div><div class="kpi-val kv-blue" id="tr_inv_cost">0</div><div class="kpi-lbl">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (ØªÙƒÙ„ÙØ©)</div></div>
      <div class="kpi-tile kt-green"><div class="kpi-icon">ğŸ’</div><div class="kpi-val kv-green" id="tr_inv_sale">0</div><div class="kpi-lbl">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨ÙŠØ¹)</div></div>
      <div class="kpi-tile kt-red"><div class="kpi-icon">âŒ</div><div class="kpi-val kv-red" id="tr_out_stock">0</div><div class="kpi-lbl">Ù…Ù†ØªØ¬Ø§Øª Ù†ÙØ¯Øª</div></div>
      <div class="kpi-tile kt-amber"><div class="kpi-icon">âš ï¸</div><div class="kpi-val kv-amber" id="tr_low_stock">0</div><div class="kpi-lbl">Ù…Ù†ØªØ¬Ø§Øª Ù‚Ù„ÙŠÙ„Ø©</div></div>
    </div>
  </div>
</div>

<button id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})" title="Ù„Ù„Ø£Ø¹Ù„Ù‰">â†‘</button>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHITE CLOTHES â€” FINAL MERGED SYSTEM
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ CONFIG â”€â”€ */
const WEB_APP_URL       = "https://script.google.com/macros/s/AKfycbwsMr7euLyvoHz0Sr_k26N_HJYG_O_W5mb061-ljwm-G6I2n0W_Wjb2aiXCk0hg0HkN/exec";
const WEB_APP_PRINT_URL = "https://script.google.com/macros/s/AKfycbwZ68iM4-HzCpfX3tRrVWzzZQIONDuDO2VKXyKxhRY/exec";
const API_KEY           = "123";
const FOLLOW_MIN=6, FOLLOW_MAX=9, OVERDUE_MIN=10;
const DUP_WINDOW_MS     = 24*60*60*1000;
const CANCELLED_STATUSES= new Set(["Ø§Ù„ØºØ§Ø¡","Ù…Ø±ØªØ¬Ø¹","Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"]);

/* â”€â”€ STATE â”€â”€ */
let rows=[], selected=new Set(), mineIds=new Set();
let allCache=[], shipAll=[], awaitOrders=[];
let shipTabMode="normal", courierStats={};
let productsCache=[], purchasesCache=[], expensesCache=[];
let qrScanner=null, lastScan={id:"",t:0}, scanLockUntil=0;
let srSelected=new Set(), lastResults=[];
let lastKnownIds=new Set();
let notifHistory=[];
let dupTimes={};
let productRowCounter=0;
let _fetchPromise=null;

/* â”€â”€ KEYS â”€â”€ */
const LS_MINE     ="wc_mine_ids_v2";
const LS_CACHE    ="wc_data_cache_v2";
const LS_DUP      ="wc_dup_times_v1";
const LS_COLORS   ="wc_courier_colors";
const LS_NOTIF    ="wc_notif_history_v1";
const LS_COURIERS ="wc_couriers_v1";
const LS_LCOURIER ="wc_last_courier_v1";
const LS_OVERDUE  ="wc_overdue_ids";
const LS_SEEN     ="wc_seen_order_ids_v1";
const LS_FOLLOWED ="wc_followed_ids_v1";

/* â”€â”€ UTILS â”€â”€ */
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function n(v){const x=Number(v);return isNaN(x)?0:x;}
function fmt(v){return n(v).toLocaleString("ar-EG");}
function fmtYMD(dt){return`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;}
function fmtDate(s){if(!s)return"";try{const d=new Date(String(s).replace(/\//g,"-"));if(isNaN(d))return String(s).slice(0,10);return fmtYMD(d);}catch{return String(s).slice(0,10);}}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function nextFrame(){return new Promise(r=>requestAnimationFrame(r));}

/* â”€â”€ CLOCK â”€â”€ */
function tickClock(){const e=document.getElementById("clock");if(e)e.textContent=new Date().toLocaleTimeString("ar-EG");}
tickClock();setInterval(tickClock,1000);

/* â”€â”€ LOADING â”€â”€ */
function showLoading(txt="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"){document.getElementById("loadingTxt").textContent=txt;document.getElementById("loadingOverlay").classList.add("active");}
function hideLoading(){document.getElementById("loadingOverlay").classList.remove("active");}

/* â”€â”€ TOAST â”€â”€ */
let _toastTimer=null;
function toast(title,sub="",type="",dur=2800){
  const el=document.getElementById("statusToast"),box=document.getElementById("toastBox");
  const ic=document.getElementById("toastIcon"),ti=document.getElementById("toastTitle"),ts=document.getElementById("toastSub"),tp=document.getElementById("toastProgress");
  if(!el)return;
  const icons={ok:"âœ…",warn:"âš ï¸",err:"âŒ"};
  if(ic)ic.textContent=icons[type]||"â„¹ï¸";
  if(ti)ti.textContent=title;if(ts)ts.textContent=sub;
  if(box){box.className="toast-box";if(type)box.classList.add("t-"+type);}
  if(tp){tp.style.animation="none";tp.offsetHeight;tp.style.animation=`progressShrink ${dur}ms linear forwards`;}
  el.classList.add("show");clearTimeout(_toastTimer);_toastTimer=setTimeout(()=>el.classList.remove("show"),dur+300);
}

/* â”€â”€ MODAL â”€â”€ */
function openModal(html){const b=document.getElementById("inlineModalContent");if(b)b.innerHTML=html;document.getElementById("inlineModal").classList.add("open");}
function closeModal(){document.getElementById("inlineModal").classList.remove("open");}
document.getElementById("inlineModal").addEventListener("click",e=>{if(e.target===document.getElementById("inlineModal"))closeModal();});

/* â”€â”€ BEEP â”€â”€ */
let _audioCtx=null;
function beep(){try{if(!_audioCtx)_audioCtx=new(window.AudioContext||window.webkitAudioContext)();const o=_audioCtx.createOscillator(),g=_audioCtx.createGain();o.type="sine";o.frequency.value=880;g.gain.value=0.07;o.connect(g);g.connect(_audioCtx.destination);o.start();setTimeout(()=>o.stop(),110);}catch(e){}}
function beepDuplicate(){try{if(!_audioCtx)_audioCtx=new(window.AudioContext||window.webkitAudioContext)();[0,180,360].forEach(d=>{setTimeout(()=>{const o=_audioCtx.createOscillator(),g=_audioCtx.createGain();o.type="sawtooth";o.frequency.value=440;g.gain.value=0.09;o.connect(g);g.connect(_audioCtx.destination);o.start();setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001,_audioCtx.currentTime+.15);o.stop(_audioCtx.currentTime+.16);},140);},d);});}catch(e){}}

/* â”€â”€ API â”€â”€ */
function jsonp(url){return new Promise((res,rej)=>{const cb="cb_"+Math.random().toString(36).slice(2);window[cb]=(data)=>{cleanup();res(data);};function cleanup(){try{delete window[cb];}catch(e){window[cb]=undefined;}script.remove();}const script=document.createElement("script");script.src=url+(url.includes("?")?"&":"?")+`callback=${cb}`;script.onerror=()=>{cleanup();rej(new Error("JSONP fail"));};document.body.appendChild(script);});}
async function api(action,params={}){const qs=new URLSearchParams({action,key:API_KEY,_t:Date.now(),...params}).toString();return jsonp(WEB_APP_URL+"?"+qs);}

/* â”€â”€ PERSISTENCE â”€â”€ */
function saveMine(){try{localStorage.setItem(LS_MINE,JSON.stringify([...mineIds]));}catch{}}
function loadMine(){try{mineIds=new Set((JSON.parse(localStorage.getItem(LS_MINE)||"[]")).map(String));}catch{mineIds=new Set();}}
function saveCachedData(r){try{localStorage.setItem(LS_CACHE,JSON.stringify({rows:r,ts:Date.now()}));}catch{}}
function loadCachedData(){try{const raw=localStorage.getItem(LS_CACHE);if(!raw)return null;const{rows,ts}=JSON.parse(raw);if(!rows?.length)return null;return{rows,ts,stale:(Date.now()-ts)>30000};}catch{return null;}}
function getDupTimes(){try{return JSON.parse(localStorage.getItem(LS_DUP)||"{}");}catch{return{};}}
function saveDupTimes(m){localStorage.setItem(LS_DUP,JSON.stringify(m));}
function recordScanTime(id){const m=getDupTimes();m[String(id)]=Date.now();saveDupTimes(m);}
function wasScannedRecently(id){const m=getDupTimes();const t=m[String(id)];return t?((Date.now()-t)<DUP_WINDOW_MS):false;}
function pruneDupTimes(){const m=getDupTimes();const now=Date.now();Object.keys(m).forEach(k=>{if(now-m[k]>DUP_WINDOW_MS)delete m[k];});saveDupTimes(m);}
function isCancelledStatus(s){return CANCELLED_STATUSES.has(String(s||"").trim());}
function getOldOverdueIds(){try{return JSON.parse(localStorage.getItem(LS_OVERDUE)||"[]");}catch{return[];}}
function setOldOverdueIds(a){localStorage.setItem(LS_OVERDUE,JSON.stringify(a||[]));}
function getSeenIds(){try{return new Set(JSON.parse(localStorage.getItem(LS_SEEN)||"[]"));}catch{return new Set();}}
function saveSeenIds(s){localStorage.setItem(LS_SEEN,JSON.stringify([...s]));}
function getFollowedIds(){try{return new Set(JSON.parse(localStorage.getItem(LS_FOLLOWED)||"[]"));}catch{return new Set();}}
function saveFollowedIds(s){localStorage.setItem(LS_FOLLOWED,JSON.stringify([...s]));}
// â”€â”€ CACHE KEYS â”€â”€
const LS_PRODUCTS  = "wc_products_cache_v1";
const LS_PURCHASES = "wc_purchases_cache_v1";
const LS_EXPENSES  = "wc_expenses_cache_v1";
const LS_TREASURY  = "wc_treasury_cache_v1";

// â”€â”€ SAVE/LOAD HELPERS â”€â”€
function saveCache(key, data){ try{ localStorage.setItem(key, JSON.stringify({data, ts:Date.now()})); }catch(e){} }
function loadCache(key, maxAge=60000){ try{ const raw=localStorage.getItem(key); if(!raw) return null; const {data,ts}=JSON.parse(raw); if(Date.now()-ts > maxAge) return null; return data; }catch(e){ return null; } }

/* â”€â”€ COURIER MEMORY â”€â”€ */
function getSavedCouriers(){try{return JSON.parse(localStorage.getItem(LS_COURIERS)||"[]");}catch{return[];}}
function saveCourier(name){if(!name)return;let list=getSavedCouriers();list=[name,...list.filter(c=>c!==name)].slice(0,8);localStorage.setItem(LS_COURIERS,JSON.stringify(list));localStorage.setItem(LS_LCOURIER,name);renderCourierBar();}
function getLastCourier(){return localStorage.getItem(LS_LCOURIER)||"";}
function setActiveCourier(name){localStorage.setItem(LS_LCOURIER,name);renderCourierBar();}
function renderCourierBar(){
  const bar=document.getElementById("courierBar"),chips=document.getElementById("courierChips");
  if(!bar||!chips)return;
  const list=getSavedCouriers();
  if(!list.length){bar.style.display="none";return;}
  bar.style.display="flex";
  const cur=getLastCourier();
  chips.innerHTML=list.map(c=>`<button class="cb-chip${c===cur?" active":""}" onclick="setActiveCourier('${esc(c)}')">${esc(c)}</button>`).join("");
}

/* â”€â”€ NOTIF HISTORY (Bell) â”€â”€ */
function loadNotifHistory(){try{notifHistory=JSON.parse(localStorage.getItem(LS_NOTIF)||"[]");}catch{notifHistory=[];}}
function saveNotifHistory(){localStorage.setItem(LS_NOTIF,JSON.stringify(notifHistory.slice(0,60)));}
function addNotifHistory(icon,txt,sub=""){notifHistory.unshift({icon,txt,sub,ts:Date.now()});if(notifHistory.length>60)notifHistory.pop();saveNotifHistory();updateBellDot();if(document.getElementById("notifDrawer")?.classList.contains("open"))renderNotifDrawer();}
function clearNotifHistory(){notifHistory=[];saveNotifHistory();updateBellDot();renderNotifDrawer();}
function updateBellDot(){const dot=document.getElementById("bellDot");if(dot)dot.className="bell-dot"+(notifHistory.length>0?" active":"");}
function renderNotifDrawer(){
  const list=document.getElementById("ndList");if(!list)return;
  if(!notifHistory.length){list.innerHTML='<div class="nd-empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</div>';return;}
  const now=Date.now();
  list.innerHTML=notifHistory.map(no=>{
    const mins=Math.round((now-no.ts)/60000);
    const ago=mins<1?"Ø§Ù„Ø¢Ù†":mins<60?mins+" Ø¯Ù‚ÙŠÙ‚Ø©":Math.round(mins/60)+" Ø³Ø§Ø¹Ø©";
    return`<div class="nd-item"><div class="nd-icon">${esc(no.icon)}</div><div class="nd-body"><div class="nd-txt">${esc(no.txt)}</div><div class="nd-sub">${esc(no.sub||"")}${no.sub?" Â· ":""}${ago}</div></div></div>`;
  }).join("");
}
function toggleNotifDrawer(e){e.stopPropagation();const d=document.getElementById("notifDrawer");const isOpen=d.classList.toggle("open");if(isOpen)renderNotifDrawer();}
function closeNotifDrawer(){document.getElementById("notifDrawer")?.classList.remove("open");}

/* â”€â”€ COURIER COLORS â”€â”€ */
function colorFor(name){const m=JSON.parse(localStorage.getItem(LS_COLORS)||"{}");const k=String(name||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";if(!m[k]){let h=0;for(let i=0;i<k.length;i++)h=(h*31+k.charCodeAt(i))>>>0;m[k]=`hsl(${h%360} 60% 55%)`;localStorage.setItem(LS_COLORS,JSON.stringify(m));}return m[k];}
function courierChipHTML(name){const n2=String(name||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯",c=colorFor(n2);return`<span class="courier-chip"><span class="courier-dot" style="background:${c};box-shadow:0 0 5px ${c}80"></span>${esc(n2)}</span>`;}

/* â”€â”€ STATUS BADGE â”€â”€ */
function statusBadge(s){const st=(s||"").trim();if(["ØªÙ… Ø§Ù„Ø´Ø­Ù†","ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"].includes(st))return`<span class="badge b-ok"><span class="badge-dot"></span>${esc(st||"â€”")}</span>`;if(["Ù…Ø±ØªØ¬Ø¹","Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"].includes(st))return`<span class="badge b-err"><span class="badge-dot"></span>${esc(st||"â€”")}</span>`;if(st==="Ø§Ù„ØºØ§Ø¡")return`<span class="badge b-cancel"><span class="badge-dot"></span>${esc(st||"â€”")}</span>`;return`<span class="badge b-warn"><span class="badge-dot"></span>${esc(st||"â€”")}</span>`;}

/* â”€â”€ FORMAT PHONE â”€â”€ */
function fmtPhone(p){const clean=String(p||"").replace(/\s/g,"");if(!clean)return"";if(clean.startsWith("+20"))return"0"+clean.slice(3);if(clean.startsWith("20")&&clean.length>=11)return"0"+clean.slice(2);if(/^1\d{9}$/.test(clean))return"0"+clean;return clean;}

/* â”€â”€ ADDRESS CELL â”€â”€ */
function addrCell(r){const p1=fmtPhone(r.phone||r.phone1),p2=fmtPhone(r.altPhone||r.phone2);const city=String(r.city||"").trim(),addr=String(r.address||"").trim();const phonePart=p2?`${esc(p1)} â€” ${esc(p2)}`:esc(p1);const locPart=[city&&esc(city),addr&&esc(addr)].filter(Boolean).join(" / ");return`<div class="addr-line"><span class="td-phone">${phonePart}</span>${locPart?`<span class="addr-sep">|</span><span style="font-size:11px;color:var(--mist)">${locPart}</span>`:""}</div>`;}

/* â”€â”€ DATE FORMATTER â”€â”€ */
function fmtOrderDate(r){const raw=String(r.orderDate||r.order_date||r.createdDate||r.date||"").trim();if(!raw)return"â€”";const dt=new Date(raw);if(isNaN(dt.getTime()))return raw.slice(0,10)||"â€”";return fmtYMD(dt);}

/* â”€â”€ PARSE SHIP DATE â”€â”€ */
function parseShipDate(r){const raw=String(r.shipDate??r.ship_date??r.shippedDate??r.shipped_date??"").trim();if(!raw)return null;const m=raw.match(/^(\d{4})-(\d{2})-(\d{2})/);if(m){const dt=new Date(`${m[1]}-${m[2]}-${m[3]}T00:00:00`);return isNaN(dt.getTime())?null:dt;}const dt=new Date(raw.replace(/\//g,"-"));return isNaN(dt.getTime())?null:dt;}
function daysSince(dt){if(!dt)return null;return Math.floor((Date.now()-dt.getTime())/86400000);}

/* â”€â”€ FETCH + PROCESS â”€â”€ */
async function fetchAllRows(force=false){
  if(_fetchPromise)return _fetchPromise;
  if(!force){const cached=loadCachedData();if(cached&&!cached.stale)return{ok:true,rows:cached.rows,fromCache:true};}
  _fetchPromise=(async()=>{try{const res=await api("scanList");if(res?.ok&&res.rows)saveCachedData(res.rows);return res;}finally{_fetchPromise=null;}})();
  return _fetchPromise;
}

function processAllRows(all){
  if(!all?.length)return;
  allCache=all;

  // My orders
  const order=[...mineIds];
  const mine=all.filter(r=>mineIds.has(String(r.orderId||r.id||"")));
  mine.sort((a,b)=>order.indexOf(String(b.orderId||b.id||""))-order.indexOf(String(a.orderId||a.id||"")));
  rows=mine;selected=new Set(rows.map(r=>String(r.orderId||r.id||"")));

  // Ship + await
  shipAll=all.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†");
  awaitOrders=all.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");

  // Dashboard
  updateDashboard(all);

 // Print counts
  const archiveOnly=all.filter(r=>r.source==="archive");
  const newOrders=archiveOnly.filter(r=>{const s=String(r.status||"").trim();return s===""||s.toLowerCase()==="new"||s==="Ø¬Ø¯ÙŠØ¯";});
  const underPrint=archiveOnly.filter(r=>String(r.status||"").trim()==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  const total=newOrders.length+underPrint.length;
  const pmN=document.getElementById("pmNewCount"),pmP=document.getElementById("pmPendingCount"),pmB=document.getElementById("pmBothCount"),pt=document.getElementById("pendingTotal");
  if(pmN)pmN.textContent=newOrders.length;if(pmP)pmP.textContent=underPrint.length;if(pmB)pmB.textContent=total;if(pt)pt.textContent=total;
  const ppb=document.getElementById("printPendingBtn");if(ppb)ppb.classList.toggle("pending-active",total>0);
  _pendingCache={newOrders,pending:underPrint};

  // Await badge
  const acb=document.getElementById("awaitCountBadge");if(acb)acb.textContent=awaitOrders.length;
  const awaitBtn=document.getElementById("awaitBtn");
  if(awaitBtn){if(awaitOrders.length){awaitBtn.style.borderColor="rgba(201,168,76,.35)";awaitBtn.style.background="rgba(201,168,76,.08)";awaitBtn.style.color="var(--gold)";}else{awaitBtn.style.borderColor="";awaitBtn.style.background="";awaitBtn.style.color="";}}

  // Ship monitor
  let ov=0,fw=0,nm=0;
  shipAll.forEach(r=>{const d=daysSince(parseShipDate(r));if(d===null){nm++;return;}if(d>=OVERDUE_MIN)ov++;else if(d>=FOLLOW_MIN)fw++;else nm++;});
  const ovIds=shipAll.filter(r=>{const d=daysSince(parseShipDate(r));return d!==null&&d>=OVERDUE_MIN;}).map(r=>String(r.orderId||r.id||""));
  const lastIds=getOldOverdueIds();const newOv=ovIds.filter(id=>!lastIds.includes(id));
  if(newOv.length){const names=new Set(shipAll.filter(r=>newOv.includes(String(r.orderId||r.id||""))).map(r=>String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")));toast("Ù…ØªØ£Ø®Ø± Ø¬Ø¯ÙŠØ¯ ğŸš¨",[...names].join(" ØŒ "),"err",5000);addNotifHistory("ğŸš¨","Ø´Ø­Ù†Ø§Øª Ù…ØªØ£Ø®Ø±Ø©",[...names].join(" ØŒ "));document.body.classList.add("dup-shake");setTimeout(()=>document.body.classList.remove("dup-shake"),600);}
  setOldOverdueIds(ovIds);
  courierStats={};
  shipAll.forEach(r=>{const nm2=String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯";const d=daysSince(parseShipDate(r));if(!courierStats[nm2])courierStats[nm2]={total:0,overdue:0};courierStats[nm2].total++;if(d!==null&&d>=OVERDUE_MIN)courierStats[nm2].overdue++;});
  setShipBtn({total:shipAll.length,follow:fw,overdue:ov});
  const bN=document.getElementById("bNormal"),bF=document.getElementById("bFollow"),bO=document.getElementById("bOverdue");
  if(bN)bN.textContent=nm;if(bF)bF.textContent=fw;if(bO)bO.textContent=ov;
  buildCourierFilter(shipAll);renderCourierBadges();

  // Index stats
  const idxEl=document.getElementById("indexStats");if(idxEl)idxEl.textContent=`âœ… ${all.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`;

  // Render
  render();
  if(document.getElementById("shipCard")?.style.display!=="none")renderShipTable();
  if(document.getElementById("awaitCard")?.style.display!=="none")renderAwaitTable();

  _checkNewOrders(all);
}

let _pendingCache={newOrders:[],pending:[]};

async function refreshAll(force=false){
  const cached=loadCachedData();
  if(cached?.rows?.length)processAllRows(cached.rows);
  if(!force&&cached&&!cached.stale)return;
  try{const res=await fetchAllRows(force);if(res?.ok&&res.rows&&!res.fromCache)processAllRows(res.rows);}
  catch(e){toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err");}
}

/* â”€â”€ NEW ORDER DETECTION â”€â”€ */
function _checkNewOrders(all){
  const currentIds=new Set(all.map(r=>String(r.orderId||r.id||"")));
  const seenIds=getSeenIds();
  
  if(lastKnownIds.size===0){
    all.forEach(r=>lastKnownIds.add(String(r.orderId||r.id||"")));
    all.forEach(r=>seenIds.add(String(r.orderId||r.id||"")));
    saveSeenIds(seenIds);
    return;
  }
  
  const newIds=[...currentIds].filter(id=>!lastKnownIds.has(id));
  
  newIds.forEach(id=>{
    const order=all.find(r=>String(r.orderId||r.id||"")===id);
    if(!order)return;
    
    if(isCancelledStatus(order.status)){
      seenIds.add(id);saveSeenIds(seenIds);lastKnownIds.add(id);return;
    }
    
    // â”€â”€ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ â”€â”€
    if(!seenIds.has(id)){
      const phone=String(order.phone||order.phone1||"").replace(/\D/g,"");
      if(phone){
        const dupOrder=all.find(r=>{
          const rId=String(r.orderId||r.id||"");
          if(rId===id)return false;
          const rPhone=String(r.phone||r.phone1||"").replace(/\D/g,"");
          if(rPhone!==phone)return false;
          // Ù„Ùˆ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„ØªØ§Ù†ÙŠ ÙÙŠ Ø¢Ø®Ø± 24 Ø³Ø§Ø¹Ø©
          const orderDate=new Date(r.orderDate||r.date||0);
          const newOrderDate=new Date(order.orderDate||order.date||0);
          return Math.abs(newOrderDate-orderDate)<DUP_WINDOW_MS;
        });
        
        if(dupOrder){
          // Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¹Ù…ÙŠÙ„
          beepDuplicate();
          showDuplicateNotif(id,{
            ...order,
            name:order.name||order.customer,
            status:order.status,
            dupWith:dupOrder.orderId||dupOrder.id
          });
          addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± â€” "+id,(order.name||"")+" | Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„");
        } else {
          beep();
          showNewOrderNotif(id,{name:order.name||order.customer,phone:order.phone||order.phone1,status:order.status});
          addNotifHistory("ğŸ†•","Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ â€” "+id,order.name||"");
        }
        
        seenIds.add(id);saveSeenIds(seenIds);
      }
    }
    
    lastKnownIds.add(id);
  });
  
  updateDashboard(all);
}

/* â”€â”€ DASHBOARD â”€â”€ */
function updateDashboard(all){
  if(!all?.length)return;
  const s=t=>String(t||"").trim();
  const delivered=all.filter(r=>s(r.status)==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…");
  const shipped=all.filter(r=>s(r.status)==="ØªÙ… Ø§Ù„Ø´Ø­Ù†");
  const printed=all.filter(r=>s(r.status)==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  const returned=all.filter(r=>["Ù…Ø±ØªØ¬Ø¹","Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"].includes(s(r.status)));
  const sum=arr=>arr.reduce((a,r)=>a+n(r.subtotal||r.productTotal||0),0);
  const totalSub=sum(all),totalShip=all.reduce((a,r)=>a+n(r.shipping||0),0);
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set("dTotal",all.length.toLocaleString("ar-EG"));
  set("dDelivered",delivered.length);set("dDeliveredAmt",fmt(sum(delivered))+" Ø¬");
  set("dShipped",shipped.length);set("dShippedAmt",fmt(sum(shipped))+" Ø¬");
  set("dPrinted",printed.length);
  set("dReturned",returned.length);set("dReturnedAmt",fmt(sum(returned))+" Ø¬");
  set("dRevenue",fmt(totalSub));set("dRevenueShip","+"+fmt(totalShip)+" Ø´Ø­Ù†");
  set("dashLastUpdate","Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: "+new Date().toLocaleTimeString("ar-EG"));
}

/* â”€â”€ RENDER MY ORDERS â”€â”€ */
function quickActionBtn(r){
  const s=String(r.status||"").trim(),id=String(r.orderId||r.id||"");
  if(s===""||s==="Ø¬Ø¯ÙŠØ¯"||s.toLowerCase()==="new")return`<div class="qa-wrap"><button class="qa-btn qa-print" onclick="quickUpdate('${id}','ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©')">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>`;
  if(s==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")return`<div class="qa-wrap"><button class="qa-btn qa-print" onclick="quickUpdate('${id}','ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©')">âœ… ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</button></div>`;
  if(s==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©")return`<div class="qa-wrap"><button class="qa-btn qa-ship" onclick="quickShip('${id}')">ğŸšš Ø´Ø­Ù†</button></div>`;
  if(s==="ØªÙ… Ø§Ù„Ø´Ø­Ù†")return`<div class="qa-wrap"><button class="qa-btn qa-done" onclick="quickUpdate('${id}','ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…')">ğŸ“¦ ØªØ³Ù„ÙŠÙ…</button><button class="qa-btn qa-ret" onclick="quickUpdate('${id}','Ù…Ø±ØªØ¬Ø¹')">â†©ï¸</button></div>`;
  if(s==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…")return`<div class="qa-wrap" style="color:var(--mist);font-size:10px;">âœ“ Ù…ÙƒØªÙ…Ù„</div>`;
  if(isCancelledStatus(s))return`<div class="qa-wrap"><button class="qa-btn" onclick="quickUpdate('${id}','Ø¬Ø¯ÙŠØ¯')">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button></div>`;
  return"";
}

function render(){
  updateToggleBtn();
  const tbody=document.getElementById("tbody");tbody.innerHTML="";
  const subSum=rows.reduce((a,r)=>a+n(r.subtotal||r.productTotal||0),0);
  const shipSum=rows.reduce((a,r)=>a+n(r.shipping||0),0);
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set("metricOrders",rows.length);set("metricSubtotal",fmt(subSum));set("metricShipping",fmt(shipSum));
  set("tabDeliveryBadge",rows.length);
  const si=document.getElementById("selectionInfo");if(si)si.textContent=selected.size+" Ù…Ø­Ø¯Ø¯";
  if(!rows.length){tbody.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div><div class="empty-sub">Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ù…Ø³Ø­ QR</div></div></td></tr>`;return;}
  rows.forEach(r=>{
    const id=String(r.orderId||r.id||""),checked=selected.has(id);
    const tr=document.createElement("tr");
    if(checked)tr.style.background="rgba(201,168,76,.04)";
    const sd=parseShipDate(r),days=daysSince(sd);
    let daysHtml="";
    if(String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"&&days!==null){const dc=days>=OVERDUE_MIN?"danger":days>=FOLLOW_MIN?"":"safe";daysHtml=`<div class="days-chip ${dc}" style="margin-top:3px;display:inline-flex;">${days} ÙŠÙˆÙ…</div>`;}
    const courierHtml=r.courier?`<div style="margin-top:3px">${courierChipHTML(r.courier)}</div>`:"";
    tr.innerHTML=`<td class="no-print" style="text-align:center"><input type="checkbox" ${checked?"checked":""}></td>
    <td class="td-id"><b>${esc(id)}</b></td>
    <td class="td-name">${esc(r.name||r.customer||"")}</td>
    <td>${addrCell(r)}</td>
    <td class="td-amount">${fmt(r.subtotal||r.productTotal||0)}</td>
    <td class="mono" style="font-size:11px;color:var(--silver)">${fmt(r.shipping||0)}</td>
    <td>${statusBadge(r.status)}${daysHtml}${courierHtml}</td>
    <td class="td-date no-print">${fmtOrderDate(r)}</td>
    <td class="no-print">${quickActionBtn(r)}</td>`;
    tr.querySelector("input").addEventListener("change",e=>{e.target.checked?selected.add(id):selected.delete(id);if(si)si.textContent=selected.size+" Ù…Ø­Ø¯Ø¯";tr.style.background=e.target.checked?"rgba(201,168,76,.04)":"";updateToggleBtn();});
    tbody.appendChild(tr);
  });
}

function toggleAll(){const allIds=rows.map(r=>String(r.orderId||r.id||""));const allSel=allIds.length&&allIds.every(id=>selected.has(id));if(allSel)selected.clear();else allIds.forEach(id=>selected.add(id));updateToggleBtn();render();}
function updateToggleBtn(){const btn=document.getElementById("toggleAllBtn");if(!btn)return;const allIds=rows.map(r=>String(r.orderId||r.id||""));btn.textContent=(allIds.length&&allIds.every(id=>selected.has(id)))?"Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„":"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„";}

/* â”€â”€ QUICK UPDATE â”€â”€ */
async function quickUpdate(orderId,status){
  const id=String(orderId);
  const prevCache=allCache.map(r=>({...r})),prevRows=rows.map(r=>({...r}));
  allCache=allCache.map(r=>String(r.orderId||r.id||"")===id?{...r,status}:r);
  rows=rows.map(r=>String(r.orderId||r.id||"")===id?{...r,status}:r);
  saveCachedData(allCache);render();toast(status,"Order "+id,"ok",2200);
  if(isCancelledStatus(status)){const m=getDupTimes();delete m[id];saveDupTimes(m);}
  try{const res=await api("bulkUpdate",{ids:id,status,courier:"",shipDate:"",deliveryDate:"",partialAmount:""});if(!res?.ok){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err");return;}refreshAll(true);}
  catch(e){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err");}
}

async function quickShip(orderId){
  const savedCourier=getLastCourier(),today=new Date().toISOString().slice(0,10);
  if(savedCourier){const r=await showQuickShipConfirm(orderId,savedCourier,today);if(!r)return;await _doQuickShip(orderId,r.courier,r.shipDate);}
  else{const r=await showShipModal();if(!r)return;saveCourier(r.courier);await _doQuickShip(orderId,r.courier,r.shipDate);}
}

function showQuickShipConfirm(orderId,defCourier,defDate){
  return new Promise(resolve=>{
    const couriers=getSavedCouriers();
    const chips=couriers.map(c=>`<button class="cb-chip${c===defCourier?" active":""}" onclick="this.closest('.qsc-wrap').querySelectorAll('.cb-chip').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('qsc_courier').value='${esc(c)}'">${esc(c)}</button>`).join("");
    openModal(`<div style="margin-bottom:12px"><div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:3px;">ğŸšš ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</div><div style="font-size:11px;color:var(--mist)">Order ID: <b style="color:var(--silver)">${esc(String(orderId))}</b></div></div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      ${chips?`<div class="qsc-wrap" style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:2px;">${chips}</div>`:""}
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *</label><input id="qsc_courier" value="${esc(defCourier)}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨" style="width:100%;"/></div>
      <div><label class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† *</label><input id="qsc_date" type="date" value="${defDate}" style="width:100%;"/></div>
      <div style="display:flex;gap:8px;margin-top:4px;"><button class="btn-gold" style="flex:1" onclick="_qscOk()">âœ… ØªØ£ÙƒÙŠØ¯</button><button style="flex:1" onclick="_qscCancel()">Ø¥Ù„ØºØ§Ø¡</button></div>
      <div id="qsc_err" style="color:var(--red);font-size:11px;display:none;"></div>
    </div>`);
    setTimeout(()=>document.getElementById("qsc_courier")?.select(),80);
    window._qscOk=()=>{const courier=(document.getElementById("qsc_courier")?.value||"").trim(),shipDate=(document.getElementById("qsc_date")?.value||"").trim(),err=document.getElementById("qsc_err");if(!courier){err.textContent="â›” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨";err.style.display="block";return;}if(!shipDate){err.textContent="â›” Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†";err.style.display="block";return;}saveCourier(courier);closeModal();resolve({courier,shipDate});delete window._qscOk;delete window._qscCancel;};
    window._qscCancel=()=>{closeModal();resolve(null);delete window._qscOk;delete window._qscCancel;};
  });
}

async function _doQuickShip(orderId,courier,shipDate){
  const id=String(orderId);
  const prevCache=allCache.map(r=>({...r})),prevRows=rows.map(r=>({...r}));
  allCache=allCache.map(r=>String(r.orderId||r.id||"")===id?{...r,status:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",courier,shipDate}:r);
  rows=rows.map(r=>String(r.orderId||r.id||"")===id?{...r,status:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",courier,shipDate}:r);
  saveCachedData(allCache);render();toast("ØªÙ… Ø§Ù„Ø´Ø­Ù†","Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+courier,"ok",2500);
  try{const res=await api("bulkUpdate",{ids:id,status:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",courier,shipDate,deliveryDate:"",partialAmount:""});if(!res?.ok){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err");return;}refreshAll(true);}
  catch(e){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err");}
}

/* â”€â”€ BULK UPDATE â”€â”€ */
async function bulkUpdate(){
  const status=document.getElementById("statusSelect").value.trim();
  if(!status){toast("Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹","","warn");return;}
  const ids=[...selected];if(!ids.length){toast("Ù„Ù… ØªØ­Ø¯Ø¯ Ø£ÙŠ Ø£ÙˆØ±Ø¯Ø±Ø§Øª","","warn");return;}
  let courier="",shipDate="",deliveryDate="",partialAmount="";
  if(status==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"){const r=await showShipModal();if(!r){toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","warn");return;}courier=r.courier;shipDate=r.shipDate;if(!courier.trim()||!shipDate.trim()){toast("â›” Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©","","err");return;}}
  if(status==="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"){const r=await showDeliveryModal();if(!r){toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","warn");return;}deliveryDate=r.deliveryDate;if(!deliveryDate.trim()){toast("â›” Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…","","err");return;}}
  if(status==="Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"){const r=await showPartialModal();if(!r){toast("ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡","","warn");return;}partialAmount=r.amount;if(!partialAmount.trim()){toast("â›” Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº","","err");return;}}
  const idSet=new Set(ids.map(String));
  const prevCache=allCache.map(r=>({...r})),prevRows=rows.map(r=>({...r}));
  allCache=allCache.map(r=>idSet.has(String(r.orderId||r.id||""))?{...r,status,courier:courier||r.courier,shipDate:shipDate||r.shipDate}:r);
  rows=rows.map(r=>idSet.has(String(r.orderId||r.id||""))?{...r,status,courier:courier||r.courier,shipDate:shipDate||r.shipDate}:r);
  saveCachedData(allCache);render();toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«",`${ids.length} Ø£ÙˆØ±Ø¯Ø± â€” ${status}`,"ok",3500);
  document.getElementById("statusSelect").value="";
  if(isCancelledStatus(status)){const m=getDupTimes();ids.forEach(id=>delete m[String(id)]);saveDupTimes(m);}
  try{const res=await api("bulkUpdate",{ids:ids.join(","),status,courier,shipDate,deliveryDate,partialAmount});if(!res?.ok){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«","","err");return;}refreshAll(true);}
  catch(e){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err");}
}

function onStatusSelectChange(val){
  const bar=document.getElementById("courierBar");
  if(!bar)return;
  if(val==="ØªÙ… Ø§Ù„Ø´Ø­Ù†")renderCourierBar();else bar.style.display="none";
}

/* â”€â”€ ADD ORDER â”€â”€ */
async function addOneWithDupCheck(){
  const id=(document.getElementById("orderIdInput")?.value||"").trim();if(!id)return;
  if(mineIds.has(String(id))){toast("Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ","","warn");return;}
  const inCache=allCache.find(r=>String(r.orderId||r.id||"").trim()===String(id));
  if(inCache&&!isCancelledStatus(inCache.status)&&wasScannedRecently(id)){
    beepDuplicate();document.body.classList.add("dup-shake");setTimeout(()=>document.body.classList.remove("dup-shake"),700);
    showDuplicateNotif(id,inCache);const proceed=await confirmDupProceed();if(!proceed)return;
  }
  mineIds.add(String(id));saveMine();beep();toast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±",id,"ok");
  recordScanTime(id);
  const res=await api("scanAdd",{orderId:id});if(!res?.ok){toast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©",res?.error||"","err");return;}
  document.getElementById("orderIdInput").value="";
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦");await refreshAll(true);hideLoading();
}

function confirmDupProceed(){
  return new Promise(resolve=>{
    const panel=document.getElementById("notifPanel"),nId="confirm_"+Date.now(),div=document.createElement("div");
    div.id=nId;div.className="notif-card";div.style.borderColor="rgba(212,150,26,.4)";
    div.innerHTML=`<div class="notif-icon">â“</div><div class="notif-body"><div class="notif-title">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ â€” ØªÙƒÙ…Ù‘Ù„ØŸ</div><div class="notif-sub">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø´ÙŠØª. Ø¹Ø§ÙŠØ² ØªØ¶ÙŠÙÙ‡ Ù„Ù‚Ø§Ø¦Ù…ØªÙƒØŸ</div><div class="notif-actions"><button class="notif-btn gold" onclick="_dupResolve('${nId}',true)">Ù†Ø¹Ù…ØŒ Ø£Ø¶Ù</button><button class="notif-btn" onclick="_dupResolve('${nId}',false)">Ù„Ø£ØŒ Ø¥Ù„ØºØ§Ø¡</button></div></div>`;
    panel.appendChild(div);
    window._dupResolve=(nid,val)=>{dismissNotif(nid);resolve(val);delete window._dupResolve;};
  });
}

function clearMine(){if(!confirm("Ù‡ØªÙ…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø© (Ù…Ø´ Ù…Ù† Ø§Ù„Ø´ÙŠØª). Ù…ØªØ£ÙƒØ¯ØŸ"))return;mineIds=new Set();saveMine();rows=[];selected=new Set();render();toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­","","warn");}

/* â”€â”€ QR â”€â”€ */
async function startScan(){
  document.getElementById("qrWrap").style.display="block";
  if(!qrScanner)qrScanner=new Html5Qrcode("qr-reader");
  const cfg={fps:15,qrbox:{width:200,height:200},aspectRatio:1.0};let camId=null;
  try{const cams=await Html5Qrcode.getCameras();if(cams?.length){const bk=cams.find(c=>/back|rear|environment/i.test(c.label));camId=(bk||cams[0]).id;}}catch(e){}
  try{await qrScanner.start(camId||{facingMode:"environment"},cfg,onQrSuccess,()=>{});toast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø©","","ok");}
  catch(e){toast("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§",String(e),"err");}
}
async function stopScan(){document.getElementById("qrWrap").style.display="none";if(qrScanner){try{await qrScanner.stop();}catch(e){}}toast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");}

async function onQrSuccess(txt){
  const now=Date.now();if(now<scanLockUntil)return;
  const raw=String(txt||"").trim();const clean=raw.match(/\d+/)?raw.match(/\d+/)[0]:raw;
  if(!clean)return;if(lastScan.id===clean&&(now-lastScan.t)<3000)return;
  lastScan={id:clean,t:now};scanLockUntil=now+2000;
  if(mineIds.has(String(clean))){beepDuplicate();document.body.classList.add("dup-shake");setTimeout(()=>document.body.classList.remove("dup-shake"),700);const ex=allCache.find(r=>String(r.orderId||r.id||"").trim()===String(clean));showDuplicateNotif(clean,ex||{name:"Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ Ø¨Ø§Ù„ÙØ¹Ù„",status:"â€”"});addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙƒ","ID: "+clean);return;}
  const inCache=allCache.find(r=>String(r.orderId||r.id||"").trim()===String(clean));
  if(inCache&&!isCancelledStatus(inCache.status)&&wasScannedRecently(clean)){beepDuplicate();document.body.classList.add("dup-shake");setTimeout(()=>document.body.classList.remove("dup-shake"),700);showDuplicateNotif(clean,inCache);addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø±","ID: "+clean+" | "+inCache.name);setTimeout(async()=>{mineIds.add(String(clean));saveMine();recordScanTime(clean);await api("scanAdd",{orderId:clean});await refreshAll(true);},600);return;}
  beep();toast("ØªÙ… Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·",clean,"ok");
  mineIds.add(String(clean));saveMine();recordScanTime(clean);
  addNotifHistory("âœ…","ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±","ID: "+clean+(inCache?" | "+(inCache.name||inCache.customer):""));
  const res=await api("scanAdd",{orderId:clean});if(!res?.ok){toast("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©",res?.error||"","err");return;}await refreshAll(true);
}

/* â”€â”€ SEARCH â”€â”€ */
function searchIndex(){
  const q=(document.getElementById("idx_q")?.value||"").trim().toLowerCase();if(!q){closeSearch();return;}
  if(!allCache.length){toast("Ø§Ù„Ø¯Ø§ØªØ§ Ù„Ø³Ù‡ Ø¨ØªØªØ­Ù…Ù‘Ù„","","warn");return;}
  const digits=q.replace(/\D/g,""),isD=digits.length>=4;
  lastResults=allCache.filter(r=>{const h=[r.orderId||r.id,r.name||r.customer,r.phone||r.phone1,r.altPhone||r.phone2,r.city,r.address,r.status].join("|").toLowerCase();if(isD)return String(r.orderId||r.id||"").includes(digits)||String(r.phone||r.phone1||"").includes(digits)||String(r.altPhone||r.phone2||"").includes(digits)||h.includes(q);return h.includes(q);});
  srSelected.clear();renderSearchResults();
  document.getElementById("searchCard")?.scrollIntoView({behavior:"smooth",block:"start"});
}
function renderSearchResults(){
  const card=document.getElementById("searchCard"),tbody=document.getElementById("srTbody"),cnt=document.getElementById("srCount");
  if(!lastResults?.length){if(card)card.style.display="none";return;}
  if(card)card.style.display="block";if(cnt)cnt.textContent=lastResults.length+" Ù†ØªÙŠØ¬Ø©";if(!tbody)return;
  tbody.innerHTML="";
  lastResults.forEach(r=>{const id=String(r.orderId||r.id||""),tr=document.createElement("tr");tr.innerHTML=`<td style="text-align:center"><input type="checkbox" ${srSelected.has(id)?"checked":""}></td><td class="td-id"><b>${esc(id)}</b></td><td class="td-name">${esc(r.name||r.customer||"")}</td><td>${addrCell(r)}</td><td class="td-amount">${fmt(r.subtotal||r.productTotal||0)}</td><td>${statusBadge(r.status)}</td>`;tr.querySelector("input").addEventListener("change",e=>{e.target.checked?srSelected.add(id):srSelected.delete(id);});tbody.appendChild(tr);});
}
function srToggleAll(){ if(!lastResults?.length) return; const allIds=lastResults.map(r=>String(r.orderId)); const allSel=allIds.every(id=>srSelected.has(id)); if(allSel) srSelected.clear(); else allIds.forEach(id=>srSelected.add(id)); renderSearchResults(); }
function closeSearch(){ lastResults=[];srSelected.clear();document.getElementById("searchCard").style.display="none";document.getElementById("srTbody").innerHTML="";document.getElementById("idx_q").value="";document.getElementById("indexStats").textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`; }
async function srAddToMine(){ const ids=[...srSelected]; if(!ids.length){toast("Ø­Ø¯Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø£ÙˆÙ„Ø§Ù‹","","warn");return;} let added=0; ids.forEach(id=>{if(!mineIds.has(String(id))){mineIds.add(String(id));added++;}}); saveMine(); toast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${added} Ø£ÙˆØ±Ø¯Ø±`,"","ok"); closeSearch(); showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦"); await refreshMine(); hideLoading(); }
document.getElementById("idx_q").addEventListener("input",()=>{ const q=document.getElementById("idx_q").value.trim().toLowerCase(); const el=document.getElementById("indexStats"); if(!q){el.textContent=`âœ… ${allCache.length.toLocaleString("ar-EG")} Ø£ÙˆØ±Ø¯Ø±`;return;} const cnt=allCache.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q))).length; el.textContent=`ğŸ” ${cnt.toLocaleString("ar-EG")} Ù…ØªÙˆÙ‚Ø¹`; });


/* â”€â”€ SHIP MONITOR â”€â”€ */
function setShipBtn({total=0,follow=0,overdue=0}){
  const btn=document.getElementById("shipBtn"),dot=document.getElementById("shipDot");
  const scb=document.getElementById("shipCountBadge");if(scb)scb.textContent=total;
  if(btn)btn.className="tb-btn"+(overdue>0?" ship-overdue":follow>0?" ship-follow":"");
  if(dot){if(overdue>0){dot.textContent=overdue;dot.style.display="inline-flex";}else dot.style.display="none";}
}

function toggleCard(id){const el=document.getElementById(id);if(!el)return;if(el.style.display!=="none"){el.style.display="none";return;}el.style.display="block";if(id==="shipCard"){renderShipTable();if(!document.getElementById("tabOverdue")?.classList.contains("tab-overdue")&&!document.getElementById("tabFollow")?.classList.contains("tab-follow"))setShipTab("normal");}if(id==="awaitCard")renderAwaitTable();el.scrollIntoView({behavior:"smooth",block:"start"});}

function setShipTab(tab){shipTabMode=tab;["normal","follow","overdue"].forEach(t=>{const btn=document.getElementById("tab"+t.charAt(0).toUpperCase()+t.slice(1));if(btn)btn.className="ship-tab"+(t===tab?" tab-"+t:"");});renderShipTable();}

function renderShipTable(){
  const tbody=document.getElementById("shipTbody");if(!tbody)return;tbody.innerHTML="";
  const cf=(document.getElementById("shipCourierFilter")?.value||"").trim();
  let list=shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}));
  const allFiltered=list.filter(x=>!cf||(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list=list.filter(x=>{if(x.days===null)return shipTabMode==="normal";if(shipTabMode==="overdue")return x.days>=OVERDUE_MIN;if(shipTabMode==="follow")return x.days>=FOLLOW_MIN&&x.days<=FOLLOW_MAX;return x.days<FOLLOW_MIN;});
  if(cf)list=list.filter(x=>(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list.sort((a,b)=>{const da=a.days??-1,db=b.days??-1;return shipTabMode==="normal"?da-db:db-da;});
  // Summary
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  const sub=allFiltered.reduce((a,x)=>a+n(x.r.subtotal||x.r.productTotal||0),0);
  const ship=allFiltered.reduce((a,x)=>a+n(x.r.shipping||0),0);
  set("ssTotal",allFiltered.length.toLocaleString("ar-EG"));set("ssSubtotal",fmt(sub)+" Ø¬");set("ssShipping",fmt(ship)+" Ø¬");set("ssTotal2",fmt(sub+ship)+" Ø¬");
  const ss=document.getElementById("shipStats");if(ss)ss.textContent=list.length+" Ø´Ø­Ù†Ø© | "+allFiltered.length+" Ø¥Ø¬Ù…Ø§Ù„ÙŠ";
  if(!list.length){tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</div></div></td></tr>`;return;}
  list.forEach(x=>{const r=x.r,isOv=x.days!==null&&x.days>=OVERDUE_MIN,isWrn=!isOv&&x.days!==null&&x.days>=FOLLOW_MIN,dc=isOv?"danger":isWrn?"":"safe";const tr=document.createElement("tr");if(isOv)tr.style.background="rgba(192,57,43,.04)";tr.innerHTML=`<td class="td-id"><b>${esc(r.orderId||r.id||"")}</b></td><td class="td-name">${esc(r.name||r.customer||"")}</td><td>${addrCell(r)}</td><td>${courierChipHTML(r.courier)}</td><td class="mono" style="font-size:11px;color:var(--silver)">${x.dt?fmtYMD(x.dt):"â€”"}</td><td><span class="days-chip ${dc}">${x.days??"â€”"} ÙŠÙˆÙ…</span></td><td>${statusBadge(r.status)}</td>`;tbody.appendChild(tr);});
}

function buildCourierFilter(list){const sel=document.getElementById("shipCourierFilter");if(!sel)return;const prev=(sel.value||"").trim();const arr=[...new Set(list.map(r=>String(r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"))].sort((a,b)=>a.localeCompare(b,"ar"));sel.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>`+arr.map(nm=>`<option value="${esc(nm)}">${esc(nm)}</option>`).join("");if(prev&&arr.includes(prev))sel.value=prev;else sel.value="";}
function renderCourierBadges(){const wrap=document.getElementById("courierBadges");if(!wrap)return;const cur=(document.getElementById("shipCourierFilter")?.value||"").trim();const names=Object.keys(courierStats).sort((a,b)=>a.localeCompare(b,"ar"));let html=`<button class="c-badge${cur===""?" active":""}" onclick="setCourierFilter('')">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ† <span class="c-n">${names.reduce((s,nm)=>s+(courierStats[nm]?.total||0),0)}</span></button>`;names.forEach(nm=>{const st=courierStats[nm]||{total:0,overdue:0};const cls=["c-badge",st.overdue>0?"overdue-c":"",cur===nm?"active":""].filter(Boolean).join(" ");html+=`<button class="${cls}" onclick='setCourierFilter(${JSON.stringify(nm)})'>${esc(nm)} <span class="c-n">${st.total}</span></button>`;});wrap.innerHTML=html;}
function setCourierFilter(name){const sel=document.getElementById("shipCourierFilter");if(sel)sel.value=(name||"").trim();renderCourierBadges();renderShipTable();}

function printShipCurrent(){
  const cf=(document.getElementById("shipCourierFilter")?.value||"").trim();
  let list=shipAll.map(r=>({r,dt:parseShipDate(r),days:daysSince(parseShipDate(r))}));
  const allForPrint=list.filter(x=>!cf||(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list=list.filter(x=>{if(x.days===null)return shipTabMode==="normal";if(shipTabMode==="overdue")return x.days>=OVERDUE_MIN;if(shipTabMode==="follow")return x.days>=FOLLOW_MIN&&x.days<=FOLLOW_MAX;return x.days<FOLLOW_MIN;});
  if(cf)list=list.filter(x=>(String(x.r.courier||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯").trim()||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯")===cf);
  list.sort((a,b)=>{const da=a.days??-1,db=b.days??-1;return shipTabMode==="normal"?da-db:db-da;});
  if(!list.length){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª","","warn");return;}
  const totalSub=allForPrint.reduce((a,x)=>a+n(x.r.subtotal||x.r.productTotal||0),0);
  const totalShip=allForPrint.reduce((a,x)=>a+n(x.r.shipping||0),0);
  const rowsHtml=list.map(x=>{const r=x.r,isOv=x.days!==null&&x.days>=OVERDUE_MIN;const p1=fmtPhone(r.phone||r.phone1),p2=fmtPhone(r.altPhone||r.phone2);return`<tr style="${isOv?"background:#fff8f8":""}"><td><b>${esc(r.orderId||r.id||"")}</b></td><td>${esc(r.name||r.customer||"")}</td><td>${p2?esc(p1)+" â€” "+esc(p2):esc(p1)}<br>${esc(r.city||"")} / ${esc(r.address||"")}</td><td>${esc(String(r.courier||""))}</td><td>${x.dt?fmtYMD(x.dt):"â€”"}</td><td style="${isOv?"color:#c0392b;font-weight:800":""}">${x.days??"â€”"} ÙŠÙˆÙ…</td></tr>`;}).join("");
  const now=new Date().toLocaleString("ar-EG"),tabLabel={overdue:"Ù…ØªØ£Ø®Ø±",follow:"Ù…ØªØ§Ø¨Ø¹Ø©",normal:"Ø·Ø¨ÙŠØ¹ÙŠ"}[shipTabMode]||"";
  const w=window.open("","_blank");if(!w){toast("Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°","","err");return;}
  w.document.write(`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><title>Ø´Ø­Ù†Ø§Øª</title><style>body{font-family:Cairo,Arial,sans-serif;margin:0;padding:12px;background:#fff;color:#000}.summary-bar{display:flex;gap:16px;background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:10px 16px;margin-bottom:12px;flex-wrap:wrap}.sb-item{display:flex;flex-direction:column;align-items:center;min-width:100px}.sb-val{font-size:18px;font-weight:800;color:#111}.sb-lbl{font-size:9px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-top:2px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:7px 10px;font-size:11px;text-align:right;vertical-align:top}th{background:#f5f5f5;font-weight:700}@media print{body{padding:0}tr,td,th{page-break-inside:avoid}}</style></head><body onload="window.print()"><h1 style="font-size:15px;margin:0 0 4px">ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª â€” ${esc(tabLabel)}</h1><div style="font-size:11px;color:#555;margin-bottom:8px">Ø§Ù„ØªØ§Ø±ÙŠØ®: ${esc(now)} Â· ${cf?"Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+esc(cf):"ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†"} Â· Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: <b>${list.length}</b></div><div class="summary-bar"><div class="sb-item"><div class="sb-val">${allForPrint.length}</div><div class="sb-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø§Øª</div></div><div class="sb-item"><div class="sb-val" style="color:#b8941e">${totalSub.toLocaleString("ar-EG")}</div><div class="sb-lbl">ØªØ­ØµÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†</div></div><div class="sb-item"><div class="sb-val">${totalShip.toLocaleString("ar-EG")}</div><div class="sb-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†</div></div><div class="sb-item"><div class="sb-val" style="color:#27ae60">${(totalSub+totalShip).toLocaleString("ar-EG")}</div><div class="sb-lbl">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div></div></div><table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ/Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th></tr></thead><tbody>${rowsHtml}</tbody></table></body></html>`);
  w.document.close();
}

/* â”€â”€ AWAIT TABLE â”€â”€ */
function renderAwaitTable(){
  const tbody=document.getElementById("awaitTbody");if(!tbody)return;
  const st=document.getElementById("awaitStats");if(st)st.textContent=awaitOrders.length+" Ø£ÙˆØ±Ø¯Ø±";
  tbody.innerHTML="";
  if(!awaitOrders.length){tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">âœ…</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªÙ†ØªØ¸Ø± Ø§Ù„Ø´Ø­Ù†</div></div></td></tr>`;return;}
  awaitOrders.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=`<td class="td-id"><b>${esc(r.orderId||r.id||"")}</b></td><td class="td-name">${esc(r.name||r.customer||"")}</td><td>${addrCell(r)}</td><td class="td-amount">${fmt(r.subtotal||r.productTotal||0)}</td><td class="mono" style="font-size:11px">${fmt(r.shipping||0)}</td><td>${statusBadge(r.status)}</td>`;tbody.appendChild(tr);});
}

/* â”€â”€ PRINT / PDF â”€â”€ */
function updatePrintSummary(){
  const sub=rows.reduce((a,r)=>a+n(r.subtotal||r.productTotal||0),0);
  const shp=rows.reduce((a,r)=>a+n(r.shipping||0),0);
  const now=new Date().toLocaleString("ar-EG");
  const courier=[...new Set(rows.map(r=>String(r.courier||"")).filter(Boolean))][0]||"";
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set("printDate","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…: "+now+(courier?" | Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+courier:""));
  set("pDate2",now);set("pCount",rows.length);set("pSubtotal",sub);set("pShipping",shp);set("pTotal",sub+shp);
}
function printA4(){
  updatePrintSummary();
  const courier=[...new Set(rows.map(r=>String(r.courier||"")).filter(Boolean))][0]||"";
  const count=rows.length;
  const date=new Date().toISOString().slice(0,10);
  const oldTitle=document.title;
  document.title=`wc-${courier?courier+"-":""}${count}orders-${date}`;
  window.print();
  setTimeout(()=>document.title=oldTitle, 1000);
}

async function downloadSelectedPDF(){
  const ids=[...selected];if(!ids.length){toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn");return;}
  const prevRows=rows.slice(),prevSel=new Set(selected);
  rows=rows.filter(r=>ids.includes(String(r.orderId||r.id||"")));selected=new Set(ids);
  updatePrintSummary();render();
  document.body.classList.add("pdf-mode");
  const area=document.getElementById("printArea");
  await nextFrame();await nextFrame();await sleep(200);area.offsetHeight;await nextFrame();
  const pdfCourier=[...new Set(rows.map(r=>String(r.courier||"")).filter(Boolean))][0]||"";
  const pdfCount=ids.length;
  const opt={
    margin:[6,6,6,6],
    filename:`wc-${pdfCourier?pdfCourier+"-":""}${pdfCount}orders-${new Date().toISOString().slice(0,10)}.pdf`,
    enableLinks:false,
    image:{type:"jpeg",quality:1.0},
    html2canvas:{scale:2.5,useCORS:true,backgroundColor:"#ffffff",scrollX:0,scrollY:0,logging:false,
      onclone(doc){const s=doc.createElement("style");s.textContent=`*{color:#111!important;background:transparent!important;font-family:'Cairo',Arial,sans-serif!important;box-shadow:none!important;text-shadow:none!important;backdrop-filter:none!important;}html,body{background:#fff!important;margin:0!important;padding:0!important;direction:rtl!important;}.no-print,.nav-shell,#notifPanel,button{display:none!important}.wrap,.tab-panel{display:block!important;max-width:none!important;padding:0!important;gap:0!important;}.card,#printArea{background:#fff!important;border:none!important;border-radius:0!important;padding:8mm!important;margin:0!important;}.card-header{display:none!important;}.print-header{display:block!important;margin-bottom:14px!important;}.print-title{font-size:22px!important;font-weight:900!important;color:#111!important;}.print-summary{display:grid!important;grid-template-columns:1fr 1fr 1fr!important;gap:10px!important;margin:12px 0 16px!important;}.print-box{border:1px solid #ddd!important;border-radius:6px!important;padding:10px 14px!important;background:#fafafa!important;color:#111!important;line-height:2!important;font-size:11px!important;}.tbl-wrap{border:1px solid #ccc!important;overflow:visible!important;background:#fff!important;}.tbl-wrap table{width:100%!important;min-width:0!important;border-collapse:collapse!important;}thead th:first-child,tbody td:first-child,thead th:last-child,tbody td:last-child{display:none!important;}thead th{position:static!important;background:#111!important;color:#fff!important;border:1px solid #111!important;padding:9px 12px!important;font-size:10px!important;font-weight:700!important;text-align:right!important;}tbody tr:nth-child(even) td{background:#f9f9f9!important;}tbody td{border:1px solid #e0e0e0!important;padding:9px 12px!important;font-size:11px!important;color:#111!important;background:#fff!important;vertical-align:top!important;}.addr-line{display:block!important;}.badge{border:1px solid #999!important;background:#f0f0f0!important;color:#111!important;font-size:10px!important;padding:2px 10px!important;border-radius:999px!important;display:inline-block!important;}.badge-dot,.courier-chip,.courier-dot{display:none!important;}.empty,#selectionInfo,#toggleAllBtn{display:none!important;}`;doc.head.appendChild(s);}
    },
    jsPDF:{unit:"mm",format:"a4",orientation:"landscape"},
    pagebreak:{mode:["css","legacy"],avoid:["tr","td"]}
  };
  try{await html2pdf().set(opt).from(area).save();toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ PDF","","ok");}
  catch(e){toast("Ø®Ø·Ø£ ÙÙŠ PDF","","err");}
  finally{document.body.classList.remove("pdf-mode");rows=prevRows;selected=prevSel;render();}
}

function downloadAllXLSX(){
  const ids=[...selected];if(!ids.length){toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn");return;}
  const exp=rows.filter(r=>ids.includes(String(r.orderId||r.id||"")));
  if(!exp.length){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª","","warn");return;}
  const sub=exp.reduce((a,r)=>a+n(r.subtotal||r.productTotal||0),0);
  const shp=exp.reduce((a,r)=>a+n(r.shipping||0),0);
  const now=new Date().toLocaleString("ar-EG");
  const courier=[...new Set(exp.map(r=>String(r.courier||"")).filter(Boolean))][0]||"";
  const header=["Order ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‡Ø§ØªÙ","Ù‡Ø§ØªÙ Ø¥Ø¶Ø§ÙÙŠ","Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©","Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","Ø§Ù„ØªØ­ØµÙŠÙ„","Ø§Ù„Ø´Ø­Ù†","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„ØªØ§Ø±ÙŠØ®"];;
  const aoa=[];
  aoa.push([`ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… â€” White Clothes${courier?" | Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨: "+courier:""}`]);
  aoa.push([`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now}`]);
  aoa.push([""]);
  aoa.push(["Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:",exp.length,"","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø´Ø­Ù†):",sub+shp,"","Ù…Ø·Ø¨ÙˆØ¹ Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­"]);
  aoa.push(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„:",sub,"","Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:","___________","","Ø§Ù„ØªØ§Ø±ÙŠØ®:",now]);
  aoa.push(["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†:",shp,"","Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:","___________"]);
  aoa.push([""]);
  const hRow=aoa.length;aoa.push(header);
  exp.forEach(r=>aoa.push([
    String(r.orderId||r.id||""),String(r.name||r.customer||""),
    fmtPhone(r.phone||r.phone1),fmtPhone(r.altPhone||r.phone2),
    String(r.city||""),String(r.address||""),
    n(r.subtotal||r.productTotal||0),n(r.shipping||0),
    n(r.subtotal||r.productTotal||0)+n(r.shipping||0),
    String(r.status||""),String(r.orderDate||r.date||"").slice(0,10)
  ]));
  const wb=XLSX.utils.book_new();wb.Workbook={Views:[{RTL:true}]};
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  ws["!rows"]=[{hpt:36},{hpt:22}];
  ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:10}},{s:{r:1,c:0},e:{r:1,c:10}}];
  ws["!cols"]=[{wch:12},{wch:22},{wch:15},{wch:15},{wch:14},{wch:35},{wch:14},{wch:10},{wch:14},{wch:18},{wch:12}];
  ws["!freeze"]={xSplit:0,ySplit:hRow+1};
  const bdr=(s="thin")=>{const b={style:s,color:{rgb:"000000"}};return{top:b,bottom:b,left:b,right:b};};
  const range=XLSX.utils.decode_range(ws["!ref"]);
  for(let R=range.s.r;R<=range.e.r;R++)for(let C=range.s.c;C<=range.e.c;C++){const a=XLSX.utils.encode_cell({r:R,c:C});if(!ws[a])continue;ws[a].s={alignment:{wrapText:true,vertical:"top",horizontal:"right"}};if(R===0){ws[a].s.font={bold:true,sz:16,color:{rgb:"1a1a1a"}};ws[a].s.alignment.horizontal="center";ws[a].s.alignment.vertical="center";}if(R===1){ws[a].s.font={bold:true,sz:11};}if(R>=3&&R<=5){ws[a].s.border=bdr();}if(R===hRow){ws[a].s.font={bold:true};ws[a].s.fill={patternType:"solid",fgColor:{rgb:"1a1a1a"}};ws[a].s.font.color={rgb:"FFFFFF"};ws[a].s.border=bdr("medium");}if(R>hRow){ws[a].s.border=bdr();if(R%2===0)ws[a].s.fill={patternType:"solid",fgColor:{rgb:"F9F9F9"}};}}
  XLSX.utils.book_append_sheet(wb,ws,"Delivery Sheet");
  XLSX.writeFile(wb,`wc-${courier?courier+"-":""}${exp.length}orders-${new Date().toISOString().slice(0,10)}.xlsx`);
  toast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Excel","","ok");
}

/* â”€â”€ PRINT MENU â”€â”€ */
let _printMenuOpen=false;
function togglePrintMenu(e){
  e.stopPropagation();const menu=document.getElementById("printMenu");
  if(_printMenuOpen){_printMenuOpen=false;menu.classList.remove("open");return;}
  const btn=document.getElementById("printPendingBtn");if(btn){const r=btn.getBoundingClientRect();menu.style.top=(r.bottom+window.scrollY+6)+"px";}
  menu.classList.add("open");_printMenuOpen=true;
}
document.addEventListener("click",e=>{if(!e.target.closest("#printMenu")&&!e.target.closest("#printPendingBtn")){_printMenuOpen=false;document.getElementById("printMenu")?.classList.remove("open");}});

async function doPrintBatch(which){
  _printMenuOpen=false;document.getElementById("printMenu")?.classList.remove("open");
  let ids=[];
  if(which==="new")ids=_pendingCache.newOrders.map(r=>r.orderId||r.id).filter(Boolean);
  else if(which==="pending")ids=_pendingCache.pending.map(r=>r.orderId||r.id).filter(Boolean);
  else ids=[..._pendingCache.newOrders,..._pendingCache.pending].map(r=>r.orderId||r.id).filter(Boolean);
  if(!ids.length){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©","","warn");return;}
  const btn=document.getElementById("printPendingBtn");if(btn)btn.disabled=true;
  showLoading(`Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² ${ids.length} ÙØ§ØªÙˆØ±Ø©â€¦`);
  try{
    const url=WEB_APP_PRINT_URL+"?action=printBatch&ids="+encodeURIComponent(ids.join(","))+"&v="+Date.now();
    const w=window.open(url,"_blank");hideLoading();
    if(!w){toast("Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†ÙˆØ§ÙØ°","Ø§Ø³Ù…Ø­ Ø¨Ù€ Pop-up","err");return;}
    showPrintConfirmNotif(ids);
  }catch(e){hideLoading();toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©","","err");}
  finally{if(btn)btn.disabled=false;}
}

function showPrintConfirmNotif(ids){
  const panel=document.getElementById("notifPanel");const old=document.getElementById("printConfirmPanel");if(old)old.remove();
  const div=document.createElement("div");div.id="printConfirmPanel";div.className="notif-card";div.style.borderColor="rgba(201,168,76,.45)";
  div.innerHTML=`<div class="notif-icon">ğŸ–¨ï¸</div><div class="notif-body"><div class="notif-title">ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${ids.length} ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</div><div class="notif-sub">Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ø¶ØºØ· ØªØ£ÙƒÙŠØ¯ Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ <b>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</b></div><div class="notif-actions"><button class="notif-btn gold" id="confirmPrintedBtn">âœ… ØªØ£ÙƒÙŠØ¯ â€” Ø­ÙˆÙ‘Ù„ Ù„Ù€ "ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"</button><button class="notif-btn" onclick="dismissNotif('printConfirmPanel')">ØªØ¬Ø§Ù‡Ù„</button></div></div><button class="notif-close" onclick="dismissNotif('printConfirmPanel')">âœ•</button>`;
  panel.appendChild(div);
  document.getElementById("confirmPrintedBtn").addEventListener("click",()=>confirmMarkPrinted(ids,"printConfirmPanel"));
}

async function confirmMarkPrinted(ids,notifId){
  dismissNotif(notifId);
  const idSet=new Set(ids.map(String));
  const prevCache=allCache.map(r=>({...r})),prevRows=rows.map(r=>({...r}));
  allCache=allCache.map(r=>idSet.has(String(r.orderId||r.id||""))?{...r,status:"ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"}:r);
  rows=rows.map(r=>idSet.has(String(r.orderId||r.id||""))?{...r,status:"ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"}:r);
  saveCachedData(allCache);render();toast("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«",`${ids.length} Ø£ÙˆØ±Ø¯Ø± â†’ ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©`,"ok",3500);
  try{const res=await api("bulkUpdate",{ids:ids.join(","),status:"ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",courier:"",shipDate:"",deliveryDate:"",partialAmount:""});if(!res?.ok){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©","","err");return;}refreshAll(true);}
  catch(e){allCache=prevCache;rows=prevRows;saveCachedData(allCache);render();toast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„","","err");}
}

/* â”€â”€ MODALS â”€â”€ */
function showShipModal(){
  return new Promise(resolve=>{
    const today=new Date().toISOString().slice(0,10),lastCourier=getLastCourier(),couriers=getSavedCouriers();
    const chips=couriers.map(c=>`<button class="cb-chip${c===lastCourier?" active":""}" onclick="this.closest('.qsc-wrap').querySelectorAll('.cb-chip').forEach(b=>b.classList.remove('active'));this.classList.add('active');document.getElementById('m_courier').value='${esc(c)}'">${esc(c)}</button>`).join("");
    openModal(`<div style="margin-bottom:16px"><div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:4px">ğŸšš ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†</div><div style="font-size:11px;color:var(--mist)">Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯ÙŠ Ù…Ø·Ù„ÙˆØ¨Ø©</div></div>
    <div style="display:flex;flex-direction:column;gap:10px">
      ${chips?`<div class="qsc-wrap" style="display:flex;gap:5px;flex-wrap:wrap">${chips}</div>`:""}
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ *</label><input id="m_courier" value="${esc(lastCourier)}" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯" style="width:100%"/></div>
      <div><label class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† *</label><input id="m_shipDate" type="date" value="${today}" style="width:100%"/></div>
      <div style="display:flex;gap:8px;margin-top:6px"><button class="btn-gold" style="flex:1" onclick="_mShipOk()">âœ… ØªØ£ÙƒÙŠØ¯</button><button style="flex:1" onclick="_mCancel()">Ø¥Ù„ØºØ§Ø¡</button></div>
      <div id="m_err" style="color:var(--red);font-size:11px;display:none"></div>
    </div>`);
    setTimeout(()=>{const el=document.getElementById("m_courier");if(el){el.focus();if(lastCourier)el.select();}},80);
    window._mShipOk=()=>{const courier=(document.getElementById("m_courier")?.value||"").trim(),shipDate=(document.getElementById("m_shipDate")?.value||"").trim(),err=document.getElementById("m_err");if(!courier){err.textContent="â›” Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨";err.style.display="block";return;}if(!shipDate){err.textContent="â›” Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†";err.style.display="block";return;}saveCourier(courier);closeModal();resolve({courier,shipDate});delete window._mShipOk;delete window._mCancel;};
    window._mCancel=()=>{closeModal();resolve(null);delete window._mShipOk;delete window._mCancel;};
  });
}
function showDeliveryModal(){return new Promise(resolve=>{const today=new Date().toISOString().slice(0,10);openModal(`<div style="margin-bottom:16px"><div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:4px">ğŸ“¦ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</div></div><div style="display:flex;flex-direction:column;gap:10px"><div><label class="field-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… *</label><input id="m_delivDate" type="date" value="${today}" style="width:100%"/></div><div style="display:flex;gap:8px;margin-top:6px"><button class="btn-gold" style="flex:1" onclick="_mDelivOk()">âœ… ØªØ£ÙƒÙŠØ¯</button><button style="flex:1" onclick="_mCancel()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`);window._mDelivOk=()=>{const d=(document.getElementById("m_delivDate")?.value||"").trim();if(!d){toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…","","err");return;}closeModal();resolve({deliveryDate:d});delete window._mDelivOk;delete window._mCancel;};window._mCancel=()=>{closeModal();resolve(null);delete window._mDelivOk;delete window._mCancel;};}); }
function showPartialModal(){return new Promise(resolve=>{openModal(`<div style="margin-bottom:16px"><div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white);margin-bottom:4px">â†©ï¸ Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</div></div><div style="display:flex;flex-direction:column;gap:10px"><div><label class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label><input id="m_partial" type="number" placeholder="Ù…Ø«Ø§Ù„: 250" style="width:100%"/></div><div style="display:flex;gap:8px;margin-top:6px"><button class="btn-gold" style="flex:1" onclick="_mPartOk()">âœ… ØªØ£ÙƒÙŠØ¯</button><button style="flex:1" onclick="_mCancel()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`);setTimeout(()=>document.getElementById("m_partial")?.focus(),80);window._mPartOk=()=>{const v=(document.getElementById("m_partial")?.value||"").trim();if(!v){toast("Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº","","err");return;}closeModal();resolve({amount:v});delete window._mPartOk;delete window._mCancel;};window._mCancel=()=>{closeModal();resolve(null);delete window._mPartOk;delete window._mCancel;};}); }

/* â”€â”€ NOTIFICATIONS â”€â”€ */
function showDuplicateNotif(orderId,order){
  const panel=document.getElementById("notifPanel");if(!panel)return;
  const nId="dup_"+orderId+"_"+Date.now(),status=order?.status||"â€”",name=order?.name||order?.customer||"",phone=order?fmtPhone(order.phone||order.phone1||""):"";
  const div=document.createElement("div");div.id=nId;div.className="notif-card duplicate";
  div.innerHTML=`<div class="notif-icon">âš ï¸</div><div class="notif-body"><div class="notif-title">Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± â€” ${esc(String(orderId))}</div><div class="notif-sub">${name?"Ø§Ù„Ø§Ø³Ù…: <b>"+esc(name)+"</b><br>":""}${phone?"ğŸ“ "+esc(phone)+"<br>":""}Ø§Ù„Ø­Ø§Ù„Ø©: <b>${esc(status)}</b></div><div class="notif-actions"><button class="notif-btn gold" onclick="markFollowed('${esc(String(orderId))}','${nId}')">âœ… ØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button><button class="notif-btn" onclick="dismissNotif('${nId}')">ØªØ¬Ø§Ù‡Ù„</button></div></div><button class="notif-close" onclick="dismissNotif('${nId}')">âœ•</button>`;
  panel.appendChild(div);setTimeout(()=>dismissNotif(nId),30000);
  addNotifHistory("âš ï¸","Ø£ÙˆØ±Ø¯Ø± Ù…ÙƒØ±Ø± â€” "+String(orderId),name||status);
}
function showNewOrderNotif(orderId,info={}){
  const panel=document.getElementById("notifPanel");if(!panel)return;
  const nId="new_"+orderId+"_"+Date.now();const div=document.createElement("div");div.id=nId;div.className="notif-card";
  div.innerHTML=`<div class="notif-icon">ğŸ†•</div><div class="notif-body"><div class="notif-title">Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ â€” ${esc(String(orderId))}</div><div class="notif-sub">${info.name?"Ø§Ù„Ø§Ø³Ù…: <b>"+esc(info.name)+"</b><br>":""}${info.phone?"ğŸ“ "+esc(fmtPhone(info.phone))+"<br>":""}${info.status?"Ø§Ù„Ø­Ø§Ù„Ø©: <b>"+esc(info.status)+"</b>":""}</div><div class="notif-actions"><button class="notif-btn gold" onclick="addOrderFromNotif('${esc(String(orderId))}','${nId}')">â• Ø£Ø¶Ù Ù„Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button><button class="notif-btn" onclick="dismissNotif('${nId}')">ØªØ¬Ø§Ù‡Ù„</button></div></div><button class="notif-close" onclick="dismissNotif('${nId}')">âœ•</button>`;
  panel.appendChild(div);setTimeout(()=>dismissNotif(nId),60000);
  addNotifHistory("ğŸ†•","Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ â€” "+String(orderId),info.name||"");
}
function dismissNotif(id){const el=document.getElementById(id);if(!el)return;el.style.transition="all .25s ease";el.style.opacity="0";el.style.transform="translateY(-8px) scale(.96)";setTimeout(()=>el.remove(),280);}
function markFollowed(orderId,notifId){const f=getFollowedIds();f.add(String(orderId));saveFollowedIds(f);dismissNotif(notifId);toast("ØªÙ… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©","Order: "+orderId,"ok");}
async function addOrderFromNotif(orderId,notifId){const id=String(orderId).trim();if(!mineIds.has(id)){mineIds.add(id);saveMine();recordScanTime(id);const res=await api("scanAdd",{orderId:id});if(res?.ok){toast("ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©",id,"ok");await refreshAll(true);}}dismissNotif(notifId);}

/* â”€â”€ TAB SWITCHING â”€â”€ */
function switchTab(name,btn){
  document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  const panel=document.getElementById("panel-"+name);if(panel)panel.classList.add("active");
  if(btn)btn.classList.add("active");
  const bar=document.getElementById("deliveryActionBar");
  if(bar)bar.style.display=name==="delivery"?"flex":"none";
  if(name==="products"&&!productsCache.length)loadProducts();
  if(name==="purchases"&&!purchasesCache.length)loadPurchases();
  if(name==="expenses"&&!expensesCache.length)loadExpenses();
  if(name==="treasury"&&!document.getElementById("tr_sales")?.textContent?.replace(/[,\s]/g,""))loadTreasury();
}

/* â•â• ORDER FORM â•â• */
function buildSKUOptions(){if(!productsCache.length)return`<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ â€”</option>`;return`<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ â€”</option>`+productsCache.map(p=>`<option value="${esc(p.sku||p.name)}">${esc(p.name||p.sku)}${p.color?" â€” "+p.color:""}${p.size?" â€” "+p.size:""}</option>`).join("");}

function addProductRow(containerId,prefix){
  productRowCounter++;const id=productRowCounter;
  const cont=document.getElementById(containerId);if(!cont)return;
  const div=document.createElement("div");div.className="product-item";div.id=prefix+"_row_"+id;
  div.innerHTML=`<div class="product-item-header"><span class="product-item-title">ğŸ“¦ Ù…Ù†ØªØ¬ ${id}</span><button class="remove-product-btn" onclick="document.getElementById('${prefix}_row_${id}').remove();calcOrderTotal()">âœ• Ø­Ø°Ù</button></div>
  <div class="form-grid form-grid-3">
    <div><label class="field-label">Ø§Ù„Ù…Ù†ØªØ¬</label><select id="${prefix}_sku_${id}" class="sku-select" onchange="onProdSKUChange('${prefix}',${id})">${buildSKUOptions()}</select></div>
    <div><label class="field-label">Ø§Ù„Ù„ÙˆÙ†</label><input id="${prefix}_color_${id}" placeholder="Ø§Ù„Ù„ÙˆÙ†"/></div>
    <div><label class="field-label">Ø§Ù„Ù…Ù‚Ø§Ø³</label><input id="${prefix}_size_${id}" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø³"/></div>
    <div><label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="${prefix}_qty_${id}" type="number" value="1" min="1" oninput="calcOrderTotal()"/></div>
    <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø© (Ø¬)</label><input id="${prefix}_price_${id}" type="number" min="0" oninput="calcOrderTotal()"/></div>
    <div><label class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ†Ù (Ø¬)</label><input id="${prefix}_line_${id}" type="number" readonly style="background:var(--ink3);color:var(--gold);font-weight:700;"/></div>
  </div>`;
  cont.appendChild(div);
}

function onProdSKUChange(prefix,id){
  const sku=document.getElementById(prefix+"_sku_"+id)?.value;
  const prod=productsCache.find(p=>p.sku===sku||p.name===sku);
  if(prod){const c=document.getElementById(prefix+"_color_"+id),s=document.getElementById(prefix+"_size_"+id),p=document.getElementById(prefix+"_price_"+id);if(c&&prod.color)c.value=prod.color;if(s&&prod.size)s.value=prod.size;if(p&&prod.price)p.value=prod.price;}
  calcOrderTotal();
}

function calcOrderTotal(){
  let subtotal=0;
  document.querySelectorAll(".product-item").forEach(item=>{
    const idMatch=item.id.match(/_row_(\d+)$/);if(!idMatch)return;
    const id=idMatch[1],prefix=item.id.replace(/_row_\d+$/,"");
    const qty=parseFloat(document.getElementById(prefix+"_qty_"+id)?.value||0)||0;
    const price=parseFloat(document.getElementById(prefix+"_price_"+id)?.value||0)||0;
    const line=qty*price;const lineEl=document.getElementById(prefix+"_line_"+id);if(lineEl)lineEl.value=line.toFixed(0);
    subtotal+=line;
  });
  const shipping=parseFloat(document.getElementById("of_shipping")?.value||0)||0;
  const discount=parseFloat(document.getElementById("of_discount")?.value||0)||0;
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set("of_subtotal_display",fmt(subtotal)+" Ø¬");set("of_shipping_display",fmt(shipping)+" Ø¬");set("of_discount_display",fmt(discount)+" Ø¬");set("of_total_display",fmt(subtotal+shipping-discount));
}

function resetOrderForm(){
  ["of_name","of_phone","of_phone2","of_address","of_note","of_coupon"].forEach(id=>{const el=document.getElementById(id);if(el)el.value="";});
  document.getElementById("of_city").value="";document.getElementById("of_source").value="Direct";
  document.getElementById("of_payment").value="cod";document.getElementById("of_shipping").value="60";document.getElementById("of_discount").value="0";
  document.getElementById("of_products_container").innerHTML="";productRowCounter=0;
  addProductRow("of_products_container","of_prod");calcOrderTotal();
}

async function submitNewOrder(){
  const name=(document.getElementById("of_name")?.value||"").trim();
  const phone=(document.getElementById("of_phone")?.value||"").trim();
  const city=document.getElementById("of_city")?.value||"";
  const address=(document.getElementById("of_address")?.value||"").trim();
  if(!name||!phone||!city||!address){toast("â›” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†Ø§Ù‚ØµØ©","Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†","err");return;}
  const products=[];
  document.querySelectorAll(".product-item").forEach(item=>{
    const idMatch=item.id.match(/_row_(\d+)$/);if(!idMatch)return;
    const id=idMatch[1],prefix=item.id.replace(/_row_\d+$/,"");
    const sku=document.getElementById(prefix+"_sku_"+id)?.value||"";
    const qty=parseInt(document.getElementById(prefix+"_qty_"+id)?.value||1)||1;
    const price=parseFloat(document.getElementById(prefix+"_price_"+id)?.value||0)||0;
    const prod=productsCache.find(p=>p.sku===sku||p.name===sku);
    if(sku||prod)products.push({sku,name:prod?.name||sku,color:document.getElementById(prefix+"_color_"+id)?.value||"",size:document.getElementById(prefix+"_size_"+id)?.value||"",qty,lineTotal:qty*price});
  });
  if(!products.length){toast("â›” Ø£Ø¶Ù Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„","","err");return;}
  const shipping=parseFloat(document.getElementById("of_shipping")?.value||60)||0;
  const discount=parseFloat(document.getElementById("of_discount")?.value||0)||0;
  const subtotal=products.reduce((s,p)=>s+p.lineTotal,0);
  const payload={name,phone,phone2:document.getElementById("of_phone2")?.value||"",city,address,source:document.getElementById("of_source")?.value||"Direct",paymentMethod:document.getElementById("of_payment")?.value||"cod",shipping,discount,coupon:document.getElementById("of_coupon")?.value||"",note:document.getElementById("of_note")?.value||"",products:JSON.stringify(products),subtotal,total:subtotal+shipping-discount};
  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±â€¦");
  try{const res=await api("addNewOrder",payload);hideLoading();if(res?.ok){toast(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± #${res.orderId}`,"","ok",4000);resetOrderForm();refreshAll(true);}else toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",res?.error||"","err");}
  catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â•â• EDIT ORDER â•â• */
async function searchOrderForEdit(){
  const q=(document.getElementById("eo_search_id")?.value||"").trim().toLowerCase();
  if(!q){toast("Ø§ÙƒØªØ¨ Order ID Ø£Ùˆ Ù…ÙˆØ¨Ø§ÙŠÙ„","","warn");return;}

  // Ø¯ÙˆØ± ÙÙŠ Ø§Ù„Ù€ cache Ø§Ù„Ø£ÙˆÙ„
  if(allCache.length){
    const digits=q.replace(/\D/g,""),isD=digits.length>=4;
    const results=allCache.filter(r=>{
  const rowId=String(r.orderId||r.id||"").toLowerCase();
  const rowPhone=String(r.phone||r.phone1||"").replace(/\s/g,"").toLowerCase();
  const rowPhone2=String(r.altPhone||r.phone2||"").replace(/\s/g,"").toLowerCase();
  const rowName=String(r.name||r.customer||"").toLowerCase();
  // Ù„Ùˆ Order ID â€” exact match Ø¨Ø³
  if(rowId===q) return true;
  // Ù„Ùˆ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ â€” exact match Ø¨Ø³
  if(isD) return rowPhone===digits||rowPhone2===digits||rowPhone.endsWith(digits)||rowPhone2.endsWith(digits);
  // Ù„Ùˆ Ø§Ø³Ù… â€” contains
  return rowName.includes(q);
});

    if(results.length>1){
      // Ø£ÙƒØªØ± Ù…Ù† Ù†ØªÙŠØ¬Ø© â€” ÙˆØ±ÙŠÙ‡ Ù‚Ø§ÙŠÙ…Ø© ÙŠØ®ØªØ§Ø± Ù…Ù†Ù‡Ø§
      showEditSearchResults(results);
      return;
    }
    if(results.length===1){
  showEditSearchResults(results);
  return;
}
  }

  // Ù…Ø´ Ù„Ø§Ù‚ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù€ cache â€” Ø±ÙˆØ­ Ù„Ù„Ù€ API
  await fetchAndFillEditOrder(q);
}

function showEditSearchResults(results){
  const cont=document.getElementById("eo_empty");
  cont.style.display="block";
  cont.innerHTML=`
    <div style="margin-bottom:10px;font-size:12px;color:var(--mist);">Ø§Ø®ØªØ§Ø± Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ¹Ø¯Ù„Ù‡:</div>
    <div class="tbl-wrap">
      <table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th></th></tr></thead>
      <tbody>
        ${results.map(r=>`
          <tr>
            <td class="td-id"><b>${esc(r.orderId||r.id||"")}</b></td>
            <td class="td-name">${esc(r.name||r.customer||"")}</td>
            <td class="td-phone">${esc(r.phone||r.phone1||"")}</td>
            <td>${esc(r.city||"")}</td>
            <td>${statusBadge(r.status)}</td>
            <td><button class="btn-gold btn-sm" onclick="fetchAndFillEditOrder('${esc(r.orderId||r.id||"")}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
          </tr>
        `).join("")}
      </tbody></table>
    </div>`;
}
async function fetchAndFillEditOrder(orderId){
  const id=String(orderId).trim();
  
  // Ø¬ÙŠØ¨ Ù…Ù† Ø§Ù„Ù€ cache Ø§Ù„Ø£ÙˆÙ„
  const cached=allCache.find(r=>String(r.orderId||r.id||"").trim()===id);
  
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦");
  try{
    const res=await api("getOrderForEdit",{q:id});
    hideLoading();
    if(!res?.ok||!res.order){toast("Ù„Ù… ÙŠØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±","","warn");return;}

    const o=res.order;
    
    // Ù„Ùˆ Ø§Ù„Ù€ API Ø±Ø¬Ø¹ Ø£ÙˆØ±Ø¯Ø± Ù…Ø®ØªÙ„Ù â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ cache
    if(String(o.orderId||"").trim()!==id){
      toast("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„ØµØ­â€¦","","warn");
      // ÙƒÙ…Ù‘Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ù† Ø§Ù„Ù€ cache
      if(cached){
        o.orderId=id;
        o.name=cached.name||cached.customer||"";
        o.phone=cached.phone||cached.phone1||"";
        o.city=cached.city||"";
        o.address=cached.address||"";
        o.shipping=cached.shipping||0;
        o.status=cached.status||"";
      }
    }

    document.getElementById("eo_empty").style.display="none";
    document.getElementById("eo_result").style.display="block";
    document.getElementById("eo_found_info").textContent=`#${id} â€” ${o.name||o.customer||""} â€” ${o.city||""}`;
    document.getElementById("eo_order_id").value=id;
    ["name","phone","city","address","shipping","discount","note","status"].forEach(f=>{
      const el=document.getElementById("eo_"+f);if(el)el.value=o[f]||"";
    });
    document.getElementById("eo_row_index").value=o.rowIndex||"";
    const cont=document.getElementById("eo_products_container");
    if(cont)cont.innerHTML="";
    (o.items||[]).forEach(item=>{
      productRowCounter++;const id2=productRowCounter;
      const div=document.createElement("div");div.className="product-item";div.id="eo_prod_row_"+id2;
      div.innerHTML=`<div class="product-item-header"><span class="product-item-title">ğŸ“¦ Ù…Ù†ØªØ¬ ${id2}</span><button class="remove-product-btn" onclick="document.getElementById('eo_prod_row_${id2}').remove()">âœ•</button></div>
      <div class="form-grid form-grid-3">
        <div><label class="field-label">Ø§Ù„Ù…Ù†ØªØ¬</label><input id="eo_prod_name_${id2}" value="${esc(item.name||"")}"/></div>
        <div><label class="field-label">Ø§Ù„Ù„ÙˆÙ†</label><input id="eo_prod_color_${id2}" value="${esc(item.color||"")}"/></div>
        <div><label class="field-label">Ø§Ù„Ù…Ù‚Ø§Ø³</label><input id="eo_prod_size_${id2}" value="${esc(item.size||"")}"/></div>
        <div><label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="eo_prod_qty_${id2}" type="number" value="${item.qty||1}"/></div>
        <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„ØµÙ†Ù (Ø¬)</label><input id="eo_prod_line_${id2}" type="number" value="${item.lineTotal||0}"/></div>
      </div>`;
      cont.appendChild(div);
    });
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«","","err");}
}

async function submitEditOrder(){
  const orderId=document.getElementById("eo_order_id")?.value||"";
  if(!orderId){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Order ID","","err");return;}

  const products=[];
  document.querySelectorAll("#eo_products_container .product-item").forEach(item=>{
    const idMatch=item.id.match(/_row_(\d+)$/);if(!idMatch)return;
    const id=idMatch[1];
    products.push({
      name:(document.getElementById("eo_prod_name_"+id)?.value||"").trim(),
      color:(document.getElementById("eo_prod_color_"+id)?.value||"").trim(),
      size:(document.getElementById("eo_prod_size_"+id)?.value||"").trim(),
      qty:parseInt(document.getElementById("eo_prod_qty_"+id)?.value||1)||1,
      lineTotal:parseFloat(document.getElementById("eo_prod_line_"+id)?.value||0)||0,
    });
  });

  const subtotal=products.reduce((s,p)=>s+p.lineTotal,0);
  const shipping=parseFloat(document.getElementById("eo_shipping")?.value||0)||0;
  const discount=parseFloat(document.getElementById("eo_discount")?.value||0)||0;
  const total=subtotal+shipping-discount;

  const payload={
    orderId,
    name:document.getElementById("eo_name")?.value||"",
    phone:document.getElementById("eo_phone")?.value||"",
    city:document.getElementById("eo_city")?.value||"",
    address:document.getElementById("eo_address")?.value||"",
    shipping,
    discount,
    total,
    note:document.getElementById("eo_note")?.value||"",
    status:document.getElementById("eo_status")?.value||"",
    products:JSON.stringify(products)
  };

  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øªâ€¦");
  try{
    const res=await api("editOrder",payload);
    hideLoading();
    if(res?.ok){toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª","","ok",3000);document.getElementById("eo_result").style.display="none";refreshAll(true);}
    else toast("âŒ ÙØ´Ù„",res?.error||"","err");
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â•â• PRODUCTS â•â• */
async function loadProducts(){
  const cached=loadCache(LS_PRODUCTS, 300000);
  if(cached){ productsCache=cached; renderProductsTable(); updateProductKPIs(); }
  
  try{
    const res=await api("getProducts");
    if(res?.ok&&res.products){
      let salesMap={};
      try{
        const salesRes=await api("getAllProductSales");
        salesMap=salesRes?.sales||{};
      }catch(e){}
      productsCache=res.products.map(p=>{
        const sku=String(p.sku||"").trim().replace(/\.0+$/,"");
  const nameKey=`${(p.name||"").trim()}||${(p.color||"").trim()}||${(p.size||"").trim()}`;
  const skuKey=sku;
  // Ø¬Ø±Ø¨ Ø§Ù„Ù€ SKU Ø§Ù„Ø£ÙˆÙ„ØŒ Ù„Ùˆ Ù…ÙÙŠØ´ Ø¬Ø±Ø¨ Ø§Ù„Ø§Ø³Ù…+Ù„ÙˆÙ†+Ù…Ù‚Ø§Ø³
  return{
    ...p,
    sold: salesMap[skuKey] || salesMap[nameKey] || 0
        };
      });
      saveCache(LS_PRODUCTS, productsCache);
      renderProductsTable();
      updateProductKPIs();
    }
  }catch(e){}
}

function openAddProductModal(){
  // ÙˆÙ„Ù‘Ø¯ SKU Ù…Ø¤Ù‚Øª Ù…Ù† Ø§Ù„Ù€ cache
  const existingSkus = productsCache.map(p => String(p.sku || "")).filter(s => s.startsWith("WC-"));
  const maxNum = existingSkus.length
    ? Math.max(...existingSkus.map(v => parseInt(v.replace("WC-", "")) || 0))
    : 0;
  const suggestedSku = "WC-" + String(maxNum + 1).padStart(4, "0");

  openModal(`
    <div style="margin-bottom:14px">
      <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:800;color:var(--white)">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</div>
    </div>
    <div class="form-grid form-grid-3">
      <div><label class="field-label">SKU (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label><input id="ap_sku" value="${esc(suggestedSku)}" placeholder="WC-0001"/></div>
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label><input id="ap_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"/></div>
      <div><label class="field-label">Ø§Ù„Ù†ÙˆØ¹</label><input id="ap_type" placeholder="Ù…Ù„Ø§Ø¨Ø³ / Ø¥ÙƒØ³Ø³ÙˆØ§Ø±"/></div>
      <div><label class="field-label">Ø§Ù„Ù„ÙˆÙ†</label><input id="ap_color" placeholder="Ø§Ù„Ù„ÙˆÙ†"/></div>
      <div><label class="field-label">Ø§Ù„Ù…Ù‚Ø§Ø³</label><input id="ap_size" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø³"/></div>
      <div><label class="field-label">Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¬)</label><input id="ap_cost" type="number" value="0"/></div>
      <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬)</label><input id="ap_price" type="number" value="0"/></div>
      <div><label class="field-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input id="ap_stock" type="number" value="0"/></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn-gold" style="flex:1" onclick="_apSave()">ğŸ’¾ Ø­ÙØ¸</button>
      <button style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div id="ap_err" style="margin-top:10px;color:var(--red);font-size:11px;display:none"></div>
  `);

  window._apSave = async ()=>{
    const err=document.getElementById("ap_err");
    const payload={
      sku:  (document.getElementById("ap_sku")?.value||"").trim(),
      name: (document.getElementById("ap_name")?.value||"").trim(),
      type: (document.getElementById("ap_type")?.value||"").trim(),
      color:(document.getElementById("ap_color")?.value||"").trim(),
      size: (document.getElementById("ap_size")?.value||"").trim(),
      cost: n(document.getElementById("ap_cost")?.value),
      price:n(document.getElementById("ap_price")?.value),
      stock:n(document.getElementById("ap_stock")?.value),
    };
    if(!payload.name){ err.textContent="â›” Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨"; err.style.display="block"; return; }
    showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦");
    try{
      const res=await api("addProduct", payload);
      hideLoading();
      if(res?.ok){
        toast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ â€” SKU: ${res.sku}`,"","ok");
        closeModal();
        await loadProducts();
      }else{
        err.textContent="âŒ "+(res?.error||"ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸");
        err.style.display="block";
      }
    }catch(e){ hideLoading(); err.textContent="âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„"; err.style.display="block"; }
  };
}

function updateProductKPIs(){
  const total=productsCache.length,inStock=productsCache.filter(p=>Number(p.stock||0)>10).length;
  const lowStock=productsCache.filter(p=>Number(p.stock||0)>0&&Number(p.stock||0)<=10).length;
  const outStock=productsCache.filter(p=>Number(p.stock||0)<=0).length;
  const totalSold=productsCache.reduce((s,p)=>s+Number(p.sold||0),0);
  const invValue=productsCache.reduce((s,p)=>s+Number(p.stock||0)*Number(p.price||0),0);
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set("kpi_total_skus",total);set("kpi_in_stock",inStock);set("kpi_low_stock",lowStock);
  set("kpi_out_stock",outStock);set("kpi_total_sold",fmt(totalSold));set("kpi_inv_value",fmt(invValue)+" Ø¬");
  set("tabProductsBadge",total);
  document.querySelectorAll(".sku-select").forEach(sel=>sel.innerHTML=buildSKUOptions());
  document.getElementById("pur_sku").innerHTML=buildSKUOptions();
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   PATCH â€” REPLACE FROM renderProductsTable() TO END
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* âœ… Fix: used earlier but not defined */
async function refreshMine(){ return refreshAll(true); }

/* âœ… Products table (was truncated) */
function renderProductsTable(){
  const tbody=document.getElementById("prodTbody"); if(!tbody) return;

  const q=(document.getElementById("prod_search")?.value||"").trim().toLowerCase();
  const ft=(document.getElementById("prod_filter_status")?.value||"").trim();

  let data=(productsCache||[]).filter(p=>{
    const sku=String(p.sku||"").toLowerCase();
    const name=String(p.name||"").toLowerCase();
    if(q && !sku.includes(q) && !name.includes(q)) return false;

    const s=Number(p.stock||0);
    if(ft==="ok" && s<=10) return false;
    if(ft==="low" && (s<=0 || s>10)) return false;
    if(ft==="empty" && s>0) return false;
    return true;
  });

  const badge=document.getElementById("prodTableBadge");
  if(badge) badge.textContent = `${data.length.toLocaleString("ar-EG")} ØµÙ`;

  tbody.innerHTML="";
  if(!data.length){
    tbody.innerHTML=`<tr><td colspan="12"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div></div></td></tr>`;
    return;
  }

  data.forEach((p,idx)=>{
    const stock=Number(p.stock||0);
    const sold=Number(p.sold||0);
    const ret=Number(p.returned||0);
    const cost=Number(p.cost||0);
    const price=Number(p.price||0);

    const margin = price>0 ? Math.round(((price-cost)/price)*100) : 0;
    const status =
      stock<=0 ? `<span class="stock-empty">Ù†ÙØ¯</span>` :
      stock<=10 ? `<span class="stock-low">Ù‚Ù„ÙŠÙ„</span>` :
      `<span class="stock-ok">Ù…ØªÙˆÙØ±</span>`;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="td-id"><b>${esc(p.sku||"")}</b></td>
      <td class="td-name">${esc(p.name||"")}</td>
      <td>${esc(p.color||"")}</td>
      <td>${esc(p.size||"")}</td>
      <td class="mono">${fmt(cost)}</td>
      <td class="mono td-amount">${fmt(price)}</td>
      <td class="mono">${margin}%</td>
      <td class="mono">${fmt(sold)}</td>
      <td class="mono">${fmt(ret)}</td>
      <td class="mono">${fmt(stock)}</td>
      <td>${status}</td>
      <td><button class="btn-sm" onclick="openEditProductModal(${idx})">âœï¸</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* Optional: quick edit modal for product (client-side only, calls API if available) */
function openEditProductModal(idx){
  const p=productsCache[idx]||{};
  openModal(`
    <div style="margin-bottom:14px">
      <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:800;color:var(--white)">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</div>
      <div style="font-size:11px;color:var(--mist)">SKU: <b style="color:var(--gold)">${esc(p.sku||"")}</b></div>
    </div>

    <div class="form-grid form-grid-3">
      <div><label class="field-label">Ø§Ù„Ø§Ø³Ù…</label><input id="mp_name" value="${esc(p.name||"")}"></div>
      <div><label class="field-label">Ø§Ù„Ù„ÙˆÙ†</label><input id="mp_color" value="${esc(p.color||"")}"></div>
      <div><label class="field-label">Ø§Ù„Ù…Ù‚Ø§Ø³</label><input id="mp_size" value="${esc(p.size||"")}"></div>
      <div><label class="field-label">Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="mp_cost" type="number" value="${n(p.cost)}"></div>
      <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label><input id="mp_price" type="number" value="${n(p.price)}"></div>
      <div><label class="field-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label><input id="mp_stock" type="number" value="${n(p.stock)}"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn-gold" style="flex:1" onclick="_mpSave('${esc(p.sku||"")}')">ğŸ’¾ Ø­ÙØ¸</button>
      <button style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div id="mp_err" style="margin-top:10px;color:var(--red);font-size:11px;display:none"></div>
  `);

  window._mpSave = async (sku)=>{
    const err=document.getElementById("mp_err");
    const payload={
      sku,
      name:(document.getElementById("mp_name")?.value||"").trim(),
      color:(document.getElementById("mp_color")?.value||"").trim(),
      size:(document.getElementById("mp_size")?.value||"").trim(),
      cost: n(document.getElementById("mp_cost")?.value),
      price:n(document.getElementById("mp_price")?.value),
      stock:n(document.getElementById("mp_stock")?.value),
    };
    if(!payload.sku){ err.textContent="â›” SKU Ù…ÙÙ‚ÙˆØ¯"; err.style.display="block"; return; }

    showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦");
    try{
      // requires server action (if you implemented it)
      const res=await api("updateProduct", payload);
      hideLoading();
      if(res?.ok){
        toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬","","ok");
        closeModal();
        await loadProducts();
      }else{
        err.textContent="âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: "+(res?.error||"");
        err.style.display="block";
      }
    }catch(e){
      hideLoading();
      err.textContent="âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„";
      err.style.display="block";
    }
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Purchases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onPurchaseSKUSelect(){
  const sku=document.getElementById("pur_sku")?.value||"";
  const p=productsCache.find(x=>x.sku===sku||x.name===sku);
  const nameEl=document.getElementById("pur_product_name");
  if(nameEl) nameEl.value = p?.name || sku || "";
  const up=document.getElementById("pur_unit_price");
  if(up && p?.cost) up.value = n(p.cost);
  calcPurchaseTotal();
}

function calcPurchaseTotal(){
  const qty=n(document.getElementById("pur_qty")?.value);
  const unit=n(document.getElementById("pur_unit_price")?.value);
  const total=qty*unit;
  const t=document.getElementById("pur_total");
  if(t) t.value = total.toFixed(0);
}

function resetPurchaseForm(){
  ["pur_sku","pur_product_name","pur_qty","pur_unit_price","pur_total","pur_supplier","pur_notes"].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(id==="pur_qty") el.value="1";
    else el.value="";
  });
  document.getElementById("pur_method").value="ÙƒØ§Ø´";
  document.getElementById("pur_status").value="Ù…Ø¯ÙÙˆØ¹";
  calcPurchaseTotal();
}

async function submitPurchase(){
  const sku=(document.getElementById("pur_sku")?.value||"").trim();
  const qty=n(document.getElementById("pur_qty")?.value);
  const unit=n(document.getElementById("pur_unit_price")?.value);
  const supplier=(document.getElementById("pur_supplier")?.value||"").trim();
  if(!sku || qty<=0 || unit<0 || !supplier){
    toast("â›” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ù†Ø§Ù‚ØµØ©","SKU/ÙƒÙ…ÙŠØ©/Ø³Ø¹Ø±/Ù…ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨Ø©","err"); return;
  }
  const payload={
    sku,
    productName:(document.getElementById("pur_product_name")?.value||"").trim(),
    qty,
    unitPrice:unit,
    total:qty*unit,
    supplier,
    method:(document.getElementById("pur_method")?.value||"").trim(),
    status:(document.getElementById("pur_status")?.value||"").trim(),
    notes:(document.getElementById("pur_notes")?.value||"").trim(),
  };

  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øªâ€¦");
  try{
    const res=await api("addPurchase", payload);
    hideLoading();
    if(res?.ok){
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª","","ok");
      resetPurchaseForm();
      await loadPurchases();
      await loadProducts(); // stock refresh if server updates
      if(document.getElementById("panel-treasury")?.classList.contains("active")) loadTreasury();
    }else{
      toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",res?.error||"","err");
    }
  }catch(e){
    hideLoading();
    toast("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„","","err");
  }
}

async function loadPurchases(){
  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øªâ€¦");
  try{
    const res=await api("getPurchases");
    hideLoading();
    if(res?.ok && Array.isArray(res.purchases)){
      purchasesCache=res.purchases;
      renderPurchasesTable();
      const b=document.getElementById("purTableBadge");
      if(b) b.textContent = `${purchasesCache.length.toLocaleString("ar-EG")} ÙØ§ØªÙˆØ±Ø©`;
    }else{
      toast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª","","warn");
    }
  }catch(e){
    hideLoading();
    toast("Ø®Ø·Ø£","","err");
  }
}

function renderPurchasesTable(){
  const tbody=document.getElementById("purTbody"); if(!tbody) return;
  const q=(document.getElementById("pur_search")?.value||"").trim().toLowerCase();
  let data=(purchasesCache||[]);
  if(q){
    data=data.filter(x=>{
      const h=[x.invoiceId,x.date,x.supplier,x.sku,x.productName].join("|").toLowerCase();
      return h.includes(q);
    });
  }
  tbody.innerHTML="";
  if(!data.length){
    tbody.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª</div></div></td></tr>`;
    return;
  }
  data.forEach(x=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="td-id"><b>${esc(x.invoiceId||"")}</b></td>
      <td class="td-date">${esc(fmtDate(x.date||""))}</td>
      <td class="td-name">${esc(x.supplier||"")}</td>
      <td class="mono">${esc(x.sku||"")}</td>
      <td>${esc(x.productName||"")}</td>
      <td class="mono">${fmt(x.qty||0)}</td>
      <td class="mono">${fmt(x.unitPrice||0)}</td>
      <td class="mono td-amount">${fmt(x.total||0)}</td>
      <td>${esc(x.method||"")}</td>
      <td>${esc(x.status||"")}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Expenses â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetExpenseForm(){
  ["exp_desc","exp_amount","exp_notes"].forEach(id=>{const el=document.getElementById(id); if(el) el.value="";});
  const dt=document.getElementById("exp_date");
  if(dt) dt.value = new Date().toISOString().slice(0,10);
  document.getElementById("exp_method").value="ÙƒØ§Ø´";
  document.getElementById("exp_type").value="Ø¥ÙŠØ¬Ø§Ø±";
}

async function submitExpense(){
  const type=(document.getElementById("exp_type")?.value||"").trim();
  const desc=(document.getElementById("exp_desc")?.value||"").trim();
  const amount=n(document.getElementById("exp_amount")?.value);
  const date=(document.getElementById("exp_date")?.value||"").trim();
  if(!type || !desc || amount<=0){
    toast("â›” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ù†Ø§Ù‚ØµØ©","Ø§Ù„Ù†ÙˆØ¹/Ø§Ù„ÙˆØµÙ/Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø©","err"); return;
  }
  const payload={
    type, desc, amount,
    date: date || new Date().toISOString().slice(0,10),
    method:(document.getElementById("exp_method")?.value||"").trim(),
    notes:(document.getElementById("exp_notes")?.value||"").trim(),
  };

  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙâ€¦");
  try{
    const res=await api("addExpense", payload);
    hideLoading();
    if(res?.ok){
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ","","ok");
      resetExpenseForm();
      await loadExpenses();
      if(document.getElementById("panel-treasury")?.classList.contains("active")) loadTreasury();
    }else toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",res?.error||"","err");
  }catch(e){
    hideLoading();
    toast("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„","","err");
  }
}

async function loadExpenses(){
  const cached=loadCache(LS_EXPENSES, 300000);
  if(cached){ expensesCache=cached; renderExpensesTable(); }
  try{
    const res=await api("getExpenses");
    if(res?.ok&&Array.isArray(res.expenses)){
      expensesCache=res.expenses;
      saveCache(LS_EXPENSES, expensesCache);
      renderExpensesTable();
      const b=document.getElementById("expTableBadge");
      if(b)b.textContent=`${expensesCache.length.toLocaleString("ar-EG")} Ø¨Ù†Ø¯`;
    }
  }catch(e){}
}

function renderExpensesTable(){
  const tbody=document.getElementById("expTbody"); if(!tbody) return;
  const ft=(document.getElementById("exp_filter_type")?.value||"").trim();
  let data=(expensesCache||[]);
  if(ft) data=data.filter(x=>String(x.type||"").trim()===ft);

  tbody.innerHTML="";
  if(!data.length){
    tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ’¸</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</div></div></td></tr>`;
    return;
  }
  data.forEach(x=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="td-date">${esc(fmtDate(x.date||""))}</td>
      <td>${esc(x.type||"")}</td>
      <td>${esc(x.desc||"")}</td>
      <td class="mono td-amount">${fmt(x.amount||0)}</td>
      <td>${esc(x.method||"")}</td>
      <td>${esc(x.notes||"")}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Treasury â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadTreasury(){
  const cached=loadCache(LS_TREASURY, 300000);
  if(cached){ renderTreasuryData(cached); }
  try{
    const res=await api("getTreasury");
    if(res?.ok&&res.data){
      saveCache(LS_TREASURY, res.data);
      renderTreasuryData(res.data);
    }
  }catch(e){}
}

function renderTreasuryData(d){
  // Ù†ÙØ³ ÙƒÙˆØ¯ loadTreasury Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø³ Ø¨ÙŠØ§Ø®Ø¯ d ÙƒÙ€ parameter
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set("tr_sales",        fmt(d.totalSales     ||0));
  set("tr_purchases",    fmt(d.totalPurchases  ||0));
  set("tr_expenses",     fmt(d.totalExpenses   ||0));
  set("tr_shipping_cost",fmt(d.totalShipping   ||0));
  set("tr_returns",      fmt(d.totalReturns    ||0));
  const netProfit=n(d.totalSales)-n(d.totalPurchases)-n(d.totalExpenses);
  set("tr_net_profit",fmt(netProfit));
  const margin=n(d.totalSales)>0?Math.round((netProfit/n(d.totalSales))*100):0;
  const mEl=document.getElementById("tr_margin");if(mEl)mEl.textContent="Ù‡Ø§Ù…Ø´: "+margin+"%";
  set("tr_inv_cost",  fmt(d.invCost   ||0));
  set("tr_inv_sale",  fmt(d.invSale   ||0));
  set("tr_out_stock", fmt(d.outOfStock||0));
  set("tr_low_stock", fmt(d.lowStock  ||0));
  const tb=document.getElementById("treasuryTbody");
  if(tb){
    const months=["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const rowsM=Array.isArray(d.monthly)?d.monthly:[];
    tb.innerHTML=rowsM.map(r=>{
      const gross=n(r.sales)-n(r.purchases);
      const net=gross-n(r.expenses);
      const mg=n(r.sales)>0?Math.round((gross/n(r.sales))*100):0;
      return`<tr>
        <td class="td-name">${esc(months[(r.month||1)-1]||r.month)}</td>
        <td class="mono">${fmt(r.orders||0)}</td>
        <td class="mono td-amount">${fmt(r.sales||0)}</td>
        <td class="mono">${fmt(r.purchases||0)}</td>
        <td class="mono">${fmt(r.expenses||0)}</td>
        <td class="mono">${fmt(gross)}</td>
        <td class="mono">${mg}%</td>
        <td class="mono">${fmt(r.returns||0)}</td>
        <td class="mono td-amount">${fmt(net)}</td>
      </tr>`;
    }).join("")||`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“Š</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div></div></td></tr>`;
  }
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UI fixes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* âœ… status select: show courier bar only for â€œØªÙ… Ø§Ù„Ø´Ø­Ù†â€ */
document.getElementById("statusSelect")?.addEventListener("change", e=>onStatusSelectChange(e.target.value));

/* âœ… close bell drawer on outside click + ESC */
document.addEventListener("click",(e)=>{
  const d=document.getElementById("notifDrawer");
  if(!d?.classList.contains("open")) return;
  if(e.target.closest(".nd-panel")) return;
  if(e.target.closest(".bell-btn")) return;
  closeNotifDrawer();
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    closeNotifDrawer();
    if(_printMenuOpen){
      _printMenuOpen=false;
      document.getElementById("printMenu")?.classList.remove("open");
    }
    closeModal();
  }
});

/* âœ… print menu: keep centered & inside viewport */
function _placePrintMenu(){
  const menu=document.getElementById("printMenu");
  const btn=document.getElementById("printPendingBtn");
  if(!menu || !btn) return;

  const r=btn.getBoundingClientRect();
  const top = Math.min(window.innerHeight-20, r.bottom + 8);
  menu.style.top = (top + window.scrollY) + "px";
}
const _oldTogglePrintMenu = togglePrintMenu;
togglePrintMenu = function(e){
  _oldTogglePrintMenu(e);
  if(_printMenuOpen) _placePrintMenu();
};
async function loadAll(){
  await refreshAll(true);
  setTimeout(()=>{
    loadProducts();
    setTimeout(()=>loadPurchases(), 500);
    setTimeout(()=>loadExpenses(), 1000);
    setTimeout(()=>loadTreasury(), 1500);
  }, 2000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function init(){
  pruneDupTimes();
  loadMine();
  loadNotifHistory();
  updateBellDot();
  renderCourierBar();

  // ensure date defaults
  resetExpenseForm();

  // order form defaults
  if(document.getElementById("of_products_container") && document.getElementById("of_products_container").children.length===0){
    addProductRow("of_products_container","of_prod");
    calcOrderTotal();
  }

    loadAll();  // â† Ø¨Ø¯Ù„ refreshAll(true)

  setInterval(()=>refreshAll(false), 15000);  // â† Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ø¢Ø®Ø±
}

// Ø¶ÙŠÙÙ‡ ÙÙŠ Ø¢Ø®Ø± init() Ù‚Ø¨Ù„ Ø§Ù„Ù‚ÙÙ„Ø©
document.addEventListener("keydown", e => {
  if (e.key !== "Enter") return;
  const active = document.activeElement;
  if (!active) return;

  // Ø®Ø§Ù†Ø© Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø±
  if (active.id === "orderIdInput") { addOneWithDupCheck(); return; }

  // Ø®Ø§Ù†Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
  if (active.id === "idx_q") { searchIndex(); return; }

  // Ø®Ø§Ù†Ø© Ø¨Ø­Ø« Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  if (active.id === "eo_search_id") { searchOrderForEdit(); return; }
});
init();
</script>

</body>
</html>
