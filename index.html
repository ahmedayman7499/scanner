<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>WC â€” Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Cairo:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
:root{--ink:#0a0a0a;--ink2:#141414;--ink3:#1e1e1e;--rule:#2e2e2e;--rule2:#3a3a3a;--mist:#888;--silver:#aaa;--pearl:#ccc;--ivory:#e8e4dc;--white:#f5f2ed;--gold:#c9a84c;--gold2:#b8941e;--gold-faint:rgba(201,168,76,.12);--gold-glow:rgba(201,168,76,.25);--red:#c0392b;--red-faint:rgba(192,57,43,.12);--green:#27ae60;--green-faint:rgba(39,174,96,.10);--amber:#d4961a;--amber-faint:rgba(212,150,26,.12);--blue:#3498db;--blue-faint:rgba(52,152,219,.10);--purple:#8e44ad;--r1:4px;--r2:8px;--r3:16px;--r4:999px;--sh1:0 2px 16px rgba(0,0,0,.40);--sh2:0 8px 40px rgba(0,0,0,.55);--sh3:0 20px 80px rgba(0,0,0,.70);}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Cairo',sans-serif;background:var(--ink);color:var(--ivory);min-height:100vh;overflow-x:hidden;}
.mono{font-family:'JetBrains Mono',monospace;}
.nav-shell{position:sticky;top:0;z-index:200;background:rgba(10,10,10,.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--rule2);box-shadow:var(--sh2);}
.nav-top{display:flex;align-items:center;gap:10px;padding:10px 16px 0;}
.brand-name-nav{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:700;color:var(--white);letter-spacing:2px;text-transform:uppercase;}
.brand-tag-nav{font-size:8px;color:var(--mist);letter-spacing:2px;}
.nav-metrics{display:flex;gap:6px;align-items:center;margin-inline-start:auto;flex-wrap:wrap;}
.nav-metric{display:inline-flex;flex-direction:column;align-items:center;padding:4px 10px;border-radius:var(--r2);border:1px solid var(--rule);background:rgba(255,255,255,.03);}
.nm-val{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600;color:var(--white);}
.nm-lbl{font-size:8px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;}
.clock-nav{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--mist);}
.tab-bar{display:flex;gap:2px;padding:8px 16px 0;overflow-x:auto;scrollbar-width:none;}
.tab-bar::-webkit-scrollbar{display:none;}
.tab-btn{font-family:'Cairo',sans-serif;font-size:11px;font-weight:700;color:var(--mist);background:transparent;border:none;padding:8px 16px;border-radius:var(--r2) var(--r2) 0 0;cursor:pointer;transition:all .18s;white-space:nowrap;display:flex;align-items:center;gap:5px;border-bottom:2px solid transparent;}
.tab-btn:hover{color:var(--silver);background:rgba(255,255,255,.04);}
.tab-btn.active{color:var(--gold);background:rgba(201,168,76,.08);border-bottom-color:var(--gold);}
.tab-badge{font-family:'JetBrains Mono',monospace;font-size:9px;padding:1px 6px;border-radius:var(--r4);background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);}
.tab-panel{display:none;padding:14px;}
.tab-panel.active{display:block;animation:fadeUp .25s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--ink2);border:1px solid var(--rule);border-radius:var(--r3);padding:16px;box-shadow:var(--sh1);margin-bottom:12px;}
.card-header{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.card-title{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:600;color:var(--pearl);}
.card-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 8px;border-radius:var(--r4);border:1px solid var(--rule);color:var(--silver);background:rgba(255,255,255,.04);margin-inline-start:auto;}
input,select,textarea{font-family:'Cairo',sans-serif;font-size:13px;color:var(--ivory);background:var(--ink3);border:1px solid var(--rule);border-radius:var(--r2);padding:9px 13px;outline:none;width:100%;min-height:38px;transition:border-color .18s,box-shadow .18s;}
input::placeholder,textarea::placeholder{color:var(--mist);}
input:focus,select:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-faint);}
select option{background:var(--ink2);}
textarea{min-height:80px;resize:vertical;}
.input-row{display:flex;gap:8px;align-items:center;}
.flex1{flex:1;min-width:0;}
label.field-label{font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;display:block;margin-bottom:4px;}
button{font-family:'Cairo',sans-serif;font-size:12px;font-weight:700;color:var(--ivory);background:rgba(255,255,255,.06);border:1px solid var(--rule);border-radius:var(--r2);padding:9px 16px;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:6px;white-space:nowrap;min-height:38px;}
button:hover{background:rgba(255,255,255,.10);}
button:active{transform:scale(.97);}
button:disabled{opacity:.4;cursor:not-allowed;}
.btn-gold{background:linear-gradient(145deg,var(--gold),var(--gold2));border-color:rgba(201,168,76,.4);color:#0a0a0a;font-weight:900;box-shadow:0 4px 18px var(--gold-faint);}
.btn-gold:hover{box-shadow:0 6px 28px var(--gold-glow);transform:translateY(-1px);}
.btn-danger{background:rgba(192,57,43,.15);border-color:rgba(192,57,43,.35);color:#e74c3c;}
.btn-green{background:rgba(39,174,96,.15);border-color:rgba(39,174,96,.35);color:var(--green);}
.btn-blue{background:rgba(52,152,219,.15);border-color:rgba(52,152,219,.35);color:var(--blue);}
.btn-ghost{background:transparent;border-color:var(--rule);font-size:11px;padding:6px 12px;min-height:32px;}
.btn-sm{padding:5px 10px;min-height:28px;font-size:11px;}
.form-grid{display:grid;gap:12px;}
.form-grid-2{grid-template-columns:1fr 1fr;}
.form-grid-3{grid-template-columns:1fr 1fr 1fr;}
@media(max-width:700px){.form-grid-2,.form-grid-3{grid-template-columns:1fr;}}
.form-section-title{font-family:'Cormorant Garamond',serif;font-size:13px;font-weight:600;color:var(--gold);letter-spacing:1px;padding-bottom:6px;border-bottom:1px solid var(--rule);margin:4px 0 8px;}
.product-item{background:var(--ink3);border:1px solid var(--rule);border-radius:var(--r2);padding:12px;margin-bottom:10px;animation:fadeUp .2s ease;}
.product-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.product-item-title{font-size:12px;font-weight:700;color:var(--gold);}
.remove-product-btn{padding:3px 8px;font-size:11px;background:rgba(192,57,43,.15);border-color:rgba(192,57,43,.3);color:var(--red);border-radius:var(--r1);min-height:unset;}
.tbl-wrap{width:100%;overflow-x:auto;border-radius:var(--r2);border:1px solid var(--rule);}
table{width:100%;border-collapse:collapse;min-width:600px;}
thead th{background:var(--ink3);border-bottom:1px solid var(--rule2);padding:9px 12px;text-align:right;font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--rule);transition:background .12s;}
tbody tr:hover{background:rgba(255,255,255,.025);}
tbody td{padding:10px 12px;font-size:12px;color:var(--silver);vertical-align:top;}
.td-id{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--gold)!important;}
.td-name{color:var(--ivory)!important;font-weight:600;}
.td-phone{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--pearl)!important;}
.td-amount{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;color:var(--white)!important;}
.badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:var(--r4);font-size:10px;font-weight:700;border:1px solid;white-space:nowrap;}
.badge-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.b-ok{color:var(--green);border-color:rgba(39,174,96,.3);background:var(--green-faint);}
.b-ok .badge-dot{background:var(--green);}
.b-warn{color:var(--amber);border-color:rgba(212,150,26,.3);background:var(--amber-faint);}
.b-warn .badge-dot{background:var(--amber);}
.b-err{color:var(--red);border-color:rgba(192,57,43,.3);background:var(--red-faint);}
.b-err .badge-dot{background:var(--red);}
.b-cancel{color:var(--mist);border-color:rgba(136,136,136,.2);background:rgba(136,136,136,.06);}
input[type=checkbox]{width:15px;height:15px;min-height:unset;padding:0;border-radius:3px;accent-color:var(--gold);cursor:pointer;}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:14px;}
.kpi-tile{background:var(--ink2);border:1px solid var(--rule);border-radius:var(--r3);padding:14px 16px;position:relative;overflow:hidden;transition:border-color .2s,transform .15s;}
.kpi-tile:hover{border-color:var(--rule2);transform:translateY(-1px);}
.kpi-tile::after{content:"";position:absolute;bottom:0;left:0;right:0;height:2px;border-radius:0 0 var(--r3) var(--r3);}
.kt-gold::after{background:linear-gradient(90deg,var(--gold2),var(--gold));}
.kt-green::after{background:linear-gradient(90deg,#1e8449,var(--green));}
.kt-red::after{background:linear-gradient(90deg,#922b21,var(--red));}
.kt-amber::after{background:linear-gradient(90deg,#b7770d,var(--amber));}
.kt-blue::after{background:linear-gradient(90deg,#1a5276,var(--blue));}
.kt-purple::after{background:linear-gradient(90deg,#6c3483,var(--purple));}
.kpi-icon{font-size:18px;margin-bottom:6px;}
.kpi-val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:600;color:var(--white);line-height:1;margin-bottom:4px;}
.kpi-val.kv-gold{color:var(--gold);}.kpi-val.kv-green{color:var(--green);}.kpi-val.kv-red{color:#e74c3c;}.kpi-val.kv-amber{color:var(--amber);}.kpi-val.kv-blue{color:var(--blue);}.kpi-val.kv-purple{color:var(--purple);}
.kpi-lbl{font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1.5px;}
.kpi-sub{font-size:10px;color:var(--mist);margin-top:3px;}
.stock-ok{color:var(--green);font-weight:700;}.stock-low{color:var(--amber);font-weight:700;}.stock-critical{color:var(--red);font-weight:700;}.stock-empty{color:#666;font-weight:700;}
#loadingOverlay{position:fixed;inset:0;background:rgba(10,10,10,.75);backdrop-filter:blur(6px);z-index:9000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
#loadingOverlay.active{display:flex;}
.spinner{width:44px;height:44px;border-radius:50%;border:2px solid var(--rule2);border-top-color:var(--gold);animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-txt{font-family:'Cormorant Garamond',serif;font-size:16px;color:var(--pearl);letter-spacing:2px;}
#statusToast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);z-index:8000;pointer-events:none;min-width:280px;max-width:90vw;}
#statusToast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.toast-box{background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);padding:14px 18px;box-shadow:var(--sh3);display:flex;align-items:center;gap:12px;position:relative;overflow:hidden;}
.toast-icon{font-size:20px;flex-shrink:0;}.toast-body{flex:1;min-width:0;}.toast-title{font-size:13px;font-weight:700;color:var(--white);}.toast-sub{font-size:11px;color:var(--silver);margin-top:2px;}
.toast-progress{position:absolute;bottom:0;left:0;height:2px;background:var(--gold);width:100%;transform-origin:left;animation:progressShrink 2.8s linear forwards;}
@keyframes progressShrink{from{transform:scaleX(1)}to{transform:scaleX(0)}}
.toast-box.t-ok{border-color:rgba(39,174,96,.3);}.toast-box.t-ok .toast-progress{background:var(--green);}
.toast-box.t-warn{border-color:rgba(212,150,26,.3);}.toast-box.t-warn .toast-progress{background:var(--amber);}
.toast-box.t-err{border-color:rgba(192,57,43,.3);}.toast-box.t-err .toast-progress{background:var(--red);}
#inlineModal{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:9500;display:none;align-items:center;justify-content:center;}
#inlineModal.open{display:flex;}
#inlineModalBox{background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);padding:24px;min-width:340px;max-width:92vw;max-height:90vh;overflow-y:auto;box-shadow:var(--sh3);animation:fadeUp .25s ease;}
#notifPanel{position:fixed;top:90px;left:50%;transform:translateX(-50%);width:min(480px,94vw);z-index:8500;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.notif-card{background:var(--ink2);border:1px solid rgba(201,168,76,.35);border-radius:var(--r3);padding:12px 16px;box-shadow:var(--sh3);display:flex;align-items:flex-start;gap:12px;pointer-events:all;animation:fadeUp .35s ease;position:relative;overflow:hidden;}
.notif-card::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),var(--amber));}
.notif-card.duplicate{border-color:rgba(192,57,43,.40);}.notif-card.duplicate::before{background:linear-gradient(90deg,var(--red),#e74c3c);}
.notif-icon{font-size:22px;flex-shrink:0;}.notif-body{flex:1;min-width:0;}.notif-title{font-size:13px;font-weight:700;color:var(--white);margin-bottom:3px;}.notif-sub{font-size:11px;color:var(--silver);line-height:1.5;}
.notif-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.notif-btn{font-size:11px;font-weight:700;padding:5px 12px;border-radius:var(--r4);border:1px solid var(--rule2);background:rgba(255,255,255,.07);color:var(--ivory);cursor:pointer;min-height:unset;transition:all .15s;}
.notif-btn.gold{background:var(--gold-faint);border-color:rgba(201,168,76,.35);color:var(--gold);}
.notif-close{position:absolute;top:8px;left:10px;font-size:14px;color:var(--mist);cursor:pointer;background:none;border:none;min-height:unset;padding:2px 6px;}
.topbar-btn-row{display:flex;align-items:center;gap:6px;justify-content:center;flex-wrap:wrap;padding:8px 16px;}
.tb-btn{font-family:'Cairo',sans-serif;font-size:11px;font-weight:700;color:var(--silver);background:rgba(255,255,255,.05);border:1px solid var(--rule);border-radius:var(--r2);padding:8px 14px;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;position:relative;}
.tb-btn:hover{background:rgba(255,255,255,.08);color:var(--white);}
.tb-badge{font-family:'JetBrains Mono',monospace;font-size:10px;padding:1px 7px;border-radius:var(--r4);background:rgba(201,168,76,.2);border:1px solid rgba(201,168,76,.3);color:var(--gold);}
@keyframes goldPulse{0%,100%{box-shadow:0 0 0 rgba(201,168,76,0)}50%{box-shadow:0 0 20px var(--gold-glow)}}
.tb-btn.pending-active{color:var(--gold);border-color:rgba(201,168,76,.35);background:var(--gold-faint);animation:goldPulse 2.5s ease-in-out infinite;}
.ship-dot{position:absolute;top:-5px;left:-5px;min-width:17px;height:17px;padding:0 5px;border-radius:var(--r4);background:var(--red);color:#fff;font-size:9px;font-weight:800;display:none;align-items:center;justify-content:center;border:2px solid var(--ink);font-family:'JetBrains Mono',monospace;}
.qa-btn{font-size:10px;font-weight:700;padding:3px 7px;border-radius:var(--r4);border:1px solid var(--rule2);background:rgba(255,255,255,.05);color:var(--silver);cursor:pointer;min-height:unset;transition:all .15s;white-space:nowrap;font-family:'Cairo',sans-serif;}
.qa-btn.qa-ship{border-color:rgba(243,156,18,.35);color:#f39c12;}
.qa-btn.qa-done{border-color:rgba(39,174,96,.35);color:#27ae60;}
.qa-btn.qa-ret{border-color:rgba(192,57,43,.35);color:var(--red);}
.qa-btn.qa-print{border-color:rgba(201,168,76,.35);color:var(--gold);}
#printMenu{position:fixed;z-index:9100;display:none;left:50%;transform:translateX(-50%);min-width:min(300px,92vw);}
#printMenu.open{display:block;animation:fadeUp .18s ease;}
.print-menu-box{background:var(--ink2);border:1px solid var(--rule2);border-radius:var(--r3);box-shadow:var(--sh3);overflow:hidden;padding:6px;}
.pm-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r2);cursor:pointer;transition:background .15s;border:none;background:transparent;width:100%;text-align:right;color:var(--ivory);font-family:'Cairo',sans-serif;font-size:12px;font-weight:600;min-height:unset;}
.pm-item:hover{background:rgba(255,255,255,.06);}
.pm-count{font-family:'JetBrains Mono',monospace;font-size:11px;padding:2px 8px;border-radius:var(--r4);border:1px solid var(--rule);background:rgba(255,255,255,.05);color:var(--silver);margin-inline-start:auto;}
.pm-count.gold{border-color:rgba(201,168,76,.35);background:var(--gold-faint);color:var(--gold);}
#qrWrap{display:none;margin-top:12px;}
.qr-shell{position:relative;max-width:460px;border-radius:var(--r2);overflow:hidden;border:1px solid var(--rule2);background:#000;}
.qr-overlay{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center;}
.qr-frame{width:200px;height:200px;position:relative;}
.qr-frame::before,.qr-frame::after,.qr-br::before,.qr-br::after{content:"";position:absolute;width:22px;height:22px;border-color:var(--gold);border-style:solid;}
.qr-frame::before{top:0;right:0;border-width:2px 2px 0 0;}
.qr-frame::after{top:0;left:0;border-width:2px 0 0 2px;}
.qr-br::before{bottom:0;right:0;border-width:0 2px 2px 0;}
.qr-br::after{bottom:0;left:0;border-width:0 0 2px 2px;}
.qr-scan{position:absolute;left:5%;right:5%;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);box-shadow:0 0 8px var(--gold);animation:scan 2s ease-in-out infinite alternate;}
@keyframes scan{from{top:8%}to{top:92%}}
.courier-bar{display:flex;align-items:center;gap:6px;flex-wrap:wrap;padding:7px 12px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);margin-bottom:8px;font-size:11px;}
.cb-label{color:var(--mist);flex-shrink:0;}
.cb-chip{padding:3px 10px;border-radius:var(--r4);border:1px solid var(--rule2);background:rgba(255,255,255,.05);color:var(--silver);cursor:pointer;font-size:11px;font-weight:600;transition:all .15s;min-height:unset;}
.cb-chip:hover,.cb-chip.active{background:var(--gold-faint);border-color:rgba(201,168,76,.35);color:var(--gold);}
.ship-tabs{display:flex;gap:4px;background:rgba(255,255,255,.03);border:1px solid var(--rule);border-radius:var(--r2);padding:3px;width:fit-content;}
.ship-tab{padding:7px 14px;border-radius:var(--r1);font-size:11px;font-weight:700;color:var(--mist);cursor:pointer;transition:all .18s;border:1px solid transparent;background:transparent;min-height:unset;display:flex;align-items:center;gap:6px;}
.ship-tab.tab-normal{color:var(--green);background:var(--green-faint);border-color:rgba(39,174,96,.25);}
.ship-tab.tab-follow{color:var(--amber);background:var(--amber-faint);border-color:rgba(212,150,26,.25);}
.ship-tab.tab-overdue{color:var(--red);background:var(--red-faint);border-color:rgba(192,57,43,.25);}
.tab-n{font-family:'JetBrains Mono',monospace;font-size:10px;padding:1px 6px;border-radius:var(--r4);background:rgba(255,255,255,.08);}
.days-chip{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;padding:2px 9px;border-radius:var(--r4);border:1px solid rgba(212,150,26,.3);background:var(--amber-faint);color:var(--amber);}
.days-chip.danger{border-color:rgba(192,57,43,.3);background:var(--red-faint);color:var(--red);}
.days-chip.safe{border-color:rgba(39,174,96,.25);background:var(--green-faint);color:var(--green);}
.courier-chip{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;border-radius:var(--r4);font-size:10px;font-weight:600;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);}
.courier-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.c-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px;}
.c-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:var(--r4);border:1px solid var(--rule);background:rgba(255,255,255,.04);cursor:pointer;font-size:11px;font-weight:600;color:var(--silver);transition:all .15s;min-height:unset;}
.c-badge.active{border-color:var(--gold);background:var(--gold-faint);color:var(--gold);}
.c-badge.overdue-c{border-color:rgba(192,57,43,.3);background:var(--red-faint);color:#e74c3c;}
.c-n{font-family:'JetBrains Mono',monospace;font-size:10px;padding:1px 6px;border-radius:var(--r4);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);}
.ship-summary-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-bottom:10px;padding:10px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);}
.ssb-item{display:flex;flex-direction:column;align-items:center;gap:2px;}
.ssb-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:var(--white);}
.ssb-val.gold{color:var(--gold);}.ssb-val.green{color:var(--green);}
.empty{display:flex;flex-direction:column;align-items:center;padding:40px 20px;gap:8px;color:var(--mist);text-align:center;}
.empty-icon{font-size:32px;opacity:.3;}
.empty-text{font-family:'Cormorant Garamond',serif;font-size:16px;}
#scrollTopBtn{position:fixed;bottom:24px;left:24px;width:42px;height:42px;border-radius:50%;background:var(--ink2);border:1px solid var(--rule2);color:var(--silver);font-size:16px;cursor:pointer;box-shadow:var(--sh2);display:none;align-items:center;justify-content:center;z-index:300;min-height:unset;padding:0;}
#scrollTopBtn.visible{display:flex;}
@media(max-width:640px){.nav-top{padding:8px 10px 0;}.tab-bar{padding:6px 10px 0;}.tab-panel{padding:10px;}.kpi-grid{grid-template-columns:repeat(2,1fr);}}
@media print{.nav-shell,.tab-bar,.no-print,button{display:none!important;}.tab-panel{display:block!important;}.card{background:#fff!important;border:none!important;}}
</style>
</head>
<body>

<div id="loadingOverlay"><div class="spinner"></div><div class="loading-txt" id="loadingTxt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div>
<div id="statusToast"><div class="toast-box" id="toastBox"><div class="toast-icon" id="toastIcon">âœ…</div><div class="toast-body"><div class="toast-title" id="toastTitle">ØªÙ…</div><div class="toast-sub" id="toastSub"></div></div><div class="toast-progress" id="toastProgress"></div></div></div>
<div id="notifPanel"></div>

<div id="printMenu"><div class="print-menu-box">
  <div style="padding:10px 12px 8px;border-bottom:1px solid var(--rule);margin-bottom:6px;"><div style="font-family:'Cormorant Garamond',serif;font-size:14px;color:var(--pearl);font-weight:600;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div></div>
  <button class="pm-item" onclick="doPrintBatch('new')">ğŸ†• Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©<span class="pm-count gold" id="pmNewCount">0</span></button>
  <button class="pm-item" onclick="doPrintBatch('pending')">ğŸ–¨ï¸ ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©<span class="pm-count gold" id="pmPendingCount">0</span></button>
  <button class="pm-item" onclick="doPrintBatch('both')">ğŸ“‹ Ø§Ù„ÙƒÙ„<span class="pm-count gold" id="pmBothCount">0</span></button>
</div></div>

<div id="inlineModal"><div id="inlineModalBox"><div id="inlineModalContent"></div></div></div>

<div class="nav-shell">
  <div class="nav-top">
    <div><div class="brand-name-nav">White Clothes</div><div class="brand-tag-nav">Management System</div></div>
    <div class="nav-metrics">
      <div class="nav-metric"><div class="nm-val" id="metricOrders">0</div><div class="nm-lbl">Ø·Ù„Ø¨Ø§Øª</div></div>
      <div class="nav-metric"><div class="nm-val" id="metricSubtotal">0</div><div class="nm-lbl">ØªØ­ØµÙŠÙ„</div></div>
      <div class="nav-metric"><div class="nm-val" id="metricShipping">0</div><div class="nm-lbl">Ø´Ø­Ù†</div></div>
      <span class="clock-nav" id="clock"></span>
    </div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('delivery',this)">ğŸšš Ø§Ù„ØªÙˆØµÙŠÙ„<span class="tab-badge" id="tabDeliveryBadge">0</span></button>
    <button class="tab-btn" onclick="switchTab('order-form',this)">â• Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯</button>
    <button class="tab-btn" onclick="switchTab('edit-order',this)">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆØ±Ø¯Ø±</button>
    <button class="tab-btn" onclick="switchTab('products',this)">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª<span class="tab-badge" id="tabProductsBadge">0</span></button>
    <button class="tab-btn" onclick="switchTab('purchases',this)">ğŸ›’ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
    <button class="tab-btn" onclick="switchTab('expenses',this)">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
    <button class="tab-btn" onclick="switchTab('treasury',this)">ğŸ’° Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</button>
  </div>
  <div class="topbar-btn-row" id="deliveryActionBar">
    <button class="tb-btn" id="printPendingBtn" onclick="togglePrintMenu(event)">ğŸ–¨ï¸ ÙÙˆØ§ØªÙŠØ±<span class="tb-badge" id="pendingTotal">0</span></button>
    <button class="tb-btn" id="awaitBtn" onclick="toggleCard('awaitCard')">ğŸ“¦ Ø§Ù†ØªØ¸Ø§Ø±<span class="tb-badge" id="awaitCountBadge">0</span></button>
    <button class="tb-btn" id="shipBtn" onclick="toggleCard('shipCard')">ğŸšš Ø´Ø­Ù†<span class="tb-badge" id="shipCountBadge">0</span><span class="ship-dot" id="shipDot"></span></button>
    <button class="tb-btn" onclick="showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦');refreshAll(true).finally(hideLoading)">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    <button class="tb-btn btn-danger" style="border-color:rgba(192,57,43,.3)" onclick="clearMine()">ğŸ§¹ Ù…Ø³Ø­</button>
  </div>
</div>

<!-- DELIVERY TAB -->
<div class="tab-panel active" id="panel-delivery">
  <div class="card">
    <div class="card-header"><div class="card-title">ğŸ“· Ø¥Ø¶Ø§ÙØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</div></div>
    <div class="form-grid form-grid-3" style="margin-bottom:10px;">
      <div><label class="field-label">Order ID ÙŠØ¯ÙˆÙŠ</label>
        <div class="input-row"><input id="orderIdInput" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù…Ø³Ø­ QR" class="flex1"/><button class="btn-gold" onclick="addOneWithDupCheck()">Ø¥Ø¶Ø§ÙØ©</button></div></div>
      <div><label class="field-label">QR Scanner</label>
        <div class="input-row"><button style="flex:1" onclick="startScan()">ğŸ“· ØªØ´ØºÙŠÙ„</button><button style="flex:1" onclick="stopScan()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button></div></div>
      <div><label class="field-label">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯</label>
        <div class="input-row">
          <select id="statusSelect" class="flex1"><option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© â€”</option>
            <option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
            <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option><option>Ù…Ø±ØªØ¬Ø¹</option><option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option><option>Ø§Ù„ØºØ§Ø¡</option>
          </select>
          <button class="btn-gold" onclick="bulkUpdate()">âœï¸ ØªØ­Ø¯ÙŠØ«</button>
        </div></div>
    </div>
    <div class="courier-bar" id="courierBar" style="display:none;"><span class="cb-label">ğŸšš Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:</span><div id="courierChips" style="display:flex;gap:5px;flex-wrap:wrap;"></div></div>
    <div id="qrWrap"><div style="margin-top:10px;padding:10px;background:var(--ink3);border-radius:var(--r2);border:1px solid var(--rule);font-size:11px;color:var(--silver);">ğŸ“Œ Ø¶Ø¹ Ø§Ù„Ù€ QR Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
      <div style="margin-top:10px;"><div class="qr-shell"><div id="qr-reader"></div><div class="qr-overlay"><div class="qr-frame"><div class="qr-br"></div><div class="qr-scan"></div></div></div></div></div>
    </div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</div><span class="card-badge" id="indexStats">â³</span></div>
    <div class="input-row"><input id="idx_q" placeholder="Ù…ÙˆØ¨Ø§ÙŠÙ„ / Order ID / Ø§Ø³Ù… / Ù…Ø­Ø§ÙØ¸Ø©â€¦" class="flex1"/><button onclick="searchIndex()">Ø¨Ø­Ø«</button><button onclick="closeSearch()">âœ–ï¸</button></div>
  </div>
  <div class="card" id="searchCard" style="display:none;">
    <div class="card-header"><div class="card-title">ğŸ“Œ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div><span class="card-badge" id="srCount"></span></div>
    <div class="input-row" style="margin-bottom:10px;"><button class="btn-ghost" onclick="srToggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button><button class="btn-gold" onclick="srAddToMine()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯</button><button onclick="closeSearch()">âœ–ï¸</button></div>
    <div class="tbl-wrap"><table><thead><tr><th></th><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="srTbody"></tbody></table></div>
  </div>
  <div class="card" id="shipCard" style="display:none;">
    <div class="card-header"><div class="card-title">ğŸšš Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø­Ù†Ø§Øª</div><span class="card-badge" id="shipStats"></span></div>
    <div class="ship-summary-bar">
      <div class="ssb-item"><div class="ssb-val" id="ssTotal">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>
      <div class="ssb-item"><div class="ssb-val gold" id="ssSubtotal">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">ØªØ­ØµÙŠÙ„</div></div>
      <div class="ssb-item"><div class="ssb-val" id="ssShipping">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">Ø´Ø­Ù†</div></div>
      <div class="ssb-item"><div class="ssb-val green" id="ssTotal2">0</div><div style="font-size:9px;color:var(--mist);text-transform:uppercase;letter-spacing:1px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div></div>
    </div>
    <div class="input-row" style="flex-wrap:wrap;gap:8px;margin-bottom:10px;">
      <div class="ship-tabs"><button class="ship-tab" id="tabNormal" onclick="setShipTab('normal')">ğŸŸ¢ Ø·Ø¨ÙŠØ¹ÙŠ<span class="tab-n" id="bNormal">0</span></button><button class="ship-tab" id="tabFollow" onclick="setShipTab('follow')">ğŸŸ¡ Ù…ØªØ§Ø¨Ø¹Ø©<span class="tab-n" id="bFollow">0</span></button><button class="ship-tab" id="tabOverdue" onclick="setShipTab('overdue')">ğŸ”´ Ù…ØªØ£Ø®Ø±<span class="tab-n" id="bOverdue">0</span></button></div>
      <select id="shipCourierFilter" style="min-width:160px;flex:1;" onchange="renderShipTable();renderCourierBadges();"><option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option></select>
      <button onclick="printShipCurrent()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button onclick="toggleCard('shipCard')">âœ–ï¸</button>
    </div>
    <div class="c-badges" id="courierBadges"></div>
    <div class="tbl-wrap" style="margin-top:10px;"><table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="shipTbody"></tbody></table></div>
  </div>
  <div class="card" id="awaitCard" style="display:none;">
    <div class="card-header"><div class="card-title">ğŸ“¦ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø´Ø­Ù†</div><span class="card-badge" id="awaitStats"></span></div>
    <div class="input-row" style="margin-bottom:10px;"><button onclick="toggleCard('awaitCard')">âœ–ï¸ Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="awaitTbody"></tbody></table></div>
  </div>
  <div class="card" id="printArea">
    <div class="card-header" style="justify-content:space-between;">
      <div style="display:flex;align-items:center;gap:8px;"><span class="card-title">ğŸ“‹ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</span><span class="card-badge" id="selectionInfo">0 Ù…Ø­Ø¯Ø¯</span></div>
      <div style="display:flex;gap:6px;"><button class="btn-ghost" id="toggleAllBtn" onclick="toggleAll()">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button><button class="btn-ghost" onclick="downloadAllXLSX()">â¬‡ï¸ Excel</button><button class="btn-ghost" onclick="printA4()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>
    </div>
    <div class="tbl-wrap"><table><thead><tr><th></th><th>Order ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ/Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©/Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØªØ­ØµÙŠÙ„</th><th>Ø§Ù„Ø´Ø­Ù†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
    <tbody id="tbody"><tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- ORDER FORM TAB -->
<div class="tab-panel" id="panel-order-form">
  <div class="card">
    <div class="card-header"><div class="card-title">â• Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯</div><span class="card-badge" id="newOrderIdBadge">ID: â€”</span></div>
    <div class="form-section-title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
    <div class="form-grid form-grid-2" style="margin-bottom:14px;">
      <div><label class="field-label">Ø§Ù„Ø§Ø³Ù… *</label><input id="of_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„"/></div>
      <div><label class="field-label">Ø§Ù„Ù…ØµØ¯Ø±</label><select id="of_source"><option value="Direct">Direct</option><option value="Facebook">Facebook</option><option value="TikTok">TikTok</option><option value="Instagram">Instagram</option></select></div>
      <div><label class="field-label">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ *</label><input id="of_phone" placeholder="01xxxxxxxxx" type="tel"/></div>
      <div><label class="field-label">Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ</label><input id="of_phone2" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" type="tel"/></div>
      <div><label class="field-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© *</label>
        <select id="of_city"><option value="">â€” Ø§Ø®ØªØ± â€”</option>
          <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option><option>Ø§Ù„Ø¬ÙŠØ²Ø©</option><option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option><option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option><option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option><option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option><option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option><option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option>
          <option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option><option>Ø¯Ù…ÙŠØ§Ø·</option><option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option><option>Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©</option><option>Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯</option><option>Ø§Ù„Ø³ÙˆÙŠØ³</option>
          <option>Ø§Ù„ÙÙŠÙˆÙ…</option><option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option><option>Ø§Ù„Ù…Ù†ÙŠØ§</option><option>Ø£Ø³ÙŠÙˆØ·</option><option>Ø³ÙˆÙ‡Ø§Ø¬</option><option>Ù‚Ù†Ø§</option><option>Ø§Ù„Ø£Ù‚ØµØ±</option><option>Ø£Ø³ÙˆØ§Ù†</option><option>Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option><option>Ù…Ø·Ø±ÙˆØ­</option>
        </select>
      </div>
      <div><label class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ *</label><input id="of_address" placeholder="Ø§Ù„Ø´Ø§Ø±Ø¹ ÙˆØ§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©â€¦"/></div>
    </div>
    <div class="form-section-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <div id="of_products_container"></div>
    <button class="btn-blue" style="margin-bottom:14px;" onclick="addProductRow()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
    <div class="form-section-title">ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</div>
    <div class="form-grid form-grid-3" style="margin-bottom:14px;">
      <div><label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="of_payment"><option value="cod">ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)</option><option value="transfer_receipt">ØªØ­ÙˆÙŠÙ„ Ù…Ø³Ø¨Ù‚</option></select></div>
      <div><label class="field-label">Ø§Ù„Ø´Ø­Ù† (Ø¬)</label><input id="of_shipping" type="number" value="60" min="0" oninput="calcOrderTotal()"/></div>
      <div><label class="field-label">Ø®ØµÙ… (Ø¬)</label><input id="of_discount" type="number" value="0" min="0" oninput="calcOrderTotal()"/></div>
      <div><label class="field-label">ÙƒÙˆØ¨ÙˆÙ†</label><input id="of_coupon" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
      <div style="grid-column:span 2;"><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</label><input id="of_note" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£ÙˆØ±Ø¯Ø±"/></div>
    </div>
    <div style="background:var(--ink3);border:1px solid var(--rule);border-radius:var(--r2);padding:14px;margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
        <div style="font-size:12px;color:var(--mist);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <b style="color:var(--white)" id="of_subtotal_display">0 Ø¬</b></div>
        <div style="font-size:12px;color:var(--mist);">Ø§Ù„Ø´Ø­Ù†: <b style="color:var(--white)" id="of_shipping_display">0 Ø¬</b></div>
        <div style="font-size:12px;color:var(--mist);">Ø®ØµÙ…: <b style="color:#e74c3c" id="of_discount_display">0 Ø¬</b></div>
        <div style="font-size:16px;font-weight:900;color:var(--gold);">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: <span id="of_total_display">0</span> Ø¬</div>
      </div>
    </div>
    <div class="input-row" style="justify-content:flex-end;gap:10px;">
      <button onclick="resetOrderForm()">ğŸ”„ Ù…Ø³Ø­ Ø§Ù„ÙÙˆØ±Ù…</button>
      <button class="btn-gold" style="min-width:180px;" onclick="submitNewOrder()">âœ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙŠ Ø§Ù„Ø´ÙŠØª</button>
    </div>
  </div>
</div>

<!-- EDIT ORDER TAB -->
<div class="tab-panel" id="panel-edit-order">
  <div class="card">
    <div class="card-header"><div class="card-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙˆØ±Ø¯Ø± Ù…ÙˆØ¬ÙˆØ¯</div></div>
    <div class="input-row" style="margin-bottom:16px;"><input id="eo_search_id" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ Order ID Ø£Ùˆ Ù…ÙˆØ¨Ø§ÙŠÙ„â€¦" class="flex1"/><button class="btn-gold" onclick="searchOrderForEdit()">ğŸ” Ø¨Ø­Ø«</button></div>
    <div id="eo_empty" style="padding:30px;text-align:center;color:var(--mist);">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆØ±Ø¯Ø± Ø¹Ø´Ø§Ù† ØªØ¹Ø¯Ù„Ù‡</div>
    <div id="eo_result" style="display:none;">
      <div style="background:var(--ink3);border:1px solid var(--gold);border-radius:var(--r2);padding:12px;margin-bottom:14px;">
        <div style="font-size:11px;color:var(--mist);">ØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:</div>
        <div style="font-size:14px;font-weight:700;color:var(--gold);margin-top:3px;" id="eo_found_info"></div>
      </div>
      <div class="form-section-title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
      <div class="form-grid form-grid-2" style="margin-bottom:14px;">
        <div><label class="field-label">Ø§Ù„Ø§Ø³Ù…</label><input id="eo_name"/></div>
        <div><label class="field-label">Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input id="eo_phone" type="tel"/></div>
        <div><label class="field-label">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label><select id="eo_city"><option value="">â€” Ø§Ø®ØªØ± â€”</option>
          <option>Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©</option><option>Ø§Ù„Ø¬ÙŠØ²Ø©</option><option>Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©</option><option>Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©</option><option>Ø§Ù„ØºØ±Ø¨ÙŠØ©</option><option>Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©</option><option>Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option><option>Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©</option><option>ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®</option><option>Ø¯Ù…ÙŠØ§Ø·</option><option>Ø§Ù„Ø¨Ø­ÙŠØ±Ø©</option><option>Ø§Ù„ÙÙŠÙˆÙ…</option><option>Ø¨Ù†ÙŠ Ø³ÙˆÙŠÙ</option><option>Ø§Ù„Ù…Ù†ÙŠØ§</option><option>Ø£Ø³ÙŠÙˆØ·</option><option>Ø³ÙˆÙ‡Ø§Ø¬</option>
        </select></div>
        <div><label class="field-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input id="eo_address"/></div>
      </div>
      <div class="form-section-title">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
      <div id="eo_products_container" style="margin-bottom:10px;"></div>
      <button class="btn-blue" style="margin-bottom:14px;" onclick="addProductRowEdit()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
      <div class="form-section-title">ğŸ“ ØªÙØ§ØµÙŠÙ„</div>
      <div class="form-grid form-grid-3" style="margin-bottom:14px;">
        <div><label class="field-label">Ø§Ù„Ø´Ø­Ù† (Ø¬)</label><input id="eo_shipping" type="number"/></div>
        <div><label class="field-label">Ø®ØµÙ… (Ø¬)</label><input id="eo_discount" type="number" value="0"/></div>
        <div><label class="field-label">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="eo_status"><option>New</option><option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option><option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option><option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option><option>Ù…Ø±ØªØ¬Ø¹</option><option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option><option>Ø§Ù„ØºØ§Ø¡</option></select></div>
        <div style="grid-column:span 3;"><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="eo_note"/></div>
      </div>
      <input type="hidden" id="eo_order_id"/><input type="hidden" id="eo_row_index"/>
      <div class="input-row" style="justify-content:flex-end;gap:10px;">
        <button onclick="document.getElementById('eo_result').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn-gold" style="min-width:180px;" onclick="submitEditOrder()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </div>
    </div>
  </div>
</div>

<!-- PRODUCTS TAB -->
<div class="tab-panel" id="panel-products">
  <div class="kpi-grid">
    <div class="kpi-tile kt-gold"><div class="kpi-icon">ğŸ“¦</div><div class="kpi-val kv-gold" id="kpi_total_skus">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ SKUs</div></div>
    <div class="kpi-tile kt-green"><div class="kpi-icon">âœ…</div><div class="kpi-val kv-green" id="kpi_in_stock">0</div><div class="kpi-lbl">Ù…ØªÙˆÙØ±</div></div>
    <div class="kpi-tile kt-amber"><div class="kpi-icon">âš ï¸</div><div class="kpi-val kv-amber" id="kpi_low_stock">0</div><div class="kpi-lbl">Ù‚Ù„ÙŠÙ„ (â‰¤10)</div></div>
    <div class="kpi-tile kt-red"><div class="kpi-icon">âŒ</div><div class="kpi-val kv-red" id="kpi_out_stock">0</div><div class="kpi-lbl">Ù†ÙØ¯</div></div>
    <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸ“Š</div><div class="kpi-val kv-blue" id="kpi_total_sold">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø¹</div></div>
    <div class="kpi-tile kt-purple"><div class="kpi-icon">ğŸ’°</div><div class="kpi-val kv-purple" id="kpi_inv_value">0</div><div class="kpi-lbl">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></div>
  </div>
  <div class="card"><div class="input-row" style="flex-wrap:wrap;gap:8px;">
    <input id="prod_search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ SKUâ€¦" class="flex1" oninput="renderProductsTable()"/>
    <select id="prod_filter_status" onchange="renderProductsTable()" style="min-width:160px;"><option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option><option value="ok">âœ… Ù…ØªÙˆÙØ±</option><option value="low">âš ï¸ Ù‚Ù„ÙŠÙ„</option><option value="empty">âŒ Ù†ÙØ¯</option></select>
    <button class="btn-gold" onclick="loadProducts()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  </div></div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ“¦ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div><span class="card-badge" id="prodTableBadge">â€”</span></div>
    <div class="tbl-wrap"><table><thead><tr><th>SKU</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù„ÙˆÙ†</th><th>Ø§Ù„Ù…Ù‚Ø§Ø³</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ù‡Ø§Ù…Ø´ %</th><th>Ø§Ù„Ù…Ø¨Ø§Ø¹</th><th>Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="prodTbody"><tr><td colspan="12"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- PURCHASES TAB -->
<div class="tab-panel" id="panel-purchases">
  <div class="card"><div class="card-header"><div class="card-title">ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±ÙŠØ§Øª</div></div>
    <div class="form-grid form-grid-3" style="margin-bottom:12px;">
      <div><label class="field-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ (SKU)</label><select id="pur_sku" onchange="onPurchaseSKUSelect()"><option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ â€”</option></select></div>
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="pur_product_name" readonly style="background:var(--ink3);color:var(--mist);"/></div>
      <div><label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label><input id="pur_qty" type="number" min="1" value="1" oninput="calcPurchaseTotal()"/></div>
      <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø¬) *</label><input id="pur_unit_price" type="number" min="0" oninput="calcPurchaseTotal()"/></div>
      <div><label class="field-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¬)</label><input id="pur_total" readonly style="background:var(--ink3);color:var(--gold);font-weight:700;"/></div>
      <div><label class="field-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ *</label><input id="pur_supplier" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯"/></div>
      <div><label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="pur_method"><option>ÙƒØ§Ø´</option><option>ØªØ­ÙˆÙŠÙ„</option><option>Ø´ÙŠÙƒ</option><option>Ø¢Ø¬Ù„</option></select></div>
      <div><label class="field-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="pur_status"><option>Ù…Ø¯ÙÙˆØ¹</option><option>Ø¬Ø²Ø¦ÙŠ</option><option>Ø¢Ø¬Ù„</option></select></div>
      <div><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="pur_notes" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;"><button onclick="resetPurchaseForm()">ğŸ”„ Ù…Ø³Ø­</button><button class="btn-gold" onclick="submitPurchase()">âœ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button></div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div><span class="card-badge" id="purTableBadge">â€”</span></div>
    <div class="input-row" style="margin-bottom:10px;"><input id="pur_search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ SKU Ø£Ùˆ Ù…ÙˆØ±Ø¯â€¦" class="flex1" oninput="renderPurchasesTable()"/><button class="btn-gold" onclick="loadPurchases()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>SKU</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="purTbody"><tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ø¹Ø¯</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- EXPENSES TAB -->
<div class="tab-panel" id="panel-expenses">
  <div class="card"><div class="card-header"><div class="card-title">ğŸ’¸ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</div></div>
    <div class="form-grid form-grid-3" style="margin-bottom:12px;">
      <div><label class="field-label">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ *</label><select id="exp_type"><option>Ø¥ÙŠØ¬Ø§Ø±</option><option>Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</option><option>Ø±ÙˆØ§ØªØ¨</option><option>Ø´Ø­Ù†</option><option>Ù…ÙˆØ§Ø¯ ØªØºÙ„ÙŠÙ</option><option>ØµÙŠØ§Ù†Ø©</option><option>ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØºØ§Ø²</option><option>Ø£Ø¯ÙˆØ§Øª Ù…ÙƒØªØ¨ÙŠØ©</option><option>Ù…ØªÙ†ÙˆØ¹</option></select></div>
      <div><label class="field-label">Ø§Ù„ÙˆØµÙ *</label><input id="exp_desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ"/></div>
      <div><label class="field-label">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¬) *</label><input id="exp_amount" type="number" min="0" placeholder="0"/></div>
      <div><label class="field-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="exp_date" type="date"/></div>
      <div><label class="field-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select id="exp_method"><option>ÙƒØ§Ø´</option><option>ØªØ­ÙˆÙŠÙ„</option><option>Ø´ÙŠÙƒ</option></select></div>
      <div><label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="exp_notes" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"/></div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:10px;"><button onclick="resetExpenseForm()">ğŸ”„ Ù…Ø³Ø­</button><button class="btn-gold" onclick="submitExpense()">âœ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button></div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div><span class="card-badge" id="expTableBadge">â€”</span></div>
    <div class="input-row" style="margin-bottom:10px;"><select id="exp_filter_type" onchange="renderExpensesTable()" style="min-width:160px;"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option><option>Ø¥ÙŠØ¬Ø§Ø±</option><option>Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</option><option>Ø±ÙˆØ§ØªØ¨</option><option>Ø´Ø­Ù†</option><option>Ù…ÙˆØ§Ø¯ ØªØºÙ„ÙŠÙ</option><option>Ù…ØªÙ†ÙˆØ¹</option></select><button class="btn-gold" onclick="loadExpenses()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody id="expTbody"><tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ’¸</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¹Ø¯</div></div></td></tr></tbody></table></div>
  </div>
</div>

<!-- TREASURY TAB -->
<div class="tab-panel" id="panel-treasury">
  <div class="kpi-grid">
    <div class="kpi-tile kt-green"><div class="kpi-icon">ğŸ’°</div><div class="kpi-val kv-green" id="tr_sales">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ø­ØµÙ‘Ù„Ø©</div><div class="kpi-sub">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙÙ‚Ø·</div></div>
    <div class="kpi-tile kt-red"><div class="kpi-icon">ğŸ›’</div><div class="kpi-val kv-red" id="tr_purchases">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div></div>
    <div class="kpi-tile kt-amber"><div class="kpi-icon">ğŸ’¸</div><div class="kpi-val kv-amber" id="tr_expenses">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div></div>
    <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸšš</div><div class="kpi-val kv-blue" id="tr_shipping_cost">0</div><div class="kpi-lbl">ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†</div></div>
    <div class="kpi-tile kt-gold" style="border-color:rgba(201,168,76,.4);"><div class="kpi-icon">ğŸ“ˆ</div><div class="kpi-val kv-gold" id="tr_net_profit">0</div><div class="kpi-lbl">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div><div class="kpi-sub" id="tr_margin">Ù‡Ø§Ù…Ø´: â€”%</div></div>
    <div class="kpi-tile kt-purple"><div class="kpi-icon">â†©ï¸</div><div class="kpi-val kv-purple" id="tr_returns">0</div><div class="kpi-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</div></div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ“… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div><button class="btn-ghost" onclick="loadTreasury()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button></div>
    <div class="tbl-wrap"><table><thead><tr><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</th><th>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (Ø¬)</th><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª (Ø¬)</th><th>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø¬)</th><th>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¬)</th><th>Ù‡Ø§Ù…Ø´ %</th><th>Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (Ø¬)</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø¬)</th></tr></thead><tbody id="treasuryTbody"></tbody></table></div>
  </div>
  <div class="card"><div class="card-header"><div class="card-title">ğŸ“¦ Ù„Ù…Ø­Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div></div>
    <div class="kpi-grid">
      <div class="kpi-tile kt-blue"><div class="kpi-icon">ğŸ’µ</div><div class="kpi-val kv-blue" id="tr_inv_cost">0</div><div class="kpi-lbl">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (ØªÙƒÙ„ÙØ©)</div></div>
      <div class="kpi-tile kt-green"><div class="kpi-icon">ğŸ’</div><div class="kpi-val kv-green" id="tr_inv_sale">0</div><div class="kpi-lbl">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨ÙŠØ¹)</div></div>
      <div class="kpi-tile kt-red"><div class="kpi-icon">âŒ</div><div class="kpi-val kv-red" id="tr_out_stock">0</div><div class="kpi-lbl">Ù…Ù†ØªØ¬Ø§Øª Ù†ÙØ¯Øª</div></div>
      <div class="kpi-tile kt-amber"><div class="kpi-icon">âš ï¸</div><div class="kpi-val kv-amber" id="tr_low_stock">0</div><div class="kpi-lbl">Ù…Ù†ØªØ¬Ø§Øª Ù‚Ù„ÙŠÙ„Ø©</div></div>
    </div>
  </div>
</div>

<button id="scrollTopBtn" onclick="window.scrollTo({top:0,behavior:'smooth'})">â†‘</button>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHITE CLOTHES â€” Management System â€” JS Part 1
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ CONFIG â€” ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù€ key â”€â”€ */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwsMr7euLyvoHz0Sr_k26N_HJYG_O_W5mb061-ljwm-G6I2n0W_Wjb2aiXCk0hg0HkN/exec";
const API_KEY     = "123";

/* â”€â”€ STATE â”€â”€ */
let rows         = [];
let selected     = new Set();
let mineIds      = new Set();
let allCache     = { rows: [], ts: 0 };
let shipAll      = [];
let awaitOrders  = [];
let shipTabMode  = "normal";
let productsCache= [];
let purchasesCache=[];
let expensesCache = [];
let courierStats  = {};
let dupTimes      = {};
let productRowCounter = 0;
let editProductRowCounter = 0;

/* â”€â”€ UTILS â”€â”€ */
function esc(s){
  return String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function fmt(n){
  const v=parseFloat(n)||0;
  return v%1===0?v.toLocaleString("ar-EG"):v.toFixed(1);
}
function fmtDate(s){
  if(!s)return"";
  try{const d=new Date(String(s).replace(/\//g,"-"));
    if(isNaN(d))return String(s).slice(0,10);
    return d.toLocaleDateString("ar-EG",{day:"2-digit",month:"2-digit",year:"numeric"});
  }catch{return String(s).slice(0,10);}
}

/* â”€â”€ CLOCK â”€â”€ */
setInterval(()=>{
  const el=document.getElementById("clock");
  if(el)el.textContent=new Date().toLocaleTimeString("ar-EG",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
},1000);

/* â”€â”€ LOADING â”€â”€ */
function showLoading(txt="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦"){
  const ov=document.getElementById("loadingOverlay");
  const lt=document.getElementById("loadingTxt");
  if(ov)ov.classList.add("active");
  if(lt)lt.textContent=txt;
}
function hideLoading(){
  const ov=document.getElementById("loadingOverlay");
  if(ov)ov.classList.remove("active");
}

/* â”€â”€ TOAST â”€â”€ */
let _toastTimer=null;
function toast(title,sub="",type="",dur=3000){
  const box=document.getElementById("toastBox");
  const ic=document.getElementById("toastIcon");
  const ti=document.getElementById("toastTitle");
  const ts=document.getElementById("toastSub");
  const tp=document.getElementById("toastProgress");
  const el=document.getElementById("statusToast");
  if(!el)return;
  if(ic)ic.textContent=type==="ok"?"âœ…":type==="err"?"âŒ":type==="warn"?"âš ï¸":"â„¹ï¸";
  if(ti)ti.textContent=title;
  if(ts)ts.textContent=sub;
  if(box){box.className="toast-box";if(type)box.classList.add("t-"+type);}
  if(tp){tp.style.animation="none";tp.offsetHeight;tp.style.animation="";}
  el.classList.add("show");
  if(_toastTimer)clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>el.classList.remove("show"),dur);
}

/* â”€â”€ MODAL â”€â”€ */
function openModal(html){
  const el=document.getElementById("inlineModal");
  const c=document.getElementById("inlineModalContent");
  if(c)c.innerHTML=html;
  if(el)el.classList.add("open");
}
function closeModal(){
  const el=document.getElementById("inlineModal");
  if(el)el.classList.remove("open");
}
document.getElementById("inlineModal")?.addEventListener("click",e=>{
  if(e.target===document.getElementById("inlineModal"))closeModal();
});

/* â”€â”€ TAB SWITCHING â”€â”€ */
function switchTab(name,btn){
  document.querySelectorAll(".tab-panel").forEach(p=>p.classList.remove("active"));
  document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
  const panel=document.getElementById("panel-"+name);
  if(panel)panel.classList.add("active");
  if(btn)btn.classList.add("active");
  const bar=document.getElementById("deliveryActionBar");
  if(bar)bar.style.display=name==="delivery"?"flex":"none";
  // Lazy-load tabs
  if(name==="products"&&!productsCache.length)loadProducts();
  if(name==="purchases"&&!purchasesCache.length)loadPurchases();
  if(name==="expenses"&&!expensesCache.length)loadExpenses();
  if(name==="treasury")loadTreasury();
}

/* â”€â”€ API â”€â”€ */
function api(action,params={}){
  return new Promise((resolve,reject)=>{
    const cb="cb_"+Date.now()+"_"+Math.random().toString(36).slice(2);
    const p=new URLSearchParams({action,key:API_KEY,callback:cb,...Object.fromEntries(
      Object.entries(params).map(([k,v])=>[k,typeof v==="object"?JSON.stringify(v):String(v)])
    )});
    const url=WEB_APP_URL+"?"+p.toString();
    const script=document.createElement("script");
    const timer=setTimeout(()=>{cleanup();reject(new Error("timeout"));},15000);
    window[cb]=(data)=>{cleanup();resolve(data);};
    function cleanup(){clearTimeout(timer);delete window[cb];script.remove();}
    script.onerror=()=>{cleanup();reject(new Error("network error"));};
    script.src=url;
    document.head.appendChild(script);
  });
}

/* â”€â”€ LOCAL STORAGE â”€â”€ */
const MINE_KEY="wc_mine_ids";
const CACHE_KEY="wc_allcache";
const DUP_KEY="wc_dup_times";
const COURIER_KEY="wc_courier_colors";

function saveMine(){try{localStorage.setItem(MINE_KEY,JSON.stringify([...mineIds]));}catch{}}
function loadMine(){try{const d=JSON.parse(localStorage.getItem(MINE_KEY)||"[]");mineIds=new Set(d);}catch{mineIds=new Set();}}
function saveCachedData(rows){try{localStorage.setItem(CACHE_KEY,JSON.stringify({rows,ts:Date.now()}));}catch{}}
function loadCachedData(){try{return JSON.parse(localStorage.getItem(CACHE_KEY)||"null");}catch{return null;}}
function saveDupTimes(){try{localStorage.setItem(DUP_KEY,JSON.stringify(dupTimes));}catch{}}
function loadDupTimes(){try{dupTimes=JSON.parse(localStorage.getItem(DUP_KEY)||"{}");}catch{dupTimes={};}}
function pruneDupTimes(){
  loadDupTimes();
  const now=Date.now();
  Object.keys(dupTimes).forEach(k=>{if(now-dupTimes[k]>24*3600*1000)delete dupTimes[k];});
  saveDupTimes();
}

/* â”€â”€ STATUS BADGE â”€â”€ */
function statusBadge(s){
  const map={
    "New":           ["b-ok","ğŸ†•"],
    "ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©":   ["b-warn","ğŸ–¨ï¸"],
    "ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©":    ["b-warn","âœ…"],
    "ØªÙ… Ø§Ù„Ø´Ø­Ù†":      ["b-warn","ğŸšš"],
    "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…":    ["b-ok","ğŸ‰"],
    "Ù…Ø±ØªØ¬Ø¹":         ["b-err","â†©ï¸"],
    "Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ":    ["b-err","â†©ï¸"],
    "Ø§Ù„ØºØ§Ø¡":         ["b-cancel","âŒ"],
  };
  const [cls,icon]=map[s]||["b-cancel","â“"];
  return `<span class="badge ${cls}"><span class="badge-dot"></span>${icon} ${esc(s||"â€”")}</span>`;
}

/* â”€â”€ FETCH ALL ROWS â”€â”€ */
async function fetchAllRows(force=false){
  const now=Date.now();
  if(!force&&allCache.rows.length&&now-allCache.ts<30000)return{ok:true,rows:allCache.rows};
  const res=await api("scanList");
  if(res?.ok&&res.rows){
    allCache={rows:res.rows,ts:now};
    saveCachedData(res.rows);
    const idxEl=document.getElementById("indexStats");
    if(idxEl)idxEl.textContent=res.rows.length+" Ø£ÙˆØ±Ø¯Ø±";
  }
  return res;
}

function processAllRows(allRows){
  // Update ship and await caches
  shipAll=allRows.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†");
  awaitOrders=allRows.filter(r=>String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");

  // Update ship count badge
  const sd=document.getElementById("shipDot");
  const scb=document.getElementById("shipCountBadge");
  const overdue=shipAll.filter(r=>{
    const d=r.shipDate||r.shippedDate||"";
    if(!d)return false;
    const dt=new Date(String(d).replace(/\//g,"-"));
    return(Date.now()-dt.getTime())/(86400000)>=10;
  });
  if(sd){sd.style.display=overdue.length?"flex":"none";sd.textContent=overdue.length;}
  if(scb)scb.textContent=shipAll.length;

  const acb=document.getElementById("awaitCountBadge");
  if(acb)acb.textContent=awaitOrders.length;

  // Build courier filter
  const couriers=[...new Set(shipAll.map(r=>String(r.courier||r.deliveryMan||"")).filter(Boolean))];
  const sel=document.getElementById("shipCourierFilter");
  if(sel){
    const cur=sel.value;
    sel.innerHTML=`<option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ÙŠÙ†</option>`+couriers.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
    if(cur)sel.value=cur;
  }

  // Render mine rows
  const myRows=allRows.filter(r=>mineIds.has(String(r.orderId||r.id||"")));
  rows=myRows;
  renderTable();
  updateNavMetrics();
  updatePrintCounts(allRows);
  renderShipTable();
  renderAwaitTable();
  renderCourierBar();
}

/* â”€â”€ REFRESH â”€â”€ */
async function refreshAll(force=false){
  try{
    const res=await fetchAllRows(force);
    if(res?.ok&&res.rows)processAllRows(res.rows);
  }catch(e){toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«","","warn");}
}

/* â”€â”€ NAV METRICS â”€â”€ */
function updateNavMetrics(){
  const om=document.getElementById("metricOrders");
  const sm=document.getElementById("metricSubtotal");
  const shm=document.getElementById("metricShipping");
  if(om)om.textContent=rows.length;
  const sub=rows.reduce((s,r)=>s+Number(r.subtotal||r.productTotal||0),0);
  const sh=rows.reduce((s,r)=>s+Number(r.shipping||0),0);
  if(sm)sm.textContent=fmt(sub);
  if(shm)shm.textContent=fmt(sh);
  const tbb=document.getElementById("tabDeliveryBadge");
  if(tbb)tbb.textContent=rows.length;
}

/* â”€â”€ PRINT COUNTS â”€â”€ */
function updatePrintCounts(allRows){
  const newOrders=allRows.filter(r=>["New","ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"].includes(String(r.status||"").trim()));
  const pendingOrders=allRows.filter(r=>String(r.status||"").trim()==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  const ptEl=document.getElementById("pendingTotal");
  if(ptEl)ptEl.textContent=newOrders.length;
  const pmN=document.getElementById("pmNewCount");
  const pmP=document.getElementById("pmPendingCount");
  const pmB=document.getElementById("pmBothCount");
  if(pmN)pmN.textContent=allRows.filter(r=>String(r.status||"").trim()==="New").length;
  if(pmP)pmP.textContent=pendingOrders.length;
  if(pmB)pmB.textContent=newOrders.length;
  const ppb=document.getElementById("printPendingBtn");
  if(ppb)ppb.classList.toggle("pending-active",pendingOrders.length>0);
}

/* â”€â”€ TOGGLE CARD â”€â”€ */
function toggleCard(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.display=el.style.display==="none"?"block":"none";
  if(id==="shipCard"&&el.style.display!=="none"){renderShipTable();setShipTab("normal");}
  if(id==="awaitCard"&&el.style.display!=="none")renderAwaitTable();
}

/* â”€â”€ RENDER TABLE (My Orders) â”€â”€ */
function renderTable(){
  const tbody=document.getElementById("tbody");
  if(!tbody)return;
  if(!rows.length){
    tbody.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¨Ø¹Ø¯</div></div></td></tr>`;
    document.getElementById("selectionInfo").textContent="0 Ù…Ø­Ø¯Ø¯";
    return;
  }
  tbody.innerHTML="";
  rows.forEach(r=>{
    const id=String(r.orderId||r.id||"");
    const checked=selected.has(id);
    const tr=document.createElement("tr");
    if(checked)tr.style.background="rgba(201,168,76,.06)";
    const shipDateStr=r.shipDate||r.shippedDate||"";
    let daysChipHtml="";
    if(String(r.status||"").trim()==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"&&shipDateStr){
      const days=Math.floor((Date.now()-new Date(String(shipDateStr).replace(/\//g,"-")).getTime())/86400000);
      const cls=days>=10?"danger":days>=6?"":"safe";
      daysChipHtml=`<div class="days-chip ${cls}" style="margin-top:3px;display:inline-flex">${days}ÙŠÙˆÙ…</div>`;
    }
    const courierColor=getCourierColor(r.courier||r.deliveryMan||"");
    const courierHtml=r.courier||r.deliveryMan?`<div class="courier-chip" style="margin-top:3px;border-color:${courierColor}33;background:${courierColor}11"><span class="courier-dot" style="background:${courierColor}"></span>${esc(r.courier||r.deliveryMan)}</div>`:"";
    tr.innerHTML=`
      <td><input type="checkbox" ${checked?"checked":""} onchange="toggleSelect('${id}',this.checked)"/></td>
      <td class="td-id">${esc(id)}</td>
      <td class="td-name">${esc(r.customer||r.name||"")}</td>
      <td class="td-phone"><div>${esc(r.phone||r.phone1||"")}</div><div style="font-size:10px;color:var(--mist)">${esc(r.city||"")} â€” ${esc(r.address||"").slice(0,25)}${(r.address||"").length>25?"â€¦":""}</div></td>
      <td class="td-amount">${fmt(r.subtotal||r.productTotal||0)} Ø¬</td>
      <td class="mono" style="font-size:11px">${fmt(r.shipping||0)} Ø¬</td>
      <td>${statusBadge(r.status||"")}${daysChipHtml}${courierHtml}</td>
      <td class="mono" style="font-size:10px">${fmtDate(r.date||"")}</td>
      <td>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          <button class="qa-btn qa-print" onclick="quickAction('${id}','print')">ğŸ–¨ï¸</button>
          <button class="qa-btn qa-ship" onclick="quickAction('${id}','ship')">ğŸšš</button>
          <button class="qa-btn qa-done" onclick="quickAction('${id}','done')">âœ…</button>
          <button class="qa-btn qa-ret" onclick="quickAction('${id}','return')">â†©ï¸</button>
          <button class="qa-btn" onclick="removeFromMine('${id}')">ğŸ—‘</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
  updateSelectionInfo();
}

/* â”€â”€ COURIER COLORS â”€â”€ */
const COURIER_PALETTE=["#c9a84c","#3498db","#27ae60","#e74c3c","#9b59b6","#e67e22","#1abc9c","#e91e63","#ff9800","#00bcd4"];
function getCourierColor(name){
  if(!name)return"#666";
  let h=0;for(let i=0;i<name.length;i++)h=(h*31+name.charCodeAt(i))%COURIER_PALETTE.length;
  return COURIER_PALETTE[h];
}
function renderCourierBar(){
  const sel=document.getElementById("statusSelect");
  const bar=document.getElementById("courierBar");
  const chips=document.getElementById("courierChips");
  if(!sel||!bar||!chips)return;
  if(sel.value==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"){
    bar.style.display="flex";
    const couriers=[...new Set(shipAll.map(r=>String(r.courier||r.deliveryMan||"")).filter(Boolean))];
    chips.innerHTML=couriers.map(c=>`<button class="cb-chip" onclick="setCourier('${esc(c)}')">${esc(c)}</button>`).join("");
  }else{bar.style.display="none";}
}
let _selectedCourier="";
function setCourier(name){_selectedCourier=name;document.querySelectorAll(".cb-chip").forEach(c=>c.classList.toggle("active",c.textContent===name));}

/* â”€â”€ SELECT â”€â”€ */
function toggleSelect(id,checked){
  if(checked)selected.add(id);else selected.delete(id);
  updateSelectionInfo();
  const row=document.querySelector(`input[type=checkbox][onchange*="'${id}'"]`)?.closest("tr");
  if(row)row.style.background=checked?"rgba(201,168,76,.06)":"";
}
function updateSelectionInfo(){
  const el=document.getElementById("selectionInfo");
  if(el)el.textContent=selected.size+" Ù…Ø­Ø¯Ø¯";
  const allChecked=rows.length>0&&rows.every(r=>selected.has(String(r.orderId||r.id||"")));
  const tb=document.getElementById("toggleAllBtn");
  if(tb)tb.textContent=allChecked?"Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„":"ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„";
}
function toggleAll(){
  const allChecked=rows.every(r=>selected.has(String(r.orderId||r.id||"")));
  if(allChecked)selected.clear();else rows.forEach(r=>selected.add(String(r.orderId||r.id||"")));
  renderTable();
}

/* â”€â”€ ADD / REMOVE â”€â”€ */
function addOneWithDupCheck(){
  const el=document.getElementById("orderIdInput");
  if(!el)return;
  const id=(el.value||"").trim();
  if(!id)return;
  const now=Date.now();
  loadDupTimes();
  if(dupTimes[id]&&now-dupTimes[id]<24*3600*1000){
    showDupNotif(id,now-dupTimes[id]);
  }else{
    doAddId(id);
    el.value="";
  }
}
function doAddId(id){
  if(mineIds.has(id)){toast("Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„","","warn");return;}
  mineIds.add(id);
  saveMine();
  dupTimes[id]=Date.now();
  saveDupTimes();
  const all=allCache.rows;
  const found=all.find(r=>String(r.orderId||r.id||"")===id);
  if(found){rows=[found,...rows.filter(r=>String(r.orderId||r.id||"")!==id)];renderTable();updateNavMetrics();}
  else{api("scanAdd",{orderId:id}).then(res=>{if(res?.ok)refreshAll(true);});}
}
function removeFromMine(id){
  mineIds.delete(id);selected.delete(id);
  rows=rows.filter(r=>String(r.orderId||r.id||"")!==id);
  saveMine();renderTable();updateNavMetrics();
}
function clearMine(){
  openModal(`<div style="margin-bottom:16px;font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--white)">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§ØªØŸ</div>
  <div style="font-size:12px;color:var(--mist);margin-bottom:16px;">Ù‡ÙŠØªÙ… Ù…Ø³Ø­ ${rows.length} Ø£ÙˆØ±Ø¯Ø± Ù…Ù† Ø§Ù„Ù‚Ø§ÙŠÙ…Ø©</div>
  <div style="display:flex;gap:8px;">
    <button class="btn-danger" style="flex:1" onclick="mineIds.clear();selected.clear();rows=[];saveMine();renderTable();updateNavMetrics();closeModal();toast('ØªÙ… Ø§Ù„Ù…Ø³Ø­','','ok')">Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­</button>
    <button style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
  </div>`);
}

/* â”€â”€ DUP NOTIF â”€â”€ */
function showDupNotif(id,elapsed){
  const h=Math.floor(elapsed/3600000);
  const m=Math.floor((elapsed%3600000)/60000);
  const timeStr=h>0?`${h} Ø³Ø§Ø¹Ø© Ùˆ ${m} Ø¯Ù‚ÙŠÙ‚Ø©`:`${m} Ø¯Ù‚ÙŠÙ‚Ø©`;
  const panel=document.getElementById("notifPanel");
  if(!panel)return;
  const card=document.createElement("div");
  card.className="notif-card duplicate";
  card.innerHTML=`<button class="notif-close" onclick="this.parentElement.remove()">âœ•</button>
  <div class="notif-icon">âš ï¸</div>
  <div class="notif-body">
    <div class="notif-title">ØªÙƒØ±Ø§Ø± Ù…Ø­ØªÙ…Ù„ â€” Order ${esc(id)}</div>
    <div class="notif-sub">Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ø§ØªØ¶Ø§Ù Ù…Ù† ${timeStr}</div>
    <div class="notif-actions">
      <button class="notif-btn gold" onclick="doAddId('${esc(id)}');this.closest('.notif-card').remove()">â• Ø¥Ø¶Ø§ÙØ© Ø±ØºÙ… Ø°Ù„Ùƒ</button>
      <button class="notif-btn" onclick="this.closest('.notif-card').remove()">ØªØ¬Ø§Ù‡Ù„</button>
    </div>
  </div>`;
  panel.prepend(card);
  setTimeout(()=>card.remove(),12000);
}

/* â”€â”€ BULK UPDATE â”€â”€ */
async function bulkUpdate(){
  const status=document.getElementById("statusSelect")?.value;
  if(!status){toast("Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹","","warn");return;}
  const ids=[...selected];
  if(!ids.length){toast("Ø­Ø¯Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹","","warn");return;}
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«â€¦");
  try{
    const params={ids:JSON.stringify(ids),status};
    if(status==="ØªÙ… Ø§Ù„Ø´Ø­Ù†"&&_selectedCourier)params.courier=_selectedCourier;
    const res=await api("bulkUpdate",params);
    hideLoading();
    if(res?.ok){toast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${ids.length} Ø£ÙˆØ±Ø¯Ø±`,"","ok");selected.clear();await refreshAll(true);}
    else toast("âŒ ÙØ´Ù„",res?.error||"","err");
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â”€â”€ QUICK ACTION â”€â”€ */
async function quickAction(id,action){
  const statusMap={print:"ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©",ship:"ØªÙ… Ø§Ù„Ø´Ø­Ù†",done:"ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…",return:"Ù…Ø±ØªØ¬Ø¹"};
  const status=statusMap[action];
  if(!status)return;
  showLoading();
  try{
    const params={ids:JSON.stringify([id]),status};
    const res=await api("bulkUpdate",params);
    hideLoading();
    if(res?.ok){toast(`âœ… ${status}`,"","ok",2000);await refreshAll(true);}
    else toast("âŒ ÙØ´Ù„","","err");
  }catch{hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â”€â”€ SEARCH INDEX â”€â”€ */
function searchIndex(){
  const q=(document.getElementById("idx_q")?.value||"").trim().toLowerCase();
  if(!q){toast("Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø«","","warn");return;}
  const all=allCache.rows;
  const res=all.filter(r=>
    String(r.orderId||r.id||"").toLowerCase().includes(q)||
    String(r.phone||r.phone1||"").replace(/\s/g,"").includes(q)||
    String(r.customer||r.name||"").toLowerCase().includes(q)||
    String(r.city||"").toLowerCase().includes(q)
  ).slice(0,50);
  const card=document.getElementById("searchCard");
  const cnt=document.getElementById("srCount");
  const tbody=document.getElementById("srTbody");
  if(card)card.style.display="block";
  if(cnt)cnt.textContent=res.length+" Ù†ØªÙŠØ¬Ø©";
  if(!tbody)return;
  tbody.innerHTML="";
  if(!res.length){tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div></div></td></tr>`;return;}
  res.forEach(r=>{
    const id=String(r.orderId||r.id||"");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><input type="checkbox" class="sr-cb" data-id="${esc(id)}"/></td>
    <td class="td-id">${esc(id)}</td>
    <td class="td-name">${esc(r.customer||r.name||"")}</td>
    <td class="td-phone">${esc(r.phone||r.phone1||"")} / ${esc(r.city||"")}</td>
    <td class="td-amount">${fmt(r.subtotal||r.productTotal||0)} Ø¬</td>
    <td>${statusBadge(r.status||"")}</td>`;
    tbody.appendChild(tr);
  });
}
function closeSearch(){
  const card=document.getElementById("searchCard");
  if(card)card.style.display="none";
  const q=document.getElementById("idx_q");
  if(q)q.value="";
}
function srToggleAll(){
  const cbs=document.querySelectorAll(".sr-cb");
  const allChecked=[...cbs].every(c=>c.checked);
  cbs.forEach(c=>c.checked=!allChecked);
}
function srAddToMine(){
  const cbs=document.querySelectorAll(".sr-cb:checked");
  cbs.forEach(c=>doAddId(c.dataset.id));
  toast(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${cbs.length} Ø£ÙˆØ±Ø¯Ø±`,"","ok");
  closeSearch();
}

/* â”€â”€ QR SCANNER â”€â”€ */
let _scanner=null;
function startScan(){
  const wrap=document.getElementById("qrWrap");
  if(wrap)wrap.style.display="block";
  if(_scanner)return;
  _scanner=new Html5Qrcode("qr-reader");
  _scanner.start({facingMode:"environment"},{fps:10,qrbox:180},
    (text)=>{
      if(navigator.vibrate)navigator.vibrate([80,40,80]);
      const el=document.getElementById("orderIdInput");
      if(el)el.value=text.trim();
      addOneWithDupCheck();
    },
    ()=>{}
  ).catch(e=>toast("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§",String(e),"err"));
}
function stopScan(){
  if(_scanner){_scanner.stop().catch(()=>{});_scanner=null;}
  const wrap=document.getElementById("qrWrap");
  if(wrap)wrap.style.display="none";
}

/* â”€â”€ PRINT MENU â”€â”€ */
let _printMenuOpen=false;
function togglePrintMenu(e){
  e.stopPropagation();
  const menu=document.getElementById("printMenu");
  if(!menu)return;
  _printMenuOpen=!_printMenuOpen;
  menu.classList.toggle("open",_printMenuOpen);
  if(_printMenuOpen){
    const btn=document.getElementById("printPendingBtn");
    if(btn){const r=btn.getBoundingClientRect();menu.style.top=(r.bottom+8)+"px";}
  }
}
document.addEventListener("click",()=>{
  if(_printMenuOpen){_printMenuOpen=false;document.getElementById("printMenu")?.classList.remove("open");}
});
function doPrintBatch(type){
  _printMenuOpen=false;document.getElementById("printMenu")?.classList.remove("open");
  const all=allCache.rows;
  let toprint=[];
  if(type==="new")toprint=all.filter(r=>String(r.status||"").trim()==="New");
  else if(type==="pending")toprint=all.filter(r=>String(r.status||"").trim()==="ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
  else toprint=all.filter(r=>["New","ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©"].includes(String(r.status||"").trim()));
  if(!toprint.length){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©","","warn");return;}
  printOrders(toprint);
}
function printOrders(ordersList){
  const pages=ordersList.map(r=>({
    orderId:String(r.orderId||r.id||""),
    date:fmtDate(r.date||""),
    time:String(r.time||""),
    customer:String(r.customer||r.name||""),
    phone1:String(r.phone||r.phone1||""),
    phone2:String(r.phone2||""),
    city:String(r.city||""),
    address:String(r.address||""),
    paymentMethod:String(r.paymentMethod||"cod"),
    subtotal:Number(r.subtotal||r.productTotal||0),
    shipping:Number(r.shipping||0),
    discount:Number(r.discount||0),
    coupon:String(r.coupon||""),
    note:String(r.note||""),
    items:Array.isArray(r.items)?r.items:(r.products||[]),
  }));
  const enc=encodeURIComponent(JSON.stringify(pages));
  window.open("receipt.html?pages="+enc,"_blank","width=420,height=700");
}
function printA4(){window.print();}

/* â”€â”€ SHIP TABLE â”€â”€ */
function setShipTab(mode){
  shipTabMode=mode;
  document.querySelectorAll(".ship-tab").forEach(t=>t.className="ship-tab");
  const tab=document.getElementById("tab"+mode.charAt(0).toUpperCase()+mode.slice(1));
  if(tab)tab.classList.add("tab-"+mode);
  renderShipTable();renderCourierBadges();
}
function renderShipTable(){
  const tbody=document.getElementById("shipTbody");if(!tbody)return;
  const cf=document.getElementById("shipCourierFilter")?.value||"";
  const now=Date.now();
  let filtered=shipAll.filter(r=>{
    if(cf&&String(r.courier||r.deliveryMan||"")!==cf)return false;
    const d=r.shipDate||r.shippedDate||"";
    if(!d)return shipTabMode==="normal";
    const days=(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000;
    if(shipTabMode==="normal")return days<6;
    if(shipTabMode==="follow")return days>=6&&days<10;
    if(shipTabMode==="overdue")return days>=10;
    return true;
  });
  document.getElementById("shipStats").textContent=filtered.length+" Ø´Ø­Ù†Ø©";
  const bN=shipAll.filter(r=>{const d=r.shipDate||r.shippedDate||"";if(!d)return true;const days=(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000;return days<6;}).length;
  const bF=shipAll.filter(r=>{const d=r.shipDate||r.shippedDate||"";if(!d)return false;const days=(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000;return days>=6&&days<10;}).length;
  const bO=shipAll.filter(r=>{const d=r.shipDate||r.shippedDate||"";if(!d)return false;const days=(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000;return days>=10;}).length;
  ["bNormal","bFollow","bOverdue"].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.textContent=[bN,bF,bO][i];});
  const totSub=filtered.reduce((s,r)=>s+Number(r.subtotal||r.productTotal||0),0);
  const totShip=filtered.reduce((s,r)=>s+Number(r.shipping||0),0);
  document.getElementById("ssTotal").textContent=filtered.length;
  document.getElementById("ssSubtotal").textContent=fmt(totSub);
  document.getElementById("ssShipping").textContent=fmt(totShip);
  document.getElementById("ssTotal2").textContent=fmt(totSub+totShip);
  tbody.innerHTML="";
  if(!filtered.length){tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="empty-icon">ğŸšš</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø­Ù†Ø§Øª</div></div></td></tr>`;return;}
  filtered.forEach(r=>{
    const d=r.shipDate||r.shippedDate||"";
    const days=d?Math.floor((now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000):null;
    const daysClass=days===null?"":days>=10?"danger":days>=6?"":"safe";
    const courierName=r.courier||r.deliveryMan||"";
    const cc=getCourierColor(courierName);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="td-id">${esc(r.orderId||r.id||"")}</td>
    <td class="td-name">${esc(r.customer||r.name||"")}</td>
    <td class="td-phone"><div>${esc(r.phone||r.phone1||"")}</div><div style="font-size:10px;color:var(--mist)">${esc(r.address||"").slice(0,30)}</div></td>
    <td>${courierName?`<span class="courier-chip"><span class="courier-dot" style="background:${cc}"></span>${esc(courierName)}</span>`:"â€”"}</td>
    <td class="mono" style="font-size:11px">${fmtDate(d)}</td>
    <td>${days!==null?`<span class="days-chip ${daysClass}">${days} ÙŠÙˆÙ…</span>`:"â€”"}</td>
    <td>${statusBadge(r.status||"")}</td>`;
    tbody.appendChild(tr);
  });
}
function renderCourierBadges(){
  const el=document.getElementById("courierBadges");if(!el)return;
  const cf=document.getElementById("shipCourierFilter")?.value||"";
  const now=Date.now();
  let base=shipAll;
  if(shipTabMode==="normal")base=shipAll.filter(r=>{const d=r.shipDate||r.shippedDate||"";if(!d)return true;return(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000<6;});
  else if(shipTabMode==="follow")base=shipAll.filter(r=>{const d=r.shipDate||r.shippedDate||"";if(!d)return false;const days=(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000;return days>=6&&days<10;});
  else if(shipTabMode==="overdue")base=shipAll.filter(r=>{const d=r.shipDate||r.shippedDate||"";if(!d)return false;return(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000>=10;});
  const couriers={};
  base.forEach(r=>{const c=String(r.courier||r.deliveryMan||"â€”");couriers[c]=(couriers[c]||0)+1;});
  el.innerHTML=Object.entries(couriers).map(([c,n])=>{
    const cc=getCourierColor(c);
    const isOverdue=c!=="â€”"&&base.filter(r=>(r.courier||r.deliveryMan||"â€”")===c).some(r=>{const d=r.shipDate||r.shippedDate||"";return d&&(now-new Date(String(d).replace(/\//g,"-")).getTime())/86400000>=10;});
    return `<button class="c-badge${isOverdue?" overdue-c":""}${cf===c?" active":""}" onclick="document.getElementById('shipCourierFilter').value='${esc(c)}';renderShipTable();renderCourierBadges();">
      <span style="width:7px;height:7px;border-radius:50%;background:${cc};display:inline-block;flex-shrink:0;"></span>${esc(c)}<span class="c-n">${n}</span></button>`;
  }).join("");
}
function printShipCurrent(){
  const filtered=shipAll.filter(r=>{
    const d=r.shipDate||r.shippedDate||"";
    if(!d)return shipTabMode==="normal";
    const days=(Date.now()-new Date(String(d).replace(/\//g,"-")).getTime())/86400000;
    if(shipTabMode==="normal")return days<6;
    if(shipTabMode==="follow")return days>=6&&days<10;
    return days>=10;
  });
  printOrders(filtered);
}

/* â”€â”€ AWAIT TABLE â”€â”€ */
function renderAwaitTable(){
  const tbody=document.getElementById("awaitTbody");if(!tbody)return;
  const el=document.getElementById("awaitStats");
  if(el)el.textContent=awaitOrders.length+" Ø£ÙˆØ±Ø¯Ø±";
  tbody.innerHTML="";
  if(!awaitOrders.length){tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div></div></td></tr>`;return;}
  awaitOrders.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="td-id">${esc(r.orderId||r.id||"")}</td>
    <td class="td-name">${esc(r.customer||r.name||"")}</td>
    <td class="td-phone"><div>${esc(r.phone||r.phone1||"")}</div><div style="font-size:10px">${esc(r.city||"")} â€” ${esc(r.address||"").slice(0,25)}</div></td>
    <td class="td-amount">${fmt(r.subtotal||r.productTotal||0)} Ø¬</td>
    <td class="mono">${fmt(r.shipping||0)} Ø¬</td>
    <td>${statusBadge(r.status||"")}</td>`;
    tbody.appendChild(tr);
  });
}

/* â”€â”€ DOWNLOAD XLSX â”€â”€ */
function downloadAllXLSX(){
  if(!rows.length){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª","","warn");return;}
  const headers=["Order ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù‡Ø§ØªÙ","Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©","Ø§Ù„Ø¹Ù†ÙˆØ§Ù†","Ø§Ù„ØªØ­ØµÙŠÙ„","Ø§Ù„Ø´Ø­Ù†","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„ØªØ§Ø±ÙŠØ®"];
  const data=[headers,...rows.map(r=>[
    r.orderId||r.id||"",r.customer||r.name||"",r.phone||r.phone1||"",r.city||"",r.address||"",
    Number(r.subtotal||r.productTotal||0),Number(r.shipping||0),
    Number(r.subtotal||r.productTotal||0)+Number(r.shipping||0),
    r.status||"",String(r.date||"").slice(0,10)
  ])];
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(data);
  ws["!cols"]=[{wch:12},{wch:20},{wch:15},{wch:15},{wch:30},{wch:12},{wch:10},{wch:12},{wch:18},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws,"Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ");
  XLSX.writeFile(wb,"WC_Orders_"+new Date().toISOString().slice(0,10)+".xlsx");
}

/* â•â• ORDER FORM TAB â•â• */
function buildSKUOptions(){
  if(!productsCache.length)return`<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ â€”</option>`;
  return`<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ â€”</option>`+productsCache.map(p=>`<option value="${esc(p.sku||p.name)}">${esc(p.name||p.sku)}${p.color?" â€” "+p.color:""}${p.size?" â€” "+p.size:""}</option>`).join("");
}
function addProductRow(container="of_products_container",prefix="of_prod"){
  productRowCounter++;
  const id=productRowCounter;
  const cont=document.getElementById(container);
  if(!cont)return;
  const div=document.createElement("div");
  div.className="product-item";div.id=prefix+"_row_"+id;
  div.innerHTML=`<div class="product-item-header"><span class="product-item-title">ğŸ“¦ Ù…Ù†ØªØ¬ ${id}</span><button class="remove-product-btn" onclick="document.getElementById('${prefix}_row_${id}').remove();calcOrderTotal()">âœ• Ø­Ø°Ù</button></div>
  <div class="form-grid form-grid-3">
    <div><label class="field-label">Ø§Ù„Ù…Ù†ØªØ¬</label><select id="${prefix}_sku_${id}" class="sku-select" onchange="onProductSKUChange('${prefix}',${id})">${buildSKUOptions()}</select></div>
    <div><label class="field-label">Ø§Ù„Ù„ÙˆÙ†</label><input id="${prefix}_color_${id}" placeholder="Ø§Ù„Ù„ÙˆÙ†"/></div>
    <div><label class="field-label">Ø§Ù„Ù…Ù‚Ø§Ø³</label><input id="${prefix}_size_${id}" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø³"/></div>
    <div><label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="${prefix}_qty_${id}" type="number" value="1" min="1" oninput="calcOrderTotal()"/></div>
    <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„Ù‚Ø·Ø¹Ø© (Ø¬)</label><input id="${prefix}_price_${id}" type="number" min="0" oninput="calcOrderTotal()"/></div>
    <div><label class="field-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ†Ù (Ø¬)</label><input id="${prefix}_line_${id}" type="number" min="0" readonly style="background:var(--ink3);color:var(--gold);font-weight:700;"/></div>
  </div>`;
  cont.appendChild(div);
}
function addProductRowEdit(){addProductRow("eo_products_container","eo_prod");}
function onProductSKUChange(prefix,id){
  const sku=document.getElementById(prefix+"_sku_"+id)?.value;
  const prod=productsCache.find(p=>p.sku===sku||p.name===sku);
  if(prod){
    const colorEl=document.getElementById(prefix+"_color_"+id);
    const sizeEl=document.getElementById(prefix+"_size_"+id);
    const priceEl=document.getElementById(prefix+"_price_"+id);
    if(colorEl&&prod.color)colorEl.value=prod.color;
    if(sizeEl&&prod.size)sizeEl.value=prod.size;
    if(priceEl&&prod.price)priceEl.value=prod.price;
  }
  calcOrderTotal();
}
function calcOrderTotal(){
  let subtotal=0;
  document.querySelectorAll(".product-item").forEach(item=>{
    const idMatch=item.id.match(/_row_(\d+)$/);if(!idMatch)return;
    const id=idMatch[1];
    const prefix=item.id.replace(/_row_\d+$/,"");
    const qty=parseFloat(document.getElementById(prefix+"_qty_"+id)?.value||0)||0;
    const price=parseFloat(document.getElementById(prefix+"_price_"+id)?.value||0)||0;
    const line=qty*price;
    const lineEl=document.getElementById(prefix+"_line_"+id);
    if(lineEl)lineEl.value=fmt(line);
    subtotal+=line;
  });
  const shipping=parseFloat(document.getElementById("of_shipping")?.value||0)||0;
  const discount=parseFloat(document.getElementById("of_discount")?.value||0)||0;
  const total=subtotal+shipping-discount;
  const sd=document.getElementById("of_subtotal_display");if(sd)sd.textContent=fmt(subtotal)+" Ø¬";
  const shd=document.getElementById("of_shipping_display");if(shd)shd.textContent=fmt(shipping)+" Ø¬";
  const dd=document.getElementById("of_discount_display");if(dd)dd.textContent=fmt(discount)+" Ø¬";
  const td=document.getElementById("of_total_display");if(td)td.textContent=fmt(total);
}
function resetOrderForm(){
  ["of_name","of_phone","of_phone2","of_address","of_note","of_coupon"].forEach(id=>{const el=document.getElementById(id);if(el)el.value="";});
  document.getElementById("of_city").value="";
  document.getElementById("of_source").value="Direct";
  document.getElementById("of_payment").value="cod";
  document.getElementById("of_shipping").value="60";
  document.getElementById("of_discount").value="0";
  document.getElementById("of_products_container").innerHTML="";
  productRowCounter=0;
  addProductRow();
  calcOrderTotal();
}
async function submitNewOrder(){
  const name=(document.getElementById("of_name")?.value||"").trim();
  const phone=(document.getElementById("of_phone")?.value||"").trim();
  const city=document.getElementById("of_city")?.value||"";
  const address=(document.getElementById("of_address")?.value||"").trim();
  if(!name||!phone||!city||!address){toast("â›” Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†Ø§Ù‚ØµØ©","Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†","err");return;}
  const products=[];
  document.querySelectorAll(".product-item").forEach(item=>{
    const idMatch=item.id.match(/_row_(\d+)$/);if(!idMatch)return;
    const id=idMatch[1];
    const prefix=item.id.replace(/_row_\d+$/,"");
    const sku=document.getElementById(prefix+"_sku_"+id)?.value||"";
    const color=document.getElementById(prefix+"_color_"+id)?.value||"";
    const size=document.getElementById(prefix+"_size_"+id)?.value||"";
    const qty=parseInt(document.getElementById(prefix+"_qty_"+id)?.value||1)||1;
    const price=parseFloat(document.getElementById(prefix+"_price_"+id)?.value||0)||0;
    const prod=productsCache.find(p=>p.sku===sku||p.name===sku);
    if(sku||prod)products.push({sku,name:prod?.name||sku,color,size,qty,lineTotal:qty*price});
  });
  if(!products.length){toast("â›” Ø£Ø¶Ù Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„","","err");return;}
  const shipping=parseFloat(document.getElementById("of_shipping")?.value||60)||0;
  const discount=parseFloat(document.getElementById("of_discount")?.value||0)||0;
  const subtotal=products.reduce((s,p)=>s+p.lineTotal,0);
  const payload={
    name,phone,phone2:document.getElementById("of_phone2")?.value||"",
    city,address,source:document.getElementById("of_source")?.value||"Direct",
    paymentMethod:document.getElementById("of_payment")?.value||"cod",
    shipping,discount,coupon:document.getElementById("of_coupon")?.value||"",
    note:document.getElementById("of_note")?.value||"",
    products:JSON.stringify(products),
    subtotal,total:subtotal+shipping-discount
  };
  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±â€¦");
  try{
    const res=await api("addNewOrder",payload);hideLoading();
    if(res?.ok){toast(`âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± #${res.orderId}`,"","ok",4000);resetOrderForm();refreshAll(true);}
    else toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",res?.error||"","err");
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â•â• EDIT ORDER TAB â•â• */
async function searchOrderForEdit(){
  const q=(document.getElementById("eo_search_id")?.value||"").trim();
  if(!q){toast("Ø§ÙƒØªØ¨ Order ID Ø£Ùˆ Ù…ÙˆØ¨Ø§ÙŠÙ„","","warn");return;}
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦");
  try{
    const res=await api("getOrderForEdit",{q});hideLoading();
    if(!res?.ok||!res.order){toast("Ù„Ù… ÙŠØªÙ… Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±","","warn");return;}
    const o=res.order;
    document.getElementById("eo_empty").style.display="none";
    document.getElementById("eo_result").style.display="block";
    document.getElementById("eo_found_info").textContent=`#${o.orderId} â€” ${o.name||o.customer||""} â€” ${o.city||""}`;
    document.getElementById("eo_name").value=o.name||o.customer||"";
    document.getElementById("eo_phone").value=o.phone||"";
    document.getElementById("eo_city").value=o.city||"";
    document.getElementById("eo_address").value=o.address||"";
    document.getElementById("eo_shipping").value=o.shipping||0;
    document.getElementById("eo_discount").value=o.discount||0;
    document.getElementById("eo_note").value=o.note||"";
    document.getElementById("eo_status").value=o.status||"New";
    document.getElementById("eo_order_id").value=o.orderId||"";
    document.getElementById("eo_row_index").value=o.rowIndex||"";
    const cont=document.getElementById("eo_products_container");
    if(cont){cont.innerHTML="";editProductRowCounter=0;}
    (o.items||[]).forEach(item=>{
      editProductRowCounter++;
      const id=editProductRowCounter;
      const div=document.createElement("div");
      div.className="product-item";div.id="eo_prod_row_"+id;
      div.innerHTML=`<div class="product-item-header"><span class="product-item-title">ğŸ“¦ Ù…Ù†ØªØ¬ ${id}</span><button class="remove-product-btn" onclick="document.getElementById('eo_prod_row_${id}').remove()">âœ• Ø­Ø°Ù</button></div>
      <div class="form-grid form-grid-3">
        <div><label class="field-label">Ø§Ù„Ù…Ù†ØªØ¬</label><input id="eo_prod_name_${id}" value="${esc(item.name||"")}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"/></div>
        <div><label class="field-label">Ø§Ù„Ù„ÙˆÙ†</label><input id="eo_prod_color_${id}" value="${esc(item.color||"")}" placeholder="Ø§Ù„Ù„ÙˆÙ†"/></div>
        <div><label class="field-label">Ø§Ù„Ù…Ù‚Ø§Ø³</label><input id="eo_prod_size_${id}" value="${esc(item.size||"")}" placeholder="Ø§Ù„Ù…Ù‚Ø§Ø³"/></div>
        <div><label class="field-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="eo_prod_qty_${id}" type="number" value="${item.qty||1}"/></div>
        <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„ØµÙ†Ù (Ø¬)</label><input id="eo_prod_line_${id}" type="number" value="${item.lineTotal||0}"/></div>
      </div>`;
      cont.appendChild(div);
    });
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«","","err");}
}
async function submitEditOrder(){
  const orderId=document.getElementById("eo_order_id")?.value||"";
  if(!orderId){toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Order ID","","err");return;}
  const payload={
    orderId,
    name:document.getElementById("eo_name")?.value||"",
    phone:document.getElementById("eo_phone")?.value||"",
    city:document.getElementById("eo_city")?.value||"",
    address:document.getElementById("eo_address")?.value||"",
    shipping:document.getElementById("eo_shipping")?.value||0,
    discount:document.getElementById("eo_discount")?.value||0,
    note:document.getElementById("eo_note")?.value||"",
    status:document.getElementById("eo_status")?.value||"",
  };
  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øªâ€¦");
  try{
    const res=await api("editOrder",payload);hideLoading();
    if(res?.ok){toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª","","ok",3000);document.getElementById("eo_result").style.display="none";refreshAll(true);}
    else toast("âŒ ÙØ´Ù„",res?.error||"","err");
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â•â• PRODUCTS TAB â•â• */
async function loadProducts(){
  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øªâ€¦");
  try{
    const res=await api("getProducts");hideLoading();
    if(res?.ok&&res.products){
      productsCache=res.products;
      // Update KPIs
      const total=productsCache.length;
      const inStock=productsCache.filter(p=>Number(p.stock||0)>10).length;
      const lowStock=productsCache.filter(p=>Number(p.stock||0)>0&&Number(p.stock||0)<=10).length;
      const outStock=productsCache.filter(p=>Number(p.stock||0)<=0).length;
      const totalSold=productsCache.reduce((s,p)=>s+Number(p.sold||0),0);
      const invValue=productsCache.reduce((s,p)=>s+Number(p.stock||0)*Number(p.price||0),0);
      document.getElementById("kpi_total_skus").textContent=total;
      document.getElementById("kpi_in_stock").textContent=inStock;
      document.getElementById("kpi_low_stock").textContent=lowStock;
      document.getElementById("kpi_out_stock").textContent=outStock;
      document.getElementById("kpi_total_sold").textContent=fmt(totalSold);
      document.getElementById("kpi_inv_value").textContent=fmt(invValue)+" Ø¬";
      document.getElementById("tabProductsBadge").textContent=total;
      renderProductsTable();
      // Update SKU dropdowns
      document.querySelectorAll(".sku-select").forEach(sel=>{sel.innerHTML=buildSKUOptions();});
      document.getElementById("pur_sku").innerHTML=buildSKUOptions();
    }else{hideLoading();toast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª","","warn");}
  }catch(e){hideLoading();toast("Ø®Ø·Ø£","","err");}
}
function renderProductsTable(){
  const tbody=document.getElementById("prodTbody");if(!tbody)return;
  const q=(document.getElementById("prod_search")?.value||"").toLowerCase();
  const ft=document.getElementById("prod_filter_status")?.value||"";
  let data=productsCache.filter(p=>{
    if(q&&!String(p.sku||"").toLowerCase().includes(q)&&!String(p.name||"").toLowerCase().includes(q))return false;
    const s=Number(p.stock||0);
    if(ft==="ok"&&s<=10)return false;
    if(ft==="low"&&(s<=0||s>10))return false;
    if(ft==="empty"&&s>0)return false;
    return true;
  });
  document.getElementById("prodTableBadge").textContent=data.length+" Ù…Ù†ØªØ¬";
  if(!data.length){tbody.innerHTML=`<tr><td colspan="12"><div class="empty"><div class="empty-icon">ğŸ“¦</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div></div></td></tr>`;return;}
  tbody.innerHTML="";

  tbody.innerHTML="";
  data.forEach(p=>{
    const stock=Number(p.stock||p.available||0);
    const sold=Number(p.sold||0);
    const cost=Number(p.cost||0);
    const price=Number(p.price||0);
    const margin=price>0?((price-cost)/price*100).toFixed(1)+"%" : "â€”";
    let stockClass="stock-ok",stockTxt=`âœ… ${stock}`;
    if(stock<=0){stockClass="stock-empty";stockTxt="âŒ Ù†ÙØ¯";}
    else if(stock<=5){stockClass="stock-critical";stockTxt=`ğŸ”´ ${stock}`;}
    else if(stock<=10){stockClass="stock-low";stockTxt=`ğŸŸ¡ ${stock}`;}
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono" style="font-size:11px;color:var(--gold)">${esc(p.sku||"")}</td>
    <td class="td-name">${esc(p.name||"")}</td>
    <td>${esc(p.color||"â€”")}</td><td>${esc(p.size||"â€”")}</td>
    <td class="mono">${fmt(cost)} Ø¬</td>
    <td class="td-amount">${fmt(price)} Ø¬</td>
    <td class="mono" style="color:var(--green)">${margin}</td>
    <td class="mono">${fmt(sold)}</td>
    <td class="mono" style="color:var(--red)">${fmt(p.returned||0)}</td>
    <td class="${stockClass}">${stockTxt}</td>
    <td>${stockTxt.includes("âŒ")?"<span class='badge b-err'>Ù†ÙØ¯</span>":stockTxt.includes("ğŸ”´")?"<span class='badge b-err'>Ø­Ø±Ø¬</span>":stockTxt.includes("ğŸŸ¡")?"<span class='badge b-warn'>Ù‚Ù„ÙŠÙ„</span>":"<span class='badge b-ok'>Ù…ØªÙˆÙØ±</span>"}</td>
    <td><button class="btn-ghost btn-sm" onclick="showStockEditModal(${JSON.stringify(p)})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button></td>`;
    tbody.appendChild(tr);
  });
}

function showStockEditModal(p){
  openModal(`<div style="margin-bottom:16px">
    <div style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:700;color:var(--white)">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
    <div style="font-size:11px;color:var(--mist);margin-top:3px">${esc(p.sku||"")} â€” ${esc(p.name||"")}</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:10px;">
    <div><label class="field-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø¶Ø§Ù ÙŠØ¯ÙˆÙŠØ§Ù‹</label><input id="m_stock" type="number" value="${Number(p.manualStock||p.stock||0)}"/></div>
    <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¬)</label><input id="m_cost" type="number" value="${Number(p.cost||0)}"/></div>
    <div><label class="field-label">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬)</label><input id="m_price" type="number" value="${Number(p.price||0)}"/></div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn-gold" style="flex:1" onclick="_saveStock('${esc(p.sku||p.name||"")}')">âœ… Ø­ÙØ¸</button>
      <button style="flex:1" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>`);
  window._saveStock=async function(sku){
    const stock=Number(document.getElementById("m_stock")?.value||0);
    const cost=Number(document.getElementById("m_cost")?.value||0);
    const price=Number(document.getElementById("m_price")?.value||0);
    closeModal();showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦");
    try{const res=await api("updateProduct",{sku,stock,cost,price});hideLoading();
      if(res?.ok){toast("âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«","","ok");loadProducts();}
      else{toast("âŒ ÙØ´Ù„",res?.error||"","err");}
    }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
    delete window._saveStock;
  };
}

/* â•â• PURCHASES TAB â•â• */
async function loadPurchases(){
  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øªâ€¦");
  try{
    const res=await api("getPurchases");hideLoading();
    if(res?.ok&&res.purchases){purchasesCache=res.purchases;renderPurchasesTable();}
    else{hideLoading();toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„","","warn");}
  }catch(e){hideLoading();toast("Ø®Ø·Ø£","","err");}
}

function onPurchaseSKUSelect(){
  const sel=document.getElementById("pur_sku");if(!sel)return;
  const sku=sel.value;
  const prod=productsCache.find(p=>p.sku===sku||p.name===sku);
  if(prod){
    const nameEl=document.getElementById("pur_product_name");if(nameEl)nameEl.value=prod.name||"";
    const priceEl=document.getElementById("pur_unit_price");if(priceEl&&prod.cost)priceEl.value=prod.cost;
  }
  calcPurchaseTotal();
}

function calcPurchaseTotal(){
  const qty=parseFloat(document.getElementById("pur_qty")?.value||0)||0;
  const price=parseFloat(document.getElementById("pur_unit_price")?.value||0)||0;
  const totEl=document.getElementById("pur_total");if(totEl)totEl.value=fmt(qty*price)+" Ø¬";
}

function renderPurchasesTable(){
  const tbody=document.getElementById("purTbody");if(!tbody)return;
  const q=(document.getElementById("pur_search")?.value||"").toLowerCase();
  let data=purchasesCache.filter(p=>!q||String(p.sku||"").toLowerCase().includes(q)||String(p.supplier||"").toLowerCase().includes(q)||String(p.productName||"").toLowerCase().includes(q));
  document.getElementById("purTableBadge").textContent=data.length+" ÙØ§ØªÙˆØ±Ø©";
  if(!data.length){tbody.innerHTML=`<tr><td colspan="10"><div class="empty"><div class="empty-icon">ğŸ›’</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª</div></div></td></tr>`;return;}
  data.forEach(p=>{
    const statusClass=p.payStatus==="Ù…Ø¯ÙÙˆØ¹"?"b-ok":p.payStatus==="Ø¢Ø¬Ù„"?"b-err":"b-warn";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono" style="color:var(--gold)">${esc(p.invNo||"")}</td>
    <td class="mono" style="font-size:11px">${esc(p.date||"")}</td>
    <td>${esc(p.supplier||"")}</td>
    <td class="mono" style="color:var(--gold)">${esc(p.sku||"")}</td>
    <td>${esc(p.productName||"")}</td>
    <td class="mono">${p.qty}</td>
    <td class="mono">${fmt(p.unitPrice)} Ø¬</td>
    <td class="td-amount">${fmt(p.total)} Ø¬</td>
    <td>${esc(p.method||"")}</td>
    <td><span class="badge ${statusClass}">${esc(p.payStatus||"")}</span></td>`;
    tbody.appendChild(tr);
  });
}

function resetPurchaseForm(){
  ["pur_sku","pur_product_name","pur_qty","pur_unit_price","pur_total","pur_supplier","pur_notes"].forEach(id=>{
    const el=document.getElementById(id);if(el)el.value=id==="pur_qty"?"1":"";
  });
  document.getElementById("pur_method").value="ÙƒØ§Ø´";
  document.getElementById("pur_status").value="Ù…Ø¯ÙÙˆØ¹";
}

async function submitPurchase(){
  const sku=(document.getElementById("pur_sku")?.value||"").trim();
  const name=(document.getElementById("pur_product_name")?.value||"").trim();
  const qty=parseInt(document.getElementById("pur_qty")?.value||0)||0;
  const unitPrice=parseFloat(document.getElementById("pur_unit_price")?.value||0)||0;
  const supplier=(document.getElementById("pur_supplier")?.value||"").trim();
  if((!sku&&!name)||qty<=0||!supplier){toast("â›” Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© (Ù…Ù†ØªØ¬ØŒ ÙƒÙ…ÙŠØ©ØŒ Ù…ÙˆØ±Ø¯)","","err");return;}
  const payload={sku:sku||name,productName:name||sku,qty,unitPrice,total:qty*unitPrice,supplier,method:document.getElementById("pur_method")?.value||"ÙƒØ§Ø´",payStatus:document.getElementById("pur_status")?.value||"Ù…Ø¯ÙÙˆØ¹",notes:document.getElementById("pur_notes")?.value||""};
  showLoading("Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øªâ€¦");
  try{
    const res=await api("addPurchase",payload);hideLoading();
    if(res?.ok){toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª!","","ok",3000);resetPurchaseForm();loadPurchases();loadProducts();}
    else{toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",res?.error||"","err");}
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â•â• EXPENSES TAB â•â• */
async function loadExpenses(){
  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙâ€¦");
  try{
    const res=await api("getExpenses");hideLoading();
    if(res?.ok&&res.expenses){expensesCache=res.expenses;renderExpensesTable();}
    else{hideLoading();toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„","","warn");}
  }catch(e){hideLoading();toast("Ø®Ø·Ø£","","err");}
}

function renderExpensesTable(){
  const tbody=document.getElementById("expTbody");if(!tbody)return;
  const ft=(document.getElementById("exp_filter_type")?.value||"");
  let data=expensesCache.filter(e=>!ft||e.type===ft);
  document.getElementById("expTableBadge").textContent=data.length+" Ù…ØµØ±ÙˆÙ";
  if(!data.length){tbody.innerHTML=`<tr><td colspan="6"><div class="empty"><div class="empty-icon">ğŸ’¸</div><div class="empty-text">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ</div></div></td></tr>`;return;}
  data.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="mono" style="font-size:11px">${esc(e.date||"")}</td>
    <td><span class="badge b-warn">${esc(e.type||"")}</span></td>
    <td>${esc(e.desc||"")}</td>
    <td class="td-amount">${fmt(e.amount)} Ø¬</td>
    <td>${esc(e.method||"")}</td>
    <td style="font-size:11px;color:var(--mist)">${esc(e.notes||"")}</td>`;
    tbody.appendChild(tr);
  });
}

function resetExpenseForm(){
  ["exp_desc","exp_amount","exp_notes"].forEach(id=>{const el=document.getElementById(id);if(el)el.value="";});
  document.getElementById("exp_type").value="Ø¥ÙŠØ¬Ø§Ø±";
  document.getElementById("exp_method").value="ÙƒØ§Ø´";
  document.getElementById("exp_date").value=new Date().toISOString().slice(0,10);
}

async function submitExpense(){
  const type=document.getElementById("exp_type")?.value||"";
  const desc=(document.getElementById("exp_desc")?.value||"").trim();
  const amount=parseFloat(document.getElementById("exp_amount")?.value||0)||0;
  const date=document.getElementById("exp_date")?.value||"";
  if(!desc||amount<=0){toast("â›” Ø§Ù„ÙˆØµÙ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨ÙŠÙ†","","err");return;}
  const payload={type,desc,amount,date,method:document.getElementById("exp_method")?.value||"ÙƒØ§Ø´",notes:document.getElementById("exp_notes")?.value||""};
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸â€¦");
  try{
    const res=await api("addExpense",payload);hideLoading();
    if(res?.ok){toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ!","","ok",3000);resetExpenseForm();loadExpenses();}
    else{toast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸",res?.error||"","err");}
  }catch(e){hideLoading();toast("âŒ Ø®Ø·Ø£","","err");}
}

/* â•â• TREASURY TAB â•â• */
async function loadTreasury(){
  showLoading("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©â€¦");
  try{
    const res=await api("getTreasury");hideLoading();
    if(!res?.ok){toast("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©","","warn");return;}
    const d=res.data||{};
    document.getElementById("tr_sales").textContent=fmt(d.totalSales||0)+" Ø¬";
    document.getElementById("tr_purchases").textContent=fmt(d.totalPurchases||0)+" Ø¬";
    document.getElementById("tr_expenses").textContent=fmt(d.totalExpenses||0)+" Ø¬";
    document.getElementById("tr_shipping_cost").textContent=fmt(d.totalShipping||0)+" Ø¬";
    const net=((d.totalSales||0)-(d.totalPurchases||0)-(d.totalExpenses||0));
    document.getElementById("tr_net_profit").textContent=fmt(net)+" Ø¬";
    const margin=d.totalSales>0?((net/d.totalSales)*100).toFixed(1)+"%" : "â€”%";
    document.getElementById("tr_margin").textContent="Ù‡Ø§Ù…Ø´: "+margin;
    document.getElementById("tr_returns").textContent=fmt(d.totalReturns||0)+" Ø¬";
    document.getElementById("tr_inv_cost").textContent=fmt(d.invCost||0)+" Ø¬";
    document.getElementById("tr_inv_sale").textContent=fmt(d.invSale||0)+" Ø¬";
    document.getElementById("tr_out_stock").textContent=d.outOfStock||0;
    document.getElementById("tr_low_stock").textContent=d.lowStock||0;
    renderMonthlyTable(d.monthly||[]);
  }catch(e){hideLoading();toast("Ø®Ø·Ø£","","err");}
}

const MONTHS_AR=["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];

function renderMonthlyTable(monthly){
  const tbody=document.getElementById("treasuryTbody");if(!tbody)return;
  tbody.innerHTML="";
  let totSales=0,totPur=0,totExp=0,totNet=0,totRet=0,totCount=0;
  MONTHS_AR.forEach((month,i)=>{
    const m=monthly.find(x=>x.month===(i+1))||{};
    const sales=Number(m.sales||0),pur=Number(m.purchases||0),exp=Number(m.expenses||0),ret=Number(m.returns||0),count=Number(m.orders||0);
    const gross=sales-pur-exp,net=gross-ret;
    const marg=sales>0?((gross/sales)*100).toFixed(1)+"%" : "â€”";
    totSales+=sales;totPur+=pur;totExp+=exp;totNet+=net;totRet+=ret;totCount+=count;
    if(sales===0&&pur===0&&exp===0)return;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td style="font-weight:700;color:var(--gold)">${month}</td>
    <td class="mono">${count}</td>
    <td class="td-amount">${fmt(sales)}</td>
    <td class="mono" style="color:var(--red)">${fmt(pur)}</td>
    <td class="mono" style="color:var(--amber)">${fmt(exp)}</td>
    <td class="mono" style="color:var(--green)">${fmt(gross)}</td>
    <td class="mono">${marg}</td>
    <td class="mono" style="color:var(--red)">${fmt(ret)}</td>
    <td style="font-weight:900;color:${net>=0?"var(--gold)":"var(--red)"}">${fmt(net)}</td>`;
    tbody.appendChild(tr);
  });
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  const tr=document.createElement("tr");tr.style.borderTop="2px solid var(--rule2)";tr.style.background="rgba(201,168,76,.05)";
  const grossTot=totSales-totPur-totExp,margTot=totSales>0?((grossTot/totSales)*100).toFixed(1)+"%" : "â€”";
  tr.innerHTML=`<td style="font-weight:900;color:var(--white)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
  <td class="mono" style="font-weight:700">${totCount}</td>
  <td class="td-amount" style="font-size:14px">${fmt(totSales)}</td>
  <td class="mono" style="color:var(--red);font-weight:700">${fmt(totPur)}</td>
  <td class="mono" style="color:var(--amber);font-weight:700">${fmt(totExp)}</td>
  <td class="mono" style="color:var(--green);font-weight:700">${fmt(grossTot)}</td>
  <td class="mono" style="font-weight:700">${margTot}</td>
  <td class="mono" style="color:var(--red);font-weight:700">${fmt(totRet)}</td>
  <td style="font-size:15px;font-weight:900;color:${totNet>=0?"var(--gold)":"var(--red)"}">${fmt(totNet)}</td>`;
  tbody.appendChild(tr);
}

/* â•â• SCROLL TOP â•â• */
window.addEventListener("scroll",()=>{const btn=document.getElementById("scrollTopBtn");if(btn)btn.classList.toggle("visible",window.scrollY>300);});

/* â•â• INIT â•â• */
loadMine();pruneDupTimes();
renderCourierBar();
// Set today date for expense form
const expDate=document.getElementById("exp_date");if(expDate)expDate.value=new Date().toISOString().slice(0,10);
// Init delivery tab
document.getElementById("deliveryActionBar").style.display="flex";
// Start auto refresh
async function autoInit(){
  showLoading("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦");
  const cached=loadCachedData();
  if(cached?.rows?.length){processAllRows(cached.rows);}
  try{const res=await fetchAllRows(true);if(res?.ok&&res.rows){processAllRows(res.rows);}}
  catch(e){toast("ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„","","err");}
  hideLoading();
}
autoInit();
setInterval(()=>refreshAll(false),35000);
// Populate SKU dropdown for purchases
document.querySelectorAll(".sku-select").forEach(sel=>{sel.innerHTML=buildSKUOptions();});

</script>
</body>
</html>
