<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Scanner + A4 Delivery Sheet</title>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a31;
      --card2:#0c152b;
      --text:#e8eefc;
      --muted:rgba(232,238,252,.72);
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --blue:#3b82f6;
      --blue2:#2563eb;
      --red:#ef4444;
      --amber:#f59e0b;
      --green:#22c55e;
      --radius:16px;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Arial;
      background: radial-gradient(1200px 700px at 15% 0%, #12214a 0%, transparent 60%),
                  radial-gradient(900px 600px at 95% 15%, #0f2b3f 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:14px;
    }

    tbody tr{
  break-inside: avoid;
  page-break-inside: avoid;
}

@media print{
  tr, td, th { 
    page-break-inside: avoid !important; 
  }
  tbody tr { 
    break-inside: avoid !important; 
  }
}
    
    .wrap{max-width:1100px;margin:0 auto}
    .topbar{
      position:sticky; top:10px; z-index:30;
      backdrop-filter: blur(10px);
      background: rgba(15,26,49,.72);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px 12px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .right{margin-inline-start:auto}
    .title{font-weight:900;font-size:18px;letter-spacing:.2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(12,21,43,.65);
      font-size:12px;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}

    .card{
      margin-top:12px;
      background: linear-gradient(180deg, rgba(15,26,49,.92), rgba(12,21,43,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }

    input,select,button{
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(12,21,43,.78);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      transition:.15s ease;
      min-height: 44px;
    }
    input::placeholder{color:rgba(232,238,252,.45)}
    input:focus,select:focus{border-color:rgba(59,130,246,.7); box-shadow:0 0 0 4px rgba(59,130,246,.18)}

    button{
      cursor:pointer;
      border:0;
      background: linear-gradient(180deg,var(--blue),var(--blue2));
      font-weight:800;
    }
    button:active{transform: translateY(1px)}
    button.secondary{background: rgba(148,163,184,.14); border:1px solid var(--line2); font-weight:800}
    button.danger{background: linear-gradient(180deg,#ff5a5a,var(--red))}
    button.ghost{background:transparent;border:1px solid var(--line2)}

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
      .topbar{top:8px}
    }

    /* Table */
    .tableWrap{
      width:100%;
      overflow:auto;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(10,18,34,.35);
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 980px; /* Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙŠØ³ÙƒØ±ÙˆÙ„ Ø£ÙÙ‚ÙŠ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠÙƒØ³Ø± */
    }
    thead th{
      position:sticky; top:0;
      background: rgba(10,18,34,.90);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:10px;
      text-align:right;
      font-size:12px;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:10px;
      vertical-align:top;
      font-size:13px;
    }
    tbody tr:hover td{background: rgba(59,130,246,.06)}
    .mono{font-variant-numeric: tabular-nums}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;
      white-space:nowrap;
      background: rgba(255,255,255,.05);
    }
    .b-ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .b-warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10)}
    .b-err{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10)}

    .addr{line-height:1.5}
    .small{font-size:12px;color:var(--muted)}
    .nowrap{white-space:nowrap}
    .no-print{display:block}

    /* QR */
    #qrWrap{display:none; margin-top:10px;}
    #qrBoxOuter{
      position:relative;
      width:100%;
      max-width:560px;
      border-radius:18px;
      border:1px solid var(--line);
      overflow:hidden;
      background: rgba(12,21,43,.75);
    }
    #qr-reader{width:100%;}
    #qrOverlay{
      position:absolute; inset:0;
      pointer-events:none;
      display:flex; align-items:center; justify-content:center;
    }
    #qrOverlay .frame{
      width:260px; height:260px;
      border-radius:18px;
      border:3px solid rgba(34,197,94,.92);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35);
      position:relative;
    }
    #qrOverlay .frame:after{
      content:"";
      position:absolute; inset:-10px;
      border-radius:22px;
      border:2px dashed rgba(245,158,11,.55);
    }

    /* Toast */
    #toast{
      position:fixed;
      bottom:14px; left:14px; right:14px;
      max-width:520px;
      margin:auto;
      background: rgba(10,18,34,.92);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      z-index:9999;
      box-shadow: var(--shadow);
    }

    /* PRINT */
    @page { size: A4 landscape; margin: 8mm; }
    .print-header,.print-summary{display:none}

    @media print{
      body{background:#fff;color:#000;margin:0;padding:0;font-size:12px}
      .no-print{display:none !important}
      .wrap{max-width:none}
      .card{box-shadow:none;border:0;border-radius:0;background:#fff;padding:0;margin:0}
      .tableWrap{border:0; overflow:visible}
      table{min-width:auto; width:100%}
      thead th{
        position:static;
        background:#f4f4f4;
        border:1px solid #ddd;
        font-size:11px;
        padding:7px;
      }
      tbody td{border:1px solid #ddd;padding:7px;font-size:11px}
      .print-header{display:block;margin-bottom:8px}
      .print-title{font-size:16px;font-weight:900;margin-bottom:2px}
      .print-summary{
        display:grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap:8px;
        margin:8px 0 12px 0;
      }
      .print-box{
        border:1px solid #ddd;border-radius:10px;padding:8px 10px;
      }
      .badge{border:1px solid #ddd;background:#fff}
    }
   /* ===== PDF MODE = Ù†ÙØ³ Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø§Ù„Ø¸Ø¨Ø· ===== */
body.pdf-mode{
  background:#fff !important;
  color:#000 !important;
  margin:0 !important;
  padding:0 !important;
  font-size:12px !important;
}

/* Ù†ÙØ³ Ø§Ù„Ù„ÙŠ ÙÙŠ print: Ø§Ø®ÙØ§Ø¡ UI */
body.pdf-mode .no-print{ display:none !important; }

/* Ù†ÙØ³ Ø§Ù„Ù„ÙŠ ÙÙŠ print */
body.pdf-mode .wrap{ max-width:none !important; }
body.pdf-mode #printArea{
  box-shadow:none !important;
  border:0 !important;
  border-radius:0 !important;
  background:#fff !important;
  padding:0 !important;
  margin:0 !important;
  width: 100% !important;
}

/* Ø§Ù…Ù†Ø¹ Ø£ÙŠ min-width ÙŠØ²ÙˆÙ‘Ø¯ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙŠÙ‚Øµ */
body.pdf-mode table{
  min-width: 0 !important;
  width: 100% !important;
}

body.pdf-mode #printArea{
  width: 297mm !important;
  min-height: 210mm !important;
}

body.pdf-mode{
  display:flex !important;
  justify-content:center !important;
}

body.pdf-mode .tableWrap{
  overflow: visible !important;
  border:0 !important;
  background:#fff !important;
}

/* Ø§Ø¹Ù…Ù„ padding Ø­Ù‚ÙŠÙ‚ÙŠ Ø²ÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ¬ÙŠ Ù‚Øµ Ù…Ù† Ø§Ù„Ø·Ø±Ù */
body.pdf-mode #printArea{
  padding: 8mm !important;
  box-sizing: border-box !important;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù…Ù„Ø®Øµ ÙŠØ¸Ù‡Ø±ÙˆØ§ */
body.pdf-mode .print-header{ display:block !important; margin-bottom:8px !important; }
body.pdf-mode .print-summary{
  display:grid !important;
  grid-template-columns: 1fr 1fr 1fr !important;
  gap:8px !important;
  margin:8px 0 12px 0 !important;
}
body.pdf-mode .print-box{ border:1px solid #ddd !important; border-radius:10px !important; padding:8px 10px !important; }

/* Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
body.pdf-mode .tableWrap{ border:0 !important; overflow:visible !important; background:#fff !important; }
body.pdf-mode table{ min-width:auto !important; width:100% !important; border-collapse:separate !important; border-spacing:0 !important; }
body.pdf-mode thead th{
  position:static !important;
  background:#f4f4f4 !important;
  border:1px solid #ddd !important;
  font-size:11px !important;
  padding:7px !important;
}
body.pdf-mode tbody td{ border:1px solid #ddd !important; padding:7px !important; font-size:11px !important; }
body.pdf-mode .badge{ border:1px solid #ddd !important; background:#fff !important; }

/* ÙŠÙ…Ù†Ø¹ ØªÙ‚Ø·ÙŠØ¹ Ø§Ù„ØµÙ */
body.pdf-mode tr,
body.pdf-mode tbody tr{
  break-inside: avoid !important;
  page-break-inside: avoid !important;
}
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar no-print">
    <div class="row">
      <div class="title">ğŸ“„ ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… A4</div>
      <span class="pill" id="countPill">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„: 0</span>
      <span class="pill" id="sumPill">Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†): 0</span>
      <span class="pill" id="shipSumPill">Ø§Ù„Ø´Ø­Ù†: 0</span>
      <span class="pill right" id="datePill"></span>
    </div>
    <div class="muted" style="margin-top:6px">
      âœ… Ø§Ù„ØµÙØ­Ø© Ø¨ØªÙØªØ­ ÙØ§Ø¶ÙŠØ© â€” Ù‡ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ <b>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„Ù„ÙŠ Ø¨ØªØ¹Ù…Ù„Ù‡Ø§ Scan/Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø·</b>.
    </div>
  </div>

  <div class="card no-print">
    <div class="grid">
      <div class="row">
        <input id="orderIdInput" placeholder="Ø§Ø¯Ø®Ù„ Order ID ÙŠØ¯ÙˆÙŠÙ‹Ø§" style="flex:1;min-width:220px" />
        <button onclick="addOne()">â• Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div class="row">
        <button class="secondary" onclick="startScan()">ğŸ“· ØªØ´ØºÙŠÙ„ QR</button>
        <button class="secondary" onclick="stopScan()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
        <button class="secondary" onclick="refreshMine()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      </div>

      <div class="row">
        <button class="danger" onclick="clearMine()">ğŸ§¹ Ù…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙŠ</button>
        <button onclick="printA4()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="secondary" onclick="downloadSelectedPDF()">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ PDF Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="statusSelect" style="min-width:220px;flex:1">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„ØªØºÙŠÙŠØ± Ø¨Ø§Ù„Ø¬Ù…Ù„Ø©â€¦</option>
        <option>ØªØ­Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
        <option>ØªÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</option>
        <option>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
        <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
        <option>Ù…Ø±ØªØ¬Ø¹</option>
        <option>Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ</option>
        <option>Ø§Ù„ØºØ§Ø¡</option>
      </select>

      <button class="danger" onclick="bulkUpdate()">âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…Ø­Ø¯Ø¯</button>
      <span class="small">* (ØªÙ… Ø§Ù„Ø´Ø­Ù†) ÙŠØ·Ù„Ø¨ Ù…Ù†Ø¯ÙˆØ¨ + ØªØ§Ø±ÙŠØ® Ø´Ø­Ù† â€” (Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ) ÙŠØ·Ù„Ø¨ Ù…Ø¨Ù„Øº.</span>
    </div>

    <div id="qrWrap">
      <div class="small" style="margin:8px 0">
        ğŸ“Œ Ø­Ø· Ø§Ù„Ù€ QR Ø¬ÙˆÙ‘Ù‡ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø®Ø¶Ø±. Ø£ÙˆÙ„ Ù…Ø§ ÙŠÙ„Ù‚Ø·: <b style="color:var(--green)">ÙŠØ±Ù† ÙÙˆØ±Ù‹Ø§</b> + ÙŠØ¶ÙŠÙ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±.
      </div>

      <div id="qrBoxOuter">
        <div id="qr-reader"></div>
        <div id="qrOverlay"><div class="frame"></div></div>
      </div>

      <div class="small" style="margin-top:8px">
        Ù„Ùˆ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø´ Ø¨ØªÙØªØ­: Ù„Ø§Ø²Ù… https + Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.
      </div>
    </div>
  </div>

  <div class="card no-print">
    <div class="title" style="font-size:16px">âœï¸ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ (Ù„Ùˆ Ù…ÙÙŠØ´ ÙÙˆØ§ØªÙŠØ±)</div>
    <div class="row" style="margin-top:10px">
      <input id="m_id" placeholder="Order ID" />
      <input id="m_name" placeholder="Ø§Ù„Ø§Ø³Ù…" />
      <input id="m_phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" />
      <input id="m_city" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©" />
      <input id="m_addr" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" style="min-width:280px; flex:1" />
      <input id="m_sub" placeholder="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†" />
      <button onclick="manualAdd()">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="card" id="printArea">
    <div class="print-header">
      <div class="print-title">ÙˆØ±Ù‚Ø© ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ - white-clothes</div>
      <div id="printDate"></div>
    </div>

    <div class="print-summary">
      <div class="print-box">
        <div><b>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</b> <span id="pCount">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†):</b> <span id="pSubtotal">0</span></div>
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†:</b> <span id="pShipping">0</span></div>
      </div>
      <div class="print-box">
        <div><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø§Ù„Ø´Ø­Ù†):</b> <span id="pTotalWithShip">0</span></div>
        <div><b>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</b> ____________</div>
        <div><b>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</b> ____________</div>
      </div>
      <div class="print-box">
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø·Ø¨ÙˆØ¹Ø© Ù…Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­</div>
        <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> <span id="pDate2"></span></div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="no-print">
            <button type="button" class="ghost" id="toggleAllBtn" onclick="toggleAll()">
               ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
            </button>
            </th>
            <th class="nowrap">Order ID</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ / Ù…Ø­Ø§ÙØ¸Ø© / Ø¹Ù†ÙˆØ§Ù†</th>
            <th class="nowrap">Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†)</th>
            <th class="nowrap">Ø§Ù„Ø´Ø­Ù†</th>
            <th class="nowrap">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<div id="toast"></div>

<script>
/** ================== CONFIG ================== **/
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwsMr7euLyvoHz0Sr_k26N_HJYG_O_W5mb061-ljwm-G6I2n0W_Wjb2aiXCk0hg0HkN/exec";
const API_KEY = "123";

/** ================== STATE ================== **/
let rows = [];
let selected = new Set();
let mineIds = new Set();
let qr = null;

let lastScan = { id:"", t:0 };
let scanLockUntil = 0;

document.getElementById("datePill").textContent = new Date().toLocaleString("ar-EG");

/** ================== Persistence ================== **/
const LS_KEY = "scanner_mine_ids_v1";
function loadMine(){
  try{
    const arr = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
    mineIds = new Set(arr.map(x => String(x)));
  }catch(e){ mineIds = new Set(); }
}
function saveMine(){
  localStorage.setItem(LS_KEY, JSON.stringify(Array.from(mineIds)));
}

/** ================== Toast ================== **/
let toastTimer=null;
function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.style.display="none", 2200);
}

/** ================== BEEP ================== **/
let audioCtx = null;
function beep(){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = 880;
    g.gain.value = 0.07;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, 120);
  }catch(e){}
  try{ if(navigator.vibrate) navigator.vibrate([50]); }catch(e){}
}

/** ================== HTTP ================== **/
async function api(action, params = {}) {
  const qs = new URLSearchParams({
    action,
    key: API_KEY,
    _t: Date.now(),
    ...params
  }).toString();

  const url = WEB_APP_URL + "?" + qs;
  return await jsonp(url);
}
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ cleanup(); resolve(data); };
    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      script.remove();
    }
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    script.onerror = ()=>{ cleanup(); reject(new Error("JSONP failed")); };
    document.body.appendChild(script);
  });
}

/** ================== Helpers ================== **/
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function n(v){ const x = Number(v); return isNaN(x)?0:x; }
function statusBadge(status){
  const s = (status||"").trim();
  if (s === "ØªÙ… Ø§Ù„Ø´Ø­Ù†" || s === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…") return `<span class="badge b-ok">${esc(s||"-")}</span>`;
  if (s === "Ù…Ø±ØªØ¬Ø¹" || s === "Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ" || s === "Ø§Ù„ØºØ§Ø¡") return `<span class="badge b-err">${esc(s||"-")}</span>`;
  return `<span class="badge b-warn">${esc(s||"-")}</span>`;
}

/** ================== Render ================== **/
function render(){
  updateToggleBtn();
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  const subtotalSum = rows.reduce((a,r)=> a + n(r.subtotal), 0);
  const shippingSum = rows.reduce((a,r)=> a + n(r.shipping), 0);

  document.getElementById("countPill").textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„: " + rows.length;
  document.getElementById("sumPill").textContent = "Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¨Ø¯ÙˆÙ† Ø´Ø­Ù†): " + subtotalSum;
  document.getElementById("shipSumPill").textContent = "Ø§Ù„Ø´Ø­Ù†: " + shippingSum;

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const checked = selected.has(String(r.orderId));

    const phone1 = (r.phone || "").trim();
    const phone2 = (r.altPhone || "").trim();
    const phones = phone2 ? `${esc(phone1)} - ${esc(phone2)}` : `${esc(phone1)}`;

    tr.innerHTML = `
      <td class="no-print"><input type="checkbox" ${checked?"checked":""} /></td>
      <td class="mono"><b>${esc(r.orderId)}</b></td>
      <td>${esc(r.name||"")}</td>
      <td class="addr mono">
  ${phones} / ${esc(r.city||"")} / ${esc(r.address||"")}
</td>
      <td class="mono"><b>${esc(String(r.subtotal||0))}</b></td>
      <td class="mono">${esc(String(r.shipping||0))}</td>
      <td>${statusBadge(r.status)}</td>
    `;

    tr.querySelector("input").addEventListener("change",(e)=>{
      const id = String(r.orderId);
      if (e.target.checked) selected.add(id);
      else selected.delete(id);
    });

    tbody.appendChild(tr);
  });
}

/** ================== Load only MY orders ================== **/
async function refreshMine(){
  if (mineIds.size === 0){
    rows = [];
    selected = new Set();
    render();
    toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø¹Ù†Ø¯Ùƒ Ù„Ø³Ù‡ â€” Ø§Ø¨Ø¯Ø£ Scan/Ø¥Ø¶Ø§ÙØ©.");
    return;
  }

  const res = await api("scanList");
  if(!res || !res.ok){
    toast("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª: " + (res?.error || "Unknown"));
    return;
  }

  const all = res.rows || [];
  const mine = all.filter(r => mineIds.has(String(r.orderId)));

  const mineOrder = Array.from(mineIds);
  mine.sort((a,b)=> mineOrder.indexOf(String(b.orderId)) - mineOrder.indexOf(String(a.orderId)));

  rows = mine;
  selected = new Set(rows.map(r=>String(r.orderId)));
  render();
}

/** ================== Add one ================== **/
async function addOne(){
  const id = document.getElementById("orderIdInput").value.trim();
  if(!id) return;

  if(mineIds.has(String(id))){
    toast("Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ù…ØªØ³Ø¬Ù„ Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„.");
    return;
  }

  mineIds.add(String(id));
  saveMine();

  beep();
  toast("ØªÙ… Ø¥Ø¶Ø§ÙØ©: " + id);

  const res = await api("scanAdd", { orderId:id });
  if(!res || !res.ok){
    toast("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±: " + (res?.error||"Unknown"));
    return;
  }

  document.getElementById("orderIdInput").value="";
  await refreshMine();
}

/** ================== Manual add ================== **/
async function manualAdd(){
  const d = {
    orderId: document.getElementById("m_id").value.trim(),
    name: document.getElementById("m_name").value.trim(),
    phone: document.getElementById("m_phone").value.trim(),
    city: document.getElementById("m_city").value.trim(),
    address: document.getElementById("m_addr").value.trim(),
    subtotal: document.getElementById("m_sub").value.trim(),
  };
  if(!d.orderId) return alert("Ø§ÙƒØªØ¨ Order ID");

  if(mineIds.has(String(d.orderId))){
    toast("Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ù…ØªØ³Ø¬Ù„ Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„.");
    return;
  }

  mineIds.add(String(d.orderId));
  saveMine();

  try{
    const res = await api("manualAdd", d);
    if(res && res.ok){}
  }catch(e){}

  ["m_id","m_name","m_phone","m_city","m_addr","m_sub"].forEach(id=>document.getElementById(id).value="");
  beep();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙŠØ¯ÙˆÙŠÙ‹Ø§: " + d.orderId);
  await refreshMine();
}

/** ================== Bulk Update ================== **/
async function bulkUpdate(){
  const status = document.getElementById("statusSelect").value.trim();
  if(!status) return alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø©");

  const ids = Array.from(selected);
  if(ids.length===0) return alert("Ù…ÙÙŠØ´ Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ø¯Ø¯Ø©");

  let courier="", shipDate="", deliveryDate="", partialAmount="";

  if(status === "ØªÙ… Ø§Ù„Ø´Ø­Ù†"){
    courier = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ØŸ", "") || "";
    shipDate = prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø­Ù† (YYYY-MM-DD)ØŸ", new Date().toISOString().slice(0,10)) || "";
    if(!courier) return alert("Ù„Ø§Ø²Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨");
  }
  if(status === "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"){
    deliveryDate = prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ… (YYYY-MM-DD)ØŸ", new Date().toISOString().slice(0,10)) || "";
  }
  if(status === "Ù…Ø±ØªØ¬Ø¹ Ø¬Ø²Ø¦ÙŠ"){
    partialAmount = prompt("Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹Ù‡ØŸ", "") || "";
    if(!partialAmount) return alert("Ù„Ø§Ø²Ù… ØªÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº");
  }

  const res = await api("bulkUpdate", {
    ids: ids.join(","),
    status, courier, shipDate, deliveryDate, partialAmount
  });

  if(!res || !res.ok){
    toast("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: " + (res?.error || "Unknown"));
    return;
  }

  toast(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (${res.updated ?? ids.length})`);
  if(res.missing && res.missing.length){
    toast("âš ï¸ Ø·Ù„Ø¨Ø§Øª Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©: " + res.missing.join(","));
  }
  await refreshMine();
}

/** ================== Print ================== **/
function updatePrintSummary(){
  const count = rows.length;
  const subtotalSum = rows.reduce((a,r)=>a + n(r.subtotal), 0);
  const shippingSum = rows.reduce((a,r)=>a + n(r.shipping), 0);
  const totalWithShip = subtotalSum + shippingSum;

  const now = new Date().toLocaleString("ar-EG");
  document.getElementById("printDate").textContent = "ØªØ§Ø±ÙŠØ® ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø´Ø­Ù†Ø©: " + now;
  document.getElementById("pDate2").textContent = now;

  document.getElementById("pCount").textContent = count;
  document.getElementById("pSubtotal").textContent = subtotalSum;
  document.getElementById("pShipping").textContent = shippingSum;
  document.getElementById("pTotalWithShip").textContent = totalWithShip;
}
function printA4(){
  updatePrintSummary();
  window.print();
}

/** ================== QR Scan ================== **/
async function startScan(){
  document.getElementById("qrWrap").style.display = "block";

  if(!qr) qr = new Html5Qrcode("qr-reader");

  const config = { fps: 15, qrbox: { width: 260, height: 260 }, aspectRatio: 1.0, disableFlip:false };

  let camId = null;
  try{
    const cams = await Html5Qrcode.getCameras();
    if(cams && cams.length){
      const back = cams.find(c => /back|rear|environment/i.test(c.label));
      camId = (back || cams[0]).id;
    }
  }catch(e){}

  try{
    await qr.start(camId || { facingMode:"environment" }, config, onQrSuccess, ()=>{});
    toast("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø© âœ…");
  }catch(e){
    toast("ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e);
  }
}
async function stopScan(){
  document.getElementById("qrWrap").style.display = "none";
  if(qr){ try{ await qr.stop(); }catch(e){} }
  toast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ QR");
}

async function onQrSuccess(decodedText){
  const now = Date.now();
  if(now < scanLockUntil) return; // lock after success

  const raw = String(decodedText || "").trim();
  const clean = raw.match(/\d+/) ? raw.match(/\d+/)[0] : raw;
  if(!clean) return;

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯
  if (lastScan.id === clean && (now - lastScan.t) < 2500) return;
  lastScan = { id: clean, t: now };

  // Ù„Ùˆ Ù…ØªØ³Ø¬Ù„ Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„
  if(mineIds.has(String(clean))){
    toast("âš ï¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¯Ù‡ Ù…ØªØ³Ø¬Ù„ Ø¹Ù†Ø¯Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„");
    scanLockUntil = now + 1200;
    return;
  }

  // lock 1.5s Ø¹Ø´Ø§Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙ‚Ø±Ø§Ù‡ÙˆØ´ ÙˆØ±Ø§ Ø¨Ø¹Ø¶
  scanLockUntil = now + 1500;

  beep();
  toast("ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· QR: " + clean);

  mineIds.add(String(clean));
  saveMine();

  const res = await api("scanAdd", { orderId: clean });
  if(!res || !res.ok){
    toast("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±: " + (res?.error || "Unknown"));
    return;
  }

  await refreshMine();
}

/** ================== Mine management ================== **/
function clearMine(){
  if(!confirm("Ù‡ØªÙ…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø© (Ù…Ø´ Ù…Ù† Ø§Ù„Ø´ÙŠØª). Ù…ØªØ£ÙƒØ¯ØŸ")) return;
  mineIds = new Set();
  saveMine();
  rows = [];
  selected = new Set();
  render();
  toast("ØªÙ… Ù…Ø³Ø­ Ø£ÙˆØ±Ø¯Ø±Ø§ØªÙƒ Ù…Ù† Ø§Ù„ØµÙØ­Ø©");
}

  document.getElementById("orderIdInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter") addOne();
});
  function toggleAll(){
  const allIds = rows.map(r => String(r.orderId));
  const allSelected = allIds.every(id => selected.has(id));

  if(allSelected){
    // Ù„Ùˆ ÙƒÙ„Ù‡ Ù…ØªØ­Ø¯Ø¯ â†’ Ø´ÙŠÙ„Ù‡Ù…
    selected.clear();
  }else{
    // Ù„Ùˆ Ù…Ø´ ÙƒÙ„Ù‡ Ù…ØªØ­Ø¯Ø¯ â†’ Ø­Ø¯Ø¯Ù‡Ù… ÙƒÙ„Ù‡Ù…
    allIds.forEach(id => selected.add(id));
  }

  updateToggleBtn();
  render();
}

function updateToggleBtn(){
  const btn = document.getElementById("toggleAllBtn");
  if(!btn) return;

  const allIds = rows.map(r => String(r.orderId));
  const allSelected = allIds.length && allIds.every(id => selected.has(id));

  btn.textContent = allSelected ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„" : "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„";
}
  async function downloadSelectedPDF(){
  const ids = Array.from(selected);
  if(ids.length === 0){
    toast("Ø§Ø®ØªØ§Ø± Ø£ÙˆØ±Ø¯Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ âœ…");
    return;
  }

  const prevRows = rows.slice();
  const prevSelected = new Set(selected);

  // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
  const filtered = rows.filter(r => ids.includes(String(r.orderId)));
  rows = filtered;
  selected = new Set(ids);

  updatePrintSummary();
  render();

  document.body.classList.add("pdf-mode");

  const area = document.getElementById("printArea");
  if(!area){
    toast("âŒ printArea Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯");
    document.body.classList.remove("pdf-mode");
    rows = prevRows; selected = prevSelected; render();
    return;
  }

  // Ø®Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
  const w = area.scrollWidth;
  const h = area.scrollHeight;

  const opt = {
  margin: 0,
  filename: `delivery_selected_${new Date().toISOString().slice(0,10)}.pdf`,
  image: { type: "jpeg", quality: 0.98 },
  html2canvas: {
    scale: 2,
    useCORS: true,
    backgroundColor: "#ffffff",
    scrollX: 0,
    scrollY: 0
  },
  jsPDF: { unit: "mm", format: "a4", orientation: "landscape" },
  pagebreak: { mode: ["css","legacy"] }
};

  try{
    await html2pdf().set(opt).from(area).save();
    toast("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù„Ù…Ø­Ø¯Ø¯");
  }catch(e){
    console.error(e);
    toast("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ PDF");
  }finally{
    document.body.classList.remove("pdf-mode");
    rows = prevRows;
    selected = prevSelected;
    render();
  }
}
/** ================== Boot ================== **/
loadMine();
render();
</script>
</body>
</html>
