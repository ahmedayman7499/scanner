<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Receipt</title>

<!-- QRCodeJS (Ù„Ù€ Offline Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ù‡ Ø¨Ù…Ø³Ø§Ø± Ù…Ø­Ù„ÙŠ) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
@page { size: 80mm auto; margin: 0mm; }
html,body{margin:0;padding:0;}
body{
  font-family: Arial, Tahoma, sans-serif;
  font-size:12px;
  line-height:1.35;
  color:#000;
  background:#e9e9e9;

  /* ØªØ®Ø§Ù†Ø© Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… */
  font-weight:700;

  /* Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ù„Ùˆ Ø¨Ø§Ù‡Øª ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
  -webkit-text-stroke: 0.10px #000;
}

*{ box-sizing:border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

.page{
  width:70mm;
  margin:10px auto;
  break-inside:avoid;

  background:#fff;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
  padding: 2.5mm 2.5mm;
}

.page-break{
  height:18px;
  break-after:page;
  page-break-after:always;
}

@media print{
  body{ background: transparent !important; padding: 0 !important; -webkit-text-stroke: 0px transparent; }
  .page{ box-shadow:none !important; border-radius:0 !important; margin:0 auto !important; padding:2mm 2mm; }
  .page-break{ height:0 !important; }
}

/* ===== Top Header (Ù…Ø±ÙˆÙ‚) ===== */
.topHead{
  display:grid;
  grid-template-columns: 24mm 1fr;
  gap: 3mm;
  align-items:start;
}

.qrBox{
  width:24mm;
  height:24mm;
  display:flex;
  align-items:flex-start;
  justify-content:flex-start;
}
.qrBox canvas,.qrBox img{
  width:22mm !important;
  height:22mm !important;
  image-rendering:pixelated;
  display:block;
}

.headInfo{
  text-align:center;
}

.brand{
  font-weight:900;
  letter-spacing:1px;
  font-size:18px;
  line-height:1.1;
}
.subhead{
  margin-top:1mm;
}
.subhead .muted{ color:#555; font-weight:700; }

.num{ direction:ltr; unicode-bidi:embed; }

.pm-badge{
  display:inline-block;
  margin-top:1mm;
  font-size:11px;
  font-weight:900;
  border:1px solid #000;
  border-radius:3px;
  padding:1px 6px;
}

.hr{
  border-top:1px dashed #777;
  margin:1.5mm 0;
}

/* ===== Info ===== */
.info{
  display:grid;
  grid-template-columns:15mm 1fr;
  gap:1mm 2mm;
}
.lbl{ font-weight:900; }

.val{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.val.full{
  white-space:normal;
  overflow:visible;
  text-overflow:unset;
  word-break:break-word;
}
.phones{ direction:rtl; unicode-bidi:embed; }

/* ===== Items (ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©) ===== */
/* Ø«Ø¨Ù‘Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© */
.itemsGridHead,
.itemsGridRow{
  display:grid;
  grid-template-columns: 1fr 12mm 16mm; /* ØµÙ†Ù | ÙƒÙ…ÙŠØ© | Ø³Ø¹Ø± */
  column-gap: 0;
}

.itemsGridHead{
  font-weight:900;
  border-top:1px solid #000;
  border-bottom:1px solid #000;
  padding:1mm 0.8mm;
  margin-top:1.5mm;
}
.itemsGridHead > div:nth-child(2){ text-align:center; }
.itemsGridHead > div:nth-child(3){ text-align:left; direction:ltr; }

.itemsGridRow{
  padding:1.3mm 0.8mm;
  border-bottom:1px dotted #bbb; /* ÙØ§ØµÙ„ Ù†Ø¸ÙŠÙ Ø¨Ø¯Ù„ Ø§Ù„Ø¨ÙˆØ±Ø¯Ø± Ø§Ù„Ù„ÙŠ ÙƒØ§Ù† Ø¨ÙŠØ¨ÙˆÙ‘Ø¸ */
}
.itemsGridRow:last-child{ border-bottom:none; }

.pnameLine{
  display:flex;
  gap:1mm;
  font-weight:900;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.meta{
  font-size:11px;
  color:#000;
  opacity:.75;
  overflow:hidden;
  text-overflow:ellipsis;
}

.qcol{ text-align:center; font-weight:900; }
.prcol{ text-align:left; direction:ltr; font-weight:900; white-space:nowrap; }

/* ===== Totals ===== */
.totals{
  margin-top:2mm;
  border-top:1px solid #000;
  padding-top:1mm;
}
.tline{
  display:flex;
  justify-content:space-between;
  padding:1mm 0;
  border-bottom:1px dotted #bbb;
  font-weight:900;
}
.tline:last-child{ border-bottom:none; }

.tline.grand{
  border:none;
  font-size:14px;
  font-weight:900;
  margin-top:1mm;
  padding-top:1mm;
  border-top:1px solid #000;
}

/* ===== Footer ===== */
.invoice-footer{
  padding-top:10px;
  border-top:1px dashed #777;
  text-align:center;
  line-height:1.2;
  margin-top:2mm;
}
.footer-site{ font-size:12px; margin-top:6px; font-weight:900; }
.footer-note{ font-size:12px; margin-top:6px; font-weight:800; }
</style>
</head>

<body>

<?
function clean(s){
  s=(s===null||s===undefined)?"":String(s);
  return s.replace(/[â¤â™¥â™¡ğŸ’—ğŸ’–ğŸ’˜ğŸ’ğŸ’ğŸ’Ÿ]/g,"").replace(/\s+/g," ").trim();
}
function isEmpty(v){
  var s=clean(v||"").toLowerCase();
  return !s||s==="Ù„Ø§ ÙŠÙˆØ¬Ø¯"||s==="Ø¨Ø¯ÙˆÙ†"||s==="0"||s==="none"||s==="null"||s==="-";
}
function numVal(v){
  var n=parseFloat(String(v||"").replace(/[^\d.-]/g,""));
  return isNaN(n) ? 0 : n;
}
function fmtNum(v){
  var n=parseFloat(String(v||"").replace(/[^\d.-]/g,""));
  if(isNaN(n)) return clean(v||"");
  return n%1===0?String(Math.round(n)):n.toFixed(2);
}
function buildMeta(it){
  var size=clean(it.size||"");
  var color=clean(it.color||"");
  var details=clean(it.details||it.variant||it.options||it.meta||it.description||"");

  var parts=[];
  if(size) parts.push("Ù…Ù‚Ø§Ø³: "+size);
  if(color) parts.push("Ù„ÙˆÙ†: "+color);

  if(parts.length) return parts.join(" â€¢ ");
  return details;
}

var list=(typeof pages!=='undefined'&&pages&&pages.length)?pages:[data];
?>

<? list.forEach(function(d,pageIndex){
  var data=d||{};
  var orderId=clean(data.orderId||data.id||"");

  var pm = clean(data.paymentMethod||"").toLowerCase();
  var isPaid = (pm==="transfer_receipt");
  var isCOD  = (pm==="cod");
  var pmLabel = isPaid ? "âœ“ ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹" : (isCOD ? "Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" : "");

  var p1=isEmpty(data.phone1||data.phone)?"":clean(data.phone1||data.phone||"");
  var p2=isEmpty(data.phone2)?"":clean(data.phone2||"");
  var phones=[p1,p2].filter(Boolean).join(" - ");

  var note = isEmpty(data.note) ? "" : clean(data.note||"");

  /* Ø§Ù„Ø®ØµÙ…: Ø®Ù„ÙŠÙ‡ Ù…ÙˆØ¬Ø¨ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¯Ø§ØªØ§ Ø¬Ø§ÙŠÙ‡ Ø¨Ø³Ø§Ù„Ø¨ */
  var discountV = Math.abs(numVal(data.discount));

  var coupon = isEmpty(data.coupon) ? "" : clean(data.coupon);

  /* Fix Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª */
  var subV  = numVal(data.subtotal);
  var shipV = numVal(data.shipping);
  var calcTotal = subV + shipV - discountV;
?>

<div class="page">

  <div class="topHead">
    <div class="qrBox" id="qr-<?= pageIndex ?>"></div>

    <div class="headInfo">
      <div class="brand"><?= clean(data.brand||"WHITE CLOTHES") ?></div>
      <div class="subhead">
        <div><b>Order:</b> <span class="num"><?= orderId ?></span></div>
        <div class="muted">
          <span class="num"><?= clean(data.time||"") ?></span>
          &nbsp;
          <span class="num"><?= clean(data.date||"") ?></span>
        </div>
        <? if(pmLabel){ ?><div class="pm-badge"><?= pmLabel ?></div><? } ?>
      </div>
    </div>
  </div>

  <div class="hr"></div>

  <div class="info">
    <div class="lbl">Ø§Ù„Ø§Ø³Ù…:</div>
    <div class="val"><?= clean(data.customer||"") ?></div>

    <? if(phones){ ?>
      <div class="lbl">Ù…ÙˆØ¨Ø§ÙŠÙ„:</div>
      <div class="val phones"><?= phones ?></div>
    <? } ?>

    <div class="lbl">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</div>
    <div class="val"><?= clean(data.city||"") ?></div>

    <div class="lbl">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</div>
    <div class="val full"><?= clean(data.address||"") ?></div>
  </div>

  <? if(note){ ?>
    <div class="info" style="margin-top:2mm;">
      <div class="lbl">Ù…Ù„Ø§Ø­Ø¸Ø©:</div>
      <div class="val full"><?= note ?></div>
    </div>
  <? } ?>

  <div class="itemsGridHead">
    <div>Ø§Ù„ØµÙ†Ù</div>
    <div>Ø§Ù„ÙƒÙ…ÙŠÙ‡</div>
    <div>Ø§Ù„Ø³Ø¹Ø±</div>
  </div>

  <?
  var items=data.items||data.products||[];
  for(var i=0;i<items.length;i++){
    var it=items[i]||{};
    var name=clean(it.name||it.product||it.title||"");
    if(!name) continue;

    var qty=Number(it.qty||it.quantity||1)||1;

    /* Ø§Ù„Ø³Ø¹Ø± line total */
    var price=numVal(it.price||it.lineTotal||it.total||"0");

    var meta=buildMeta(it);
    var unit=(qty>1 && price>0)?Math.round((price/qty)*100)/100:0;
  ?>

  <div class="itemsGridRow">
    <div>
      <div class="pnameLine">
        <span class="idx"><?= (i+1) ?>.</span>
        <span><?= name ?></span>
      </div>
      <? if(meta){ ?><div class="meta"><?= meta ?></div><? } ?>
      <? if(unit>0 && qty>1){ ?><div class="meta num"><?= fmtNum(unit) ?> Ã— <?= qty ?></div><? } ?>
    </div>

    <div class="qcol num"><?= qty ?></div>
    <div class="prcol num"><?= fmtNum(price) ?></div>
  </div>

  <? } ?>

  <div class="totals">
    <div class="tline">
      <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
      <div class="num"><?= fmtNum(subV) ?></div>
    </div>

    <div class="tline">
      <div>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†</div>
      <div class="num"><?= fmtNum(shipV) ?></div>
    </div>

    <? if(discountV>0){ ?>
      <div class="tline">
        <div>Ø®ØµÙ…</div>
        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø®ØµÙ… Ù…ÙˆØ¬Ø¨ (Ù…Ø´ -5) -->
        <div class="num"><?= fmtNum(discountV) ?></div>
      </div>
    <? } ?>

    <? if(coupon){ ?>
      <div class="tline">
        <div>ÙƒÙˆØ¨ÙˆÙ†</div>
        <div class="num"><?= coupon ?></div>
      </div>
    <? } ?>

    <div class="tline grand">
      <div>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
      <div class="num"><?= (isPaid ? "0 (ØªÙ… Ø§Ù„Ø¯ÙØ¹)" : fmtNum(calcTotal)) ?></div>
    </div>
  </div>

  <div class="invoice-footer">
    <div class="footer-site">www.white-clothes.com</div>
    <div class="footer-note">ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙŠØªÙ… Ø¯ÙØ¹ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙÙ‚Ø·.</div>
  </div>

</div>

<? if(pageIndex<list.length-1){ ?>
  <div class="page-break"></div>
<? } ?>

<? }); ?>

<script>
/* QR Offline + Batch safe + Print once */
(function(){
  var printed=false;

  function makeQR(id, text){
    var el=document.getElementById(id);
    if(!el || !text) return true; // Ù„Ùˆ Ù…ÙÙŠØ´ Ù†ØµØŒ Ù…Ø´ Ù…Ø´ÙƒÙ„Ø©
    el.innerHTML="";

    if(typeof QRCode === "undefined") return false;

    try{
      new QRCode(el, {
        text: text,
        width: 88,    // ÙŠØ·Ù„Ø¹ ~ 22mm
        height: 88,
        correctLevel: QRCode.CorrectLevel.M
      });
      return true;
    }catch(e){
      return false;
    }
  }

  function generateAll(){
    var ok=true;
    <? list.forEach(function(d,pi){
      var oid = clean((d||{}).orderId || (d||{}).id || "");
    ?>
      ok = makeQR("qr-<?= pi ?>", "<?= oid ?>") && ok;
    <? }); ?>
    return ok;
  }

  function printOnce(){
    if(printed) return;
    printed=true;
    setTimeout(function(){ window.print(); }, 350);
  }

  function run(){
    // Ø¬Ø±Ù‘Ø¨ ØªÙˆÙ„ÙŠØ¯ QRØŒ Ù„Ùˆ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù„Ø³Ù‡ Ù…Ø§ Ø§ØªØ¹Ù…Ù„ØªØ´ load Ø¬Ø±Ù‘Ø¨ ØªØ§Ù†ÙŠ
    var ok = generateAll();
    if(!ok){
      setTimeout(function(){
        generateAll();
        printOnce();
      }, 350);
    }else{
      printOnce();
    }
  }

  if(document.readyState==="loading"){
    document.addEventListener("DOMContentLoaded", run);
  }else{
    run();
  }
})();
</script>

</body>
</html>
