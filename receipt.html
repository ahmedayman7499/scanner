<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Receipt</title>

<!-- Ù„Ùˆ Ø¹Ø§ÙŠØ² Offline 100%: Ø­Ù…Ù‘Ù„ qrcode.min.js ÙˆØ­Ø·Ù‡ Ø¬Ù†Ø¨ receipt.html ÙˆØ®Ù„ÙŠ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡:
<script src="./qrcode.min.js"></script>
-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
@page { size: 80mm auto; margin: 0mm; }
html,body{margin:0;padding:0;}
body{
  font-family: Arial, Tahoma, sans-serif;
  font-size:12px;
  line-height:1.35;
  color:#000;
  background:#e9e9e9;
  font-weight:700;
  -webkit-text-stroke: 0.10px #000;
}
*{ box-sizing:border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

.page{
  width:70mm;
  margin:10px auto;
  break-inside:avoid;
  background:#fff;
  border-radius: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
  padding: 2.5mm 2.5mm;
  overflow:hidden;
  position:relative;
}

.page-break{
  height:18px;
}

@media print{
  body{ background: transparent !important; padding: 0 !important; -webkit-text-stroke: 0px transparent; }
  .page{ box-shadow:none !important; border-radius:0 !important; margin:0 auto !important; padding:2mm 2mm; }
  .page-break{
    height:0 !important;
    break-after: page;
    page-break-after: always;
  }
}

/* ===== Top Header ===== */
.topHead{
  display:grid;
  grid-template-columns: 24mm 1fr;
  gap: 3mm;
  align-items:start;
}

.qrBox{
  width:24mm;
  height:24mm;
  display:flex;
  align-items:flex-start;
  justify-content:flex-start;
}
.qrBox canvas,.qrBox img{
  width:22mm !important;
  height:22mm !important;
  image-rendering:pixelated;
  display:block;
}

.headInfo{ text-align:center; }

.brand{
  font-weight:900;
  letter-spacing:1px;
  font-size:18px;
  line-height:1.1;
}
.subhead{ margin-top:1mm; }
.subhead .muted{ color:#555; font-weight:700; }

.num{ direction:ltr; unicode-bidi:embed; }

.pm-badge{
  display:inline-block;
  margin-top:1mm;
  font-size:11px;
  font-weight:900;
  border:1px solid #000;
  border-radius:3px;
  padding:1px 6px;
}

.hr{
  border-top:1px dashed #777;
  margin:1.5mm 0;
}

/* ===== Info ===== */
.info{
  display:grid;
  grid-template-columns:15mm 1fr;
  gap:1mm 2mm;
}
.lbl{ font-weight:900; }
.val{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.val.full{
  white-space:normal;
  overflow:visible;
  text-overflow:unset;
  word-break:break-word;
}
.phones{ direction:rtl; unicode-bidi:embed; }

/* ===== Items (Ø«Ø§Ø¨Øª Ù…Ø­Ø§Ø°Ø§Ø©) ===== */
/* Ù†Ø®Ù„ÙŠ Ø§Ù„Ù€grid LTR Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØªØ«Ø¨Øª: ØµÙ†Ù | ÙƒÙ…ÙŠØ© | Ø³Ø¹Ø± */
.itemsGridHead,
.itemsGridRow{
  display:grid;
  grid-template-columns: 1fr 12mm 16mm;
  direction:ltr;
  column-gap:0;
}

.itemsGridHead{
  font-weight:900;
  border-top:1px solid #000;
  border-bottom:1px solid #000;
  padding:1mm 0.8mm;
  margin-top:1.5mm;
}
.itemsGridHead .hItem{ direction:rtl; text-align:right; }
.itemsGridHead .hQty{ text-align:center; }
.itemsGridHead .hPrice{ text-align:left; direction:ltr; }

.itemsGridRow{
  padding:1.3mm 0.8mm;
  border-bottom:1px dotted #bbb;
}
.itemsGridRow:last-child{ border-bottom:none; }

.itemCol{ direction:rtl; text-align:right; }
.pnameLine{
  display:flex;
  gap:1mm;
  font-weight:900;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.meta{
  font-size:11px;
  color:#000;
  opacity:.75;
  overflow:hidden;
  text-overflow:ellipsis;
}

.qcol{ text-align:center; font-weight:900; }
.prcol{ text-align:left; direction:ltr; font-weight:900; white-space:nowrap; }

/* ===== Totals ===== */
.totals{
  margin-top:2mm;
  border-top:1px solid #000;
  padding-top:1mm;
}
.tline{
  display:flex;
  justify-content:space-between;
  padding:1mm 0;
  border-bottom:1px dotted #bbb;
  font-weight:900;
}
.tline:last-child{ border-bottom:none; }

.tline.grand{
  border:none;
  font-size:14px;
  font-weight:900;
  margin-top:1mm;
  padding-top:1mm;
  border-top:1px solid #000;
}

/* ===== Footer ===== */
.invoice-footer{
  padding-top:10px;
  border-top:1px dashed #777;
  text-align:center;
  line-height:1.2;
  margin-top:2mm;
}
.footer-site{ font-size:12px; margin-top:6px; font-weight:900; }
.footer-note{ font-size:12px; margin-top:6px; font-weight:800; }

/* Ø´Ø§Ø´Ø© Ø®Ø·Ø£ */
.err{
  padding:12px;
  font-family: Arial, Tahoma, sans-serif;
  color:#000;
}
</style>
</head>

<body>
<div id="root"></div>

<script>
/* ===== Helpers ===== */
function clean(s){
  s=(s===null||s===undefined)?"":String(s);
  return s.replace(/[â¤â™¥â™¡ğŸ’—ğŸ’–ğŸ’˜ğŸ’ğŸ’ğŸ’Ÿ]/g,"").replace(/\s+/g," ").trim();
}
function isEmpty(v){
  var s=clean(v||"").toLowerCase();
  return !s||s==="Ù„Ø§ ÙŠÙˆØ¬Ø¯"||s==="Ø¨Ø¯ÙˆÙ†"||s==="0"||s==="none"||s==="null"||s==="-";
}
function numVal(v){
  var n=parseFloat(String(v||"").replace(/[^\d.-]/g,""));
  return isNaN(n) ? 0 : n;
}
function fmtNum(v){
  var n=parseFloat(String(v||"").replace(/[^\d.-]/g,""));
  if(isNaN(n)) return clean(v||"");
  return n%1===0?String(Math.round(n)):n.toFixed(2);
}
function buildMeta(it){
  var size=clean(it.size||"");
  var color=clean(it.color||"");
  var details=clean(it.details||it.variant||it.options||it.meta||it.description||"");
  var parts=[];
  if(size) parts.push("Ù…Ù‚Ø§Ø³: "+size);
  if(color) parts.push("Ù„ÙˆÙ†: "+color);
  return parts.length ? parts.join(" â€¢ ") : details;
}

/* ===== Load Data =====
   - ?data= (JSON or base64 JSON)
   - ?src=  (URL returns JSON: {pages:[...]} or [...] or {...})
*/
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name) || "";
}
function decodeDataParam(s){
  s = s.trim();
  if(!s) return null;

  // Try base64 first (safer Ù„Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø·ÙˆÙŠÙ„Ø©)
  try{
    if (/^[A-Za-z0-9+/=]+$/.test(s) && s.length > 20) {
      const json = decodeURIComponent(escape(atob(s)));
      return JSON.parse(json);
    }
  }catch(e){}

  // Then try URI-decoded JSON
  try{
    return JSON.parse(decodeURIComponent(s));
  }catch(e){}

  // Then try raw JSON
  try{
    return JSON.parse(s);
  }catch(e){}

  return null;
}

async function loadPages(){
  const dataParam = getParam("data");
  const srcParam  = getParam("src");

  if (srcParam){
    const r = await fetch(srcParam, { cache: "no-store" });
    const j = await r.json();
    if (Array.isArray(j)) return j;
    if (j && Array.isArray(j.pages)) return j.pages;
    return [j];
  }

  const decoded = decodeDataParam(dataParam);
  if (!decoded) return null;

  if (Array.isArray(decoded)) return decoded;
  if (decoded && Array.isArray(decoded.pages)) return decoded.pages;
  return [decoded];
}

/* ===== Render ===== */
function pmBadge(paymentMethod){
  const pm = clean(paymentMethod||"").toLowerCase();
  const isPaid = (pm === "transfer_receipt");
  const isCOD  = (pm === "cod");
  return isPaid ? "âœ“ ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ù…Ø³Ø¨Ù‚Ø§Ù‹" : (isCOD ? "Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" : "");
}

function pageHTML(data, idx){
  data = data || {};
  const orderId = clean(data.orderId || data.id || "");
  const phones = [clean(data.phone1||data.phone||""), clean(data.phone2||"")].filter(Boolean).join(" - ");
  const note = isEmpty(data.note) ? "" : clean(data.note||"");

  const discountV = Math.abs(numVal(data.discount));
  const coupon = isEmpty(data.coupon) ? "" : clean(data.coupon);

  const subV  = numVal(data.subtotal);
  const shipV = numVal(data.shipping);
  const calcTotal = subV + shipV - discountV;

  const badge = pmBadge(data.paymentMethod);

  // items
  const items = (data.items || data.products || []);
  let rows = "";
  let counter = 0;

  for (let i=0;i<items.length;i++){
    const it = items[i] || {};
    const name = clean(it.name||it.product||it.title||"");
    if(!name) continue;
    counter++;

    const qty = Number(it.qty||it.quantity||1)||1;
    const price = numVal(it.price||it.lineTotal||it.total||"0");

    const meta = buildMeta(it);
    const unit = (qty>1 && price>0) ? Math.round((price/qty)*100)/100 : 0;

    rows += `
      <div class="itemsGridRow">
        <div class="itemCol">
          <div class="pnameLine">
            <span class="idx">${counter}.</span>
            <span>${name}</span>
          </div>
          ${meta ? `<div class="meta">${meta}</div>` : ``}
          ${(unit>0 && qty>1) ? `<div class="meta num">${fmtNum(unit)} Ã— ${qty}</div>` : ``}
        </div>
        <div class="qcol num">${qty}</div>
        <div class="prcol num">${fmtNum(price)}</div>
      </div>
    `;
  }

  return `
  <div class="page">
    <div class="topHead">
      <div class="qrBox" data-qr="${orderId}" id="qr-${idx}"></div>
      <div class="headInfo">
        <div class="brand">${clean(data.brand||"WHITE CLOTHES")}</div>
        <div class="subhead">
          <div><b>Order:</b> <span class="num">${orderId}</span></div>
          <div class="muted">
            <span class="num">${clean(data.time||"")}</span>
            &nbsp;
            <span class="num">${clean(data.date||"")}</span>
          </div>
          ${badge ? `<div class="pm-badge">${badge}</div>` : ``}
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="info">
      <div class="lbl">Ø§Ù„Ø§Ø³Ù…:</div>
      <div class="val">${clean(data.customer||"")}</div>

      ${phones ? `
        <div class="lbl">Ù…ÙˆØ¨Ø§ÙŠÙ„:</div>
        <div class="val phones">${phones}</div>
      ` : ``}

      <div class="lbl">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</div>
      <div class="val">${clean(data.city||"")}</div>

      <div class="lbl">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</div>
      <div class="val full">${clean(data.address||"")}</div>
    </div>

    ${note ? `
      <div class="info" style="margin-top:2mm;">
        <div class="lbl">Ù…Ù„Ø§Ø­Ø¸Ø©:</div>
        <div class="val full">${note}</div>
      </div>
    ` : ``}

    <div class="itemsGridHead">
      <div class="hItem">Ø§Ù„ØµÙ†Ù</div>
      <div class="hQty">Ø§Ù„ÙƒÙ…ÙŠÙ‡</div>
      <div class="hPrice">Ø§Ù„Ø³Ø¹Ø±</div>
    </div>

    ${rows || `<div style="padding:6px 0; font-weight:900;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</div>`}

    <div class="totals">
      <div class="tline">
        <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        <div class="num">${fmtNum(subV)}</div>
      </div>

      <div class="tline">
        <div>Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù†</div>
        <div class="num">${fmtNum(shipV)}</div>
      </div>

      ${discountV>0 ? `
        <div class="tline">
          <div>Ø®ØµÙ…</div>
          <div class="num">${fmtNum(discountV)}</div>
        </div>
      ` : ``}

      ${coupon ? `
        <div class="tline">
          <div>ÙƒÙˆØ¨ÙˆÙ†</div>
          <div class="num">${coupon}</div>
        </div>
      ` : ``}

      <div class="tline grand">
        <div>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
        <div class="num">${(clean(data.paymentMethod||"").toLowerCase()==="transfer_receipt") ? "0 (ØªÙ… Ø§Ù„Ø¯ÙØ¹)" : fmtNum(calcTotal)}</div>
      </div>
    </div>

    <div class="invoice-footer">
      <div class="footer-site">www.white-clothes.com</div>
      <div class="footer-note">ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙŠØªÙ… Ø¯ÙØ¹ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø­Ù† ÙÙ‚Ø·.</div>
    </div>
  </div>
  `;
}

/* ===== QR + Print once (Batch safe) ===== */
function makeQR(el){
  const text = (el.getAttribute("data-qr") || "").trim();
  if(!text) return true;
  el.innerHTML = "";
  if(typeof QRCode === "undefined") return false;
  try{
    new QRCode(el, { text, width: 88, height: 88, correctLevel: QRCode.CorrectLevel.M });
    return true;
  }catch(e){
    return false;
  }
}

function qrsReady(){
  const nodes = document.querySelectorAll("[data-qr]");
  for (const n of nodes){
    const t = (n.getAttribute("data-qr")||"").trim();
    if(!t) continue;
    if(!n.querySelector("canvas, img")) return false;
  }
  return true;
}

(async function init(){
  const root = document.getElementById("root");

  let pages = null;
  try{
    pages = await loadPages();
  }catch(e){
    pages = null;
  }

  if(!pages || !pages.length){
    root.innerHTML = `<div class="err">No data. Use ?data=... Ø£Ùˆ ?src=...</div>`;
    return;
  }

  // Render pages
  root.innerHTML = pages.map((p,i)=> pageHTML(p,i) + (i<pages.length-1 ? `<div class="page-break"></div>` : ``)).join("");

  // Generate QR (retry) then print
  let printed = false;
  function printOnce(){
    if(printed) return;
    printed = true;
    setTimeout(()=>window.print(), 250);
  }

  function generateAll(){
    const nodes = document.querySelectorAll("[data-qr]");
    let ok = true;
    nodes.forEach(n => { ok = makeQR(n) && ok; });
    return ok;
  }

  // run + wait
  generateAll();
  const start = Date.now();
  (function tick(){
    if(qrsReady() || (Date.now()-start) > 2500){
      printOnce();
    }else{
      // Ù„Ùˆ QRCode.js Ø§ØªØ£Ø®Ø±
      generateAll();
      setTimeout(tick, 80);
    }
  })();
})();
</script>
</body>
</html>
